head	1.61;
access;
symbols
	helowiki-melon-20091010:1.58.0.8
	helowiki-2005:1.58.0.6
	helowiki:1.58.0.4
	suikawiki3-redirect:1.61
	paragraph-200404:1.58.0.2
	release-3-0-0:1.58
	branch-suikawiki-1:1.54.0.2
	branch-1-6:1.15.0.2
	release-2-0-beta1-wal1:1.1.1.1
	walwiki:1.1.1;
locks; strict;
comment	@# @;


1.61
date	2008.11.10.15.05.30;	author wakaba;	state Exp;
branches;
next	1.60;

1.60
date	2008.11.10.13.49.05;	author wakaba;	state Exp;
branches;
next	1.59;

1.59
date	2008.10.11.09.18.56;	author wakaba;	state Exp;
branches;
next	1.58;

1.58
date	2004.03.12.04.54.19;	author wakaba;	state Exp;
branches
	1.58.6.1
	1.58.8.1;
next	1.57;

1.57
date	2004.02.01.12.33.27;	author wakaba;	state Exp;
branches;
next	1.56;

1.56
date	2003.12.01.07.47.18;	author wakaba;	state Exp;
branches;
next	1.55;

1.55
date	2003.11.27.05.31.05;	author wakaba;	state Exp;
branches;
next	1.54;

1.54
date	2003.08.06.03.04.22;	author wakaba;	state Exp;
branches
	1.54.2.1;
next	1.53;

1.53
date	2003.04.03.01.09.31;	author wakaba;	state Exp;
branches;
next	1.52;

1.52
date	2003.03.27.06.25.01;	author wakaba;	state Exp;
branches;
next	1.51;

1.51
date	2003.01.26.02.30.24;	author w;	state Exp;
branches;
next	1.50;

1.50
date	2003.01.12.09.15.06;	author w;	state Exp;
branches;
next	1.49;

1.49
date	2003.01.04.03.32.55;	author w;	state Exp;
branches;
next	1.48;

1.48
date	2003.01.03.08.25.31;	author w;	state Exp;
branches;
next	1.47;

1.47
date	2003.01.03.03.27.30;	author w;	state Exp;
branches;
next	1.46;

1.46
date	2003.01.02.12.14.15;	author w;	state Exp;
branches;
next	1.45;

1.45
date	2003.01.02.00.34.04;	author w;	state Exp;
branches;
next	1.44;

1.44
date	2003.01.01.12.30.24;	author w;	state Exp;
branches;
next	1.43;

1.43
date	2003.01.01.01.29.04;	author w;	state Exp;
branches;
next	1.42;

1.42
date	2002.12.30.03.20.06;	author wakaba;	state Exp;
branches;
next	1.41;

1.41
date	2002.12.25.02.04.11;	author wakaba;	state Exp;
branches;
next	1.40;

1.40
date	2002.12.19.09.50.18;	author wakaba;	state Exp;
branches;
next	1.39;

1.39
date	2002.12.18.13.08.39;	author wakaba;	state Exp;
branches;
next	1.38;

1.38
date	2002.12.15.06.08.33;	author wakaba;	state Exp;
branches;
next	1.37;

1.37
date	2002.12.13.06.17.44;	author wakaba;	state Exp;
branches;
next	1.36;

1.36
date	2002.12.10.07.27.38;	author wakaba;	state Exp;
branches;
next	1.35;

1.35
date	2002.12.05.04.32.27;	author wakaba;	state Exp;
branches;
next	1.34;

1.34
date	2002.12.04.12.00.42;	author wakaba;	state Exp;
branches;
next	1.33;

1.33
date	2002.12.03.09.34.43;	author wakaba;	state Exp;
branches;
next	1.32;

1.32
date	2002.12.01.04.32.50;	author wakaba;	state Exp;
branches;
next	1.31;

1.31
date	2002.11.14.10.22.19;	author wakaba;	state Exp;
branches;
next	1.30;

1.30
date	2002.11.13.08.28.15;	author wakaba;	state Exp;
branches;
next	1.29;

1.29
date	2002.10.21.06.28.02;	author wakaba;	state Exp;
branches;
next	1.28;

1.28
date	2002.10.17.07.56.58;	author wakaba;	state Exp;
branches;
next	1.27;

1.27
date	2002.10.07.12.50.51;	author wakaba;	state Exp;
branches;
next	1.26;

1.26
date	2002.09.28.10.54.27;	author wakaba;	state Exp;
branches;
next	1.25;

1.25
date	2002.09.28.09.43.07;	author wakaba;	state Exp;
branches;
next	1.24;

1.24
date	2002.08.30.04.31.11;	author wakaba;	state Exp;
branches;
next	1.23;

1.23
date	2002.08.18.04.14.35;	author wakaba;	state Exp;
branches;
next	1.22;

1.22
date	2002.06.30.07.52.46;	author wakaba;	state Exp;
branches;
next	1.21;

1.21
date	2002.06.02.07.15.20;	author wakaba;	state Exp;
branches;
next	1.20;

1.20
date	2002.06.02.06.37.36;	author wakaba;	state Exp;
branches;
next	1.19;

1.19
date	2002.06.02.06.28.30;	author wakaba;	state Exp;
branches;
next	1.18;

1.18
date	2002.06.02.06.19.43;	author wakaba;	state Exp;
branches;
next	1.17;

1.17
date	2002.06.02.05.41.49;	author wakaba;	state Exp;
branches;
next	1.16;

1.16
date	2002.06.02.05.03.38;	author wakaba;	state Exp;
branches;
next	1.15;

1.15
date	2002.04.23.10.14.12;	author wakaba;	state Exp;
branches;
next	1.14;

1.14
date	2002.04.02.01.32.31;	author wakaba;	state Exp;
branches;
next	1.13;

1.13
date	2002.04.02.00.28.14;	author wakaba;	state Exp;
branches;
next	1.12;

1.12
date	2002.03.24.01.14.30;	author wakaba;	state Exp;
branches;
next	1.11;

1.11
date	2002.03.24.01.12.13;	author wakaba;	state Exp;
branches;
next	1.10;

1.10
date	2002.03.24.01.09.03;	author wakaba;	state Exp;
branches;
next	1.9;

1.9
date	2002.03.24.00.55.15;	author wakaba;	state Exp;
branches;
next	1.8;

1.8
date	2002.03.24.00.51.52;	author wakaba;	state Exp;
branches;
next	1.7;

1.7
date	2002.02.04.15.27.22;	author wakaba;	state Exp;
branches;
next	1.6;

1.6
date	2002.02.04.15.23.58;	author wakaba;	state Exp;
branches;
next	1.5;

1.5
date	2002.02.04.15.22.00;	author wakaba;	state Exp;
branches;
next	1.4;

1.4
date	2002.02.04.15.03.23;	author wakaba;	state Exp;
branches;
next	1.3;

1.3
date	2002.02.04.14.36.18;	author wakaba;	state Exp;
branches;
next	1.2;

1.2
date	2002.02.04.13.31.47;	author wakaba;	state Exp;
branches;
next	1.1;

1.1
date	2002.02.04.13.19.08;	author wakaba;	state Exp;
branches
	1.1.1.1;
next	;

1.58.6.1
date	2010.05.16.23.53.07;	author hero;	state Exp;
branches;
next	;

1.58.8.1
date	2010.05.17.22.11.47;	author wakaba;	state Exp;
branches;
next	;

1.54.2.1
date	2003.11.27.05.30.13;	author wakaba;	state Exp;
branches;
next	;

1.1.1.1
date	2002.06.02.04.26.22;	author wakaba;	state Exp;
branches;
next	;


desc
@@


1.61
log
@2008-11-10  Wakaba  <wakaba@@suika.fam.cx>

        * wiki.cgi: Support for the _charset_=utf-8 parameter, which is
        necessary for <http://suika.fam.cx/gate/2005/sw/>.
@
text
@#!/usr/bin/perl
use strict;
use lib qw[/home/httpd/html/www/markup/html/whatpm
           /home/wakaba/work/manakai2/lib
           /home/httpd/html/swe/lib/];

use CGI::Carp qw[fatalsToBrowser];
require Message::CGI::Carp;

my $sw4_url = q<http://suika.fam.cx/~wakaba/wiki/sw/>;

require Message::CGI::HTTP;
require Encode::EUCJPSW;
my $cgi = Message::CGI::HTTP->new;

my $page = $ENV{QUERY_STRING};
if ($page =~ /[&;]/) {
  $page = $cgi->get_parameter ('mypage') // '';

  my $charset = $cgi->get_parameter ('_charset_') // 'euc-jp-sw';
  $charset = 'euc-jp-sw' unless $charset eq 'utf-8';
  $page = Encode::decode ($charset, $page);
} else {
  $page = Encode::decode ('euc-jp-sw', percent_decode_byte ($page));
}

my $url = get_page_url ($page);

print qq[Status: 301 Moved
Location: $url
Content-Type: text/html; charset=utf-8

<!DOCTYPE HTML>
<html lang=en>
<title>301 Moved</title>
<h1>Moved</h1>
<p>See <a href="@@{[htescape ($url)]}">other page</a>.];
exit;

sub get_page_url ($) {
  my $wiki_name = shift;
  $wiki_name = percent_encode ($wiki_name);
  $wiki_name =~ s/%2F/+/g;
  $wiki_name = $sw4_url . 'n/' . $wiki_name;
  return $wiki_name;
} # get_page_url

sub percent_encode ($) {
  my $s = Encode::encode ('utf8', $_[0]);
  $s =~ s/([^A-Za-z0-9_~-])/sprintf '%%%02X', ord $1/ges;
  return $s;
} # percent_encode

sub percent_decode ($) { # input should be a byte string.
  my $s = shift;
  $s =~ s/%([0-9A-Fa-f]{2})/pack 'C', hex $1/ge;
  return Encode::decode ('utf-8', $s); # non-UTF-8 octet converted to \xHH
} # percent_decode

sub percent_decode_byte ($) { # input should be a byte string.
  my $s = shift;
  $s =~ s/%([0-9A-Fa-f]{2})/pack 'C', hex $1/ge;
  return $s;
} # percent_decode_byte

sub htescape ($) {
  my $s = shift;
  $s =~ s/&/&amp;/g;
  $s =~ s/</&lt;/g;
  $s =~ s/"/&quot;/g;
  return $s;
} # htescape
@


1.60
log
@2008-11-10  Wakaba  <wakaba@@suika.fam.cx>

        * wiki.cgi: Changed to redirector to the SuikaWiki4 URL.
@
text
@a14 3
$cgi->{decoder}->{'#default'} = sub {
  return Encode::decode ('euc-jp-sw', $_[1]);
};
d19 4
@


1.59
log
@Updated
@
text
@d1 1
a1 2
#!/usr/bin/perl5.8.7
BEGIN { $0 = ''.$0 }
d3 69
a71 48
use lib qw(lib);
use CGI::Carp qw(fatalsToBrowser);

## Configuration script
require 'wikidata/suikawiki-config.ph';

## WikiDriver main module
require 'suikawiki.pl';

=head1 NAME

wiki.cgi - SuikaWiki: Yet yet another WikiEngine - HTTP CGI Script Driver

=head1 DESCRIPTION

This is a boot script for SuikaWiki HTTP CGI Script Driver (SWHCS).
Actual driving of WikiEngine is coded in C<lib/suikawiki.pl>.
Options such as WikiDB directories can be specified in C<wikidata/suikawiki.ph>.

This file is part of SuikaWiki.

=head1 SYNOPSIS

  $ telnet www.example.net 80<Enter>
  GET /path/to/wiki/cgi/script?WikiName HTTP/1.1<Enter>
  Host: www.example.net<Enter>
  <Enter>

Future version of SuikaWiki will accept "Accept: text/plain" HTTP
request header field.

=head1 SEE ALSO

<http://suika.fam.cx/~wakaba/-temp/wiki/wiki?SuikaWiki>,
<http://suika.fam.cx/~wakaba/-temp/wiki/wiki?SWHCS>,
C<lib/suikawiki.pl>,
C<wikidata/suikawiki-config.ph>

=head1 LICENSE

Copyright 2002-2004 Wakaba <w@@suika.fam.cx>.  All rights reserved.

This program is free software; you can redistribute it and/or
modify it under the same terms as Perl itself.

=cut

1; # $Date: 2004/03/12 04:54:19 $
@


1.58
log
@Load suikawiki-config on this stage
@
text
@d1 1
a1 1
#!/usr/bin/perl 
d51 1
a51 1
1; # $Date: 2004/02/01 12:33:27 $
@


1.58.8.1
log
@compiled .pm files
@
text
@d1 1
a1 2
#!/usr/bin/perl5.8.8
#!/usr/local/bin/perl5.8.7 
d51 1
a51 1
1; # $Date: 2004/03/12 04:54:19 $
@


1.58.6.1
log
@helowiki compat
@
text
@d1 1
a1 1
#!/usr/bin/perl5.8.7 
d51 1
a51 1
1; # $Date: 2004/03/12 04:54:19 $
@


1.57
log
@Don't require 'suikawiki-config.ph' directly
@
text
@d1 1
a1 1
#!/usr/bin/perl -d:DProf
d6 5
d51 1
a51 1
1; # $Date: 2003/12/01 07:47:18 $
@


1.56
log
@Set $0 in BEGIN block
@
text
@d4 1
d6 1
a6 2
require 'wikidata/suikawiki-config.ph';	## the site configuration script
require 'suikawiki.pl';	## the main script
d10 19
a28 1
wiki.cgi --- SuikaWiki: Yet yet another WikiEngine
d32 4
a35 1
<IW:SuikaWiki:SuikaWiki>
d39 1
a39 1
Copyright 2002-2003 Wakaba <w@@suika.fam.cx>
d46 1
a46 1
1; # $Date: 2003/11/27 05:31:05 $
@


1.55
log
@Change $0
@
text
@d1 2
a2 3
#!/usr/bin/perl
## wiki.cgi --- This is SuikaWiki, yet another WikiEngine
$0 = ''.$0;
a7 3
package SuikaWiki;
our $VERSION = '2.2';

d25 1
a25 1
1; # $Date: 2003/08/06 03:04:22 $
@


1.54
log
@Have version info.
@
text
@d3 1
a3 1

d29 1
a29 1
1; # $Date: 2003/04/03 01:09:31 $
@


1.54.2.1
log
@Change $0
@
text
@d3 1
a3 1
$0 = ''.$0;
d29 1
a29 1
1; # $Date: 2003/08/06 03:04:22 $
@


1.53
log
@*** empty log message ***
@
text
@d9 3
d29 1
a29 1
1; # $Date: 2003/03/27 06:25:01 $
@


1.52
log
@Updated
@
text
@a5 1
our $VERSION = do{my @@r=(q$Revision: 1.51 $=~/\d+/g);sprintf "%d."."%02d" x $#r,@@r};
d26 1
a26 1
1; # $Date: $
@


1.51
log
@Mosaic Netscape 0.9 support
@
text
@d2 1
a2 1
## wiki.cgi - This is SuikaWiki, yet another WikiEngine
a4 1
use lib qw(./lib);
d6 3
a8 12
binmode STDOUT; binmode STDIN;
our $VERSION = do{my @@r=(q$Revision: 1.50 $=~/\d+/g);sprintf "%d."."%02d" x $#r,@@r};
require 'wikidata/suikawiki-config.ph';	## site configuration script
require Yuki::YukiWikiCache;
use Fcntl;
our %fmt;	## formatter objects
our %embed_command = (
	searched	=> '^\[\[#searched:([^\]]+)\]\]$',
	form	=> qr/\[\[\#form(?:\(([A-Za-z0-9-]+)\))?:'((?:[^'\\]|\\.)*)':'((?:[^'\\]|\\.)*)'(?::'((?:[^'\\]|\\.)*)')?\]\]/,
);
our ($modifier_dbtype,$url_cgi,%uri,%PathTo);
our (%PageName,$kanjicode,$lang,%ViewDefinition);
a9 1203
my %form;
our %database;
our $database = bless {}, 'wiki::dummy';
my %interwiki;
my %command_do = (
    default => \&do_view,
    adminchangepassword => \&do_adminchangepassword,
    write => \&do_write,
    searchform => \&do_searchform,
    comment => \&do_comment,
    RandomJump	=> \&do_random_jump,
    wikiform	=> \&do_wikiform,
);
our $UA = '';  ## User agent name
$| = 1;

sub main {
    $UA = $main::ENV{HTTP_USER_AGENT};
    &open_db;
    &init_form;
    if ($command_do{$form{mycmd}}) {
        &{$command_do{$form{mycmd}}};
    } else {
        &{$command_do{default}};
    }
    &close_db;
}

sub do_view {
  my $content = $database{$form{mypage}};
  my $lm = $database->mtime ($form{mypage});
  wiki::referer::add ($form{mypage}, $ENV{HTTP_REFERER});
  wiki::useragent::add ($ENV{HTTP_USER_AGENT});
  &load_formatter ('view');
    my $view = $form{mycmd};
    if ($view eq 'edit') {
      $view = 'adminedit' if $form{admin};
    } elsif ($view =~ /[^0-9A-Za-z]/) {
      $view = 'default'
    }
    if ($view eq 'default' || !$view) {
      ## BUG: this code is not strict
      if ($main::ENV{HTTP_COOKIE} =~ /SelectedMode=([0-9A-Za-z]+)/) {
        $view = $1;
      } else {
        $view = 'read';
      }
    }
  my ($magic, $content) = &SuikaWiki::Plugin::magic_and_content (undef, $content);
  $magic ||= '#?SuikaWiki/0.9';
  my $o = bless {param => \%form, page => $form{mypage}, toc => [],
                 magic => $magic, content => $content,
                 formatter => $fmt{view}, &_compatible_options ()}, 'SuikaWiki::Plugin';
  if (!ref $ViewDefinition{$view} || !&{$ViewDefinition{$view}->{check}} ($o)) {
    print "Status: 406 Unsupported Media Type\n";
    $view = '-UnsupportedMediaType';
  }
  my $media = $ViewDefinition{$view}->{media};
  if ($ViewDefinition{$view}->{xmedia} && $UA =~ /Gecko/) {
    $media = $ViewDefinition{$view}->{xmedia};
    $o->{media} = $media;
  } elsif ($UA =~ m#Mozilla/0\..+Windows#) {
    $kanjicode = 'shift_jis';
  }
    if ($magic =~ m!^\#\?SuikaWiki/0.9!) {
      &print_header ($form{mypage}, -last_modified => ($magic =~ /interactive="yes"/ ? time : $lm),
        -expires => ($magic =~ /interactive="yes"/ ? 1 : undef), o => $o,
        -media => $media, -magic => $magic,  content => $content);
    } else {
      &print_header($form{mypage}, -media => $media,
                                   -magic => $magic, -last_modified => $lm, o => $o);
    }
  if ($kanjicode ne 'euc') {
    my $s = $fmt{view}->replace ($ViewDefinition{$view}->{template} => $o);
    print &code_convert (\$s => $kanjicode);
  } else {
    print $fmt{view}->replace ($ViewDefinition{$view}->{template} => $o);
  }
}

sub _do_view_msg (%) {
  my %option = @@_;
  &load_formatter ('view');
  my $o = bless {param => \%form, page => $option{-page}, toc => [], condition => \%option,
                 formatter => $fmt{view}, &_compatible_options ()}, 'SuikaWiki::Plugin';
  unless (&{$ViewDefinition{$option{-view}}->{check}} ($o)) {
    print "Status: 406 Unsupported Media Type\n";
    $option{-view} = '-UnsupportedMediaType';
  }
  my $media = $ViewDefinition{$option{-view}}->{media};
  if ($ViewDefinition{$option{-view}}->{xmedia} && $UA =~ /Gecko/) {
    $media = $ViewDefinition{$option{-view}}->{xmedia};
    $o->{media} = $media;
  }
  &print_header($option{-page}, -media => $media, o => $o, -goto => $option{-goto});
  print $fmt{view}->replace ($ViewDefinition{$option{-view}}->{template} => $o);
}

sub id_and_name ($) {
    my $name = shift;
    if ($UA =~ m#Mozilla/[12]\.|Microsoft Internet Explorer#) {
      qq{id="$name"><a name="$name"></a};
    } else {
	qq{id="$name"};
    }
}

sub do_adminchangepassword {
    if ($form{mynewpassword} ne $form{mynewpassword2}) {
        &_do_view_msg (-view => '-error', -page => $form{mypage},
                       error_message => &Resource ('Error:PasswordMismatch'));
        return;
    }
    my ($validpassword_crypt) = $database->meta (AdminPassword => $PageName{AdminSpecialPage});
    if ($validpassword_crypt) {
        if (not &valid_password($form{myoldpassword})) {
            &_do_view_msg (-view => '-error', -page => $form{mypage},
                           error_message => &Resource ('Error:PasswordIsIncorrect'));
            return;
        }
    }
    my ($sec, $min, $hour, $day, $mon, $year, $weekday) = localtime(time);
    my (@@token) = ('0'..'9', 'A'..'Z', 'a'..'z');
    my $salt1 = $token[(time | $$) % scalar(@@token)];
    my $salt2 = $token[($sec + $min*60 + $hour*60*60) % scalar(@@token)];
    my $crypted = crypt($form{mynewpassword}, "$salt1$salt2");
    $database->meta (AdminPassword => $PageName{AdminSpecialPage} => $crypted);
    
    &_do_view_msg (-view => '-wrote', -page => $form{mypage});
}

sub valid_password ($) {
    my ($validpassword_crypt) = $database->meta (AdminPassword => $PageName{AdminSpecialPage});
    return crypt (shift, $validpassword_crypt) eq $validpassword_crypt ? 1 : 0;
}

sub do_write {
    if (&frozen_reject()) {
        return;
    }

    if (not &is_editable($form{mypage})) {
        &_do_view_msg (-view => '-error', -page => $form{mypage},
                       error_message => &Resource ('Error:ThisPageIsUneditable'));
        return;
    }

    ## Check confliction
    if ($form{myLastModified} ne $database->mtime ($form{mypage})) {
      &_do_view_msg (-view => '-conflict', -page => $form{mypage});
      return;
    }

    if ($form{mymsg}) {
        if ($form{mytouch} || !ref $database) {
          $database{$form{mypage}} = $form{mymsg};
        } else {
          $database->STORE ($form{mypage} => $form{mymsg}, -touch => 0);
        }
        $database->meta (IsFrozen => $form{mypage} => 0 + $form{myfrozen});
	my $fragment = '';
	$fragment .= qq(;after_edit_cmd=@@{[&encode($form{after_edit_cmd})]}) if $form{after_edit_cmd};
	if ($form{__comment_anchor_index}) {
	    $fragment .= qq(#anchor-$form{__comment_anchor_index});
	} elsif ($form{__wikiform_anchor_index}) {
	    $fragment .= qq(#wikiform-$form{__wikiform_anchor_index});
	}
	&_do_view_msg (-view => '-wrote', -page => $form{mypage}, -goto => $url_cgi.'?mycmd='.&encode($form{after_edit_cmd}||'default').';mypage='.&encode($form{mypage}).qq(;x-param=@@{[time.[0..9]->[rand 10]]}$fragment));
    } else {
        delete $database{$form{mypage}};
	&_do_view_msg (-view => '-deleted', -page => $form{mypage});
    }
}

sub _compatible_options () {
  (use_anchor_name => ($UA =~ m#Mozilla/[12]\.|Microsoft Internet Explorer# ? 1 : 0));
}

sub get_search_result ($;%) {
  my $word = lc shift;
  my $SearchResult = SuikaWiki::Plugin->cache ('search');
  my %option = @@_;
  my @@r;
  unless (defined $SearchResult->{$word}) {
    for my $page (keys %database) {
      next if !$option{-match_myself} && ($page eq $word);
      my $content = lc $database{$page};
      $content =~ s/^[^\x0A\x0D]+[\x0D\x0A]+//s;
      if (index (lc $page, $word) > -1) {
        my $c = $content =~ s/\Q$word\E//g;
        push @@r, [$page, $c+20];
      } elsif (index ($word, lc $page) > -1) {
        my $c = $content =~ s/\Q$word\E//g;
        push @@r, [$page, $c+10];
      } elsif (my $c = $content =~ s/\Q$word\E//g) {
        push @@r, [$page, $c];
      }
    }
    @@r = sort {$b->[1] <=> $a->[1] || $a->[0] cmp $b->[0]} @@r;
    $SearchResult->{$word} = join "\x1E", map {$_->[0]."\x1F".$_->[1]} @@r;
  } else {
    @@r = map {[split /\x1F/, $_, 2]} split /\x1E/, $SearchResult->{$word};
  }
  #my $em = sub { my $s = shift; $s =~ s#(\Q$word\E)#<em>$1</em>#gi; $s };
  my $r = join "\n", map {qq(<li>[$_->[1]] <a href ="$url_cgi?@@{[&encode($_->[0])]}" class="wiki">@@{[&escape($_->[0])]}</a> <span class="wikipage-summary">@@{[&escape(&get_subjectline($_->[0]))]}</span></li>)} @@r;
  $r = qq|<ul class="search-result">$r</ul>| if $r;
  wantarray? ($r, scalar @@r): $r;
}

sub do_random_jump {
  my @@list = keys %database;
  my $name = &encode ($list[rand @@list]);
  print "Location: $uri{wiki}?$name\n";
  print "\n";
}

sub print_header ($;%) {
    my ($page, %option) = @@_;
    my @@head;
    $option{o}->{-header}->{class} = &is_frozen($page) ? 'frozen' : '';
    $option{o}->{-header}->{class} .= " wiki-page-obsoleted" if $option{-magic} =~ /obsoleted="yes"/;
    if ($option{-goto}) {
      if ($UA =~ m#Opera|MSIE 2\.#) {
          ## WARNING: This code may output unsafe HTML document if
          ##          $option{-goto} is not clean.
	  $option{-goto} =~ tr/;/&/ if $UA =~ m#Opera#;
	  print qq{Refresh: 0; url=$option{-goto}\n};
	  push @@head, qq(<meta http-equiv="refresh" content="0; url=$option{-goto}">);
      } elsif ($UA =~ /Gecko/) {
	  print qq{Refresh: 0; url="$option{-goto}"\n};
	  push @@head, qq(<meta http-equiv="refresh" content="0; url=&quot;@@{[&escape($option{-goto})]}&quot;" />);
      } else {
	  $option{-goto} =~ tr/;/&/ if $UA =~ m#Mozilla/[1-4]\.#;
	  print qq{Refresh: 0; url="$option{-goto}"\n};
	  push @@head, qq(<meta http-equiv="refresh" content="0; url=&quot;@@{[&escape($option{-goto})]}&quot;">);
      }
    }
    print qq{Last-Modified: @@{[scalar gmtime $option{-last_modified}]}\n} if $option{-last_modified};
    if ($option{-expires} != -1) {
      if (defined $option{-expires}) {	## TODO: Don't use asctime
        print qq{Expires: @@{[scalar gmtime (time + $option{-expires})]}\n};
      } elsif ($option{-media}->{expires} != -1) {
        print qq{Expires: @@{[scalar gmtime (time + $option{-media}->{expires})]}\n};
      }
    }
    if ($option{-media}->{charset} && $UA =~ m#Mozilla/[12]\.#) {
	my $ct = qq{$option{-media}->{type}; charset=@@{[&get_charset_name($kanjicode,compatible=>1)]}};
	print qq{Content-Type: $ct\n};
	$option{o}->{-header}->{meta_ct} = qq{<meta http-equiv="content-type" content="$ct">\n};
    } elsif (!$option{-media}->{charset} || $UA =~ m#Infomosaic|Mozilla/0\.#) {
	print qq{Content-Type: $option{-media}->{type}\n};
	$option{o}->{-header}->{meta_ct} = qq{<meta http-equiv="content-type" content="$option{-media}->{type}; charset=@@{[&get_charset_name($kanjicode,compatible=>1)]}">\n};
    } else {
        my $type = $option{-media}->{type};
        $type = 'application/xml' if $type eq 'application/rss+xml';
	print qq{Content-Type: $type; charset=@@{[&get_charset_name($kanjicode)]}\n};
    }
    print <<"EOD";	## TODO: 
Content-Language: $lang
Content-Style-Type: text/css

EOD
  $option{o}->{-header}->{links} = join "\n", (@@head);
}

sub get_charset_name ($;%) {
    my ($charset, %option) = (lc shift, @@_);
    if ($charset =~ 'euc') {
	$charset = $option{compatible} ? 'x-euc-jp' : 'euc-jp';
    } elsif ($charset =~ 'sjis' || $charset =~ 'shift') {
	$charset = $option{compatible} ? 'x-sjis' : 'shift_jis';
    } elsif ($charset =~ 'jis') {
        $charset = 'iso-2022-jp';
    }
    $charset;
}

sub escape {
    my $s = shift;
    $s =~ s|\x0D\x0A|\x0A|g;
    $s =~ s|&|&amp;|g;
    $s =~ s|<|&lt;|g;
    $s =~ s|>|&gt;|g;
    $s =~ s|"|&quot;|g;
    return $s;
}

sub unescape {
    my $s = shift;
    # $s =~ s|\n|\r\n|g;
    $s =~ s|&lt;|<|g;
    $s =~ s|&gt;|>|g;
    $s =~ s|&quot;|"|g;
    $s =~ s|&amp;|&|g;
    return $s;
}

sub convert_format ($$$;%) {
  my ($content, $d => $t, %option) = @@_;
  &load_formatter ('format');
  my $f = SuikaWiki::Plugin->format_converter ($d => $t);
  if (ref $f) {
    $option{content} = $content;
    $option{from} = $d;
    $option{to} = $t;
    &$f ({}, bless (\%option, 'SuikaWiki::Plugin'));
  } elsif ($t =~ /HTML|xml/) {
    length $content ? '<pre>'.&escape($content).'</pre>' : '';
  } else {
    $content;
  }
}

sub text_to_html {
    my ($txt, %option) = @@_;
    my $toc = $option{-toc} || (ref $option{toc} ? $option{toc} : []);
    my $tocnum = 0;
    
    ## Load constants
    my %const;
    if ($option{magic} =~ /import="([^"]+)"/) {
      for (split /\s*,\s*/, $1) {
        my $wp = $database{$_};
        if ($wp =~ m!^\#\?SuikaWikiConst/(?:0.9|1.0)!) {
          wiki::suikawikiconst::to_hash ($wp => \%const);
        }
      }
    }
    
    $txt =~ s{__&&([^&]+)&&__}{defined $const{$1}?$const{$1}:qq(__&&$1&&__)}ge;
    my (@@txt) = split(/\n/, $txt);
    my (@@saved, @@result);
    unshift(@@saved, "</p>");
    push(@@result, "<p>");
    foreach (@@txt) {
        chomp;
        if (/^\*\*\*\*\*([^\x0D\x0A]*)/) {
            push @@$toc, [5, "i$tocnum" => ($1 || $tocnum)];
            push(@@result, splice(@@saved), qq(<h6 @@{[&id_and_name("i$tocnum")]}>) . &inline($1, %option, const => \%const) . '</h6>');
            $tocnum++;
        } elsif (/^\*\*\*\*([^\x0D\x0A]*)/) {
            push @@$toc, [4, "i$tocnum" => ($1 || $tocnum)];
            push(@@result, splice(@@saved), qq(<h5 @@{[&id_and_name("i$tocnum")]}>) . &inline($1, %option, const => \%const) . '</h5>');
            $tocnum++;
        } elsif (/^\*\*\*([^\x0D\x0A]*)/) {
            push @@$toc, [3, "i$tocnum" => ($1 || $tocnum)];
            push(@@result, splice(@@saved), qq(<h4 @@{[&id_and_name("i$tocnum")]}>) . &inline($1, %option, const => \%const) . '</h4>');
            $tocnum++;
        } elsif (/^\*\*([^\x0D\x0A]*)/) {
        # if (/^\*\*(.*)/) {
        # Walrus mod (6) end
            push @@$toc, [2, "i$tocnum" => ($1 || $tocnum)];
            push(@@result, splice(@@saved), qq(<h3 @@{[&id_and_name("i$tocnum")]}>) . &inline($1, %option, const => \%const) . '</h3>');
            $tocnum++;
        } elsif (/^\*([^\x0D\x0A]*)/) {
            push @@$toc, [1, "i$tocnum" => ($1 || $tocnum)];
            push(@@result, splice(@@saved), qq(<h2 @@{[&id_and_name("i$tocnum")]}>) . &inline($1, %option, const => \%const) . '</h2>');
            $tocnum++;
        } elsif (/^(={1,6})(.*)/) {
            &back_push('ol', length($1), \@@saved, \@@result);
            push(@@result, '<li>' . &inline($2, %option, const => \%const) . '</li>');
        } elsif (/^(-{1,6})(.*)/) {
          &back_push('ul', length($1), \@@saved, \@@result);
          my ($pf, $l) = ('', $2);
          if (!$main::_EMBEDED && $l =~ s/^\s*\[([0-9]+)\]//) {
            my $num = 0+$1;
            $pf = qq(<a name="anchor-$num" id="anchor-$num" class="anchor">[$num]</a>);
          }
          push(@@result, '<li>' . $pf . &inline ($l, %option, const => \%const) . '</li>');
        } elsif (/^:([^:]+):(.*)/) {
            &back_push('dl', 1, \@@saved, \@@result);
            push(@@result, '<dt>' . &inline($1, %option, const => \%const) . '</dt>', '<dd>' . &inline($2, %option, const => \%const) . '</dd>');
        } elsif (/^(?!>>\d)(>{1,5})(.*)/) {
            &back_push('blockquote', length($1), \@@saved, \@@result);
            push @@result, "<p>";
            push(@@result, &inline($2, %option, const => \%const));
            unshift @@saved, "</p>";
        } elsif (/^\s*$/) {
            push(@@result, splice(@@saved));
            push(@@result, "<p>");
            unshift(@@saved, "</p>");
        } elsif (/^(\s+.*)$/) {
            &back_push('pre', 1, \@@saved, \@@result);
            push(@@result, &inline($1, %option, const => \%const));
        } elsif (/^\,(.*?)[\x0D\x0A]*$/) {
            &back_push('table', 1, \@@saved, \@@result);
            #######
            # This part is taken from Mr. Ohzaki's Perl Memo and Makio Tsukamoto's WalWiki.
            # XXXXX
            my $tmp = "$1,";
            my @@value = map {/^"(.*)"$/ ? scalar($_ = $1, s/""/"/g, $_) : $_} ($tmp =~ /("[^"]*(?:""[^"]*)*"|[^,]*),/g);
            my @@align = map {(s/^\s+//) ? ((s/\s+$//) ? ' align="center"' : ' align="right"') : ''} @@value;
            my @@colspan = map {($_ eq '==') ? 0 : 1} @@value;
            for (my $i = 0; $i < @@value; $i++) {
                if ($colspan[$i]) {
                    while ($i + $colspan[$i] < @@value and $value[$i + $colspan[$i]] eq '==') {
                        $colspan[$i]++;
                    }
                    $colspan[$i] = ($colspan[$i] > 1) ? sprintf(' colspan="%d"', $colspan[$i]) : '';
                    $value[$i] = sprintf('<td%s%s>%s</td>', $align[$i], $colspan[$i], &inline($value[$i], %option, const => \%const));
                } else {
                    $value[$i] = '';
                }
            }
            push(@@result, join('', '<tr>', @@value, '</tr>'));
            # XXXXX
            #######
        } elsif (/^\[(INS|DEL|PRE)\[\s*$/) {
            push @@result, splice (@@saved), '<'.lc($1).'>';
            unshift @@saved, "</p>";
            push @@result, "<p>";
        } elsif (/^\](INS|DEL|PRE)\]\s*$/) {
            push @@result, splice (@@saved), '</'.lc($1).'>';
        } elsif (/^\[([0-9]+)\](.*)$/ && !$main::_EMBEDED) {
          my $num = 0+$1;
          push @@result, qq(<a name="anchor-$num" id="anchor-$num" class="anchor">[$num]</a>);
          push @@result, &inline ($2, %option, const => \%const);
        } else {
            push(@@result, &inline($_, %option, const => \%const));
        }
    }
    push(@@result, splice(@@saved));
    
    my $r = join("\n", @@result);
    $r =~ s#<p>\x0D?\x0A</p>##g;
    $r =~ s#[\x0D\x0A]+</#</#g;
    $r =~ s#<pre>\x0D?\x0A#<pre>#g;
    $r;
}

sub back_push {
    my ($tag, $level, $savedref, $resultref, $attr) = @@_;
    while (@@$savedref > $level) {
        push(@@$resultref, shift(@@$savedref));
    }
    if ($savedref->[0] ne "</$tag>") {
        push(@@$resultref, splice(@@$savedref));
    }
    while (@@$savedref < $level) {
        unshift(@@$savedref, "</$tag>");
        push(@@$resultref, "<$tag$attr>");
    }
}

sub inline ($;%) {
    my ($line, %option) = @@_;
    $line = &escape($line);
    $line =~ s{$embed_command{form}}{&make_custom_form ($1, $2, $3, $4, \%option)}ge;
    $line =~ s{\[(INS|DEL|SUP|SUB|VAR|CODE|KBD|SAMP|DFN)(?:\(([A-Za-z0-9\x20-]+)\))?\[(.+?)\]\]}{<@@{[lc $1]}@@{[$2 ? qq( class="$2") : '']}>$3</@@{[lc $1]}>}g;
    $line =~ s:\[(WEAK)\[(.+?)\]\]:<span class="@@{[lc $1]}">$2</span>:g;
    $line =~ s:\[ABBR\[([^]]+)\] \[([^]]+)\]\]:<acronym title="$2">$1</acronym>:g;
    $line =~ s:\[RUBYB\[([^]]+)\] \[([^]]+)\] \[([^]]+)\]\]:<span class="ruby"><ruby class="rb"><rb>$1</rb><rp>(</rp><rt>$2</rt><rp>)</rp></ruby><span class="rp"> (</span><span class="rt-below">$3</span><span class="rp">) </span></span>:g;
    $line =~ s:\[RUBY\[([^]]+)\] \[([^]]+)\]\]:<ruby><rb>$1</rb><rp>(</rp><rt>$2</rt><rp>)</rp></ruby>:g;
    $line =~ s:\[RUBYB\[([^]]+)\] \[([^]]+)\]\]:<span class="ruby"><span class="rb">$1</span><span class="rp"> (</span><span class="rt-below">$2</span><span class="rp">) </span></span>:g;
    $line =~ s|'''([^']+)'''|<strong>$1</strong>|g;
    $line =~ s|''([^']+)''|<em>$1</em>|g;
    $line =~ s{
      (\[\[(\#\S+?)\]\])
      |\[\[([^[]+?)](?:&gt;&gt;([0-9]+))?]
      |&gt;&gt;([0-9]+)
      |&lt;([A-Za-z0-9%]+:(?:(?!&gt;).)+)&gt;
    }{
      my ($l, $page,$anchor, $anum, $uri) = ($1, $3,$4, 0+$5, $6);
      if ($l) {
        &embedded_to_html($1);
      } elsif (defined $page) {
        &make_wikilink ($page, anchor => 0+$anchor);
      } elsif ($anum) {
        qq(<a href="#anchor-$anum" class="wiki-anchor">&gt;&gt;$anum</a>);
      } elsif ($uri) {
        &make_urilink ($uri);
      }
    }gex;
    return $line;
}

sub make_wikilink ($%) {
  my ($ename, %option) = @@_;
  my $name = &unescape ($ename);
  $option{latest} = $option{latest} ? qq(mycmd=default;x-param=@@{[time.[0..9]->[rand 10]]};mypage=) : '';
  if ($database{$name}) {
    my $subject = &escape (&get_subjectline ($name, delimiter => ''));
    if ($option{anchor}) {
      return qq(<a title="$subject" href="$uri{wiki}?$option{latest}@@{[&encode($name)]}#anchor-$option{anchor}" class="wiki">$ename&gt;&gt;$option{anchor}</a>);
    } else {
      return qq(<a title="$subject" href="$uri{wiki}?$option{latest}@@{[&encode($name)]}" class="wiki">$ename</a>);
    }
  } else {
    return qq(<a title="@@{[&Resource('JumpAndEditWikiPage',escape=>1)]}" href="$uri{wiki}?$option{latest}@@{[&escape($name)]}" class="wiki not-exist">$ename<span class="mark">@@{[&Resource('JumpAndEditWikiPageMark',escape=>1)]}</span></a>);
  }
}

sub make_urilink ($;%) {
  require URI;
  my $uri = shift;
  if ($uri =~ s/^IW://) {	## InterWiki (not URI)
    $uri = &unescape ($uri);
    if ($uri =~ /^([^\x00-\x2F\x3A-\x40\x5B-\x60\x7B-\x7F]+|"(?:\\.|[^"\\])+"):([^\x00-\x2F\x3A-\x40\x5B-\x60\x7B-\x7F]+|"(?:\\.|[^"\\])+")$/) {
      my ($site, $name) = ($1, $2);
      for ($site, $name) {
        if (s/^"//) { s/"$//; s/\\(.)/$1/g }
      }
      &init_InterWikiName () unless $interwiki{'[[]]'};
      if ($interwiki{$site}) {
        &load_formatter ('interwiki');
        my $uri = &escape ($fmt{interwiki}->replace ($interwiki{$site} => {site => $site, name => $name}));
        $site = &escape ($site); $name = &escape ($name);
        qq(&lt;<a href="$uri" class="out-of-wiki interwiki" title="$name ($site); URI: &lt;$uri&gt;"><span class="interwiki-site">$site:</span><span class="interwiki-name">$name</span></a>&gt;);
      } else {
        qq(&lt;@@{[&Resource('Error:UnknownInterWikiName=',escape=>1)]}@@{[&escape ($site)]}&gt;);
      }
    } else {
      qq(&lt;@@{[&Resource('Error:InvalidInterWiki=',escape=>1)]}@@{[&escape($uri)]}&gt;);
    }
  } elsif ($uri =~ /^urn:/) {	## URN
    my $uri2 = &escape (URI->new ('/uri-res/N2L?'.&unescape ($uri), 'http')->canonical);
    qq(&lt;<a href="$uri2" title="URI: &lt;$uri&gt; (via &lt;$uri2&gt;)" class="out-of-wiki urn">$uri</a>&gt;);
  } elsif ($uri =~ s/^MAIL://) {	## mail address (not URI)
    my $uri2 = &escape (URI->new ('mailto:'.&unescape ($uri))->canonical);
    qq(&lt;<a href="$uri2" class="out-of-wiki mail">$uri</a>&gt;);
  } elsif ($uri =~ s/^IMG(?:\([^)]+\))?://) {	## image (not URI itself)
    my $uri2 = &escape (URI->new (&unescape ($uri))->canonical);
    qq(<img src="$uri2" alt="" title="URI: &lt;$uri2&gt;" class="out-of-wiki">);
  } else {	## misc. URI
    CGI::Carp::warningsToBrowser (0);
    my $uri2 = &escape (URI->new (&unescape ($uri))->canonical);
    CGI::Carp::warningsToBrowser (1);
    qq(&lt;<a href="$uri2" title="URI: &lt;$uri2&gt;" class="out-of-wiki">$uri</a>&gt;);
  }
}

{my %FormIndex;
sub make_custom_form ($$$$%) {
    my ($wfname, $definition, $template, $foption, $option) = @@_;
    ## $template is currently not used in this procedure.
    #unless ($main::_EMBEDED) {
	$FormIndex{$option->{page}}++;
	if (length $definition) {
	    my $param = bless {depth=>10}, 'SuikaWiki::Plugin';
	    my $lastmodified = $database->mtime ($option->{page});
	    &load_formatter (qw/form_input form_option/);
	    $definition = &unescape ($definition);
	    $definition =~ s/\\(.)/$1/g;
	    $foption = &unescape ($foption);
	    $foption =~ s/\\(.)/$1/g;
	    $fmt{form_option}->replace ($foption, $param);
	    $param->{output}->{form} = 1 unless defined $param->{output}->{form};
	    $param->{output}->{form} = 0 if $main::_EMBEDED;
	    $definition .= ' %submit;' if $definition !~ /%submit/ && !$param->{output}->{nosubmit} && $param->{output}->{form};
	    $param->{output}->{page} ||= $option->{page};
	    $param->{form_disabled} = 1 if $database->meta (IsFrozen => $option->{page});
	    my $target_form = $param->{output}->{id};
	    my $r = '';
	    $r = <<EOH if $param->{output}->{form};
<form method="post" action="$url_cgi" id="wikiform-$FormIndex{$option->{page}}" class="wikiform">
  <input type="hidden" name="mycmd" value="@@{[$param->{form_disabled}?'default':'wikiform']}" />
  <input type="hidden" name="mypage" value="@@{[&escape($param->{output}->{page})]}" />
  <input type="hidden" name="myLastModified" value="$lastmodified" />
  <input type="hidden" name="mytouch" value="on" />
  <input type="hidden" name="@@{[$target_form? qq(wikiform_targetform" value="@@{[&escape($target_form)]}) : qq(wikiform_index" value="$FormIndex{$option->{page}})]}" />
EOH
            $r .= qq(<a name="wikiform-$FormIndex{$option->{page}}"></a>) if $UA =~ m#Mozilla/[12]\.#;
	    $r .= $fmt{form_input}->replace ($definition, $param);
	    $r .= "</form>\n" if $param->{output}->{form};
            $r;
       } else {  ## No input-interface WikiForm
         qq(<a id="wikiform-$FormIndex{$option->{page}}" name="wikiform-$FormIndex{$option->{page}}"><!-- #form --></a>);
       }
    #} else {
    #    qq(<ins class="wiki-error">@@{[&Resource('Error:WikiForm:EmbedIsNotSupported',escape=>1)]}</ins>);
    #}
}}

sub init_form {
    ## TODO: Support multipart/form-data
    my $query = '';
    if (uc $main::ENV{REQUEST_METHOD} eq 'POST') {
      read STDIN, $query, $main::ENV{CONTENT_LENGTH};
    }
    $query .= ($query ? ';' : '') . $main::ENV{QUERY_STRING};
    if ($main::ENV{REQUEST_METHOD} ne 'POST' && $main::ENV{QUERY_STRING} && $main::ENV{QUERY_STRING} !~ /[&;=]/) {
      my $query = &decode($main::ENV{QUERY_STRING});
      $query = &code_convert(\$query, $kanjicode);
        $form{mypage} = $query;
        $form{mycmd} = 'default';
    } else {
      for (split /[;&]/, $query) {
        if (my ($n, $v) = split /=/, $_, 2) {
          for ($n, $v) {tr/+/ /; s/%([0-9A-Fa-f][0-9A-Fa-f])/pack 'C', hex $1/ge};
          $form{$n} = $v;
        }
      }
      unless (defined $form{mypage}) {
        $form{mypage} = $form{epage};
        $form{mypage} =~ s/([0-9A-F]{2})/ord hex $1/g;
      }
    }
    $form{mypage} ||= $PageName{FrontPage};
    $form{mypage} =~ tr/\x00-\x1F\x7F//d;
    $form{mycmd} ||= 'default';

    # mypreview_edit        -> do_edit, with preview.
    # mypreview_adminedit   -> do_adminedit, with preview.
    # mypreview_write       -> do_write, without preview.
    foreach (keys %form) {
        if (/^mypreview_(.*)$/) {
            $form{mycmd} = $1;
            $form{mypreview} = 1;
        }
    }

    # 
    # $form{mycmd} is frozen here.
    # 

    for (grep /^wikiform__/, keys %form) {
	$form{$_} = &code_convert (\$form{$_}, $kanjicode);
    }
    $form{mymsg} = &code_convert(\$form{mymsg}, $kanjicode);
    $form{myname} = &code_convert(\$form{myname}, $kanjicode);
}

sub get_subjectline {
    my ($page, %option) = @@_;
    my $SubjectLine = SuikaWiki::Plugin->cache ('headline');
    unless (defined $SubjectLine->{$page}) {
      if (not &is_editable($page)) {
        $SubjectLine->{$page} = "";
      } else {
        $SubjectLine->{$page} = do {
          my $s=$database{$page};
          $s =~ s!^\#\?[^\x0A\x0D]+[\x0A\x0D]*!!s;
          $s =~ s/\x0D?\x0A.*//s;
        $s};
      }
    }
    if (length $SubjectLine->{$page}) {
      $option{delimiter} = defined $option{delimiter} ? $option{delimiter} : &Resource('Title-Summary Delimiter');
      $option{delimiter}.$SubjectLine->{$page}.$option{tail};
    } else {
      '';
    }
}

sub open_db {
    if ($modifier_dbtype eq 'dbmopen') {
        dbmopen(%database, $PathTo{WikiDataBase}, 0666) or die "(dbmopen) $PathTo{WikiDataBase}";
    } elsif ($modifier_dbtype eq 'AnyDBM_File') {
        eval q{use AnyDBM_File};
        tie(%database, "AnyDBM_File", $PathTo{WikiDataBase}, O_RDWR|O_CREAT, 0666) or die ("(tie AnyDBM_File) $PathTo{WikiDataBase}");
    } elsif ($modifier_dbtype eq 'Yuki::YukiWikiDB') {
        eval q{use Yuki::YukiWikiDB};
        tie(%database, "Yuki::YukiWikiDB", $PathTo{WikiDataBase}) or die ("(tie Yuki::YukiWikiDB) $PathTo{WikiDataBase}");
    } else {	## Yuki::YukiWikiDB || Yuki::YukiWikiDBMeta
        eval qq{use $modifier_dbtype};
        $database = tie(%database, $modifier_dbtype => $PathTo{WikiDataBase}, -lock => 2, -backup => $wiki::diff::UseDiff) or die ("(tie $modifier_dbtype) $PathTo{WikiDataBase}");
    }
}

sub close_db {
    if ($modifier_dbtype eq 'dbmopen') {
        dbmclose(%database);
    } else {
        untie(%database);
    }
}

sub editform (@@) {
  my %option = @@_;
  my $frozen = &is_frozen ($option{page});
  $option{content} = $database{$option{page}} unless defined $option{content};
  $option{content} = $database{NewPageTemplate} unless length $option{content};
  $option{last_modified} = $database->mtime ($option{page}) unless defined $option{last_modified};
  my $f = '';
  my $magic = '';
  $magic = $1 if $option{content} =~ m/^([^\x0A\x0D]+)/s;
  
  my $selected = 'default';
  if ($form{after_edit_cmd}) {
    $selected = $form{after_edit_cmd};
  } elsif ($magic =~ /Const|Config|CSS/) {
    $selected = 'edit';
  }
  my $afteredit = <<EOH;
<select name="after_edit_cmd">
<option value="default" label="@@{[&Resource('Edit:SaveAndDefault',escape=>1)]}"@@{[$selected eq 'default' ? ' selected="selected"':'']}>@@{[&Resource('Edit:SaveAndDefault',escape=>1)]}</option>
<option value="read" label="@@{[&Resource('Edit:SaveAndView',escape=>1)]}"@@{[$selected eq 'read' ? ' selected="selected"':'']}>@@{[&Resource('Edit:SaveAndView',escape=>1)]}</option>
<option value="edit" label="@@{[&Resource('Edit:SaveAndEdit',escape=>1)]}"@@{[$selected eq 'edit' ? ' selected="selected"':'']}>@@{[&Resource('Edit:SaveAndEdit',escape=>1)]}</option>
</select>
EOH
  $f .= <<"EOD";
<form action="$uri{wiki}" method="post">
    @@{[ $option{conflict} ? '' : qq(<label><input type="submit" name="mypreview_write" value="@@{[&Resource('Edit:Save',escape=>1)]}" /><kbd>S</kbd></label>) ]}
    @@{[ $option{admin} ? qq(<label>@@{[&Resource('Edit:Password=',escape=>1)]}<input type="password" name="mypassword" value="" size="10" /></label>) : "" ]} [@@{[&get_new_anchor_index($option{content})]}]<br />
    <input type="hidden" name="myLastModified" value="$option{last_modified}" />
    <input type="hidden" name="mypage" value="@@{[&escape($form{mypage})]}" />
    <textarea cols="@@{[&Resource('Edit:Form:Cols')+0||80]}" rows="@@{[&Resource('Edit:Form:Rows')+0||20]}" name="mymsg" tabindex="1">@@{[&escape($option{content})]}</textarea><br />
@@{[
    $option{admin} ?
    qq(
    <label><input type="radio" name="myfrozen" value="1" @@{[$frozen ? qq(checked="checked") : ""]} />@@{[&Resource('Edit:Freeze',escape=>1)]}</label>
    <label><input type="radio" name="myfrozen" value="0" @@{[$frozen ? "" : qq(checked="checked")]} />@@{[&Resource('Edit:DontFreeze',escape=>1)]}</label><br />)
    : ""
]}
@@{[
    $option{conflict} ? "" :
    qq(
        <label><input type="checkbox" name="mytouch" value="on" checked="checked" />@@{[&Resource('Edit:UpdateTimeStamp',escape=>1)]}</label><br />
        <label><input type="submit" name="mypreview_write" value="@@{[&Resource('Edit:Save',escape=>1)]}" accesskey="S" /><kbd>S</kbd></label>
       $afteredit
    )
]}
</form>
EOD
    $f;
}

sub is_editable {
    my ($page) = @@_;
    $page =~ /[\x00-\x20\x7F]/ ? 0 : 1;
}

sub decode {
    my ($s) = @@_;
    $s =~ tr/+/ /;
    $s =~ s/%([A-Fa-f0-9][A-Fa-f0-9])/pack("C", hex($1))/eg;
    return $s;
}

sub encode {
  my $s = shift;
  $s =~ s/([^0-9A-Za-z_-])/sprintf '%%%02X', ord $1/ge;
  $s;
}

sub get_now {
    my ($sec, $min, $hour, $day, $mon, $year) = localtime(time);
    $year += 1900;
    $mon++;
    $mon = "0$mon" if $mon < 10;
    $day = "0$day" if $day < 10;
    $hour = "0$hour" if $hour < 10;
    $min = "0$min" if $min < 10;
    #$sec = "0$sec" if $sec < 10;
    return "$year-$mon-$day $hour:$min";
}

sub init_InterWikiName {
  my @@content = split /\n/, $database{InterWikiName};
  for (@@content) {
    if (/^([^#]\S*)\s+(\S[^\x0A\x0D]+)/) {
      $interwiki{$1} = $2;
    }
  }
  $interwiki{'[[]]'} = 1;	## dummy
}

sub frozen_reject {
    my ($isfrozen) = $database->meta (IsFrozen => $form{mypage});
    my ($willbefrozen) = $form{myfrozen};
    if (not $isfrozen and not $willbefrozen) {
        # You need no check.
        return 0;
    } elsif (valid_password($form{mypassword})) {
        # You are admin.
        return 0;
    } else {
        &_do_view_msg (-view => '-error', -page => $form{mypage},
                       error_message => &Resource ('Error:PasswordIsIncorrect'));
        exit;
    }
}

sub is_frozen ($) { $database->meta (IsFrozen => $_[0]) ? 1 : 0 }

sub do_comment {
    my ($content) = $database{$form{mypage}};
    my $default_name;	## this code is not strict.
    $default_name = $1 if $content =~ /default-name="([^"]+)"/;
    my $datestr = '[WEAK['.&get_now.']]';
    my $namestr = $form{myname} || $default_name || &Resource('WikiForm:WikiComment:DefaultName');
    ($namestr = '', $datestr = '') if $form{myname} eq 'nodate';
    if ($namestr =~ /^(?:>>)?[0-9]/) {
      $namestr = qq( ''$namestr'': );
    } elsif (length $namestr) {
      $namestr = qq( ''[[$namestr]]'': );
    }
    my $anchor = &get_new_anchor_index ($content);
    my $i = 1;  my $o = 0;
    $content =~ s{(\[\[\#r?comment\]\])}{
      my $embed = $1;
      if ($i == $form{comment_index}) {
        if ($embed ne '[[#rcomment]]') {
          $embed = "- [$anchor] $datestr$namestr$form{mymsg}\n$embed";  $o = 1;
        } else {
          $embed .= "\n- [$anchor] $datestr$namestr$form{mymsg}";  $o = 1;
        }
      }
      $i++; $embed;
    }ge;
    unless ($o) {
      $content = "#?SuikaWiki/0.9\n\n" unless $content;
      $content .= "\n" unless $content =~ /\n$/s;
      $content .= "- [$anchor] $datestr$namestr$form{mymsg}\n";
    }
    $form{__comment_anchor_index} = $anchor;
    if ($form{mymsg} || $form{myname}) {
        $form{mymsg} = $content;
        $form{mytouch} = 'on';
        &do_write;
    } else {	## Don't write
        $form{mycmd} = 'default';
        &do_view;
    }
}

sub get_new_anchor_index ($) {
    my $content = shift;
    my $anchor = 0;
    $content =~ s/^(?:[-=]+\s*)?\[([0-9]+)\]/$anchor = $1 if $1 > $anchor; $&/mge;
    $anchor + 1;
}

my $CommentIndex = 0;
sub embedded_to_html {
    my ($embedded) = @@_;
    if ($embedded eq '[[#comment]]' or $embedded eq '[[#rcomment]]') {
      unless ($main::_EMBEDED) {
        my $lastmodified = $database->mtime ($form{mypage});
        return <<"EOD";
<form action="$url_cgi" method="post" id="x-comment-@@{[++$CommentIndex]}" class="comment"><p>
    <input type="hidden" name="mycmd" value="comment" />
    <input type="hidden" name="mypage" value="$form{mypage}" />
    <input type="hidden" name="myLastModified" value="$lastmodified" />
    <input type="hidden" name="mytouch" value="on" />
    <input type="hidden" name="comment_index" value="$CommentIndex" />
    @@{[&Resource('WikiForm:WikiComment:Name=',escape=>1)]}
    <input type="text" name="myname" value="" size="10" class="comment-name" />
    <input type="text" name="mymsg" value="" size="60" class="comment-msg" />
    <input type="submit" value="@@{[&Resource('WikiForm:Add',escape=>1)]}" title="@@{[&Resource('WikiForm:AddLong',escape=>1)]}" class="comment-submit" />
</p></form>
EOD
     } else {
        return <<"EOD";
<del><form action="$url_cgi" method="get">
    <input type="hidden" name="mycmd" value="default" />
    <input type="hidden" name="mypage" value="$form{mypage}" />
    @@{[&Resource('WikiForm:WikiComment:Name=',escape=>1)]}
    <input type="text" name="myname" value="" size="10" disabled="disabled" />
    <input type="text" name="mymsg" value="" size="60" disabled="disabled" />
</form></del>
EOD
    }
  } elsif ($embedded =~ /$embed_command{searched}/) {
    return get_search_result ($1, -match_myself => 1);
  } elsif ($embedded =~ /^\[\[\#embed:(.+)\]\]$/) {
    my ($name, $r) = ($1, '');
    if ($main::_EMBEDED != 1) {
      my ($cf, $content) = SuikaWiki::Plugin->magic_and_conten ($database{$name});
      $cf ||= '#?SuikaWiki/0.9';
      if ($cf =~ m!^#\?SuikaWiki/0.9(?:$|\s)!) {
        $main::_EMBEDED = 1;
        $r = &text_to_html ($content, magic => $cf, page => $name);
        $main::_EMBEDED = 0;
      } elsif (length $content) {
        $r = "<pre>@@{[&escape ($content)]}</pre>";
      } else {
        $r = &text_to_html ("[INS[\n[[$name]]: @@{[&Resource('Embed:PageNotFound')]}\n]INS]\n", magic => '#?SuikaWiki/0.9');
      }
    } else {	## nested #EMBED
      $r = &text_to_html ("[INS[\n[[$name]]: @@{[&Resource('Embed:Nested',escape=>1)]}\n]INS]\n", magic => '#?SuikaWiki/0.9');
    }
    return qq(<blockquote title="@@{[&escape($name)]}" class="wiki-embed">$r<div class="cite-note">¡Ø<cite><a href="$url_cgi?@@{[&encode($name)]}" class="wiki">@@{[&escape($name)]}</a></cite>¡Ù</div></blockquote>);
  } elsif ($embedded =~ /^\[\[\#randomlink:(.+)\]\]$/) {
    return qq(<a href="$url_cgi?mycmd=RandomJump;x-param=@@{[time.[0..9]->[rand 10]]}" class="wiki randomlink">$1</a>);
  } else {
    return $embedded;
  }
}

sub load_formatter (@@) {
    for my $t (@@_) {
	unless ($fmt{$t}) {
	    require Message::Util::Formatter;
	    $fmt{$t} = Message::Util::Formatter->new;
	    for (@@{$SuikaWiki::Plugin::List{'wiki'.$t}||[]}) {
		$_->load_formatter ($fmt{$t}, type => 'wiki'.$t);
	    }
	}
    }
}

sub do_wikiform {
    my $content = $database{$form{mypage}};
    my $anchor = &get_new_anchor_index ($content);
    &load_formatter (qw/form_template form_option/);
    my $write = 0;
    my $i = 1;
    $content =~ s{$embed_command{form}}{
	my ($embed, $wfname, $template, $option) = ($&, $1, $3, $4);
	if (($wfname && $wfname eq $form{wikiform_targetform})
	    || $i == $form{wikiform_index}) {
	    $template =~ s/\\(.)/$1/g;
	    $option =~ s/\\(.)/$1/g;
	    my $param = bless {depth=>10}, 'SuikaWiki::Plugin';
	    $param->{page} = $form{mypage};
	    $param->{form_index} = $i;
	    $param->{form_name} = $wfname;
	    $param->{anchor_index} = $anchor;
	    $param->{argv} = \%form;
	    $param->{default_name} = $1 if $content =~ /default-name="([^"]+)"/;
            $param->{default_name} ||= &Resource('WikiForm:WikiComment:DefaultName');
	    $fmt{form_option}->replace ($option, $param);
            my $t = 1;
            for (keys %{$param->{require}||{}}) {
                (undef $t, last) unless length $param->{argv}->{'wikiform__'.$_};
            }
	    $t = $fmt{form_template}->replace ($template, $param) if $t;
	    if (length $t) {
		if ($param->{output}->{reverse}) {
		    $embed .= "\n" . $t;
		} else {
		    $embed = $t . "\n" . $embed;
		}
		$write = 1;
                $form{__comment_anchor_index} = $anchor
                  if $param->{anchor_index_};  ## $anchor is used!
            }
            $form{__wikiform_anchor_index} = $i;
            undef $form{wikiform_targetform};  ## Make sure never to match
            undef $form{wikiform_index};       ## with WikiForm in rest of page!
	}
	$i++; $embed;
    }ge;
    unless ($write) {
      #$content = "#?SuikaWiki/0.9\n\n" unless $content;
      #$content .= "\n" unless $content =~ /\n$/s;
      #
    }
    if ($write) {
        $form{mymsg} = $content;
        $form{mytouch} = 'on';
        &do_write;
    } else {	## Don't write!
        $form{mycmd} = 'default';
        &do_view;
    }
}

sub code_convert {
  require Jcode;
    my ($contentref, $code) = (shift, shift || $kanjicode);
    if    ($code =~ /euc/) { $code = 'euc' }
    elsif ($code =~ /iso/) { $code = 'jis' }
    elsif ($code =~ /shi/) { $code = 'sjis' }
    elsif ($code =~ /utf/) { $code = 'utf8' }
    $$contentref = Jcode->new ($contentref)->tr ("\xA3\xB0-\xA3\xB9\xA3\xC1-\xA3\xDA\xA3\xE1-\xA3\xFA\xA1\xF5\xA1\xA4\xA1\xA5\xA1\xA7\xA1\xA8\xA1\xA9\xA1\xAA\xA1\xAE\xA1\xB0\xA1\xB2\xA1\xBF\xA1\xC3\xA1\xCA\xA1\xCB\xA1\xCE\xA1\xCF\xA1\xD0\xA1\xD1\xA1\xDC\xA1\xF0\xA1\xF3\xA1\xF4\xA1\xF6\xA1\xF7\xA1\xE1\xA2\xAF\xA2\xB0\xA2\xB2\xA2\xB1\xA1\xE4\xA1\xE3\xA1\xC0\xA1\xA1" => q(0-9A-Za-z&,.:;?!`^_/|()[]{}+$%#*@@='"~-><\ ))->$code;
    return $$contentref;
}

sub _rfc3339_date ($) {
  my @@time = gmtime (shift);
  sprintf '%04d-%02d-%02dT%02d:%02d:%02d+00:00', $time[5]+1900,$time[4]+1,@@time[3,2,1,0];
}

my %_Resource;
sub Resource ($;%) {
  my ($s, %o) = @@_;
  unless (defined $_Resource{$s}) {
    $_Resource{$_[0]} = &wiki::resource::get ($s, $_Resource{__option});
  }
  $o{escape} ? &escape ($_Resource{$s}) : $_Resource{$s};
}

package wiki::referer;
sub add ($$) {
  my $page = shift;
  my $uri = shift;
  unless (ref $uri) {
    require URI;
    $uri = URI->new ($uri);
    ## Some schemes do not have query part.
    eval q{ $uri->query (undef) if $uri->query =~ /^[0-9]{6,8}$/ };
    $uri->fragment (undef);
  }
  $uri = $uri->canonical;
  return unless $uri;
  for my $regex (&get_dont_record) {
    return if $uri =~ /$regex/;
  }
  my %list = get ($page);
  $list{ $uri }++;
  set ($page, \%list);
}
sub get ($) { split /"/, $main::database->meta (Referer => $_[0]) }
sub set ($%) {
  my $page = shift;
  my $list = shift;
  $main::database->meta (Referer => $page => join '"', %$list);
}

sub get_dont_record () {
  map {s/\$/\\\$/g; s/\@@/\\\@@/g; $_}
  grep !/^#/,
  split /[\x0D\x0A]+/, $main::database{RefererDontRecord};
}
sub get_site_name () {
  my @@lines = grep /[^#]/, split /[\x0D\x0A]+/, $main::database{RefererSiteName};
  my @@item;
  for (@@lines) {
    next if /^#/;
    my ($uri, $name) = split /\s+/, $_, 2;
    $uri =~ s/\$/\\\$/g;  $uri =~ s/\@@/\\\@@/g;  $uri =~ s/\//\\\//g;
    $name =~ s!([()/\\])!\\$1!g;  $name =~ s/\$([0-9]+)/).__decode (\${$1}).q(/g;
    push @@item, [$uri, qq(q($name))];
  }
  @@item;
}

sub list_html ($) {
  my $page = shift;
  my %list = get ($page);
  my $r = '';
  my @@name = get_site_name;
  for my $uri (sort keys %list) {
    my $title;
    for my $item (@@name) {
      if ($uri =~ /$item->[0]/) {
        $title = $uri;
        eval qq{\$title =~ s/^.*$item->[0].*\$/$item->[1]/e}
          or die $@@ ;#. qq{\$title =~ s/^.*$item->[0].*\$/$item->[1]/e};
        last;
      }
    }
    my $euri = main::escape ($uri);
    if ($title) {
      $r .= qq(<li>[$list{$uri}] <a href="$euri" title="URI: &lt;$euri&gt;">@@{[main::escape ($title)]}</a></li>\n);
    } else {
      $r .= qq(<li>[$list{$uri}] &lt;<a href="$euri">$euri</a>&gt;</li>\n);
    }
  }
  $r ? qq(<ul>$r</ul>\n) : '';
}

sub __decode ($) {
  my $s = shift;
  $s =~ tr/+/ /;
  $s =~ s/%([0-9A-Fa-f][0-9A-Fa-f])/chr hex $1/ge;
  main::code_convert (\$s);
}

package wiki::useragent;
our $UseLog;

sub add ($) {
  my $s = shift;
  return unless length $s;
  return unless $UseLog;
  $s =~ s/([\x00-\x08\x0A-\x1F\x25\x7F-\xFF])/sprintf '%%%02X', unpack 'C', $1/ge;
  my %ua;
  for (split /\n/, $main::database{$main::PageName{UserAgentList}}) {
    if (/^-\[(\d+)\] (.+)$/) {
      my ($t, $n) = ($1, $2);
      $n =~ tr/\x0A\x0D//d;
      $ua{$n} = $t;
    }
  }
  $ua{$s}++;
  my $s = qq(#?SuikaWiki/0.9\n);
  for (sort {$ua{$a} <=> $ua{$b}} keys %ua) {
    $s .= sprintf qq(-[%d] %s\n), $ua{$_}, $_;
  }
  $main::database->STORE ($main::PageName{UserAgentList} => $s, -touch => 0);
}

package wiki::suikawikiconst;

sub to_hash ($;$) {
  my $page = shift;
  my $h = shift || {};
  my $val;
  for my $line (split /\n/, $page) {
    next if $line =~ /^#/;
    $line =~ tr/\x0A\x0D//d;
    if ($val && $line =~ s/^\s+//) {
      $h->{$val} .= length $h->{$val} ? "\n" . $line : $line;
    } elsif ($line =~ /^(.+):/) {
      $val = $1; $h->{$val} = '';
    }
  }
  $h;
}

package wiki::dummy;
sub mtime (@@) {undef}
sub meta (@@) {undef}
sub Yuki::YukiWikiDB2::meta (@@) {undef}

package SuikaWiki::Plugin;
  our ($plugin_directory, %List, %Index, %Cache);
  push @@main::INC, $plugin_directory.'/../..';

sub escape ($$) { main::escape ($_[1]) }
sub unescape ($$) { main::unescape ($_[1]) }
sub encode ($$) { main::encode ($_[1]) }
sub decode ($$) { main::decode ($_[1]) }
sub __get_datetime ($) { main::get_now () }
sub resource ($$;%) { shift; &main::Resource (@@_) }
sub uri ($$) { $main::uri{$_[1]} }
sub new_index ($$) { ++$Index{$_[1]} }
sub user_agent_names ($) { $main::UA }
sub magic_and_content ($$) {
  my ($magic, $page) = ('', $_[1]);
  $magic = $1 if $page =~ s!^((?:\#\?|/\*|<\?)[^\x02\x0A\x0D]+)[\x02\x0A\x0D]+!!s;
  ($magic, $page);
}
sub formatter ($$) {
  &main::load_formatter ($_[1]);
  $main::fmt{$_[1]};
}
sub format_converter ($$$) {
  &main::load_formatter ('format');
  $main::fmt{format}->{($_[1]=~/([A-Za-z0-9]\S+)/?$1:'SuikaWiki/0.9').'_to_'.$_[2]}
  || $main::fmt{format}->{($_[1]=~/([A-Za-z0-9](?:(?!\/)\S)+)/?$1:'SuikaWiki').'_to_'.$_[2]};
}
sub cache ($$) {
  my $name = $_[1];
  unless (ref $Cache{$name}) {
    my %cache;
    tie (%cache, 'Yuki::YukiWikiCache', -file => $main::PathTo{CachePrefix}.$name);
    $Cache{$name} = \%cache;
  }
  $Cache{$name};
}

sub regist ($@@) {
    my $pack = shift;
    for (@@_) {
	push @@{$List{$_}}, $pack;
    }
}

sub import_plugins () {
    opendir PDIR, $plugin_directory;
    my @@plugin = grep {s/\.pm$//} readdir (PDIR);
    closedir PDIR;
    for (@@plugin) {
	eval qq{ use SuikaWiki::Plugin::$_ } unless /[^A-Za-z0-9_]/;
	push @@{$List{_all}}, qq(SuikaWiki::Plugin::$_);
    }
}

&import_plugins ();

package wiki::conneg;

## BUG: this parser isn't strict.
sub get_accept_lang (;$) {
  my $alang = shift || $main::ENV{HTTP_ACCEPT_LANGUAGE};
  my %alang = (ja => 0.0002, en => 0.0001);
  if ($UA =~ m#Mozilla/0\.#) {
    $alang{ja} = 0.00001;
  }
  my $i = 0.1;
  for (split /\s*,\s*/, $alang) {
    tr/\x09\x0A\x0D\x20//d;
    if (/((?:(?!;q=).)+)(?:;q="?([0-9.]+)"?)?/) {
      my $l = lc $1; $l =~ tr/\x22\x5C//d;
      $alang{$l} = (defined $2 ? $2 : 1.000)*1000;
      $alang{$l} += $i unless $alang{$l} == 0;
      $i -= 0.001;
    }
  }
  \%alang;
}

package wiki::resource;

sub get ($;\%) {
  my ($resname, $option) = @@_;
  $option->{accept_language} ||= &wiki::conneg::get_accept_lang ();
  $option->{resource} ||= {};
  my $v;
  for my $lang (sort {$option->{accept_language}->{$b} <=> $option->{accept_language}->{$a}} grep {$option->{accept_language}->{$_}!=0} keys %{$option->{accept_language}}) {
    while (length $lang) {
      unless ($option->{accept_language}->{defined $option->{accept_language}->{$lang} ? $lang : '*'} == 0) {
        $option->{resource}->{$lang} ||= &wiki::suikawikiconst::to_hash ($main::database{'WikiResource:'.$lang});
        $v = $option->{resource}->{$lang}->{$resname};
        last if defined $v;
      }
      $lang =~ s/[^+-]*$//; $lang =~ s/[+-]$//;
    }
    last if defined $v;
  }
  defined $v ? $v : $resname;
}

package main;
&main;
exit 0;

1;
__END__
a17 8
=head1 AUTHORS

Hiroshi Yuki <hyuki@@hyuki.com> <http://www.hyuki.com/yukiwiki/>

Makio Tsukamoto <http://digit.que.ne.jp/>

Wakaba <w@@suika.fam.cx>

d20 1
a20 1
Copyright (C) 2000-2003 AUTHORS
d26 2
@


1.50
log
@Most of do_* are integred
@
text
@d2 1
a2 4
# wiki.cgi - This is YukiWiki, yet another Wiki clone.
#
# This program is free software; you can redistribute it and/or
# modify it under the same terms as Perl itself.
a6 1
our $VERSION = do{my @@r=(q$Revision: 1.49 $=~/\d+/g);sprintf "%d."."%02d" x $#r,@@r};
d8 3
a10 1
require 'wikidata/suikawiki-config.ph';
a11 1
##############################
d17 1
a17 1
our ($modifier_dbtype,$url_cgi,%uri,%PathTo,$use_exists);
a19 1
##############################
a23 1
##############################
d25 1
a25 1
    read => \&do_view,
d33 1
a33 1
my $UA = '';  ## User agent name
a34 1
##############################
d43 1
a43 1
        &{$command_do{read}};
d58 9
a66 1
      $view = 'view'
d81 2
d85 1
a85 1
      &print_header ($form{mypage}, -last_modified => ($magic =~ /interactive="yes"/ ? $lm : time),
d92 4
d97 1
d187 1
a187 1
	&_do_view_msg (-view => '-wrote', -page => $form{mypage}, -goto => $url_cgi.'?mycmd='.&encode($form{after_edit_cmd}||'read').';mypage='.&encode($form{mypage}).qq(;x-param=@@{[time.[0..9]->[rand 10]]}$fragment));
d200 1
d203 14
a216 11
  foreach my $page (keys %database) {
    next if !$option{-match_myself} && ($page eq $word);
    my $content = lc $database{$page};
    if (index (lc $page, $word) > -1) {
      my $c = $content =~ s/\Q$word\E//g;
      push @@r, [$page, $c+20];
    } elsif (index ($word, lc $page) > -1) {
      my $c = $content =~ s/\Q$word\E//g;
      push @@r, [$page, $c+10];
    } elsif (my $c = $content =~ s/\Q$word\E//g) {
      push @@r, [$page, $c];
d218 4
d224 1
a224 1
  my $r = join "\n", map {qq(<li>[$_->[1]] <a href ="$url_cgi?@@{[&encode($_->[0])]}" class="wiki">@@{[&escape($_->[0])]}</a> <span class="wikipage-summary">@@{[&escape(&get_subjectline($_->[0]))]}</span></li>)} sort {$b->[1] <=> $a->[1] || $a->[0] cmp $b->[0]} @@r;
d265 1
a265 1
    if ($option{-media}->{charset} && $UA =~ m#Mozilla/2#) {
d269 1
a269 1
    } elsif (!$option{-media}->{charset} || $UA =~ m#Infomosaic#) {
d271 1
d340 1
a340 1
    if ($option{content_format} =~ /import="([^"]+)"/) {
d343 1
a343 1
        if ($wp =~ m!^\#\?SuikaWikiConst/1.0!) {
d358 1
a358 1
            push(@@result, splice(@@saved), qq(<h6 @@{[&id_and_name("i$tocnum")]}>) . &inline($1, const => \%const) . '</h6>');
d362 1
a362 1
            push(@@result, splice(@@saved), qq(<h5 @@{[&id_and_name("i$tocnum")]}>) . &inline($1, const => \%const) . '</h5>');
d366 1
a366 1
            push(@@result, splice(@@saved), qq(<h4 @@{[&id_and_name("i$tocnum")]}>) . &inline($1, const => \%const) . '</h4>');
d372 1
a372 1
            push(@@result, splice(@@saved), qq(<h3 @@{[&id_and_name("i$tocnum")]}>) . &inline($1, const => \%const) . '</h3>');
d376 1
a376 1
            push(@@result, splice(@@saved), qq(<h2 @@{[&id_and_name("i$tocnum")]}>) . &inline($1, const => \%const) . '</h2>');
d380 1
a380 1
            push(@@result, '<li>' . &inline($2, const => \%const) . '</li>');
d388 1
a388 1
          push(@@result, '<li>' . $pf . &inline ($l, const => \%const) . '</li>');
d391 1
a391 1
            push(@@result, '<dt>' . &inline($1, const => \%const) . '</dt>', '<dd>' . &inline($2, const => \%const) . '</dd>');
d395 1
a395 1
            push(@@result, &inline($2, const => \%const));
d403 1
a403 1
            push(@@result, &inline($1, const => \%const));
d419 1
a419 1
                    $value[$i] = sprintf('<td%s%s>%s</td>', $align[$i], $colspan[$i], &inline($value[$i], const => \%const));
d436 1
a436 1
          push @@result, &inline ($2, const => \%const);
d438 1
a438 1
            push(@@result, &inline($_, const => \%const));
d467 1
a467 1
    $line =~ s{$embed_command{form}}{&make_custom_form ($1, $2, $3, $4)}ge;
d499 1
a499 1
  $option{latest} = $option{latest} ? qq(mycmd=read;x-param=@@{[time.[0..9]->[rand 10]]};mypage=) : '';
d551 6
a556 6
{my $FormIndex = 0;
sub make_custom_form ($$$$) {
    my ($wfname, $definition, $template, $option) = @@_;
    ## $template and $option is currently not used in this procedure.
    unless ($main::_EMBEDED) {
	$FormIndex++;
d558 2
a559 2
	    my $param = bless {}, 'SuikaWiki::Plugin';
	    my $lastmodified = $database->mtime ($form{mypage});
d563 3
a565 3
	    $option = &unescape ($option);
	    $option =~ s/\\(.)/$1/g;
	    $fmt{form_option}->replace ($option, $param);
d567 1
d569 2
a570 2
	    $param->{output}->{page} ||= $form{mypage};
	    $param->{form_disabled} = 1 if $database->meta (IsFrozen => $form{mypage});
d574 2
a575 2
<form method="post" action="$url_cgi" id="wikiform-$FormIndex" class="wikiform">
  <input type="hidden" name="mycmd" value="@@{[$param->{form_disabled}?'read':'wikiform']}" />
d579 1
a579 1
  <input type="hidden" name="@@{[$target_form? qq(wikiform_targetform" value="@@{[&escape($target_form)]}) : qq(wikiform_index" value="$FormIndex)]}" />
d581 1
a581 1
            $r .= qq(<a name="wikiform-$FormIndex"></a>) if $UA =~ m#Mozilla/[12]\.#;
d586 1
a586 1
	   qq(<a id="wikiform-$FormIndex" name="wikiform-$FormIndex"><!-- #form --></a>);
d588 3
a590 3
    } else {
        qq(<ins class="wiki-error">@@{[&Resource('Error:WikiForm:EmbedIsNotSupported',escape=>1)]}</ins>);
    }
d604 1
a604 1
        $form{mycmd} = $database{$form{mypage}} ? 'read' : 'edit';
d619 1
a619 1
    $form{mycmd} ||= 'read';
a641 1
{my %SubjectLine;
d644 2
a645 1
    unless (defined $SubjectLine{$page}) {
d647 1
a647 1
        $SubjectLine{$page} = "";
d649 5
a653 3
        $SubjectLine{$page} = $database{$page};
        $SubjectLine{$page} =~ s!^\#\?[^\x0A\x0D]+[\x0A\x0D]*!!s;
        $SubjectLine{$page} =~ s/\x0D?\x0A.*//s;
d656 1
a656 1
    if (length $SubjectLine{$page}) {
d658 1
a658 1
      $option{delimiter}.$SubjectLine{$page}.$option{tail};
d662 1
a662 1
}}
d697 1
a697 1
  my $selected = 'read';
d705 1
d830 3
a832 3
    } else {
        $form{mycmd} = 'read';
        &do_read;
d865 1
a865 1
    <input type="hidden" name="mycmd" value="read" />
d878 3
a880 3
      my ($content, $cf) = ($database{$name}, 'SuikaWiki/0.9');
      $cf = $1 if $content =~ s!^(?:[\#<]\?|/\*\s*)?([A-Z][A-Za-z0-9-]+/[0-9.]+(?:[^0-9.][^\x0D\x0A]*)?)[\x0D\x0A]+!!s;
      if ($cf =~ m!^(?:\#\?)?SuikaWiki/0.9(?:$|\s)!) {
d882 1
a882 1
        $r = &text_to_html ($content, content_format => $cf);
d887 1
a887 1
        $r = &text_to_html ("[INS[\n[[$name]]: @@{[&Resource('Embed:PageNotFound')]}\n]INS]\n", content_format => 'SuikaWiki/0.9');
d890 1
a890 1
      $r = &text_to_html ("[INS[\n[[$name]]: @@{[&Resource('Embed:Nested',escape=>1)]}\n]INS]\n", content_format => 'SuikaWiki/0.9');
d924 1
a924 1
	    my $param = bless {}, 'SuikaWiki::Plugin';
d934 1
a934 1
            for (@@{$param->{require}||[]}) {
d949 2
a950 2
            undef $form{wikiform_targetform};  ## make sure never to match
            undef $form{wikiform_index};       ## with WikiForm in rest of page
d963 3
a965 3
    } else {
        $form{mycmd} = 'read';
        &do_read;
a984 3
sub is_exist_page { $use_exists ? exists ($database{$_[0]}) : $database{$_[0]} }
sub __get_database ($) { $database{ $_[0] } }

d1080 1
a1080 1
  for (split /\n/, &main::__get_database($main::PageName{UserAgentList})) {
d1102 1
d1119 1
a1119 3
  our $plugin_directory;
  our %List;
  our %Index;
d1145 9
d1180 3
d1225 1
a1225 1
wiki.cgi --- SuikaWiki: Yet yet another Wiki engine
@


1.49
log
@Fix to more customizable
@
text
@d10 2
a11 2
our $VERSION = do{my @@r=(q$Revision: 1.48 $=~/\d+/g);sprintf "%d."."%02d" x $#r,@@r};

d16 1
a16 1
my %embed_command = (
a28 3
my %page_command = (
    $PageName{RssPage} => 'rss',
);
d30 1
a30 3
    read => \&do_read,
    TEXT_CSS => \&do_output_css,
    edit => \&do_view,
a35 2
    rss => \&do_rss,
    diff => \&do_view,
a36 1
    map	=> \&do_view,
d54 1
a54 1
sub do_read {
d59 21
a79 3
  my @@toc;
    my ($magic, $content) = &SuikaWiki::Plugin::magic_and_content (undef, $content);
    $magic ||= '#?SuikaWiki/0.9';
d81 3
a83 8
      my $expires = time;
      if ($magic =~ /interactive="yes"/) {
        $lm = $expires;
      } else {
        $expires += 120;
      }
      &print_header ($form{mypage}, -last_modified => $lm, -expires => $expires,
        -content_format => $magic, -noindex => ($magic =~ /obsoleted="yes"/ ? 1 : 0));
d85 2
a86 1
      &print_header($form{mypage}, -expires => time + 120, -content_format => $magic, -last_modified => $lm);
d88 1
a88 2
    &load_formatter ('view');
    print $fmt{view}->replace ($ViewDefinition{read} => bless {param => \%form, page => $form{mypage}, toc => \@@toc, formatter => $fmt{view}, &_compatible_options ()}, 'SuikaWiki::Plugin');
d91 6
a96 12
sub do_output_css {
  wiki::referer::add ($form{mypage}, $ENV{HTTP_REFERER});
  wiki::useragent::add ($ENV{HTTP_USER_AGENT});
  my $content = $database{$form{mypage}};
  if ($content =~ m#^\s*/\*\s*W3C-CSS#) {
    my $lm = gmtime $database->mtime ($form{mypage});
    print "Content-Type: text/css; charset=@@{[&get_charset_name($kanjicode)]}\n";
    print "Last-Modified: $lm\n";
    print "Expires: @@{[scalar gmtime time+3600]}\n";	## TODO: don't use asctime
    print "\n";
    print $content;
  } else {
d98 1
a98 3
    &print_header('WikiPageIsNotCSS', -noindex => 1);
    &load_formatter ('view');
    print $fmt{view}->replace ($ViewDefinition{read} => bless {param => \%form, page => 'WikiPageIsNotCSS', toc => [], formatter => $fmt{view}, &_compatible_options ()}, 'SuikaWiki::Plugin');
d100 7
a117 14
sub do_view {
    wiki::referer::add ($form{mypage}, $ENV{HTTP_REFERER});
    wiki::useragent::add ($ENV{HTTP_USER_AGENT});
    &print_header($form{mypage}, -noindex => 1, -expires => time+60);
    &load_formatter ('view');
    my $view = $form{mycmd};
    if ($view eq 'edit') {
      $view = 'adminedit' if $form{admin};
    } elsif ($view =~ /[^0-9A-Za-z]/) {
      $view = 'view'
    }
    print $fmt{view}->replace ($ViewDefinition{$view} => bless {param => \%form, page => $form{mypage}, toc => [], formatter => $fmt{view}, &_compatible_options ()}, 'SuikaWiki::Plugin');
}

d120 3
a122 1
        &print_error(&Resource('Error:PasswordMismatch'));
d127 3
a129 1
            &print_error(&Resource('Error:PasswordIsIncorrect'));
d138 2
a139 3

    &print_header('CompletedSuccessfully', -noindex => 1);
    &print_message(&Resource('Error:PasswordIsChanged'));
d153 2
a154 2
        &print_header($form{mypage}, -noindex => 1);
        &print_message(&Resource('Error:ThisPageIsUneditable'));
d160 1
a160 3
      &print_header($form{mypage}, -noindex => 1);
      &load_formatter ('view');
      print $fmt{view}->replace ($ViewDefinition{-conflict} => bless {param => \%form, page => $form{mypage}, toc => [], formatter => $fmt{view}, &_compatible_options ()}, 'SuikaWiki::Plugin');
d178 1
a178 3
        &print_header($form{mypage}, -noindex => 1, -goto => $url_cgi.'?mycmd='.&encode($form{after_edit_cmd}||'read').';mypage='.&encode($form{mypage}).qq(;x-param=@@{[time.[0..9]->[rand 10]]}$fragment));
        &load_formatter ('view');
        print $fmt{view}->replace ($ViewDefinition{-wrote} => bless {param => \%form, page => $form{mypage}, formatter => $fmt{view}, &_compatible_options ()}, 'SuikaWiki::Plugin');
d181 1
a181 3
        &print_header($form{mypage}, -noindex => 1);
        &load_formatter ('view');
        print $fmt{view}->replace ($ViewDefinition{-deleted} => bless {param => \%form, page => $form{mypage}, formatter => $fmt{view}, &_compatible_options ()}, 'SuikaWiki::Plugin');
d215 1
a215 3
  my $scheme = 'http';
  $scheme = lc $1 if $main::ENV{SERVER_PROTOCOL} =~ m#([A-Za-z0-9+.%-]+)#;
  print "Location: $scheme://$main::ENV{SERVER_NAME}:$main::ENV{SERVER_PORT}$url_cgi?$name\n";
a218 7
sub print_error {
    my ($msg) = @@_;
    &print_header($PageName{ErrorPage}, -noindex => 1);
    print qq(<p><strong class="error">$msg</strong></p>);
    exit(0);
}

d222 2
a223 2
    $option{body_class} = &is_frozen($page) ? 'frozen' : 'normal';
    $option{body_class} .= " wiki-page-obsoleted" if $option{-content_format} =~ /obsoleted="yes"/;
d231 3
d241 6
a246 2
    if ($option{-expires}) {
      print qq{Expires: @@{[scalar gmtime $option{-expires}]}\n};
d248 2
a249 2
    if ($UA =~ m#Mozilla/2#) {
	my $ct = qq{text/html; charset=@@{[&get_charset_name($kanjicode,compatible=>1)]}};
d251 3
a253 3
	push @@head, qq{<meta http-equiv="content-type" content="$ct">};
    } elsif ($UA =~ m#Infomosaic#) {
	print qq{Content-Type: text/html\n};
d255 3
a257 1
	print qq{Content-Type: text/html; charset=@@{[&get_charset_name($kanjicode)]}\n};
d259 1
a259 10
    push @@head, qq(<title>@@{[&escape($page)]}</title>);
    if ($UA !~ m#Mozilla/[1-4]\.# || $UA =~ m#MSIE (?:[4-9]\.|\d\d)#) {
      push @@head, qq(<link rel="stylesheet" type="text/css").
                  qq( href="@@{[&escape($uri{wiki}.'?mycmd=TEXT_CSS;mypage='.&encode($PageName{DefaultStyleForHTML}).';x-lm='.$database->mtime ($PageName{DefaultStyleForHTML}))]}");
    }
    push @@head, q(<meta name="ROBOTS" content="NOINDEX">) if $option{-noindex};
    my ($Links, $links) = &make_navigate_links ($page);
    #print $Links;	## Link: fields
    $links = join "\n", (@@head, $links);
    print <<"EOD";
a262 6
<!-- <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd"> + RUBY -->
<html lang="$lang" class="$option{body_class}">
<head profile="http://suika.fam.cx/~wakaba/-temp/wiki/wiki?WikiHTMLMetaProfile">
$links
</head>
d264 1
a278 57
sub _navigate_links (@@) {
  my ($page) = @@_;
  my $editable = (&is_editable($page) && !&is_frozen($page)) ? 1 : 0;
  my $cookedpage = &encode($page);
  <<EOH;
    @@{[ $editable
        ? qq(<a title="@@{[&Resource('EditThisPageLong',escape=>1)]}" href="$url_cgi?mycmd=edit;mypage=$cookedpage" accesskey="E" class="wiki-cmd">@@{[&Resource('EditThisPage',escape=>1)]}</a> | )
        : qq()
    ]}
    <a href="$url_cgi?mycmd=read;mypage=$cookedpage;x-param=@@{[time.[0..9]->[rand 10]]}" class="wiki-cmd" title="@@{[&Resource('ViewThisPageLong',escape=>1)]}">@@{[&Resource('ViewThisPage',escape=>1)]}</a> | 
    <a href="$url_cgi?mycmd=map;mypage=$cookedpage" class="wiki-cmd" title="@@{[&Resource('ShowMapOfThisPageLong',escape=>1)]}">@@{[&Resource('ShowMapOfThisPage',escape=>1)]}</a> | 
    <a href="$url_cgi?$PageName{CreatePage}" class="wiki" title="@@{[&Resource('GoToCreatePageLong',escape=>1)]}">@@{[&Resource('GoToCreatePage',escape=>1)]}</a> | 
    <a href="$url_cgi?$PageName{IndexPage}" class="wiki" title="@@{[&Resource('GoToIndexPageLong',escape=>1)]}">@@{[&Resource('GoToIndexPage',escape=>1)]}</a> | 
    <a href="$url_cgi?$PageName{FrontPage}" class="wiki" title="@@{[&Resource('GoToHomePageLong',escape=>1)]}">@@{[&Resource('GoToHomePage',escape=>1)]}</a> | 
    <a href="$url_cgi?$PageName{SearchPage}" class="wiki" title="@@{[&Resource('GoToSearchPageLong',escape=>1)]}">@@{[&Resource('GoToSearchPage',escape=>1)]}</a> | 
    <a href="$url_cgi?mycmd=RandomJump;x-param=@@{[time.[0..9]->[rand 10]]}" class="wiki randomlink" title="@@{[&Resource('GoSomewhereLong',escape=>1)]}">@@{[&Resource('GoSomewhere',escape=>1)]}</a> | 
    <a href="$url_cgi?$PageName{RecentChanges}" class="wiki" title="@@{[&Resource('GoToRecentChangesLong',escape=>1)]}">@@{[&Resource('GoToRecentChanges',escape=>1)]}</a>
EOH
}

sub make_navigate_links ($) {
    my $page = shift;
    my @@link;
    push @@link, {rel=>'edit', href=>"$url_cgi?mycmd=edit;mypage=@@{[&encode($page)]}", class=>"wiki-command", title=>&Resource('EditThisPageLink')} if &is_editable ($page) && !&is_frozen ($page);
    push @@link, {rel=>'edit', href=>"$url_cgi?mycmd=edit;admin=1;mypage=@@{[&encode($page)]}", class=>"wiki-command", title=>&Resource('AdminEditThisPageLink')} if &is_editable ($page) || &is_frozen ($page);
    push @@link, {rel=>'view', href=>"$url_cgi?mycmd=read;mypage=@@{[&encode($page)]};x-p=@@{[time.[0..9]->[rand 10]]}", class=>'wiki-command', title=>&Resource('ViewThisPageLink')};
    push @@link, {rel=>'myself', href=>"$url_cgi?@@{[&encode($page)]}", class=>'wiki', title=>&Resource('GoToMyselfLink')};
    push @@link, {rel=>'index', href=>"$url_cgi?$PageName{IndexPage}", class=>'wiki', title=>&Resource('GoToIndexPageLink')};
    push @@link, {rel=>'home', href=>"$url_cgi?$PageName{FrontPage}", class=>'wiki', title=>&Resource('GoToHomePageLink')};
    push @@link, {rel=>'News', href=>"$url_cgi?WikiNews", class=>'wiki', title=>&Resource('GoToWikiNewsLink')};
    push @@link, {rel=>'News', href=>"$url_cgi?$PageName{RecentChanges}", class=>"wiki", title=>&Resource('GoToRecentChangesLink')};
    push @@link, {rel=>'News', href=>"$url_cgi?$PageName{RssPage}", class=>"wiki", title=>&Resource('GoToRssPageLink'), type=>'application/xml'};
    push @@link, {rel=>'search', href=>"$url_cgi?$PageName{SearchPage}", class=>'wiki', title=>&Resource('GoToSearchPageLink')};
    push @@link, {rel=>'help', href=>"$url_cgi?WikiHelp", class=>'wiki', title=>&Resource('GoToWikiHelpLink')};
    push @@link, {rel=>'copyright', href=>"$url_cgi?WikiPageLicense", class=>'wiki', title=>&Resource('GoToWikiPageLicenseLink')};
    push @@link, {rel=>'jump', href=>qq(javascript:var%20WikiName=prompt('Please%20input%20the%20WikiName:','','Jump%20to%20SuikaWiki');if(WikiName)%7B_content.location.href='$url_cgi%3F'+encodeURIComponent(WikiName)%7D), class=>'wiki-cmd', title=>&Resource('JumpToLink')};
    push @@link, {rel=>'jump', href=>qq(javascript:var%20WikiName=prompt('Please%20input%20the%20WikiName:','','Jump%20to%20SuikaWiki');if(WikiName)%7B_content.location.href='$url_cgi%3Fmycmd=edit;mypage='+encodeURIComponent(WikiName)%7D), class=>'wiki-cmd', title=>&Resource('JumpToEditLink')};
    push @@link, {rel=>'lucky', href=>"$url_cgi?mycmd=RandomJump;x-param=@@{[time.[0..9]->[rand 10]]}", class=>'wiki randomlink', title=>&Resource('GoSomewhereLink')};
    push @@link, {rel=>'history', href=>$uri{cvs_wikipage}.do{my $s=$page;$s=~s/(.)/sprintf '%02X', ord $1/ges;$s}.'.txt', title=>&Resource('ViewHistoryOfThisPageLink'),hreflang=>'en'} if $uri{cvs_wikipage};
    push @@link, {rel=>'history', href=>"$url_cgi?mycmd=diff;mypage=@@{[&encode($page)]}", title=>&Resource('ViewDiffOfThisPageLink'), class=>'wiki-command'} if $wiki::diff::UseDiff;
    push @@link, {rel=>'contents', href=>"$url_cgi?mycmd=map;mypage=@@{[&encode($page)]}", title=>&Resource('ShowMapOfThisPageLink'), class=>'wiki-command'};
    my ($Links, $links) = ('', '');
    for my $e (@@link) {
	$links .= qq(<link);
	$Links .= qq(Link: <$e->{href}>);
	for my $attr (qw/rel rev href title class type hreflang charset/) {
	    $links .= qq( $attr="@@{[&escape($e->{$attr})]}") if $e->{$attr};
	}
	for my $attr (qw/rel rev title/) {
	    $Links .= qq(; $attr="@@{[do{$e->{$attr} =~ s/([\\\"])/\\$1/g; $e->{$attr}}]}") if $e->{$attr};
	}
	$links .= qq(>\n);
	$Links .= qq(\n);
    }
    wantarray ? ($Links, $links) : $Links;
}

d302 1
a302 1
  my $f = $fmt{format}->{$d.'_to_'.$t};
d305 2
d550 1
a550 1
	    my $target_page = $param->{output}->{page} || $form{mypage};
d556 5
a560 5
  <input type="hidden" name="mycmd" value="@@{[$param->{form_disabled}?'read':'wikiform']}">
  <input type="hidden" name="mypage" value="@@{[&escape($target_page)]}">
  <input type="hidden" name="myLastModified" value="$lastmodified">
  <input type="hidden" name="mytouch" value="on">
  <input type="hidden" name="@@{[$target_form? qq(wikiform_targetform" value="@@{[&escape($target_form)]}) : qq(wikiform_index" value="$FormIndex)]}">
a573 5
sub print_message {
    my ($msg) = @@_;
    print qq(<p><strong>@@{[&escape($msg)]}</strong></p>);
}

a583 4
      if ($page_command{$query}) {
        $form{mycmd} = $page_command{$query};
        $form{mypage} = $query;
      } else {
a585 1
      }
a596 4
      if ($page_command{$form{mypage}} && $form{mycmd} eq 'read') {
        $form{mypage} = &code_convert(\$form{mypage}, $kanjicode);
        $form{mycmd} = $page_command{$form{mypage}};
      }
d598 1
a598 1
    $form{mypage} ||= 'HomePage';
d645 1
a645 1
        dbmopen(%database, $PathTo{WikiDataBase}, 0666) or &print_error("(dbmopen) $PathTo{WikiDataBase}");
d648 1
a648 1
        tie(%database, "AnyDBM_File", $PathTo{WikiDataBase}, O_RDWR|O_CREAT, 0666) or &print_error("(tie AnyDBM_File) $PathTo{WikiDataBase}");
d651 1
a651 1
        tie(%database, "Yuki::YukiWikiDB", $PathTo{WikiDataBase}) or &print_error("(tie Yuki::YukiWikiDB) $PathTo{WikiDataBase}");
d654 1
a654 1
        $database = tie(%database, $modifier_dbtype => $PathTo{WikiDataBase}, -lock => 2, -backup => $wiki::diff::UseDiff) or &print_error("(tie $modifier_dbtype) $PathTo{WikiDataBase}");
d690 5
a694 5
    @@{[ $option{conflict} ? '' : qq(<label><input type="submit" name="mypreview_write" value="@@{[&Resource('Edit:Save',escape=>1)]}"><kbd>S</kbd></label>) ]}
    @@{[ $option{admin} ? qq(<label>@@{[&Resource('Edit:Password=',escape=>1)]}<input type="password" name="mypassword" value="" size="10"></label>) : "" ]} [@@{[&get_new_anchor_index($option{content})]}]<br>
    <input type="hidden" name="myLastModified" value="$option{last_modified}">
    <input type="hidden" name="mypage" value="@@{[&escape($form{mypage})]}">
    <textarea cols="@@{[&Resource('Edit:Form:Cols')+0||80]}" rows="@@{[&Resource('Edit:Form:Rows')+0||20]}" name="mymsg" tabindex="1">@@{[&escape($option{content})]}</textarea><br>
d698 2
a699 2
    <label><input type="radio" name="myfrozen" value="1" @@{[$frozen ? qq(checked="checked") : ""]}>@@{[&Resource('Edit:Freeze',escape=>1)]}</label>
    <label><input type="radio" name="myfrozen" value="0" @@{[$frozen ? "" : qq(checked="checked")]}>@@{[&Resource('Edit:DontFreeze',escape=>1)]}</label><br>)
d705 2
a706 2
        <label><input type="checkbox" name="mytouch" value="on" checked="checked">@@{[&Resource('Edit:UpdateTimeStamp',escape=>1)]}</label><br>
        <label><input type="submit" name="mypreview_write" value="@@{[&Resource('Edit:Save',escape=>1)]}" accesskey="S"><kbd>S</kbd></label>
d717 1
a717 1
    $page =~ /[\x00-\x1F\x7F]/ ? 0 : 1;
d729 1
a729 1
  $s =~ s/([^0-9A-Za-z_-])/sprintf '%%%02X', ord $1/g;
d765 3
a767 2
        &print_error(&Resource('Error:PasswordIsIncorrect'));
        return 1;
d829 5
a833 5
    <input type="hidden" name="mycmd" value="comment">
    <input type="hidden" name="mypage" value="$form{mypage}">
    <input type="hidden" name="myLastModified" value="$lastmodified">
    <input type="hidden" name="mytouch" value="on">
    <input type="hidden" name="comment_index" value="$CommentIndex">
d835 3
a837 3
    <input type="text" name="myname" value="" size="10" class="comment-name">
    <input type="text" name="mymsg" value="" size="60" class="comment-msg">
    <input type="submit" value="@@{[&Resource('WikiForm:Add',escape=>1)]}" title="@@{[&Resource('WikiForm:AddLong',escape=>1)]}" class="comment-submit">
d843 2
a844 2
    <input type="hidden" name="mycmd" value="read">
    <input type="hidden" name="mypage" value="$form{mypage}">
d846 2
a847 2
    <input type="text" name="myname" value="" size="10" disabled="disabled">
    <input type="text" name="mymsg" value="" size="60" disabled="disabled">
a957 42
sub do_rss {
    eval q{use Yuki::RSS};
    my $rss = new Yuki::RSS(
        version => '1.0',
        encoding => &get_charset_name ($kanjicode),
    );
    my $scheme = 'http';
    $scheme = lc $1 if $main::ENV{SERVER_PROTOCOL} =~ m#([A-Za-z0-9+.%-]+)#;
    my $myuri = "$scheme://$main::ENV{SERVER_NAME}:$main::ENV{SERVER_PORT}$url_cgi";
    $rss->stylesheet (
      href	=> $myuri . "?mycmd=TEXT_CSS;mypage=WikiStyle:RSS",
      type	=> 'text/css',
    );
    $rss->channel(
        title	=> &Resource ('RSS:WikiTitle'),
        link	=> $myuri,
        description	=> &Resource ('RSS:WikiDescription'),
        'dc:language'	=> $lang,
    );
    my $recentchanges = $database{RecentChanges};
    my $count = 0;
    foreach (split(/\n/, $recentchanges)) {
        last if ($count >= 15);
        if (/\[\[([^]]+)\]\]/) {
          my $title = $1;
          $rss->add_item (
            title	=> &escape($title),
            link	=> $myuri . '?' . &encode($title),
            description	=> &escape(&get_subjectline($title,delimiter=>'')),
            'dc:date'	=> $database->mtime ($title),
          );
          $count++;
        }
    }
    # print RSS information (as XML).
    print <<"EOD"
Content-type: application/xml; charset=@@{[&get_charset_name ($kanjicode)]}

@@{[$rss->as_string]}
EOD
}

d1102 1
d1112 1
d1114 3
a1116 3
  my $page = $_[1];
  $page =~ s!^((?:\#\?|/\*|<\?)[^\x02\x0A\x0D]+)[\x02\x0A\x0D]+!!s;
  ($1, $page);
d1121 5
@


1.48
log
@Many builtin functions are removed and implemented as plugin modules
@
text
@d10 1
a10 1
our $VERSION = do{my @@r=(q$Revision: 1.46 $=~/\d+/g);sprintf "%d."."%02d" x $#r,@@r};
d15 1
a15 1
my %fmt;	## formatter objects
d42 1
a42 1
    diff => \&do_diff,
d68 3
a70 7
    my $cf = 'SuikaWiki/0.9';
    ## Should be support at least:
    ## - 'SuikaWiki/0.9' CRLF
    ## - 'H2H/' ("0.9" / "1.0" / "1.1") CRLF
    ## - "/*" WSP* 'W3C-CSS/' ("1.0" / "2.0") "*/" CRLF
    $cf = $1 if $content =~ s#^(?:/\*\s*|[\#<]\?)?([A-Z][A-Za-z0-9-]+/[0-9.]+(?:[^0-9.\x0D\x0A][^\x0D\x0A]*)?)[\x0D\x0A]+##s;
    if ($cf =~ m!^(?:\#\?)?SuikaWiki/0.9(?:$|\s)!) {
d72 1
a72 1
      if ($cf =~ /interactive="yes"/) {
d78 1
a78 4
        -content_format => $cf, -noindex => ($cf =~ /obsoleted="yes"/ ? 1 : 0));
      &print_content ($content, content_format => $cf, last_modified => $lm,
        -toc => \@@toc);
      print &text_to_html (q([[#comment]])) if $cf !~ /obsoleted="yes"/ && !$database->meta (IsFrozen => $form{mypage});
d80 1
a80 2
      &print_header($form{mypage}, -expires => time + 120, -last_modified => $lm);
      print "<pre>@@{[&escape($content)]}</pre>";
a83 1
    &print_footer ($form{mypage}, $lm);
d100 2
a101 2
    &print_content($database{WikiPageIsNotCSS});
    &print_footer('WikiPageIsNotCSS');
a125 1
    &print_footer($form{mypage});
a146 1
    &print_footer('CompletedSuccessfully');
a161 1
        &print_footer($form{mypage});
d166 2
a167 2
    if ($form{myLastModified} ne $database->mtime ($page)) {
      &print_header($page, -noindex => 1);
a169 1
      &print_footer($page);
d187 3
a189 4
        &print_header('CompletedSuccessfully', -noindex => 1, -goto => $url_cgi.'?mycmd='.&encode($form{after_edit_cmd}||'read').';mypage='.&encode($form{mypage}).qq(;x-param=@@{[time.[0..9]->[rand 10]]}$fragment));
        &print_message(&Resource('Error:SavedSuccessfully'));
        &print_content(&Resource('Error:ContinueReading')." @@{[&armor_name($form{mypage})]}");
        &print_footer('CompletedSuccessfully');
d193 2
a194 2
        &print_message(&Resource('Error:PageIsDeletedSuccessfully'));
        &print_footer($form{mypage});
a237 1
    &print_footer($PageName{ErrorPage});
a290 5
<body class="$option{body_class}">
EOD
    &print_navigate_links ($page);
    print <<EOD;
<h1 class="header">@@{[&escape($page)]}</h1>
d306 1
a306 1
sub print_navigate_links (@@) {
d310 1
a310 2
  print <<EOH;
<div class="tools">
a322 1
</div>
a362 17
sub print_footer {
    my ($page, $lm) = @@_;
    my $epage = &encode ($page);
  my $cvslog1 = q$Revision: 1.46 $;
  my $cvslog2 = q$Date: 2003/01/02 12:14:15 $;
  print_navigate_links ($page);
  print <<"EOD";
@@{[ $lm ? qq(<div id="wikipage-last-modified">@@{[&Resource('LastModified=',escape=>1)]}@@{[&_rfc3339_date ($lm)]}</div>) : '' ]}
<div class="footer">
<a href="http://www.hyuki.com/yukiwiki/" title="YukiWiki 2.0.beta1.2002-05-29 &copy; 2000-2002 by Hiroshi Yuki">@@{[&Resource('About:Name:YukiWiki',escape=>1)]}</a> <a href="http://digit.que.ne.jp/work/" title="WalWiki 2.0.beta1.wal.1 &copy; 2000-2002 by Makio Tsukamoto">@@{[&Resource('About:Name:WalWiki',escape=>1)]}</a>
<a href="/gate/cvs/wakaba/wiki/" title="@@{[&Resource('About:SuikaWiki:JumpToCVS',escape=>1)]} ($cvslog2)">@@{[&Resource('About:Name:SuikaWiki',escape=>1)]} $cvslog1</a>
</div>
</body>
</html>
EOD
}

d383 12
a394 3
sub print_content ($;$) {
    my ($rawcontent, %option) = @@_;
    print &text_to_html($rawcontent, toc=>1, %option);
d399 1
a399 1
    my $toc = $option{-toc} || [];
d563 1
d567 1
a567 1
      return qq(<a title="$subject" href="$url_cgi?@@{[&encode($name)]}#anchor-$option{anchor}" class="wiki">$ename&gt;&gt;$option{anchor}</a>);
d569 1
a569 1
      return qq(<a title="$subject" href="$url_cgi?@@{[&encode($name)]}" class="wiki">$ename</a>);
d572 1
a572 1
    return qq(<a title="@@{[&Resource('JumpAndEditWikiPage',escape=>1)]}" href="$url_cgi?@@{[&escape($name)]}" class="wiki not-exist">$ename<span class="mark">@@{[&Resource('JumpAndEditWikiPageMark',escape=>1)]}</span></a>);
a807 6
    unless ($option{conflict}) {
        ## Show help text
        my $help = $database{WikiEditHelp};
        $help =~ s!^\#\?([A-Z][A-Za-z0-9-]+/[0-9.]+(?:[^0-9.\x0D\x0A][^\x0D\x0A]*)?)[\x0D\x0A]+!!s;
        $f .= &text_to_html ($help, toc => 0);
    }
a815 17
# armor_name:
#   WikiName -> WikiName
#   not_wiki_name -> [[not_wiki_name]]
sub armor_name { qq([[$_[0]]]) }

# unarmor_name:
#   [[bracket_name]] -> bracket_name
#   WikiName -> WikiName
sub unarmor_name {
    my ($name) = @@_;
    if ($name =~ /^\[\[(\S+?)\]\]$/) {
        return $1;
    } else {
        return $name;
    }
}

d824 3
a826 10
    my ($s) = @@_;
    my $encoded = '';
    foreach my $ch (split(//, $s)) {
        if ($ch =~ /[A-Za-z0-9_]/) {
            $encoded .= $ch;
        } else {
            $encoded .= '%' . sprintf("%02X", ord($ch));
        }
    }
    return $encoded;
d870 1
a870 1
    my $default_name;	## this code does not strict.
d1045 4
a1048 4
    $code = 'jis' if $code =~ /iso/;
    $code = 'euc' if $code =~ /euc/;
    $code = 'sjis' if $code =~ /shift/;
    $code = 'utf8' if $code =~ /utf/;
a1052 21
sub do_diff {
    my $title = $form{mypage};
    &print_header($title, -noindex => 1);
    print qq(<h2>@@{[&Resource('Diff:Title',escape=>1)]}</h2>);
    print qq(<p>@@{[&Resource('Diff:Notice',escape=>1)]}</p>);
    print qq(<pre class="diff">);
    for (split(/\n/, &escape ($database->traverse_diff ($form{mypage})))) {
        if (/^\+(.*)/) {
            print qq(<ins class="added">$1</ins>\n);
        } elsif (/^\-(.*)/) {
            print qq(<del class="deleted">$1</del>\n);
        } elsif (/^\=(.*)/) {
            print qq(<span class="same">$1</span>\n);
        } else {
            print qq|??? $_\n|;
        }
    }
    print qq(</pre>);
    &print_footer($title);
}

d1100 1
a1100 9
sub is_exist_page {
    my ($name) = @@_;
    if ($use_exists) {
        return exists($database{$name});
    } else {
        return $database{$name};
    }
}

d1142 1
a1142 1
  split /[\x0D\x0A]+/, &main::__get_database ('RefererDontRecord');
d1145 1
a1145 1
  my @@lines = grep /[^#]/, split /[\x0D\x0A]+/, &main::__get_database('RefererSiteName');
d1236 1
a1236 1
  our $plugin_directory;  # defined in top of this file.
d1248 9
d1306 1
a1306 1
        $option->{resource}->{$lang} ||= &wiki::suikawikiconst::to_hash (&main::__get_database('WikiResource:'.$lang));
d1326 4
@


1.47
log
@YukiWikiDBMeta support
@
text
@d21 1
a21 1
our (%PageName,$kanjicode,$lang,%FixedPage);
d35 1
a35 2
    edit => \&do_edit,
    adminedit => \&do_adminedit,
d44 1
a44 1
    map	=> \&do_map,
a66 2
  my ($r, $c) = get_search_result ($form{mypage});
  my $rl = wiki::referer::list_html ($form{mypage});
a67 2
  push @@toc, qq(-<a href="#wikipage-see-also">@@{[&Resource('SeeAlso',escape=>1)]}</a>) if $c;
  push @@toc, qq(-<a href="#wikipage-referer">@@{[&Resource('Referers',escape=>1)]}</a>) if $rl;
d85 1
a85 1
      print &text_to_html (q([[#comment]])) if $cf !~ /obsoleted="yes"/ && !$FixedPage{$form{mypage}};
d90 3
a92 10
    if ($c) {
      print qq{<h2 @@{[&id_and_name('wikipage-see-also')]}>@@{[&Resource('SeeAlso',escape=>1)]}</h2>};
      print $r;
    }
    if ($rl) {
      print qq(<div @@{[&id_and_name('wikipage-referer')]}><h2>@@{[&Resource('Referers',escape=>1)]}</h2>\n$rl</div>\n);
    }
        #print "\n". gmtime."Footer...\n";
  &print_footer($form{mypage}, $lm);
        #print "\n". gmtime."Fin...\n";
d123 1
a123 12
sub do_edit {
    my ($page) = &unarmor_name(&armor_name($form{mypage}));
    if (not &is_editable($page)) {
        &print_header($page, -noindex => 1, -expires => time+60);
        &print_message(&Resource('Error:ThisPageIsUneditable'));
    } elsif (&is_frozen($page)) {
        &print_header($page, -noindex => 1, -expires => time+60);
        &print_message(&Resource('Error:ThisPageIsUneditable'));
    } else {
        &print_header($page, -noindex => 1, -expires => time+60);
        &print_editform($database{$page}, $database->mtime ($page), admin=>0);
    }
d126 7
a132 20
    my ($r, $c) = get_search_result ($form{mypage});
    my $rl = wiki::referer::list_html ($form{mypage});
    if ($c) {
      print qq{<h2 id="wikipage-see-also">@@{[&Resource('SeeAlso',escape=>1)]}</h2>};
      print $r;
    }
    if ($rl) {
      print qq(<div id="wikipage-referer"><h2>@@{[&Resource('Referers',escape=>1)]}</h2>\n$rl</div>\n);
    }
    &print_footer($page);
}

sub do_adminedit {
    my ($page) = &unarmor_name(&armor_name($form{mypage}));
    &print_header($page, -noindex => 1, -expires => time+60);
    if (not &is_editable($page)) {
        &print_message(&Resource('Error:ThisPageIsUneditable'));
    } else {
        &print_message(&Resource('Error:PasswordIsNotSpecified'));
        &print_editform($database{$page}, $database->mtime ($page), admin=>1);
d134 2
a135 1
    &print_footer($page);
d177 7
a183 2
    if (&conflict($form{mypage}, $form{mymsg})) {
        return;
d212 4
d352 1
a352 1
    push @@link, {rel=>'edit', href=>"$url_cgi?mycmd=adminedit;mypage=@@{[&encode($page)]}", class=>"wiki-command", title=>&Resource('AdminEditThisPageLink')} if &is_editable ($page) || &is_frozen ($page);
d404 1
a404 1
    $s =~ s|\r\n|\n|g;
d429 1
a429 2
    my @@toc;
    my @@toc2 = @@{$option{-toc}||[]};
d451 1
a451 1
            push(@@toc, qq(----- <a href="#i$tocnum">@@{[&escape($1)||$tocnum]}</a>\n));
d455 1
a455 1
            push(@@toc, qq(---- <a href="#i$tocnum">@@{[&escape($1)||$tocnum]}</a>\n));
d459 1
a459 1
            push(@@toc, qq(--- <a href="#i$tocnum">@@{[&escape($1)||$tocnum]}</a>\n));
d465 1
a465 1
            push(@@toc, qq(-- <a href="#i$tocnum">@@{[&escape($1)||$tocnum]}</a>\n));
d469 1
a469 1
            push(@@toc, qq(- <a href="#i$tocnum">@@{[&escape($1)||$tocnum]}</a>\n));
d537 5
a541 20
    my $toc = '';
    if ($option{toc}) {
        # Convert @@toc (table of contents) to HTML.
        # This part is taken from Makio Tsukamoto's WalWiki.
        my (@@tocsaved, @@tocresult);
        foreach (@@toc,@@toc2) {
            if (/^(-{1,6})(.*)$/) {
                &back_push('ul', length($1), \@@tocsaved, \@@tocresult);
                push(@@tocresult, '<li>' . $2 . '</li>');
            }
        }
        push(@@tocresult, splice(@@tocsaved));
        $toc = join("\n", @@tocresult);
        $toc = $toc ? qq(<div id="wikipage-toc">$toc</div>) : '';
    }
    $toc .= join("\n", @@result);
    $toc =~ s#<p>\n</p>##g;
    $toc =~ s#[\x0D\x0A]+</#</#g;
    $toc =~ s#<pre>\n#<pre>#g;
    $toc;
d662 1
a662 1
	    $param->{form_disabled} = 1 if $FixedPage{$target_page};
d724 1
d791 17
a807 31
sub print_editform {
    my ($mymsg, $lastmodified, %mode) = @@_;
    my $frozen = &is_frozen($form{mypage});

    if ($form{mypreview}) {
        if ($form{mymsg}) {
            unless ($mode{conflict}) {
                print qq(<h3>@@{[&Resource('Preview:Title',escape=>1)]}</h3>\n);
                print qq(<p>@@{[&Resource('Preview:Notice',escape=>1)]}</p>\n);
                print qq(<div class="preview">\n);
                &print_content($form{mymsg});
                print qq(</div>\n);
            }
        } else {
            print @@{[&Resource('Preview:Empty',escape=>1)]};
        }
        $mymsg = &escape($form{mymsg});
    } else {
        $mymsg = &escape($mymsg || $database{NewPageTemplate});
    }
    my $magic = '';
    $magic = $1 if $mymsg =~ m/^([^\x0A\x0D]+)/s;

    my $edit = $mode{admin} ? 'adminedit' : 'edit';
    my $selected = 'read';
    if ($form{after_edit_cmd}) {
	$selected = $form{after_edit_cmd};
    } elsif ($magic =~ /Const|Config|CSS/) {
	$selected = 'edit';
    }
    my $afteredit = <<EOH;
d813 5
a817 9

    print <<"EOD";
<form action="$url_cgi" method="post">
<h2>@@{[&Resource('Edit:Title',escape=>1)]}</h2>
    @@{[ $mode{conflict} ? '' : qq(<input type="submit" name="mypreview_write" value="@@{[&Resource('Edit:Save',escape=>1)]}"><kbd>S</kbd>) ]}
    @@{[ $mode{admin} ? qq(<label>@@{[&Resource('Edit:Password=',escape=>1)]}<input type="password" name="mypassword" value="" size="10"></label>) : "" ]} [@@{[do {my $n = 0;
               $mymsg =~ s/(?:-+\s)?\[([0-9]+)\]/$n = $1 if $1 > $n; $&/mge;
               ++$n}]}]<br>
    <input type="hidden" name="myLastModified" value="$lastmodified">
d819 1
a819 1
    <textarea cols="@@{[&Resource('Edit:Form:Cols')+0||80]}" rows="@@{[&Resource('Edit:Form:Rows')+0||20]}" name="mymsg" tabindex="1">$mymsg</textarea><br>
d821 1
a821 1
    $mode{admin} ?
d828 1
a828 1
    $mode{conflict} ? "" :
a830 1
        <input type="submit" name="mypreview_$edit" value="@@{[&Resource('Edit:Preview',escape=>1)]}">
d837 1
a837 1
    unless ($mode{conflict}) {
d841 1
a841 1
        print &text_to_html ($help, toc => 0);
d843 1
d848 1
a848 5
    if ($FixedPage{$page} || $page =~ /\s/ || $page =~ /^\#/) {
        return 0;
    } else {
        return 1;
    }
a887 12
sub conflict {
    my ($page, $rawmsg) = @@_;
    if ($form{myLastModified} eq $database->mtime ($page)) {
        return 0;
    }
    &print_header($page, -noindex => 1);
    &print_content(&Resource('Error:Conflict'));
    &print_editform($rawmsg, $form{myLastModified}, frozen=>0, conflict=>1);
    &print_footer($page);
    return 1;
}

a1190 23
sub do_map {
    my $page = $form{mypage};
    &print_header ($page);
    wiki::referer::add ($form{mypage}, $ENV{HTTP_REFERER});
    wiki::useragent::add ($ENV{HTTP_USER_AGENT});
    my ($r, $c) = get_search_result ($form{mypage});
    my $rl = wiki::referer::list_html ($form{mypage});
    print "<h2>@@{[&Resource('Map:Title',escape=>1)]}</h2>\n<p>@@{[&Resource('Map:Description',escape=>1)]}</p>\n";
    my %option = (level => 0+&Resource('Map:Depth'), weight_list => {}, not_exist => {},
      map_from_here => &Resource('Map:FromHere'),
      map_from_here_description => &Resource('Map:FromHereLong'));
    &wiki::map::make_list ($page, %option);
    print &wiki::map::list_to_html ($page, $option{weight_list}, %option);
    if ($c) {
      print qq{<h2 id="wikipage-see-also">@@{[&Resource('SeeAlso',escape=>1)]}</h2>};
      print $r;
    }
    if ($rl) {
      print qq(<div id="wikipage-referer"><h2>@@{[&Resource('Referers',escape=>1)]}</h2>\n$rl</div>\n);
    }
    &print_footer ($page);
}

d1326 1
d1335 1
a1393 48
}

package wiki::map;

sub make_list ($;%) {
  my ($page, %option) = @@_;
  $option{level} ||= 3;
  my %weight;
  my $content = &main::__get_database ($page);
  $content =~ s{^\#\?([^\x0A\x0D]+)}{
    if ($1 =~ /import="([^"]+)"/) {
      for (split /\s*,\s*/, $1) {
        $weight{$_} += 2;
      }
    }
    $&;
  }ges;
  ## Bug: this code does not support content type.
  $content =~ s{\[\[((?!\#)[^]]+)\](?:>>\d+)?\]}{
    $weight{$1}++; $&;
  }ge;
  delete $weight{$page};	## Delete myself
  for my $page (keys %weight) {
    my $w = ($content =~ s/\Q$page\E/$&/g);
    $weight{$page} += $w + $weight{$page}; ## Weight of [[name]] is x2.
    ($weight{$page} *= 0.1, $option{not_exist}->{$page} = 1) unless &main::is_exist_page ($page);
  }
  $option{weight_list}->{$page} = \%weight;
  if (--$option{level}) {
    for my $page (keys %weight) {
      &make_list ($page, %option) unless $option{weight_list}->{$page};
    }
  }
  $option{weight_list};
}

sub list_to_html ($$;%) {
  my ($Page, $wlist, %option) = @@_;
  my $r = '';
  $option{outputed}->{$Page} = 1;
  for my $page (sort {$wlist->{$Page}->{$b} <=> $wlist->{$Page}->{$a}} keys %{$wlist->{$Page}}) {
    $r .= qq(<li><span class="weight">[@@{[0+$wlist->{$Page}->{$page}]}]</span> <a href="$main::url_cgi?@@{[&main::encode($page)]}" class="wiki@@{[$option{not_exist}->{$page}?' not-exist':'']}">@@{[&main::escape ($page).($option{not_exist}->{$page}?qq(<span class="mark">@@{[&main::Resource('JumpAndEditWikiPageMark',escape=>1)]}</span>):'')]}</a> <a href="$main::url_cgi?mycmd=map;mypage=@@{[&main::encode($page)]}" class="wiki-cmd map-from-here" title="@@{[&main::escape($option{map_from_here_description})]}">@@{[&main::escape($option{map_from_here})]}</a> <span class="summary">@@{[&main::escape(&main::get_subjectline($page))]}</span>);
    unless ($option{outputed}->{$page}) {
      $r .= &list_to_html ($page, $wlist, %option);
    }
    $r .= "</li>\n";
  }
  $r ? qq(<ul class="map">$r</ul>) : '';
@


1.46
log
@do_index: Removed.
@
text
@d10 1
a10 1
our $VERSION = do{my @@r=(q$Revision: 1.26 $=~/\d+/g);sprintf "%d."."%02d" x $#r,@@r};
a23 3
my $info_LastModified = 'LastModified';
my $info_IsFrozen = 'IsFrozen';
##############################
d26 1
a26 2
our $database;
my %infobase;
d65 1
a65 2
  #print "content-type:text/plain;charset=euc-jp\n\n".gmtime."Get Lastmodified\n";
  my $lm = &get_info($form{mypage}, $info_LastModified);
a67 1
  #print gmtime."Search...\n";
d80 7
a86 2
    #print gmtime."Header...\n";
      &print_header ($form{mypage}, -last_modified => $lm, -expires => time + 120,
a87 1
        #print "\n". gmtime."Body...\n";
d112 1
a112 1
    my $lm = gmtime &get_info($form{mypage}, $info_LastModified);
d145 1
a145 1
        &print_editform($database{$page}, &get_info($page, $info_LastModified), admin=>0);
d168 1
a168 1
        &print_editform($database{$page}, &get_info($page, $info_LastModified), admin=>1);
d177 1
a177 1
    my ($validpassword_crypt) = &get_info($PageName{AdminSpecialPage}, 'AdminPassword');
d188 1
a188 1
    &set_info($PageName{AdminSpecialPage}, 'AdminPassword', $crypted);
d196 1
a196 1
    my ($validpassword_crypt) = &get_info($PageName{AdminSpecialPage}, 'AdminPassword');
d222 1
a222 1
        &set_info($form{mypage}, $info_IsFrozen, 0 + $form{myfrozen});
a235 1
        delete $infobase{$form{mypage}};
d315 2
a316 1
      push @@head, qq(<link rel="stylesheet" type="text/css" href="@@{[&escape($uri{wiki}.'?mycmd=TEXT_CSS;mypage='.&encode($PageName{DefaultStyleForHTML}).';x-lm='.&get_info($PageName{DefaultStyleForHTML}, $info_LastModified))]}");
d414 2
a415 2
  my $cvslog1 = q$Revision: 1.44 $;
  my $cvslog2 = q$Date: 2003/01/01 12:30:24 $;
d694 1
a694 1
	    my $lastmodified = &get_info($form{mypage}, $info_LastModified);
a811 1
        dbmopen(%infobase, $PathTo{WikiInfoBase}, 0666) or &print_error("(dbmopen) $PathTo{WikiInfoBase}");
d815 1
a815 2
        tie(%infobase, "AnyDBM_File", $PathTo{WikiInfoBase}, O_RDWR|O_CREAT, 0666) or &print_error("(tie AnyDBM_File) $PathTo{WikiInfoBase}");
    } elsif ($modifier_dbtype eq 'YukiWikiDB') {
d818 1
a818 2
        tie(%infobase, "Yuki::YukiWikiDB", $PathTo{WikiInfoBase}) or &print_error("(tie Yuki::YukiWikiDB) $PathTo{WikiInfoBase}");
    } else {
a820 1
        tie(%infobase, $modifier_dbtype => $PathTo{WikiInfoBase}, -lock => 2) or &print_error("(tie $modifier_dbtype) $PathTo{WikiInfoBase}");
a826 1
        dbmclose(%infobase);
a828 1
        untie(%infobase);
d953 1
a953 1
    if ($form{myLastModified} eq &get_info($page, $info_LastModified)) {
a984 18

sub get_info {
    my ($page, $key) = @@_;
    my %info = map { split(/=/, $_, 2) } split(/\n/, $infobase{$page});
    return $info{$key};
}

sub set_info {
    my ($page, $key, $value) = @@_;
    my %info = map { split(/=/, $_, 2) } split(/\n/, $infobase{$page});
    $info{$key} = $value;
    my $s = '';
    for (keys %info) {
        $s .= "$_=$info{$_}\n";
    }
    $infobase{$page} = $s;
}

d986 1
a986 1
    my ($isfrozen) = &get_info($form{mypage}, $info_IsFrozen);
d1000 1
a1000 8
sub is_frozen {
    my ($page) = @@_;
    if (&get_info($page, $info_IsFrozen)) {
        return 1;
    } else {
        return 0;
    }
}
d1055 1
a1055 1
        my $lastmodified = &get_info($form{mypage}, $info_LastModified);
d1237 1
a1237 1
            'dc:date'	=> &get_info ($title, $info_LastModified),
a1264 1
sub __set_database ($$) { $database{ $_[0] } = $_[1] }
d1318 1
a1318 4
sub get ($) {
  my $page = shift;
  split /"/, main::get_info ($page, 'Referer');
}
d1322 1
a1322 1
  main::set_info ($page, Referer => join '"', %$list);
d1415 5
@


1.45
log
@*** empty log message ***
@
text
@d10 1
a12 1
use Yuki::DiffText qw(difftext);
d28 2
a29 1
my %database;
a30 1
my %diffbase;
a33 1
    $PageName{IndexPage} => 'index',
a42 1
    index => \&do_index,
a201 23
sub do_index {
  wiki::referer::add ($form{mypage}, $ENV{HTTP_REFERER});
  wiki::useragent::add ($ENV{HTTP_USER_AGENT});
    &print_header($PageName{IndexPage});
    print qq(<ul>);
    foreach my $page (sort keys %database) {
        if (&is_editable($page)) {
            print qq(<li><a href="$url_cgi?@@{[&encode($page)]}">@@{[&escape($page)]}</a>@@{[&escape(&get_subjectline($page))]}</li>);
        }
    }
    print qq(</ul>);
    my ($r, $c) = get_search_result ($form{mypage});
    if ($c) {
      print qq{<h2 @@{[&id_and_name('wikipage-see-also')]}>@@{[&Resource('SeeAlso',escape=>1)]}</h2>};
      print $r;
    }
    my $rl = wiki::referer::list_html ($form{mypage});
    if ($rl) {
	print qq(<div @@{[&id_and_name('wikipage-referer')]}><h2>@@{[&Resource('Referers',escape=>1)]}</h2>\n$rl</div>\n);
    }
    &print_footer($PageName{IndexPage});
}

a217 9
    # Making diff
    {
        &open_diff;
        my @@msg1 = split(/\n/, $database{$form{mypage}});
        my @@msg2 = split(/\n/, $form{mymsg});
        $diffbase{$form{mypage}} = &difftext(\@@msg1, \@@msg2);
        &close_diff;
    }

d219 4
a222 4
        $database{$form{mypage}} = $form{mymsg};
        if ($form{mytouch}) {
            &set_info($form{mypage}, $info_LastModified, time);
            &update_recent_changes;
a238 3
        if ($form{mytouch}) {
            &update_recent_changes;
        }
d371 1
a371 1
    <a href="$url_cgi?RecentChanges" class="wiki" title="@@{[&Resource('GoToRecentChangesLong',escape=>1)]}">@@{[&Resource('GoToRecentChanges',escape=>1)]}</a>
d386 1
a386 1
    push @@link, {rel=>'News', href=>"$url_cgi?RecentChanges", class=>"wiki", title=>&Resource('GoToRecentChangesLink')};
d395 1
a395 1
    push @@link, {rel=>'history', href=>"$url_cgi?mycmd=diff;mypage=@@{[&encode($page)]}", title=>&Resource('ViewDiffOfThisPageLink'), class=>'wiki-command'};
a611 1
    $line =~ s%\[Q\[([^]]+)\](?: \[&lt;([\x21-\x5A\x5E-\x7E]+)&gt;\])?\]%¡Ö<q@@{[$2?qq( cite="$2"):'']}>$1</q>¡×%g;
d622 1
a622 1
        return &embedded_to_html($1);
a790 24
sub update_recent_changes {
    my $update = "- @@{[&get_now]} [[$form{mypage}]] @@{[&get_subjectline($form{mypage})]}";
    my @@oldupdates = split(/\x0D?\x0A/, $database{RecentChanges});
    shift @@oldupdates; ## '#?' magic line
    my @@updates;
    foreach (@@oldupdates) {
        /^\- \d\d\d\d\-\d\d\-\d\d \d\d:\d\d \[\[([^]]+)\]\]/;
        my $name = $1;
        if ($name ne $form{mypage}) {
            push @@updates, $_;
        }
    }
    if (&is_exist_page($form{mypage})) {
      unshift @@updates, $update;
    }
    splice @@updates, (&Resource ('RecentChanges:Max') || 50) + 1;
    $database{RecentChanges} = "#?SuikaWiki/0.9\n" . join("\n", @@updates);
    if ($PathTo{TouchFile}) {
        open(FILE, "> ".$PathTo{TouchFile});
        print FILE localtime() . "\n";
        close(FILE);
    }
}

d819 1
a819 1
    } else {
d823 4
a833 3
    } elsif ($modifier_dbtype eq 'AnyDBM_File') {
        untie(%database);
        untie(%infobase);
a839 20
sub open_diff {
    if ($modifier_dbtype eq 'dbmopen') {
        dbmopen(%diffbase, $PathTo{WikiDiffBase}, 0666) or &print_error("(dbmopen) $PathTo{WikiDiffBase}");
    } elsif ($modifier_dbtype eq 'AnyDBM_File') {
        tie(%diffbase, "AnyDBM_File", $PathTo{WikiDiffBase}, O_RDWR|O_CREAT, 0666) or &print_error("(tie AnyDBM_File) $PathTo{WikiDiffBase}");
    } else {
        tie(%diffbase, "Yuki::YukiWikiDB", $PathTo{WikiDiffBase}) or &print_error("(tie Yuki::YukiWikiDB) $PathTo{WikiDiffBase}");
    }
}

sub close_diff {
    if ($modifier_dbtype eq 'dbmopen') {
        dbmclose(%diffbase);
    } elsif ($modifier_dbtype eq 'AnyDBM_File') {
        untie(%diffbase);
    } else {
        untie(%diffbase);
    }
}

a1215 3
    #&Jcode::convert($contentref, $code);       # for Jcode.pm
#    &jcode::convert($contentref, $code);       # for jcode.pl
    #&Jcode::tr ($contentref, "\xA3\xB0-\xA3\xB9\xA3\xC1-\xA3\xDA\xA3\xE1-\xA3\xFA\xA1\xF5\xA1\xA4\xA1\xA5\xA1\xA7\xA1\xA8\xA1\xA9\xA1\xAA\xA1\xAE\xA1\xB0\xA1\xB2\xA1\xBF\xA1\xC3\xA1\xCA\xA1\xCB\xA1\xCE\xA1\xCF\xA1\xD0\xA1\xD1\xA1\xDC\xA1\xF0\xA1\xF3\xA1\xF4\xA1\xF6\xA1\xF7\xA1\xE1\xA2\xAF\xA2\xB0\xA2\xB2\xA2\xB1\xA1\xE4\xA1\xE3\xA1\xC0\xA1\xA1" => q(0-9A-Za-z&,.:;?!`^_/|()[]{}+$%#*@@='"~-><\ )) if $code eq 'euc';
a1220 5
    if (not &is_editable($form{mypage})) {
        &do_read;
        return;
    }
    &open_diff;
d1223 1
a1223 3
    $_ = &escape($diffbase{$form{mypage}});
    &close_diff;
    print qq(<h3>@@{[&Resource('Diff:Title',escape=>1)]}</h3>);
d1226 1
a1226 1
    foreach (split(/\n/, $_)) {
d1433 1
a1433 1
  &main::__set_database ($main::PageName{UserAgentList} => $s);
d1580 1
a1580 6
wiki.cgi - This is YukiWiki, yet another Wiki clone.
walwiki.cgi based on yukiwiki.cgi - Yet another WikiWikiWeb clone.

=head1 DESCRIPTION

YukiWiki is yet another Wiki clone.
d1582 1
a1582 3
YukiWiki can treat Japanese WikiNames (enclosed with [[ and ]]).
YukiWiki provides 'InterWiki' feature, RDF Site Summary (RSS),
and some embedded commands (such as [[#comment]] to add comments).
d1584 1
a1584 1
Read F<readme_en.txt> (English) or F<readme_ja.txt> (Japanese) in more detail.
d1586 1
a1586 1
=head1 AUTHOR
d1588 1
a1588 1
Hiroshi Yuki <hyuki@@hyuki.com> http://www.hyuki.com/yukiwiki/
d1592 1
a1592 1
Copyright (C) 2000-2002 by Hiroshi Yuki.
@


1.44
log
@*** empty log message ***
@
text
@d21 1
a21 1
our (%PageName,$kanjicode,$lang,%fixedpage);
a35 1
    AdminChangePassword => 'adminchangepasswordform',
a41 1
    adminchangepasswordform => \&do_adminchangepasswordform,
d94 1
a94 1
      print &text_to_html (q([[#comment]])) if $cf !~ /obsoleted="yes"/ && !$fixedpage{$form{mypage}};
d142 1
a142 1
        &print_header($page, -noindex => 1);
d145 1
a145 1
        &print_header($page, -noindex => 1);
d167 1
a167 1
    &print_header($page, -noindex => 1);
a176 6
sub do_adminchangepasswordform {
    &print_header('AdminChangePassword', -noindex => 1);
    &print_passwordform;
    &print_footer('AdminChangePassword');
}

a183 5
#            &send_mail_to_admin(<<"EOD", "AdminChangePassword");
#myoldpassword=$form{myoldpassword}
#mynewpassword=$form{mynewpassword}
#mynewpassword2=$form{mynewpassword2}
#EOD
d199 5
a253 1
        #&send_mail_to_admin($form{mypage}, "Modify");
a270 1
        #&send_mail_to_admin($form{mypage}, "Delete");
d453 2
a454 2
  my $cvslog1 = q$Revision: 1.43 $;
  my $cvslog2 = q$Date: 2003/01/01 01:29:04 $;
d744 1
a744 1
	    $param->{form_disabled} = 1 if $fixedpage{$target_page};
a944 2
    my $escapedmypage = &escape($form{mypage});
    my $escapedmypassword = &escape($form{mypassword});
d962 1
a962 1
    @@{[ $mode{admin} ? qq(<label>@@{[&Resource('Edit:Password=',escape=>1)]}<input type="password" name="mypassword" value="$escapedmypassword" size="10"></label>) : "" ]} [@@{[do {my $n = 0;
d966 1
a966 1
    <input type="hidden" name="mypage" value="$escapedmypage">
d978 1
a978 1
        <input type="checkbox" name="mytouch" value="on" checked="checked">@@{[&Resource('Edit:UpdateTimeStamp',escape=>1)]}<br>
d980 1
a980 1
        <input type="submit" name="mypreview_write" value="@@{[&Resource('Edit:Save',escape=>1)]}" accesskey="S"><kbd>S</kbd>
a981 1
       <br>
a993 12
sub print_passwordform {
        print <<"EOD";
<form action="$url_cgi" method="post">
    <input type="hidden" name="mycmd" value="adminchangepassword">
    <label>@@{[&Resource('Password:Old=',escape=>1)]}<input type="password" name="myoldpassword" size="10"></label><br>
    <label>@@{[&Resource('Password:New1=',escape=>1)]}<input type="password" name="mynewpassword" size="10"></label><br>
    <label>@@{[&Resource('Password:New2=',escape=>1)]}<input type="password" name="mynewpassword2" size="10"></label><br>
    <input type="submit" value="@@{[&Resource('WikiForm:Change',escape=>1)]}"><br>
</form>
EOD
}

d996 1
a996 1
    if ($fixedpage{$page} || $page =~ /\s/ || $page =~ /^\#/) {
a1106 10
sub valid_password {
    my ($givenpassword) = @@_;
    my ($validpassword_crypt) = &get_info($PageName{AdminSpecialPage}, 'AdminPassword');
    if (crypt($givenpassword, $validpassword_crypt) eq $validpassword_crypt) {
        return 1;
    } else {
        return 0;
    }
}

d1504 1
d1509 1
d1512 1
a1512 1
  for (split /\n/, &main::__get_database('WikiUserAgentList')) {
d1524 1
a1524 1
  &main::__set_database ('WikiUserAgentList' => $s);
@


1.43
log
@Obsoleted YukiWiki/WalWiki files are removed.
@
text
@d8 1
a8 1
use lib qw(./WalWiki/lib);
d463 2
a464 2
  my $cvslog1 = q$Revision: 1.42 $;
  my $cvslog2 = q$Date: 2002/12/30 03:20:06 $;
@


1.42
log
@Don't specialize SearchPage, CreatePage and WikiPluginInfo.
@
text
@d10 2
a13 34
#
# You MUST modify following '$modifier_...' variables.
#
# my $modifier_dbtype = 'AnyDBM_File';  # Fast, not available on some server, page size limited.
# my $modifier_dbtype = 'dbmopen';      # Fast, not available on some server, page size limited.
my $modifier_dbtype = 'YukiWikiDB';     # Slow, available on all environment.
my $modifier_dir_data = './wikidata'; # Your data directory.
our $url_cgi = '/~wakaba/-temp/wiki/wiki';
	## - MUST be started by '/'
	## - MUST NOT include [&<>"] and/or non-URI characters
our %uri;
$uri{wiki} = $url_cgi;
$uri{cvs_wikipage} = '/gate/cvs/wakaba/suikawiki/wiki/';
$SuikaWiki::Plugin::plugin_directory = q(./SuikaWiki/Plugin/);
my $file_touch = "$modifier_dir_data/touched.txt";
##############################
#
# You MAY, but do NOT NEED modify following variables.
# 
my $dataname = "$modifier_dir_data/wiki";
my $infoname = "$modifier_dir_data/info";
my $diffname = "$modifier_dir_data/diff";
my $use_exists = 0; # If you can use 'exists' method for your DB.
##############################
my $FrontPage = 'HomePage';
my $IndexPage = 'IndexPage';
my $SearchPage = 'SearchPage';
my $CreatePage = 'CreatePage';
my $ErrorPage = 'ErrorPage';
my $RssPage = 'RssPage';
my $AdminSpecialPage = 'Admin Special Page'; # must include spaces.
my %PageName = (
  DefaultStyleForHTML	=> 'WikiHTMLStyle',
);
d18 1
a18 1
	form	=> qw/\[\[\#form(?:\(([A-Za-z0-9-]+)\))?:'((?:[^'\\]|\\.)*)':'((?:[^'\\]|\\.)*)'(?::'((?:[^'\\]|\\.)*)')?\]\]/,
d20 3
a26 11
my $kanjicode = 'euc';
my $lang = 'ja';
my %fixedpage = (
    $IndexPage => 1,
    $ErrorPage => 1,
    $RssPage => 1,
    RecentChanges => 1,
    AdminChangePassword => 1,
    CompletedSuccessfully => 1,
    WikiUserAgentList => 1,
);
d34 2
a35 2
    $IndexPage => 'index',
    $RssPage => 'rss',
d189 1
a189 1
    my ($validpassword_crypt) = &get_info($AdminSpecialPage, 'AdminPassword');
d205 1
a205 1
    &set_info($AdminSpecialPage, 'AdminPassword', $crypted);
d215 1
a215 1
    &print_header($IndexPage);
d232 1
a232 1
    &print_footer($IndexPage);
d326 1
a326 1
    &print_header($ErrorPage, -noindex => 1);
d328 1
a328 1
    &print_footer($ErrorPage);
d413 4
a416 4
    <a href="$url_cgi?$CreatePage" class="wiki" title="@@{[&Resource('GoToCreatePageLong',escape=>1)]}">@@{[&Resource('GoToCreatePage',escape=>1)]}</a> | 
    <a href="$url_cgi?$IndexPage" class="wiki" title="@@{[&Resource('GoToIndexPageLong',escape=>1)]}">@@{[&Resource('GoToIndexPage',escape=>1)]}</a> | 
    <a href="$url_cgi?$FrontPage" class="wiki" title="@@{[&Resource('GoToHomePageLong',escape=>1)]}">@@{[&Resource('GoToHomePage',escape=>1)]}</a> | 
    <a href="$url_cgi?$SearchPage" class="wiki" title="@@{[&Resource('GoToSearchPageLong',escape=>1)]}">@@{[&Resource('GoToSearchPage',escape=>1)]}</a> | 
d430 2
a431 2
    push @@link, {rel=>'index', href=>"$url_cgi?$IndexPage", class=>'wiki', title=>&Resource('GoToIndexPageLink')};
    push @@link, {rel=>'home', href=>"$url_cgi?$FrontPage", class=>'wiki', title=>&Resource('GoToHomePageLink')};
d434 2
a435 2
    push @@link, {rel=>'News', href=>"$url_cgi?$RssPage", class=>"wiki", title=>&Resource('GoToRssPageLink'), type=>'application/xml'};
    push @@link, {rel=>'search', href=>"$url_cgi?$SearchPage", class=>'wiki', title=>&Resource('GoToSearchPageLink')};
d463 2
a464 2
  my $cvslog1 = q$Revision: 1.41 $;
  my $cvslog2 = q$Date: 2002/12/25 02:04:11 $;
d806 4
d856 2
a857 2
    if ($file_touch) {
        open(FILE, "> $file_touch");
d885 2
a886 2
        dbmopen(%database, $dataname, 0666) or &print_error("(dbmopen) $dataname");
        dbmopen(%infobase, $infoname, 0666) or &print_error("(dbmopen) $infoname");
d889 2
a890 2
        tie(%database, "AnyDBM_File", $dataname, O_RDWR|O_CREAT, 0666) or &print_error("(tie AnyDBM_File) $dataname");
        tie(%infobase, "AnyDBM_File", $infoname, O_RDWR|O_CREAT, 0666) or &print_error("(tie AnyDBM_File) $infoname");
d893 2
a894 2
        tie(%database, "Yuki::YukiWikiDB", $dataname) or &print_error("(tie Yuki::YukiWikiDB) $dataname");
        tie(%infobase, "Yuki::YukiWikiDB", $infoname) or &print_error("(tie Yuki::YukiWikiDB) $infoname");
d913 1
a913 1
        dbmopen(%diffbase, $diffname, 0666) or &print_error("(dbmopen) $diffname");
d915 1
a915 1
        tie(%diffbase, "AnyDBM_File", $diffname, O_RDWR|O_CREAT, 0666) or &print_error("(tie AnyDBM_File) $diffname");
d917 1
a917 1
        tie(%diffbase, "Yuki::YukiWikiDB", $diffname) or &print_error("(tie Yuki::YukiWikiDB) $diffname");
d1134 1
a1134 1
    my ($validpassword_crypt) = &get_info($AdminSpecialPage, 'AdminPassword');
d1335 1
a1335 1
    Jcode->new ($contentref)->h2z->tr ("\xA3\xB0-\xA3\xB9\xA3\xC1-\xA3\xDA\xA3\xE1-\xA3\xFA\xA1\xF5\xA1\xA4\xA1\xA5\xA1\xA7\xA1\xA8\xA1\xA9\xA1\xAA\xA1\xAE\xA1\xB0\xA1\xB2\xA1\xBF\xA1\xC3\xA1\xCA\xA1\xCB\xA1\xCE\xA1\xCF\xA1\xD0\xA1\xD1\xA1\xDC\xA1\xF0\xA1\xF3\xA1\xF4\xA1\xF6\xA1\xF7\xA1\xE1\xA2\xAF\xA2\xB0\xA2\xB2\xA2\xB1\xA1\xE4\xA1\xE3\xA1\xC0\xA1\xA1" => q(0-9A-Za-z&,.:;?!`^_/|()[]{}+$%#*@@='"~-><\ ))->$code;
@


1.41
log
@*** empty log message ***
@
text
@d19 6
a24 5
our $url_cgi = '/~wakaba/-temp/wiki/wiki';	## MUST be started by '/'
##############################
#
# You MAY modify following variables.
#
a26 3
our %uri;
$uri{stylesheet} = $url_cgi.'?mycmd=TEXT_CSS;mypage=WikiHTMLStyle';
$uri{cvs_wikipage} = '/gate/cvs/wakaba/suikawiki/wiki/';
d43 3
a59 1
    $CreatePage => 1,
a62 1
    $SearchPage => 1,
a65 1
    WikiPluginInfo    => 1,
a74 2
    $SearchPage => 'searchform',
    $CreatePage => 'create',
a76 1
    WikiPluginInfo       => 'x_WikiPluginInfo',
a87 3
    search => \&do_search,
    create => \&do_create,
    createresult => \&do_createresult,
a92 1
    x_WikiPluginInfo	=> \&do_wikiplugininfo,
d106 1
a106 1
        &{$command_do{$form{read}}};
d131 2
a132 2
      &print_header ($form{mypage}, -last_modified => $lm,
        -content_format => $cf, -noindex => $cf =~ /obsoleted="yes"/);
d138 1
a138 1
      &print_header($form{mypage}, -last_modified => $lm);
d161 1
a182 1
    &print_header($page, -noindex => 1);
d184 1
d187 1
d190 1
a331 14
sub do_searchform {
    &print_header($SearchPage);
    &print_searchform("");
    &print_footer($SearchPage);
}

sub do_search {
    my $word = $form{mymsg};
    &print_header($SearchPage);
    &print_searchform(&escape($word));
    print scalar get_search_result ($word, -output_not_found => 1, -match_myself => 1);
    &print_footer($SearchPage);
}

a354 13
sub do_create {
    &print_header($CreatePage);
    print <<"EOD";
<form action="$url_cgi" method="post">
    <input type="hidden" name="mycmd" value="edit">
    <strong>@@{[&Resource('InputPageNameEdited',escape=>1)]}</strong><br>
    <input type="text" name="mypage" value="" size="20">
    <input type="submit" value="@@{[&Resource('WikiForm:Create',escape=>1)]}"><br>
</form>
EOD
    &print_footer($CreatePage);
}

d391 3
d404 3
a406 2
    push @@head, qq(<link rel="stylesheet" type="text/css" href="@@{[&escape($uri{stylesheet})]}")
      if $UA !~ m#Mozilla/[1-4]\.# || $UA =~ m#MSIE (?:[4-9]\.|\d\d)#;
d503 2
a504 2
  my $cvslog1 = q$Revision: 1.40 $;
  my $cvslog2 = q$Date: 2002/12/19 09:50:18 $;
d733 1
a733 1
    return qq(<a title="@@{[&Resource('JumpAndEditWikiPage',escape=>1)]}" href="$url_cgi?mycmd=edit;mypage=@@{[&escape($name)]}" class="wiki not-exist">$ename<span class="mark">@@{[&Resource('JumpAndEditWikiPageMark',escape=>1)]}</span></a>);
d791 2
a792 1
	    $definition .= ' %submit;' if $definition !~ /%submit/ && !$param->{output}->{nosubmit};
d796 2
a797 1
	    my $r = <<EOH;
d807 1
a807 3
	    $r .= <<EOH;
</form>
EOH
d829 1
a829 1
    if ($main::ENV{QUERY_STRING} && $main::ENV{QUERY_STRING} !~ /[&;=]/) {
a966 11
sub print_searchform {
    my ($word) = @@_;
    print <<"EOD";
<form action="$url_cgi" method="get">
    <input type="hidden" name="mycmd" value="read">
    <input type="text" name="mypage" value="$word" size="20">
    <input type="submit" value="@@{[&Resource('WikiForm:Search',escape=>1)]}">
</form>
EOD
}

a1461 6
sub do_wikiplugininfo {
    &print_header (q(WikiPluginInfo));
    print text_to_html (&SuikaWiki::Plugin::make_info_page);
    &print_footer (q(WikiPluginInfo));
}

d1622 2
a1639 30
}

sub make_info_page () {
    my $r = <<EOH;
EOH
    unless ($List{_all}) {
	$r .= qq('''No plugin is installed!'''\n);
    } else {
	my $index = 0;
	for my $package (sort @@{$List{_all}}) {
	    $index++;
	    my $prop = $package->property ();
	    $r .= <<EOH;
*$package

[$index] '''$prop->{name}''' (Version $prop->{version})
<$prop->{uri}>

Provide:
@@{[do{my $t = ''; for my $f (@@{$prop->{provide}||[]}) {
    $t .= qq(-''$f''\n);
    for (sort grep m#^\Q$f\E/#, keys %{$prop->{partinfo}}) {
	 $t .= qq(--''$_'' -- $prop->{partinfo}->{$_}\n);
    }
}$t}]}

EOH
	}
    }
    $r;
@


1.40
log
@Calender: New plugin
@
text
@a1 1
#
a3 4
# Copyright (C) 2000-2002 by Hiroshi Yuki.
# <hyuki@@hyuki.com>
# http://www.hyuki.com/yukiwiki/
#
a5 7
#
# walwiki.cgi based on yukiwiki.cgi - Yet another WikiWikiWeb clone.

# Walrus add (debug) start
my $walrus_log;
my $walrus_debugging = 0;
# Walrus add (debug) end
a6 1
# Libraries.
a8 1
use CGI qw(:standard);
a9 1
use Yuki::RSS;
a10 4
use Yuki::YukiWikiDB;
use AnyDBM_File;
require 'jcode.pl';
require Jcode;
a11 3
my $version = '2.0.beta1.2002-05-29';
my $walversion;
##############################
a14 3
my $modifier_mail = 'w@@suika.fam.cx';	# Your mail address, like 'walrus@@digit.que.ne.jp'.
my $modifier_url  = 'http://suika.fam.cx/~wakaba/';	# Your web page, like 'http://digit.que.ne.jp/work/'.
my $modifier_name = 'ÏÂ';	# Your name, like 'Makio Tsukamoto'.
a17 2
# my $modifier_sendmail = '/usr/sbin/sendmail -t -n'; # Your sendmail.
my $modifier_sendmail = ''; # If you don't need mail notification.
d19 1
a19 3
my $modifier_rss_title = "SuikaWiki $walversion";
my $modifier_rss_link = 'http://suika.fam.cx/~wakaba/-temp/wiki2/wiki';	# Blank is not allowed.
my $modifier_rss_description = 'This is SuikaWiki';
d26 3
a28 10
my $file_resource = "$modifier_dir_data/resource.txt";
my $file_FrontPage = "$modifier_dir_data/frontpage.txt";
my $file_conflict = "$modifier_dir_data/conflict.txt";
my $file_format = "$modifier_dir_data/format.txt";
my $url_cgi = '/~wakaba/-temp/wiki/wiki';	## MUST be started from '/'
my $url_stylesheet = $url_cgi.'?mycmd=TEXT_CSS;mypage=WikiHTMLStyle';
my $icontag = '<img src="/icons/folder" alt="*" width="40" height="40" />';
my $maxrecent = 50;
my $cols = 80;
my $rows = 20;
a35 3
my $editchar = '?';
my $subject_delimiter = ' - ';
my $use_autoimg = 1; # automatically convert image URL into <img> tag.
a37 4
my $InterWikiName = 'InterWikiName';
my $RecentChanges = 'RecentChanges';
my $AdminChangePassword = 'AdminChangePassword';
my $CompletedSuccessfully = 'CompletedSuccessfully';
a43 1
my $NAME_OF_WikiPageLicense = 'WikiPageLicense';
a45 2
my $bracket_name = '\[\[(\S+?)\]\]';
my $embedded_name = '\[\[(#\S+?)\]\]';
a46 6
##############################
my $embed_comment = '[[#comment]]';
my $embed_rcomment = '[[#rcomment]]';
my $embed_comment_Name_Prompt = 'Ì¾Á°:';
my $DEFAULT_embed_comment_name = 'Ì¾Ìµ¤·¤µ¤ó';
my $embed_interwiki = '^\[\[#(box|text|password):(\S+)\]\]$';    # Walrus add (5)
d49 1
a49 1
    form => qw/\[\[\#form(?:\(([A-Za-z0-9-]+)\))?:'((?:[^'\\]|\\.)*)':'((?:[^'\\]|\\.)*)'(?::'((?:[^'\\]|\\.)*)')?\]\]/,
a53 1
my $info_AdminPassword = 'AdminPassword';
a55 1
my $charset = 'EUC-JP';
d62 1
a62 1
    $RecentChanges => 1,
d64 2
a65 3
    $AdminChangePassword => 1,
    $CompletedSuccessfully => 1,
    #$FrontPage => 1,
a72 1
my %resource;
d80 1
a80 2
    $AdminChangePassword => 'adminchangepasswordform',
    #$FrontPage => 'FrontPage',
a95 1
    FrontPage => \&do_FrontPage,
d100 3
a102 3
    interwikibox => \&do_interwiki_box, # Walrus add (5)
    wikiform => \&do_wikiform,
    x_WikiPluginInfo  => \&do_wikiplugininfo,
a103 4
##############################
my $walversion = '2.0.beta1.wal.1';          # Walrus add (1)
##############################
# &test_convert;
d105 1
a109 1
    &init_resource;
a111 1
    &init_InterWikiName;
d115 1
a115 1
        &do_FrontPage;
d122 1
d126 1
d130 2
a131 2
  push @@toc, qq(-<a href="#wikipage-see-also">See Also</a>) if $c;
  push @@toc, qq(-<a href="#wikipage-referer">»²¾È¸µ</a>) if $rl;
d139 1
d142 1
d151 1
a151 1
      print qq{<h2 @@{[&id_and_name('wikipage-see-also')]}>See also</h2>};
d155 1
a155 1
      print qq(<div @@{[&id_and_name('wikipage-referer')]}><h2>»²¾È¸µ</h2>\n$rl</div>\n);
d157 1
d159 1
d167 2
a168 3
    my $lm = &get_info($form{mypage}, $info_LastModified);
      print scalar make_navigate_links ($form{mypage});
    print "Content-Type: text/css; charset=$charset\n";
d193 1
a193 1
        &print_message($resource{cantchange});
d195 1
a195 1
        &print_message($resource{cantchange});
d204 1
a204 1
      print q{<h2 id="wikipage-see-also">See also</h2>};
d208 1
a208 1
      print qq(<div id="wikipage-referer"><h2>»²¾È¸µ</h2>\n$rl</div>\n);
d217 1
a217 1
        &print_message($resource{cantchange});
d219 1
a219 1
        &print_message($resource{passwordneeded});
d226 1
a226 1
    &print_header($AdminChangePassword, -noindex => 1);
d228 1
a228 1
    &print_footer($AdminChangePassword);
d233 1
a233 1
        &print_error($resource{passwordmismatcherror});
d235 1
a235 1
    my ($validpassword_crypt) = &get_info($AdminSpecialPage, $info_AdminPassword);
d238 6
a243 6
            &send_mail_to_admin(<<"EOD", "AdminChangePassword");
myoldpassword=$form{myoldpassword}
mynewpassword=$form{mynewpassword}
mynewpassword2=$form{mynewpassword2}
EOD
            &print_error($resource{passworderror});
d251 1
a251 1
    &set_info($AdminSpecialPage, $info_AdminPassword, $crypted);
d253 3
a255 3
    &print_header($CompletedSuccessfully, -noindex => 1);
    &print_message($resource{passwordchanged});
    &print_footer($CompletedSuccessfully);
a265 2
            # print qq(<li>@@{[&get_info($page, $info_IsFrozen)]}</li>);
            # print qq(<li>@@{[0 + &is_frozen($page)]}</li>);
d271 1
a271 1
      print qq{<h2 @@{[&id_and_name('wikipage-see-also')]}>See also</h2>};
d276 1
a276 1
	print qq(<div @@{[&id_and_name('wikipage-referer')]}><h2>??????</h2>\n$rl</div>\n);
d288 1
a288 1
        &print_message($resource{cantchange});
d308 1
a308 1
        &send_mail_to_admin($form{mypage}, "Modify");
d310 1
a310 1
            &set_info($form{mypage}, $info_LastModified, '' . localtime);
d321 4
a324 4
        &print_header($CompletedSuccessfully, -noindex => 1, -goto => $url_cgi.'?mycmd='.&encode($form{after_edit_cmd}||'read').';mypage='.&encode($form{mypage}).qq(;x-param=@@{[time.[0..9]->[rand 10]]}$fragment));
        &print_message($resource{saved});
        &print_content("$resource{continuereading} @@{[&armor_name($form{mypage})]}");
        &print_footer($CompletedSuccessfully);
d326 1
a326 1
        &send_mail_to_admin($form{mypage}, "Delete");
d333 1
a333 1
        &print_message($resource{deleted});
d357 2
a358 5
    next if $page eq $RecentChanges || ($page eq $word && !$option{-match_myself});
    my $content = $database{$page};
    my $cf = 'SuikaWiki/0.9';
    $cf = $1 if $content =~ s/^\#\?([^\x0A\x0D]+)//s;
    next if $cf =~ /obsoleted="yes"/;
d360 1
a360 1
      my $c = $content =~ s/\Q$word\E//gi;
d363 1
a363 1
      my $c = $content =~ s/\Q$word\E//gi;
d365 1
a365 1
    } elsif (my $c = $content =~ s/\Q$word\E//gi) {
d369 2
a370 2
  my $em = sub { my $s = shift; $s =~ s#(\Q$word\E)#<em>$1</em>#gi; $s };
  my $r = join "\n", map {qq(<li>[$_->[1]] <a href ="$url_cgi?@@{[&encode($_->[0])]}" class="wiki">@@{[&$em(&escape($_->[0]))]}</a> <span class="wikipage-summary">@@{[&$em(&escape(&get_subjectline($_->[0])))]}</span></li>)} sort {$b->[1] <=> $a->[1] || $a->[0] cmp $b->[0]} @@r;
a371 1
  get_message ($resource{notfound}) if @@r == 0 && $option{-output_not_found};
d380 1
a380 1
    <strong>$resource{newpagename}</strong><br>
d382 1
a382 1
    <input type="submit" value="$resource{createbutton}"><br>
d391 2
a392 2
  my ($scheme) = 'http';
  $scheme = $1 if $main::ENV{SERVER_PROTOCOL} =~ m#([A-Za-z0-9+.%-]+)#;
a396 10
sub do_FrontPage {
    open(FILE, $file_FrontPage) or &print_error("($file_FrontPage)");
    my $content = join('', <FILE>);
    &code_convert(\$content, $kanjicode);
    close(FILE);
    &print_header($FrontPage);
    &print_content($content);
    &print_footer($FrontPage);
}

d407 3
a409 5
    my $bodyclass = "normal";
    if (&is_frozen($page) and $form{mycmd} =~ /^(read|write)$/) {
        $bodyclass = "frozen";
    }
    $bodyclass .= " wiki-page-obsoleted" if $option{-content_format} =~ /obsoleted="yes"/;
d412 2
d416 1
a416 1
	  $option{-goto} = qq(<meta http-equiv="refresh" content="0; url=$option{-goto}">);
d420 1
a420 1
	  $option{-goto} = qq(<meta http-equiv="refresh" content="0; url=&quot;@@{[&escape($option{-goto})]}&quot;">);
d423 1
a423 2
    print qq{Last-Modified: $option{-last_modified}\n} if $option{-last_modified};
    my $meta_ct = '';
d425 3
a427 3
	$meta_ct = qq{text/html; charset=@@{[&x_charset($charset)]}};
	print qq{Content-Type: $meta_ct\n};
	$meta_ct = qq{<meta http-equiv="content-type" content="$meta_ct">};
d431 1
a431 1
	print qq{Content-Type: text/html; charset=$charset\n};
d433 4
a436 2
    my $cookedpage = &encode($page);
    my $escapedpage = &escape($page);
d438 2
a439 1
    print $Links;
d444 3
a446 5
<!--
<!DOCTYPE html
    PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd"> + RUBY -->
<html lang="$lang">
a447 4
    $meta_ct$option{-goto}
    <title>$escapedpage</title>
    @@{[($UA !~ m#Mozilla/[1-4]\.# || $UA =~ m#MSIE (?:[4-9]\.|\d\d)#) ? qq(<link rel="stylesheet" type="text/css" href="@@{[&escape($url_stylesheet)]}">) : '']}
    @@{[$option{-noindex} ? q(<meta name="ROBOTS" content="NOINDEX">) : '']}
d450 1
a450 1
<body class="$bodyclass">
d452 2
a453 2
  &print_navigate_links ($page);
  print <<EOD;
d458 8
a465 6
sub x_charset ($) {
    my $charset = lc shift;
    if ($charset eq 'euc-jp') {
	$charset = 'x-euc-jp';
    } elsif ($charset eq 'shift_jis') {
	$charset = 'x-sjis';
d472 2
a473 12
    my $editable = 0;
    my $admineditable = 0;
    if (&is_frozen($page) and $form{mycmd} =~ /^(read|write)$/) {
        $editable = 0;
        #$admineditable = 1;
    } elsif (&is_editable($page) and $form{mycmd} =~ /^(read|write)$/) {
        #$admineditable = 1;
        $editable = 1;
    } else {
        $editable = 0;
    }
    my $cookedpage = &encode($page);
a475 4
    @@{[ $admineditable
        ? qq(<a title="$resource{admineditthispage}" href="$url_cgi?mycmd=adminedit;mypage=$cookedpage" class="wiki-cmd">$resource{admineditbutton}</a> | )
        : qq()
    ]}
d477 1
a477 7
        ? #qq(<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit;mypage=$cookedpage" accesskey="E">$resource{editbutton} <kbd>E</kbd></a> | )
        qq(<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit;mypage=$cookedpage" accesskey="E" class="wiki-cmd">ÊÔ½¸</a> | )
        : qq()
    ]}
    <a href="$url_cgi?mycmd=read;mypage=$cookedpage;x-param=@@{[time.[0..9]->[rand 10]]}" class="wiki-cmd">É½¼¨</a> | 
    @@{[ $admineditable
        ? qq(<a href="$url_cgi?mycmd=diff;mypage=$cookedpage" class="wiki-cmd">$resource{diffbutton}</a> | )
d480 8
a487 6
    <a href="$url_cgi?$CreatePage" class="wiki">¿·µ¬</a> | 
    <a href="$url_cgi?$IndexPage" class="wiki">$resource{indexbutton}</a> | 
    <a href="$url_cgi?$FrontPage" class="wiki">¼óÊÇ</a> | 
    <a href="$url_cgi?$SearchPage" class="wiki">$resource{searchbutton}</a> | 
    <a href="$url_cgi?mycmd=RandomJump;x-param=@@{[time.[0..9]->[rand 10]]}" class="wiki randomlink">¤É¤³¤«</a> | 
    <a href="$url_cgi?$RecentChanges" class="wiki">ºÇ¿·</a>
d495 18
a512 15
    push @@link, {rel=>'edit', href=>"$url_cgi?mycmd=edit;mypage=@@{[&encode($page)]}", class=>"wiki-command", title=>$resource{editbutton}} if &is_editable ($page) && !&is_frozen ($page);
    push @@link, {rel=>'edit', href=>"$url_cgi?mycmd=adminedit;mypage=@@{[&encode($page)]}", class=>"wiki-command", title=>$resource{admineditbutton}} if &is_editable ($page) || &is_frozen ($page);
    push @@link, {rel=>'view', href=>"$url_cgi?mycmd=read;mypage=@@{[&encode($page)]};x-p=@@{[time.[0..9]->[rand 10]]}", class=>'wiki-command', title=>'View latest version of this page'};
    push @@link, {rel=>'myself', href=>"$url_cgi?@@{[&encode($page)]}", class=>'wiki'};
    push @@link, {rel=>'index', href=>"$url_cgi?$IndexPage", class=>'wiki', title=>$resource{indexbutton}};
    push @@link, {rel=>'home', href=>"$url_cgi?$FrontPage", class=>'wiki', title=>$FrontPage};
    push @@link, {rel=>'News', href=>"$url_cgi?WikiNews", class=>'wiki', title=>'News on this wiki'};
    push @@link, {rel=>'News', href=>"$url_cgi?$RecentChanges", class=>"wiki", title=>$resource{recentchangesbutton}};
    push @@link, {rel=>'News', href=>"$url_cgi?$RssPage", class=>"wiki", title=>$resource{rssbutton}, type=>'application/xml'};
    push @@link, {rel=>'search', href=>"$url_cgi?$SearchPage", class=>'wiki', title=>$resource{searchbutton}};
    push @@link, {rel=>'help', href=>"$url_cgi?WikiHelp", class=>'wiki'};
    push @@link, {rel=>'copyright', href=>"$url_cgi?WikiPageLicense", class=>'wiki'};
    push @@link, {rel=>'jump', href=>q(javascript:var%20WikiName=prompt('Please%20input%20the%20WikiName:','','Jump%20to%20SuikaWiki');if(WikiName)%7B_content.location.href='http://suika.fam.cx/%7Ewakaba/-temp/wiki/wiki%3F'+encodeURIComponent(WikiName)%7D), class=>'wiki-cmd', title=>'Jump to...'};
    push @@link, {rel=>'jump', href=>q(javascript:var%20WikiName=prompt('Please%20input%20the%20WikiName:','','Jump%20to%20SuikaWiki');if(WikiName)%7B_content.location.href='http://suika.fam.cx/%7Ewakaba/-temp/wiki/wiki%3Fmycmd=edit;mypage='+encodeURIComponent(WikiName)%7D), class=>'wiki-cmd', title=>'Jump to (edit)...'};
    push @@link, {rel=>'lucky', href=>"$url_cgi?mycmd=RandomJump;x-param=@@{[time.[0..9]->[rand 10]]}", class=>'wiki randomlink', title=>'Somewhere'};
d532 2
a533 4
    $walrus_log = ($walrus_debugging) ? &text_to_html("----\n$walrus_log") : '';    # Walrus add (debug)
    # Walrus mod (1) start
  my $cvslog1 = q$Revision: 1.39 $;
  my $cvslog2 = q$Date: 2002/12/18 13:08:39 $;
d536 1
a536 1
@@{[ $lm ? qq(<div id="wikipage-last-modified">Last modified: $lm</div>) : '' ]}
d538 2
a539 6
<a href="http://www.hyuki.com/yukiwiki/" title="$version &copy; 2000-2002 by Hiroshi Yuki">YukiWiki</a> <a href="http://digit.que.ne.jp/work/" title="$walversion &copy; 2000-2002 by Makio Tsukamoto">WalWiki</a>
<a href="/gate/cvs/wakaba/wiki/" title="CVS Repository of this script ($cvslog2)">SuikaWiki $cvslog1</a>
<div class="navigation">
[<a href="/" title="¤³¤Î¥µ¡¼¥Ð¡¼¤Î¼óÊÇ">/</a>
<a href="/map" title="¤³¤Î¥µ¡¼¥Ð¡¼¤Î°ÆÆâ">ÃÏ¿Þ</a>
<a href="/search/" title="¤³¤Î¥µ¡¼¥Ð¡¼¤Î¸¡º÷">¸¡º÷</a>]
a540 5
<div class="myuri">
    &lt;<a href="$url_cgi?$epage">$url_cgi?$epage</a>&gt;
</div>
</div>
$walrus_log
a572 1
    my (@@txt) = split(/\n/, $txt);
d576 14
d597 1
a597 1
            push(@@result, splice(@@saved), qq(<h6 @@{[&id_and_name("i$tocnum")]}>) . &inline($1) . '</h6>');
d601 1
a601 1
            push(@@result, splice(@@saved), qq(<h5 @@{[&id_and_name("i$tocnum")]}>) . &inline($1) . '</h5>');
d605 1
a605 1
            push(@@result, splice(@@saved), qq(<h4 @@{[&id_and_name("i$tocnum")]}>) . &inline($1) . '</h4>');
d611 1
a611 1
            push(@@result, splice(@@saved), qq(<h3 @@{[&id_and_name("i$tocnum")]}>) . &inline($1) . '</h3>');
d615 1
a615 1
            push(@@result, splice(@@saved), qq(<h2 @@{[&id_and_name("i$tocnum")]}>) . &inline($1) . '</h2>');
d619 1
a619 1
            push(@@result, '<li>' . &inline($2) . '</li>');
d627 1
a627 1
          push(@@result, '<li>' . $pf . &inline ($l) . '</li>');
d630 1
a630 1
            push(@@result, '<dt>' . &inline($1) . '</dt>', '<dd>' . &inline($2) . '</dd>');
d634 1
a634 1
            push(@@result, &inline($2));
d642 3
a644 5
            #push(@@result, &escape($1)); # Not &inline, but &escape
            push(@@result, &inline($1));
#       } elsif (/^\,(.*)$/) {             # Walrus del (BF)
        } elsif (/^\,(.*?)[\x0D\x0A]*$/) { # Walrus add (BF)
            &back_push('table', 1, \@@saved, \@@result, ' border="1"');
d658 1
a658 1
                    $value[$i] = sprintf('<td%s%s>%s</td>', $align[$i], $colspan[$i], &inline($value[$i]));
d675 1
a675 1
          push @@result, &inline ($2);
d677 1
a677 1
            push(@@result, &inline($_));
d718 2
a719 2
sub inline {
    my ($line) = @@_;
d732 2
a733 2
      ((?:$bracket_name))	# [[likethis]], [[#comment]], [[Friend:remotelink]]
      |\[\[([^[]+?)]&gt;&gt;([0-9]+)]	# [[WikiName]>>1]
d739 1
a739 1
        &make_link($l)
d762 1
a762 1
    return qq(<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit;mypage=@@{[&escape($name)]}" class="wiki not-exist">$ename<span class="mark">$editchar</span></a>);
d776 1
d778 1
d783 1
a783 1
        qq(&lt;Ì¤ÅÐÏ¿¤Î <a href="$url_cgi?InterWikiName" class="wiki">InterWikiName</a>: @@{[&escape ($site)]}>);
d786 1
a786 1
      qq(&lt;ÉÔÀµ¤Ê <a href="$url_cgi?InterWikiName" class="wiki">InterWikiName</a>: @@{[&escape($uri)]}>);
d805 1
a805 1
my $FormIndex = 0;
d842 1
a842 28
        q(<ins class="wiki-error"><strong>Warning</strong>: form in embeded page is currently not supported.</ins>);
    }
}

## to be obsoleted
sub make_link {
    my $chunk = shift;
    # Walrus add (3) start
    $chunk =~ s/^&lt;(.*)&gt;$/$1/;
    my $name  = $chunk;
    $name = &unarmor_name($name);
    # Walrus add (3) end
    if ($chunk =~ /^$embedded_name$/) {
        return &embedded_to_html($chunk);
    } else {
        $chunk = &unarmor_name($chunk);
        $chunk = &unescape($chunk); # To treat '&' or '>' or '<' correctly.
        my $cookedchunk = &encode($chunk);
        if ($database{$chunk}) {
            my $subject = &escape(&get_subjectline($chunk, delimiter => ''));
#           return qq(<a title="$subject" href="$url_cgi?$cookedchunk">$chunk</a>);  # Walrus del (3)
            return qq(<a title="$subject" href="$url_cgi?$cookedchunk" class="wiki">@@{[&escape($name)]}</a>);   # Walrus add (3)
        } elsif ($page_command{$chunk}) {
#           return qq(<a title="$chunk" href="$url_cgi?$cookedchunk">$chunk</a>);    # Walrus del (3)
            return qq(<a title="$chunk" href="$url_cgi?$cookedchunk" class="wiki">@@{[&escape($name)]}</a>);     # Walrus add (3)
        } else {
            return qq(<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit;mypage=$cookedchunk" class="wiki">@@{[&escape($name)]}<span class="mark">$editchar</span></a>);
        }
d844 1
a844 1
}
d848 1
a848 6
    print qq(<p><strong>$msg</strong></p>);
}

sub get_message {
    my ($msg) = @@_;
    qq(<p><strong>$msg</strong></p>);
d852 4
a855 4
    if (param()) {
        foreach my $var (param()) {
            $form{$var} = param($var);
      }
d857 1
a857 1
    $form{mypage} = &code_convert(\$form{mypage}, $kanjicode);
d868 11
d905 3
a907 3
    my $update = "- @@{[&get_now]} [[@@{[&escape($form{mypage})]}]] @@{[&get_subjectline($form{mypage})]}";
    my @@oldupdates = split(/\r?\n/, $database{$RecentChanges});
    shift (@@oldupdates); ## '#?' magic line
d910 1
a910 1
        /^\- \d\d\d\d\-\d\d\-\d\d \([^)]+\) \d\d:\d\d \[\[(\S+?)\]\]/;
d919 2
a920 2
    splice(@@updates, $maxrecent + 1);
    $database{$RecentChanges} = "#?SuikaWiki/0.9\n" . join("\n", @@updates);
d928 1
d931 12
a942 2
    if (not &is_editable($page)) {
        return "";
d944 1
a944 11
        # Delimiter check.
        my $delim = $subject_delimiter;
        if (defined($option{delimiter})) {
            $delim = $option{delimiter};
        }

        # Get the subject of the page.
        my $subject = $database{$page};
        $subject =~ s#^(?:\#\?)?SuikaWiki/0.9[^\x0D\x0A]*[\x0D\x0A]+##s;
        $subject =~ s/\r?\n.*//s;
        return "$delim$subject".$option{tail};
d946 1
a946 28
}

sub send_mail_to_admin {
    my ($page, $mode) = @@_;
    return unless $modifier_sendmail;
    my $message = <<"EOD";
To: $modifier_mail
From: $modifier_mail
Subject: [Wiki]
MIME-Version: 1.0
Content-Type: text/plain; charset=ISO-2022-JP
Content-Transfer-Encoding: 7bit

--------
MODE = $mode
REMOTE_ADDR = $ENV{REMOTE_ADDR}
REMOTE_HOST = $ENV{REMOTE_HOST}
--------
$page
--------
$database{$page}
--------
EOD
    &code_convert(\$message, 'jis');
    open(MAIL, "| $modifier_sendmail");
    print MAIL $message;
    close(MAIL);
}
d953 1
d957 1
d1002 1
a1002 1
    <input type="submit" value="$resource{searchbutton}">
d1014 2
a1015 2
                print qq(<h3>$resource{previewtitle}</h3>\n);
                print qq($resource{previewnotice}\n);
d1021 1
a1021 1
            print qq($resource{previewempty});
d1036 1
a1036 1
    } elsif ($magic =~ /Config/ || $magic =~ /CSS/) {
d1041 2
a1042 2
<option value="read" label="View changed page"@@{[$selected eq 'read' ? ' selected="selected"':'']}>read</option>
<option value="edit" label="Edit changed page"@@{[$selected eq 'edit' ? ' selected="selected"':'']}>edit</option>
d1048 3
a1050 3
<h2>$escapedmypage¤ÎÊÔ½¸</h2>
    @@{[ $mode{conflict} ? '' : qq(<input type="submit" name="mypreview_write" value="$resource{savebutton}"><kbd>S</kbd>) ]}
    @@{[ $mode{admin} ? qq($resource{frozenpassword} <input type="password" name="mypassword" value="$escapedmypassword" size="10">) : "" ]} [@@{[do {my $n = 0;
d1055 1
a1055 1
    <textarea cols="$cols" rows="$rows" name="mymsg" tabindex="1">$mymsg</textarea><br>
d1059 2
a1060 2
    <input type="radio" name="myfrozen" value="1" @@{[$frozen ? qq(checked="checked") : ""]}>$resource{frozenbutton}
    <input type="radio" name="myfrozen" value="0" @@{[$frozen ? "" : qq(checked="checked")]}>$resource{notfrozenbutton}<br>)
d1066 3
a1068 3
        <input type="checkbox" name="mytouch" value="on" checked="checked">$resource{touch}<br>
        <input type="submit" name="mypreview_$edit" value="$resource{previewbutton}">
        <input type="submit" name="mypreview_write" value="$resource{savebutton}" accesskey="S"><kbd>S</kbd>
d1076 2
a1077 2
        # Show the format rule.
        my $help = $database{'WikiEditHelp'};
a1079 5
    #    open(FILE, $file_format) or &print_error("($file_format)");
    #    my $content = join('', <FILE>);
    #    &code_convert(\$content, $kanjicode);
    #    close(FILE);
    #    print &text_to_html($content, toc=>0);
d1087 4
a1090 4
    $resource{oldpassword} <input type="password" name="myoldpassword" size="10"><br>
    $resource{newpassword} <input type="password" name="mynewpassword" size="10"><br>
    $resource{newpassword2} <input type="password" name="mynewpassword2" size="10"><br>
    <input type="submit" value="$resource{changepasswordbutton}"><br>
d1114 1
a1114 1
    if ($name =~ /^$bracket_name$/) {
a1140 11
sub init_resource {
    open(FILE, $file_resource) or &print_error("(resource)");
    while (<FILE>) {
        s/[\x0A\x0D]+$//g;
        next if /^#/;
        my ($key, $value) = split(/=/, $_, 2);
        $resource{$key} = &code_convert(\$value, $kanjicode);
    }
    close(FILE);
}

a1145 4
    open(FILE, $file_conflict) or &print_error("(conflict)");
    my $content = join('', <FILE>);
    &code_convert(\$content, $kanjicode);
    close(FILE);
d1147 1
a1147 1
    &print_content($content);
d1154 1
a1154 3
    my (@@week) = qw(Sun Mon Tue Wed Thu Fri Sat);
    my (@@week) = qw(Æü ·î ²Ð ¿å ÌÚ ¶â ÅÚ);
    my ($sec, $min, $hour, $day, $mon, $year, $weekday) = localtime(time);
d1162 1
a1162 2
    $weekday = $week[$weekday];
    return "$year-$mon-$day ($weekday) $hour:$min";
d1166 1
a1166 1
  my @@content = split /\n/, $database{$InterWikiName};
d1172 1
a1172 17
  require Message::Util::Formatter;
  $fmt{interwiki} = Message::Util::Formatter->new;
  $fmt{interwiki}->{encoded} = sub {
    my ($o, $p) = @@_;
    if ($o->{except}) {
      $o->{except} =~ tr/\x00-\x20\x22%\x2D<>^[\x5C]`{|}\x7F-\xFF//d;
    }
    my $s = &code_convert (\$p->{name}, $o->{charset} || 'iso-2022-7bit');
    $s =~ s/([^$o->{except}A-Za-z0-9_-])/sprintf '%%%02X', unpack 'C', $1/ge;
    $s;
  };
  $fmt{interwiki}->{ykwk} = sub {	## YukiWiki1
    my ($o, $p) = @@_;
    my $s = $p->{name};
    $s = qq([[$s]]) if $s !~ /^[A-Z][a-z]+(?:[A-Z][a-z]+)+$/;
    &encode (&code_convert (\$p->{name}, $o->{charset} || 'shift_jis'));
  };
d1203 1
a1203 1
        &print_error($resource{passworderror});
d1210 1
a1210 1
    my ($validpassword_crypt) = &get_info($AdminSpecialPage, $info_AdminPassword);
d1232 1
a1232 1
    my $namestr = $form{myname} || $default_name || $DEFAULT_embed_comment_name;
d1241 1
a1241 1
    $content =~ s{(\Q$embed_comment\E|\Q$embed_rcomment\E)}{
d1244 1
a1244 1
        if ($embed eq $embed_comment) {
d1278 1
a1278 1
    if ($embedded eq $embed_comment or $embedded eq $embed_rcomment) {
d1288 1
a1288 1
    $embed_comment_Name_Prompt
d1291 1
a1291 1
    <input type="submit" value="$resource{commentbutton}" class="comment-submit">
d1299 1
a1299 1
    $embed_comment_Name_Prompt
a1301 1
    <input type="submit" value="$resource{commentbutton}" disabled="disabled">
a1306 5
    # Walrus add (5) start
    } elsif ($embedded =~ /$embed_interwiki/ and my $remoteurl = $interwiki{$2}) {
        $_ = &make_interwiki_box($1, $2);
        return ($_) ? $_ : $embedded;
    # Walrus add (5) end
d1319 1
a1319 1
        $r = &text_to_html ("[INS[\nËä¤á¹þ¤Þ¤ì¤Æ¤¤¤ë [[$name]] ¤Ï¤Þ¤À½ñ¤«¤ì¤Æ¤¤¤Þ¤»¤ó¡£\n]INS]\n", content_format => 'SuikaWiki/0.9');
d1322 1
a1322 1
      $r = &text_to_html ("[INS[\n[[$name]] ¤ÎËä¤á¹þ¤ß¤Ï (Æþ¤êÁÈ¤ó¤Ç¤¤¤ë¤Î¤Ç) ²ò·è¤µ¤ì¤Þ¤»¤ó¤Ç¤·¤¿¡£\n]INS]\n", content_format => 'SuikaWiki/0.9');
d1335 1
d1363 1
a1363 1
            $param->{default_name} ||= $DEFAULT_embed_comment_name;
a1400 36

# Walrus add (5) start
sub do_interwiki_box {
    my $remoteurl = $interwiki{$form{'myintername'}};
    if ($remoteurl) {
        $remoteurl =~ s/\b(euc|sjis|ykwk|asis|isbn)\(\$1\)/&interwiki_convert($1, $form{'mylocalname'})/e;
        print "Location: $remoteurl\n\n";
        exit(1);
    } else {
        &do_read;
    }
}
# Walrus add (5) end

# Walrus add (5) start
sub make_interwiki_box {
    my ($localname, $intername) = @@_;
    my %ignoretype = (
        'box'      => 'text',
        'text'     => 'text',
        'pass'     => 'password',
        'password' => 'password'
    );
    my $converted = ($ignoretype{$localname}) ? <<EOD : undef;
<form action="$url_cgi" method="post">
    <input type="hidden" name="mycmd" value="interwikibox">
    <input type="hidden" name="mypage" value="$form{mypage}">
    <input type="hidden" name="myintername" value="$intername">
    $intername:
    <input type="$ignoretype{$localname}" name="mylocalname" value="" size="10">
    <input type="submit" value="Submit">
</form>
EOD
}
# Walrus add (5) end

d1402 1
d1408 1
a1408 1
    &Jcode::convert($contentref, $code);       # for Jcode.pm
d1410 2
a1411 1
    &jcode::tr ($contentref, "\xA3\xB0-\xA3\xB9\xA3\xC1-\xA3\xDA\xA3\xE1-\xA3\xFA\xA1\xF5\xA1\xA4\xA1\xA5\xA1\xA7\xA1\xA8\xA1\xA9\xA1\xAA\xA1\xAE\xA1\xB0\xA1\xB2\xA1\xBF\xA1\xC3\xA1\xCA\xA1\xCB\xA1\xCE\xA1\xCF\xA1\xD0\xA1\xD1\xA1\xDC\xA1\xF0\xA1\xF3\xA1\xF4\xA1\xF6\xA1\xF7\xA1\xE1\xA2\xAF\xA2\xB0\xA2\xB2\xA2\xB1\xA1\xE4\xA1\xE3\xA1\xC0\xA1\xA1" => q(0-9A-Za-z&,.:;?!`^_/|()[]{}+$%#*@@='"~-><\ )) if $code eq 'euc';
a1414 63
sub test_convert {
    my $txt = &text_to_html(<<"EOD", toc=>1);
*HEADER1
**HEADER1-1
-ITEM1
-ITEM2
-ITEM3
PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
PAR1PAR1PAR1PAR1PAR1PAR1''BOLD''PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1

PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2
PAR2PAR2PAR2PAR2PAR2PAR2'''ITALIC'''PAR2PAR2PAR2PAR2PAR2PAR2PAR2
PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2
**HEADER1-2
:TERM1:DESCRIPTION1 AND ''BOLD''
PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
PAR1PAR1PAR1PAR1PAR1PAR1''BOLD''PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
:TERM2:DESCRIPTION2
:TERM3:DESCRIPTION3
----
*HEADER2
**HEADER2-1
http://www.hyuki.com/
**HEADER2-2

[[YukiWiki2]]

PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
PAR1PAR1PAR1PAR1PAR1PAR1'''''BOLD ITALIC'''''PAR1PAR1PAR1PAR1PAR1
PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
>PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2
>PAR2PAR2PAR2PAR2PAR2PAR2'''ITALIC'''PAR2PAR2PAR2PAR2PAR2PAR2PAR2
>PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2

LEVEL0LEVEL0LEVEL0LEVEL0LEVEL0LEVEL0LEVEL0

>LEVEL1
>LEVEL1
>LEVEL1
>>LEVEL2
>>LEVEL2
>>LEVEL2
>>>LEVEL3
-HELLO-1
--HELLO-2
(HELLO-2, HELLO-2, HELLO-2)
---HELLO-3
(HELLO-3, HELLO-3, HELLO-3)
--HELLO-2
---HELLO-3
--HELLO-2
---HELLO-3
>>>LEVEL3
>>>LEVEL3
>>>LEVEL3
>>>LEVEL3
EOD
    print $txt;
    exit;
}

d1425 2
a1426 2
    print qq(<h3>$resource{difftitle}</h3>);
    print qq($resource{diffnotice});
d1430 1
a1430 1
            print qq(<b class="added">$1</b>\n);
d1432 1
a1432 1
            print qq(<s class="deleted">$1</s>\n);
a1439 1
    print qq(<hr>);
d1444 1
d1447 8
a1454 1
        encoding => $charset,
d1457 4
a1460 3
        title => $modifier_rss_title,
        link  => $modifier_rss_link,
        description => $modifier_rss_description,
d1462 1
a1462 1
    my $recentchanges = $database{$RecentChanges};
d1466 10
a1475 11
        /^\- \d\d\d\d\-\d\d\-\d\d \([^)]+\) \d\d:\d\d:\d\d (\S+)/;    # date format.
        my $title = &unarmor_name($1);
        my $escaped_title = &escape($title);
        my $link = $modifier_rss_link . '?' . &encode($title);
        my $description = $escaped_title . &escape(&get_subjectline($title));
        $rss->add_item(
            title => $escaped_title,
            link  => $link,
            description => $description,
        );
        $count++;
a1477 1
print scalar &make_navigate_links ('RssPage');
d1479 1
a1479 1
Content-type: application/xml
d1485 5
d1508 32
d1642 17
d1718 88
d1815 1
@


1.39
log
@*** empty log message ***
@
text
@d625 2
a626 2
  my $cvslog1 = q$Revision: 1.38 $;
  my $cvslog2 = q$Date: 2002/12/15 06:08:33 $;
a905 1
	    $definition .= ' %submit;' if $definition !~ /%submit/;
d909 1
@


1.38
log
@(make_navigate_links): Add two jumps, one lucky.
@
text
@d625 2
a626 2
  my $cvslog1 = q$Revision: 1.37 $;
  my $cvslog2 = q$Date: 2002/12/13 06:17:44 $;
d1857 1
a1857 1
  $s =~ s/([\x00-\x08\x0A-\x1F\x25\x7F-\xFF])/sprintf '%%%02X', unpack 'C', $1/g;
@


1.37
log
@*** empty log message ***
@
text
@d601 3
d625 2
a626 2
  my $cvslog1 = q$Revision: 1.36 $;
  my $cvslog2 = q$Date: 2002/12/10 07:27:38 $;
d1334 1
a1334 1
      $o->{except} =~ tr/\x00-\x20\x22\x23%\x2D<>^[\x5C]`{|}\x7F-\xFF//d;
@


1.36
log
@*** empty log message ***
@
text
@d220 2
d317 2
d329 9
d563 1
a563 1
        ? qq(<a title="$resource{admineditthispage}" href="$url_cgi?mycmd=adminedit;mypage=$cookedpage">$resource{admineditbutton}</a> | )
d568 1
a568 1
        qq(<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit;mypage=$cookedpage" accesskey="E">ÊÔ½¸</a> | )
d571 1
a571 1
    <a href="$url_cgi?mycmd=read;mypage=$cookedpage;x-param=@@{[time.[0..9]->[rand 10]]}">É½¼¨</a> | 
d573 1
a573 1
        ? qq(<a href="$url_cgi?mycmd=diff;mypage=$cookedpage">$resource{diffbutton}</a> | )
d622 2
a623 2
  my $cvslog1 = q$Revision: 1.35 $;
  my $cvslog2 = q$Date: 2002/12/05 04:32:27 $;
@


1.35
log
@*** empty log message ***
@
text
@d223 1
d238 1
a238 1
    if ($UA =~ m#Mozilla/[12]\.#) {
d361 2
a362 1
	my $fragment;
d364 1
a364 1
	    $fragment = qq(anchor-$form{__comment_anchor_index});
d366 1
a366 1
	    $fragment = qq(wikiform-$form{__wikiform_anchor_index});
d368 1
a368 1
        &print_header($CompletedSuccessfully, -noindex => 1, -goto => $url_cgi.'?mycmd=read;mypage='.&encode($form{mypage}).qq(;x-param=@@{[time.[0..9]->[rand 10]]}).($fragment?'#'.$fragment:''));
d474 2
a475 2
      if ($UA =~ m#Mozilla/[12]\.|Opera#) {
	  $option{-goto} =~ tr/;/&/;
d479 1
d490 2
d497 2
d508 1
a508 1
<head>
d511 1
a511 4
    <link rel="index" href="$url_cgi?$IndexPage">
    <link rel="help" href="$url_cgi?WikiHelp">
    <link rel="copyright" href="$url_cgi?$NAME_OF_WikiPageLicense">
    <link rel="stylesheet" type="text/css" href="@@{[&escape($url_stylesheet)]}">
d513 1
d571 31
a601 10
<<EOH;	## temp
    <a href="$url_cgi?$CreatePage" class="wiki">$resource{createbutton}</a> | 
    <a href="$url_cgi?$IndexPage" class="wiki">$resource{indexbutton}</a> | 
<!--    <a href="$url_cgi?$RssPage" class="wiki">$resource{rssbutton}</a> | -->
    <a href="$url_cgi?$FrontPage" class="wiki">$FrontPage</a> | 
    <a href="$url_cgi?$SearchPage" class="wiki">$resource{searchbutton}</a> | 
    <a href="$url_cgi?mycmd=RandomJump;x-param=@@{[time.[0..9]->[rand 10]]}" class="wiki randomlink">¤É¤³¤«</a> | 
    <a href="$url_cgi?$RecentChanges" class="wiki">$resource{recentchangesbutton}</a>
</div>
EOH
d609 2
a610 2
  my $cvslog1 = q$Revision: 1.34 $;
  my $cvslog2 = q$Date: 2002/12/04 12:00:42 $;
d670 1
a670 1
            push(@@result, splice(@@saved), qq(<h6 id="i$tocnum">) . &inline($1) . '</h6>');
d674 1
a674 1
            push(@@result, splice(@@saved), qq(<h5 id="i$tocnum">) . &inline($1) . '</h5>');
d678 1
a678 1
            push(@@result, splice(@@saved), qq(<h4 id="i$tocnum">) . &inline($1) . '</h4>');
d684 1
a684 1
            push(@@result, splice(@@saved), qq(<h3><a name="i$tocnum"> </a>) . &inline($1) . '</h3>');
d688 1
a688 1
            push(@@result, splice(@@saved), qq(<h2><a name="i$tocnum"> </a>) . &inline($1) . '</h2>');
d1145 2
d1151 12
d1167 4
a1170 1
    @@{[ $mode{admin} ? qq($resource{frozenpassword} <input type="password" name="mypassword" value="$escapedmypassword" size="10"><br>) : "" ]}
d1187 2
a1188 3
        [@@{[do {my $n = 0;
               $mymsg =~ s/(?:-+\s)?\[([0-9]+)\]/$n = $1 if $1 > $n; $&/mge;
               ++$n}]}]<br>
d1267 1
a1267 1
        chomp;
d1529 1
a1529 1
              (undef $t, last) unless length $param->{argv}->{'wikiform__'.$_};
d1730 1
d1732 1
a1732 1
Content-type: text/xml
d1821 1
a1821 1
      $r .= qq(<li>[$list{$uri}] <a href="$euri" title="URI: &lt;$euri>">@@{[main::escape ($title)]}</a></li>\n);
@


1.34
log
@*** empty log message ***
@
text
@d53 1
d122 1
d138 1
d160 1
a166 2
&main;
exit(0);
d583 2
a584 2
  my $cvslog1 = q$Revision: 1.33 $;
  my $cvslog2 = q$Date: 2002/12/03 09:34:43 $;
d853 1
a853 1
sub make_custom_form ($$$) {
d861 2
a864 6
	    unless ($fmt{form_option}) {
		$fmt{form_option} = Message::Util::Formatter->new;
		for (@@{$SuikaWiki::Plugin::List{wikiform_option}||[]}) {
		    $_->load_formatter ($fmt{form_option}, type => 'wikiform_option');
		}
	    }
d868 2
d873 2
a874 2
  <input type="hidden" name="mycmd" value="wikiform">
  <input type="hidden" name="mypage" value="@@{[&escape($form{mypage})]}">
d880 1
a880 1
	    $r .= $fmt{form_input}->replace (&unescape ($definition), $param);
a1287 5

  $fmt{form_input} = Message::Util::Formatter->new;
  for (@@{$SuikaWiki::Plugin::List{wikiform_input}||[]}) {
    $_->load_formatter ($fmt{form_input}, type => 'wikiform_input');
  }
d1453 2
a1454 4
sub do_wikiform {
    my $content = $database{$form{mypage}};
    my $anchor = &get_new_anchor_index ($content);
    for my $t (qw/form_template form_option/) {
d1462 6
d1707 6
d1816 1
d1832 45
a1876 1
use SuikaWiki::Plugin::WikiFormBasic;
@


1.33
log
@*** empty log message ***
@
text
@d100 1
a100 1
    form => qw/\[\[\#form:'((?:[^'\\]|\\.)+)':'((?:[^'\\]|\\.)+)'(?::'((?:[^'\\]|\\.)*)')?\]\]/,
d581 2
a582 2
  my $cvslog1 = q$Revision: 1.32 $;
  my $cvslog2 = q$Date: 2002/12/01 04:32:50 $;
d768 1
a768 1
    $line =~ s{$embed_command{form}}{&make_custom_form ($1, $2, $3)}ge;
d852 1
a852 2
    my ($definition, $template, $option) = @@_;
    $definition =~ s/\\(.)/$1/g;
d856 16
a871 3
	my $param = bless {}, 'SuikaWiki::Plugin';
        my $lastmodified = &get_info($form{mypage}, $info_LastModified);
	my $r = <<EOH;
d877 1
a877 1
  <input type="hidden" name="wikiform_index" value="$FormIndex">
d879 3
a881 3
    $r .= qq(<a name="wikiform-$FormIndex"></a>) if $UA =~ m#Mozilla/[12]\.#;
        $r .= $fmt{form_input}->replace (&unescape ($definition), $param);
	$r .= <<EOH;
d884 4
a1359 3

#    $content =~ s/(?:-+\s)?\[([0-9]+)\]/$anchor = $1 if $1 > $anchor; $&/mge;
 #   $anchor++;
d1472 5
a1476 4
	my ($embed, $template, $option) = ($&, $2, $3);
	$template =~ s/\\(.)/$1/g;
	$option =~ s/\\(.)/$1/g;
	if ($i == $form{wikiform_index}) {
d1480 1
d1484 1
d1486 5
a1490 1
	    my $t = $fmt{form_template}->replace ($template, $param);
d1493 2
a1495 2
		} else {
		    $embed .= "\n" . $t;
d1499 1
a1499 1
                  unless $param->{anchor_index};  ## $anchor is used!
d1501 3
a1511 1
    $form{__wikiform_anchor_index} = $form{wikiform_index};
@


1.32
log
@NN2 & IE3 & Opera6 support
@
text
@d100 1
d156 1
a158 2
my @@ignore_html_page = ('FrontPage');        # Walrus add (6)
my @@ignore_html_tags = ('a', 'br', 'img');   # Walrus add (6)
d162 1
a162 1
my $UA = '';
d235 1
a235 1
    if ($UA =~ m#Mozilla/2#) {
d358 7
a364 1
        &print_header($CompletedSuccessfully, -noindex => 1, -goto => $url_cgi.'?mycmd=read;mypage='.&encode($form{mypage}).qq(;x-param=@@{[time.[0..9]->[rand 10]]}).($form{__comment_anchor_index}?"#anchor-$form{__comment_anchor_index}":''));
d470 1
a470 1
      if ($UA =~ m#Mozilla/2|Opera#) {
d472 2
a473 1
        print qq{Refresh: 0; url=$option{-goto}\n};
d475 2
a476 1
        print qq{Refresh: 0; url="$option{-goto}"\n};
d500 1
a500 1
    $meta_ct
d578 1
d581 2
a582 2
  my $cvslog1 = q$Revision: 1.31 $;
  my $cvslog2 = q$Date: 2002/11/14 10:22:19 $;
d594 3
a601 14
#       print <<"EOD";
#   <hr>
#   <address class="footer">
#       <a href="http://www.hyuki.com/yukiwiki/">YukiWiki</a> $version
#       &copy; 2000-2002 by <a href="http://www.hyuki.com/">Hiroshi Yuki</a>.<br />
#       Modified by <a href="$modifier_url">$modifier_name</a>.
#   </address>
#   <p class="footer">
#       <a href="http://www.hyuki.com/yukiwiki/">$icontag</a>
#   </p>
#   </body>
#   </html>
#   EOD
    # Walrus mod (1) end
d768 1
d850 27
d949 3
d959 1
d1272 5
d1343 4
a1346 3
    my $anchor = 0;
    $content =~ s/(?:-+\s)?\[([0-9]+)\]/$anchor = $1 if $1 > $anchor; $&/mge;
    $anchor++;
d1375 7
d1445 56
d1787 18
@


1.31
log
@2002-11-14  Wakaba <w@@suika.fam.cx>

	* wiki.cgi: InterWiki is implemented.
@
text
@d29 1
a29 1
# use Jcode;
d119 1
d162 1
d168 1
d185 1
d196 1
a196 1
    $cf = $1 if $content =~ s#^(?:/\*\s*|[\#<]\?)?([A-Z][A-Za-z0-9-]+/[0-9.]+(?:[^0-9.][^\x0D\x0A]*)?)[\x0D\x0A]+##s;
d202 1
a202 1
      print &text_to_html (q([[#comment]])) unless $cf =~ /obsoleted="yes"/;
d208 1
a208 1
      print q{<h2 id="wikipage-see-also">See also</h2>};
d212 1
a212 1
      print qq(<div id="wikipage-referer"><h2>»²¾È¸µ</h2>\n$rl</div>\n);
d233 9
d253 1
d358 1
a358 1
        &print_header($CompletedSuccessfully, -noindex => 1, -goto => $url_cgi.'?'.&encode($form{mypage}).($form{__comment_anchor_index}?"#anchor-$form{__comment_anchor_index}":''));
d390 1
a390 1
  my $word = shift;
d399 2
a400 2
    if (index ($page, $word) > -1) {
      my $c = $content =~ s/\Q$word\E/$word/g;
d402 2
a403 2
    } elsif (index ($word, $page) > -1) {
      my $c = $content =~ s/\Q$word\E/$word/g;
d405 1
a405 1
    } elsif (my $c = $content =~ s/\Q$word\E/$word/g) {
d409 1
a409 1
  my $em = sub { my $s = shift; $s =~ s#(\Q$word\E)#<em>$1</em>#g; $s };
d463 8
a470 1
    print qq{Refresh: 0; url="$option{-goto}"\n} if $option{-goto};
d472 8
a482 1
Content-type: text/html; charset=$charset
d492 1
d508 10
d543 1
d572 2
a573 2
  my $cvslog1 = q$Revision: 1.29 $;
  my $cvslog2 = q$Date: 2002/10/21 06:28:02 $;
d770 1
a770 1
    $line =~ s{\[(INS|DEL|SUP|SUB|VAR|CODE|KBD)(?:\(([A-Za-z0-9\x20-]+)\))?\[(.+?)\]\]}{<@@{[lc $1]}@@{[$2 ? qq( class="$2") : '']}>$3</@@{[lc $1]}>}g;
d827 1
a827 1
        qq(&lt;<a href="$uri" class="out-of-wiki interwiki" title="$name ($site); URI: &lt;$uri&gt;">$name</a>&gt;);
d894 2
a895 1
    if ($main::ENV{QUERY_STRING} && $main::ENV{QUERY_STRING} !~ /[&;]/) {
d897 1
d907 1
d942 1
a942 1
    $database{$RecentChanges} = join("\n", @@updates);
d1230 1
a1230 1
      $o->{except} =~ tr/\x00-\x20<>\x23%\x22{|}\x5C^[]`\x7F-\xFF//d;
d1233 1
a1233 1
    $s =~ s/([^$o->{except}A-Za-z0-9_-])/sprintf '%02X', unpack 'C', $1/ge;
d1443 3
a1445 2
#   &Jcode::convert($contentref, $code);       # for Jcode.pm
    &jcode::convert($contentref, $code);       # for jcode.pl
d1585 1
d1665 22
@


1.30
log
@2002-10-21  Wakaba <w@@suika.fam.cx>

	* wiki.cgi:
	- Better support of random jump.
	- Output Last-Modified: field if possible.
	- Output ROBOTS -> NOINDEX as meta element if necessary.
	- Don't output summary of its own page within title element
	and page title (h1 element).
	- Simplify of navigation links and footer.
	- Add See Also and Referers to TOC.
	- Bug fix of [INS/DEL/PRE[ treatment.
	- Support of obsoleted="yes" attribute of wiki page.
	- >>\d+ support in name of comment.
@
text
@a1 1
#!perl
a11 2
##############################
#
a12 24
#
# WalWiki¤Î¸½¥Ð¡¼¥¸¥ç¥ó¤Ï¡¢YukiWiki 2.0.beta1¤ò¥Ù¡¼¥¹¤Ë¤·¤Æ¤¤¤Þ¤¹¡£
# 
# * ¹¹¿·ÆâÍÆ
# 
# 2.0.beta1.wal.1 on 2002/05/19,22:32:19
# (1) Footer¤ÎÊÑ¹¹
# (2) WikiName¤Î³ÈÄ¥ : PerlCE¤âÊñ´Þ¡¢PPMInstall¤Ï´Þ¤Þ¤Ê¤¤
# (3) ÊÌÌ¾¥ê¥ó¥¯¡Ê[ÊÌÌ¾ URL]¡Ë¤ËÂÐ±þ¡£
# (4) ISBN¤ò¥¢¥Þ¥¾¥ó.jp¤ÎAsociate¥×¥í¥°¥é¥à¥ê¥ó¥¯¤ËÊÑ´¹¡£
# (5) [[#box:InterWikiName]]¤ÇInterWiki¤Ê¥Æ¥­¥¹¥È¥Ü¥Ã¥¯¥¹À¸À®
# (6) HTML¥â¡¼¥ÉÂÐ±þ¡£
#
# µì2.0.alpha0.wal.3ÈÇ¤Þ¤Ç¤Î½¤Àµ¤ÎÆâ¡¢°Ê²¼¤ËÊÑ¹¹¤¬¤¢¤ê¤Þ¤¹¡£
# ¡¦°Ê²¼¤ÏYukiWiki2¤Ë¼ÂÁõ¤µ¤ì¤¿¤¿¤á¡¢ÆÈ¼«¥³¡¼¥É¤Ï¤Ê¤¯¤Ê¤ê¤Þ¤·¤¿¡£
#   - ¥¤¥ó¥é¥¤¥ó¤Î²èÁüÊÑ´¹
#   - YukiWikiDBÂÐ±þ
#   - ¥Æ¡¼¥Ö¥ë
#   - DB´ØÏ¢¥â¥¸¥å¡¼¥ëuse¤Îeval²½
#   - BracketName¤Ë¤è¤ë¥­¡¼¤«¤é¥Ö¥é¥±¥Ã¥È¤òÇÓ½ü
# ¡¦ISBNÈÖ¹æ¤Ø¤ÎÂÐ±þ¤ÏWalWiki2.0¤è¤ê¡¢InterWiki¤Ø¤ÎAdd-On¤Ë¤Ê¤ê¤Þ¤·¤¿¡£
#   [[ISBN http://www.amazon.co.jp/exec/obidos/ASIN/isbn($1)/walrdigi-22]]¤Î¤è¤¦¤ËÅÐÏ¿¡£
#
#=======================================
a88 2
# my $wiki_name = '\b([A-Z][a-z]+([A-Z][a-z]+)+)\b';        # Walrus del (2)
my $wiki_name   = '\b([A-Z][a-z]+([A-Z][a-z]*)+)\b';        # Walrus add (2)
d91 1
a91 2
my $interwiki_definition = '\[\[(\S+?)\ (\S+?)\]\]';
my $interwiki_name = 'i:([^:]+):([^:].*)';
d739 2
a740 5
    $line =~ s!
      (
        (?:&lt;(?:mailto|http|https|ftp|urn|news):[\x21-\x7E]*)&gt;
      |
        (?:$bracket_name))	# [[likethis]], [[#comment]], [[Friend:remotelink]]
d743 3
a745 2
    !
      my ($l, $page,$anchor, $anum) = ($1, $3,$4, 0+$5);
d752 2
d755 1
a755 1
    !gex;
d774 38
a816 8
    if ($chunk =~ /^\[\[([^ ]+?) ([^ ]+?)\]\]$/ and $form{mypage} ne $InterWikiName) {
        ($name, $chunk) = ($1, $2);
    } elsif ($chunk =~ /^mailto:(.*)$/) {
        $name = $1;
    }
    if ($use_autoimg and $name =~ /^(http|https|ftp):.+\.(png|gif|jpe?g)/) {
        $name = qq(<img src="$name">) ;
    }
d819 1
a819 18
    if ($chunk =~ /^(http|https|ftp|news):/) {
        # Walrus mod (3) start
#       if ($use_autoimg and $chunk =~ /\.(gif|png|jpeg|jpg)$/) {
#           return qq(<a href="$chunk"><img src="$chunk"></a>);
#       } else {
#           return qq(<a href="$chunk">$chunk</a>);
#       }
        return qq(&lt;<a href="$chunk">$name</a>&gt;);
        # Walrus mod (3) end
    } elsif ($chunk =~ m#^urn:[0-9A-Za-z_:;/.-]+#) {
        return qq|&lt;<a href="/uri-res/N2L?${name}">$name</a>&gt;|;
    } elsif ($chunk =~ /^mailto:(.*)/) {
#       return qq(<a href="$chunk">$2</a>);                 # Walrus del (3)
        return qq(&lt;<a href="$chunk">$name</a>&gt;);              # Walrus add (3)
    } elsif ($chunk =~ /^$interwiki_definition$/) {
#       return qq(<span class="InterWiki">$chunk</span>);   # Walrus del (3)
        return qq(<span class="InterWiki">$name</span>);    # Walrus add (3)
    } elsif ($chunk =~ /^$embedded_name$/) {
d825 1
a825 13
        if ($chunk =~ /^$interwiki_name$/) {
            my ($intername, $localname) = ($1, $2);
            my $remoteurl = $interwiki{$intername};
            if ($remoteurl) {
#               $remoteurl =~ s/\b(euc|sjis|ykwk|asis)\(\$1\)/&interwiki_convert($1, $localname)/e;      # Walrus del (4)
                $remoteurl =~ s/\b(euc|sjis|ykwk|asis|isbn)\(\$1\)/&interwiki_convert($1, $localname)/e; # Walrus add (4)
#               return qq(<a href="$remoteurl">$chunk</a>); # Walrus del (3)
                return qq(<a href="$remoteurl">@@{[&escape($name)]}</a>);  # Walrus add (3)
            } else {
#               return $chunk;                              # Walrus del (3)
                return &escape($name);                               # Walrus add (3)
            }
        } elsif ($database{$chunk}) {
d1003 2
a1004 2
    <input type="hidden" name="mycmd" value="search">
    <input type="text" name="mymsg" value="$word" size="20">
d1089 1
a1089 9
    if (&is_bracket_name($page)) {
        return 0;
    } elsif ($fixedpage{$page}) {
        return 0;
    } elsif ($page =~ /\s/) {
        return 0;
    } elsif ($page =~ /^\#/) {
        return 0;
    } elsif ($page =~ /^$interwiki_name$/) {
d1099 1
a1099 8
sub armor_name {
    my ($name) = @@_;
    #if ($name =~ /^$wiki_name$/) {
    #    return $name;
    #} else {
        return "[[$name]]";
    #}
}
a1112 9
sub is_bracket_name {
    my ($name) = @@_;
    if ($name =~ /^$bracket_name$/) {
        return 1;
    } else {
        return 0;
    }
}

a1174 1
# [[YukiWiki http://www.hyuki.com/yukiwiki/wiki.cgi?euc($1)]]
d1176 4
a1179 4
    my $content = $database{$InterWikiName};
    while ($content =~ /\[\[(\S+) +(\S+)\]\]/g) {
        my ($name, $url) = ($1, $2);
        $interwiki{$name} = $url;
d1181 18
a1200 24
sub interwiki_convert {
    my ($type, $localname) = @@_;
    if ($type eq 'sjis' or $type eq 'euc') {
        &code_convert(\$localname, $type);
        return &encode($localname);
    } elsif ($type eq 'ykwk') {
        # for YukiWiki1
        if ($localname =~ /^$wiki_name$/) {
            return $localname;
        } else {
            &code_convert(\$localname, 'sjis');
            return &encode("[[" . $localname . "]]");
        }
    } elsif ($type eq 'asis') {
        return $localname;
    # Walrus add (4) start
    } elsif ($type eq 'isbn') {
        $localname = join('', ($localname =~ /[0-9x]/g)) if ($localname =~ /^(\d-?){9}[\dx]$/);
        return $localname;
    # Walrus add (4) end
    } else {
        return $localname;
    }
}
d1351 1
a1351 1
    return qq(<blockquote title="@@{[&escape($name)]}">$r<div class="cite-note">¡Ø<cite><a href="$url_cgi?@@{[&encode($name)]}" class="wiki">@@{[&escape($name)]}</a></cite>¡Ù</div></blockquote>);
d1396 4
@


1.29
log
@2002-10-21  Wakaba <w@@suika.fam.cx>

	* wiki.cgi:
	- Better support of random jump.
	- Output Last-Modified: field if possible.
	- Output ROBOTS -> NOINDEX as meta element if necessary.
	- Don't output summary of its own page within title element
	and page title (h1 element).
	- Simplify of navigation links and footer.
	- Add See Also and Referers to TOC.
	- Bug fix of [INS/DEL/PRE[ treatment.
	- Support of obsoleted="yes" attribute of wiki page.
	- >>\d+ support in name of comment.
@
text
@d228 1
a228 1
      print &text_to_html (q([[#comment]]));
d269 10
d401 1
a401 1
    print scalar get_search_result ($word, -output_not_found => 1);
d408 3
a410 4
  my $counter = 0;
  my $r = '';
  foreach my $page (sort keys %database) {
    next if $page eq $RecentChanges;
d412 11
a422 7
    $content =~ s/^\#\?[^\x0A\x0D]+//s;
    if (   index ($content, $word) > 0
        || index ($page, $word) > 0
        || index ($word, $page) > 0
       ) {
      $r .= qq(<li><a href ="$url_cgi?@@{[&encode($page)]}" class="wiki">@@{[&escape($page)]}</a> <span class="wikipage-summary">@@{[&escape(&get_subjectline($page))]}</span></li>);
      $counter++;
d425 5
a429 4
  $r = qq|<ul>$r</ul>| if $r;
  get_message ($resource{notfound})
    if $counter == 0 && $option{-output_not_found};
  wantarray? ($r, $counter): $r;
d496 1
a497 1
    <link rev="made" href="mailto:@@{[&escape($modifier_mail)]}">
d562 2
a563 2
  my $cvslog1 = q$Revision: 1.28 $;
  my $cvslog2 = q$Date: 2002/10/17 07:56:58 $;
d668 1
a668 1
        } elsif (/^(>{1,5})(.*)/) {
d670 1
d672 1
d675 1
a676 1
            push(@@result, "<p>");
d736 5
a740 1
    return $toc . join("\n", @@result);
d760 9
a768 7
    $line =~ s:\[(INS|DEL|SUP|SUB)\[(.+?)\]\]:<@@{[lc $1]}>$2</@@{[lc $1]}>:g;
    $line =~ s:\[ABBR\[(.+?)\] \[(.+?)\]\]:<acronym title="$2">$1</acronym>:g;
    $line =~ s:\[RUBY\[(.+?)\] \[(.+?)\]\]:<ruby><rb>$1</rb><rp>(</rp><rt>$2</rt><rp>)</rp></ruby>:g;
    $line =~ s%\[Q\[(.+?)\](?: \[&lt;([\x21-\x5A\x5E-\x7E]+)&gt;\])?\]%¡Ö<q@@{[$2?qq( cite="$2"):'']}>$1</q>¡×%g;
    $line =~ s|'''([^']+?)'''|<strong>$1</strong>|g;
    $line =~ s|''([^']+?)''|<em>$1</em>|g;
    $line =~ s|(\d\d\d\d-\d\d-\d\d \(\w\w\w\) \d\d:\d\d:\d\d)|<span class="date">$1</span>|g;   # Date
d774 1
a774 1
      |\[\[([^[]+?)]&gt;&gt;([0-9]+)]
d881 1
a881 3
        }
    } else {
        $ENV{QUERY_STRING} = $FrontPage;
d883 3
a885 3

    my $query = &decode($ENV{QUERY_STRING});
    if ($page_command{$query}) {
d888 1
a888 5
    } elsif ($query =~ /^($wiki_name)$/) {
        $form{mycmd} = 'read';
        $form{mypage} = $1;
    } elsif ($database{$query}) {
        $form{mycmd} = 'read';
d890 2
d893 1
d905 1
a905 1
    #
d907 1
a907 1
    #
d1066 1
d1083 4
a1086 1
        <input type="submit" name="mypreview_write" value="$resource{savebutton}" accesskey="S"><kbd>S</kbd><br>
d1093 8
a1100 5
        open(FILE, $file_format) or &print_error("($file_format)");
        my $content = join('', <FILE>);
        &code_convert(\$content, $kanjicode);
        close(FILE);
        print &text_to_html($content, toc=>0);
d1315 5
a1319 2
    my $datestr = &get_now;
    my $namestr = $form{myname} || $DEFAULT_embed_comment_name;
d1322 1
a1322 1
    } else {
d1341 2
d1346 1
a1346 1
    if ($form{mymsg}) {
d1363 1
a1363 1
<form action="$url_cgi" method="post" id="x-comment-@@{[++$CommentIndex]}">
d1370 4
a1373 4
    <input type="text" name="myname" value="" size="10">
    <input type="text" name="mymsg" value="" size="60">
    <input type="submit" value="$resource{commentbutton}">
</form>
d1388 1
a1388 1
    return get_search_result ($1);
d1406 1
a1406 1
        $r = &text_to_html ("[[$name]]", content_format => 'SuikaWiki/0.9');
d1411 1
a1411 1
    return qq(<blockquote title="@@{[&escape($name)]}">$r</blockquote>);
@


1.28
log
@2002-10-17  Wakaba <w@@suika.fam.cx>

	* wiki.cgi: Updated.  See 
	<http://suika.fam.cx/~wakaba/-temp/wiki/wiki?%A4%B3%A4%CEwiki%A4%CE%C6%C8%BC%AB%B3%C8%C4%A5#anchor-1>.
@
text
@a210 1
  &print_header($form{mypage}, -last_modified => $lm);
d212 5
d224 4
a227 1
      &print_content($content, content_format => $cf, last_modified => $lm);
d230 1
a232 1
  my ($r, $c) = get_search_result ($form{mypage});
d234 1
a234 1
      print q{<h2 id="SEE-ALSO">See also</h2>};
d237 2
a238 3
  my $r = wiki::referer::list_html ($form{mypage});
    if ($r) {
      print qq(<div id="wikipage-referer"><h2>»²¾È¸µ</h2>\n$r</div>\n);
d246 1
d248 1
d253 1
a253 1
    &print_header('WikiPageIsNotCSS');
d261 1
a261 1
    &print_header($page);
d274 1
a274 1
    &print_header($page);
d285 1
a285 1
    &print_header($AdminChangePassword);
d312 1
a312 1
    &print_header($CompletedSuccessfully);
d337 1
a337 1
        &print_header($form{mypage});
d364 1
a364 1
        &print_header($CompletedSuccessfully, -goto => $url_cgi.'?'.&encode($form{mypage}).($form{comment_index}?"#x-comment-$form{comment_index}":''));
d375 1
a375 1
        &print_header($form{mypage});
d434 3
a436 1
  print "Location: $url_cgi?$name\n";
d452 1
a452 1
    &print_header($ErrorPage);
d464 1
d480 1
a480 1
    <title>$escapedpage @@{[&escape(&get_subjectline($page))]}</title>
d485 1
d491 1
a491 2
<h1 class="header">@@{[&escape($page)]} 
  <span class="wikipage-summary">@@{[&escape(&get_subjectline($page))]}</span></h1>
d501 1
a501 1
        $admineditable = 1;
d503 1
a503 1
        $admineditable = 1;
d516 2
a517 1
        ? qq(<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit;mypage=$cookedpage" accesskey="E">$resource{editbutton} <kbd>E</kbd></a> | )
d524 16
a539 6
    <a href="$url_cgi?$CreatePage">$resource{createbutton}</a> | 
    <a href="$url_cgi?$IndexPage">$resource{indexbutton}</a> | 
    <a href="$url_cgi?$RssPage">$resource{rssbutton}</a> | 
    <a href="$url_cgi?$FrontPage">$FrontPage</a> | 
    <a href="$url_cgi?$SearchPage">$resource{searchbutton}</a> | 
    <a href="$url_cgi?$RecentChanges">$resource{recentchangesbutton}</a>
d548 2
a549 1
  my $cvslog = '$Revision: 1.27 $ $Date: 2002/10/07 12:50:51 $';
d554 2
a555 7
<p>
<a href="http://digit.que.ne.jp/work/">WalWiki</a> $walversion &copy; 2000-2002 by <a href="http://digit.que.ne.jp/">Makio Tsukamoto</a>.<br />
based on <a href="http://www.hyuki.com/yukiwiki/">YukiWiki</a> $version &copy; 2000-2002 by <a href="http://www.hyuki.com/">Hiroshi Yuki</a>.<br />
<a href="/gate/cvs/wakaba/wiki/" title="CVS Repository">
$cvslog
</a>
</p>
d604 1
a604 1
    print &text_to_html($rawcontent, toc=>1);
d610 2
a611 1
    my (@@toc);
d689 1
a689 1
        } elsif (/^\[(INS|DEL|PRE)\[/) {
d693 1
a693 1
        } elsif (/^\](INS|DEL|PRE)\]/) {
d710 1
a710 1
        foreach (@@toc) {
d1180 1
a1180 1
    &print_header($page);
d1290 6
a1295 1
    my $namestr = " ''[[@@{[$form{myname}||$DEFAULT_embed_comment_name]}]]'': ";
d1314 1
d1500 1
a1500 1
    &print_header($title);
@


1.27
log
@2002-10-07  Wakaba <w@@suika.fam.cx>

	* wiki.cgi:
	- Output Last-Modified:.
	- Record and output referer information.
@
text
@d85 1
a85 1
my $url_cgi = 'wiki';
d180 1
d218 2
a219 2
    $cf = $1 if $content =~ s#^(?:/\*\s*|\#\?)?([A-Z][A-Za-z0-9-]+/[0-9.]+(?:[^0-9.][^\x0D\x0A]*)?)[\x0D\x0A]+##s;
    if ($cf =~ m#^SuikaWiki/0.9(?:$|\s)#) {
d394 3
a396 1
    if (   index ($database{$page}, $word) > 0
d423 7
d463 1
d466 1
a466 1
    "http://www.w3.org/TR/html4/loose.dtd">
d526 1
a526 1
  my $cvslog = '$Revision: 1.26 $ $Date: 2002/09/28 10:54:27 $';
d625 7
a631 2
            &back_push('ul', length($1), \@@saved, \@@result);
            push(@@result, '<li>' . &inline($2) . '</li>');
d670 10
a679 12
        } elsif (/^\[INS\[/) {
            push(@@result, "<ins>");
        } elsif (/^\]INS\]/) {
            push(@@result, "</ins>");
        } elsif (/^\[DEL\[/) {
            push(@@result, "<del>");
        } elsif (/^\]DEL\]/) {
            push(@@result, "</del>");
        } elsif (/^\[PRE\[/) {
            push(@@result, "<pre>");
        } elsif (/^\]PRE\]/) {
            push(@@result, "</pre>");
d721 4
d732 13
a744 9
        ($bracket_name)	# [[likethis]], [[#comment]], [[Friend:remotelink]]
      |
        ($interwiki_definition)	# [[Friend http://somewhere/?q=sjis($1)]]
      #|
      #  ($wiki_name)
      )
            !
                &make_link($1)
            !gex;
d748 15
d876 1
a876 1
    my $update = "- @@{[&get_now]} @@{[&armor_name($form{mypage})]} @@{[&get_subjectline($form{mypage})]}";
d880 4
a883 4
        /^\- \d\d\d\d\-\d\d\-\d\d \(...\) \d\d:\d\d:\d\d (\S+)/;    # date format.
        my $name = &unarmor_name($1);
        if (&is_exist_page($name) and ($name ne $form{mypage})) {
            push(@@updates, $_);
d887 1
a887 1
        unshift(@@updates, $update);
d911 1
a911 1
        $subject =~ s#^SuikaWiki/0.9[^\x0D\x0A]*[\x0D\x0A]+##s;
d1170 1
d1178 1
a1178 1
    $sec = "0$sec" if $sec < 10;
d1180 1
a1180 1
    return "$year-$mon-$day ($weekday) $hour:$min:$sec";
d1271 4
a1274 6
    my $namestr = " ''[[@@{[$form{myname}||$DEFAULT_embed_comment_name]}]]'' : ";
    #if ($content =~ s/(\Q$embed_comment\E)/- $datestr$namestr$form{mymsg}\n$1/) {
    #  ;
    #} else {
    #  $content =~ s/(\Q$embed_rcomment\E)/$1\n- $datestr$namestr$form{mymsg}/;
    #}
d1280 1
a1280 1
          $embed = "- $datestr$namestr$form{mymsg}\n$embed";  $o = 1;
d1282 1
a1282 1
          $embed .= "\n- $datestr$namestr$form{mymsg}";  $o = 1;
d1288 1
a1288 1
      $content .= "- $datestr$namestr$form{mymsg}\n";
d1304 1
d1319 12
d1338 16
a1353 2
    } else {
        return $embedded;
d1355 6
d1511 1
a1511 1
        /^\- \d\d\d\d\-\d\d\-\d\d \(...\) \d\d:\d\d:\d\d (\S+)/;    # date format.
d1579 1
a1579 1
  my %item;
d1584 2
a1585 2
    $name =~ s![()/\\]!\\$1!g;  $name =~ s/\$([0-9]+)/).__decode (\${$1}).q(/g;
    $item{$uri} = qq(q($name));
d1587 1
a1587 1
  %item;
d1594 1
a1594 1
  my %name = get_site_name;
d1597 2
a1598 2
    for my $regex (keys %name) {
      if ($uri =~ /$regex/) {
d1600 2
a1601 1
        eval qq{\$title =~ s/^.*$regex.*\$/$name{$regex}/e} or die $@@;
@


1.26
log
@2002-09-28  Wakaba <w@@suika.fam.cx>

	* wiki.cgi:
	- Intoduce text/css mode.
	- Anchorize news: URIs.
	- (armor_name): Bug fix of not anchorizing traditional Wiki name.
	- Indenting heading 3-5 in TOC.
	- Multi-comment support.
	- (print_footer): Embed #comment.
	- (print_editform): Use NewPageTemplate when new page.
	* wiki-style.css: Removed.
@
text
@d73 1
a73 1
my $modifier_rss_title = "WalWiki $walversion";
d75 1
a75 1
my $modifier_rss_description = 'This is WalWiki, yet another Wiki clone based on YukiWiki';
a207 1
  &print_header($form{mypage});
d209 3
d213 5
a217 1
    $cf = $1 if $content =~ s#^(?:/\*\s*|\#\?)?([A-Z][A-Za-z0-9-]+/[0-9.]+(?:\s[^\x0D\x0A]+)?)[\x0D\x0A]+##s;
d219 1
a219 1
      &print_content($content, $cf);
d229 5
a233 1
  &print_footer($form{mypage});
d355 1
a355 1
        &print_header($CompletedSuccessfully, -goto => $url_cgi.'?'.&encode($form{mypage}));
d397 1
a397 1
      $r .= qq(<li><a href ="$url_cgi?@@{[&encode($page)]}" class="wiki">@@{[&escape($page)]}</a>@@{[&escape(&get_subjectline($page))]}</li>);
d438 2
a439 2
sub print_header {
    my ($page,%option) = @@_;
d444 2
a445 3
    if ($option{-goto}) {
      print qq{Refresh: 0; url="$option{-goto}"\n};
    }
d468 2
a469 3
<h1 class="header"><a
    title="$resource{searchthispage}"
    href="$url_cgi?mycmd=search;mymsg=$cookedpage">@@{[&escape($page)]}</a>@@{[&escape(&get_subjectline($page))]}</h1>
d512 1
a512 1
    my ($page) = @@_;
d515 1
a515 1
  my $cvslog = '$Revision: 1.24 $ $Date: 2002/08/30 04:31:11 $';
d518 1
d574 1
a574 1
    my ($rawcontent, $format) = @@_;
d671 2
a672 1

d684 2
a685 3
        return join("\n", @@tocresult, @@result);
    } else {
        return join("\n", @@result);
d687 1
d876 1
a876 1
        return "$delim$subject";
d1239 1
a1239 1
    my $i = 0;  my $o = 0;
d1264 1
a1264 1
my $_O_COMMENT_INDEX = 0;
d1270 1
a1270 1
<form action="$url_cgi" method="post">
d1275 1
a1275 1
    <input type="hidden" name="comment_index" value="@@{[$_O_COMMENT_INDEX++]}">
d1330 3
a1332 3
    my ($contentref, $kanjicode) = @@_;
#   &Jcode::convert($contentref, $kanjicode);       # for Jcode.pm
    &jcode::convert($contentref, $kanjicode);       # for jcode.pl
d1469 81
@


1.25
log
@2002-09-28  Wakaba <w@@suika.fam.cx>

	* wiki.cgi:
	- Intoduce text/css mode.
	- Anchorize news: URIs.
	- (armor_name): Bug fix of not anchorizing traditional Wiki name.
	- Indenting heading 3-5 in TOC.
	- Multi-comment support.
	- (print_footer): Embed #comment.
	- (print_editform): Use NewPageTemplate when new page.
	* wiki-style.css: Removed.
@
text
@d113 1
d208 11
a218 4
    &print_header($form{mypage});
    &print_content($database{$form{mypage}});
    print &text_to_html (q([[#comment]]));
    my ($r, $c) = get_search_result ($form{mypage});
d220 1
a220 1
      print q{<h2>See also</h2>};
d223 1
a223 1
    &print_footer($form{mypage});
d387 1
a387 1
      $r .= qq(<li><a href ="$url_cgi?@@{[&encode($page)]}">@@{[&escape($page)]}</a>@@{[&escape(&get_subjectline($page))]}</li>);
d451 1
d564 2
a565 3
sub print_content {
    my ($rawcontent) = @@_;
    $rawcontent =~ s#^SuikaWiki/0.9[^\x0D\x0A]*[\x0D\x0A]+##s;
d620 1
a620 1
            push(@@result, &inline($1)); # Not &inline, but &escape
d645 12
d769 1
a769 1
            return qq(<a title="$subject" href="$url_cgi?$cookedchunk">@@{[&escape($name)]}</a>);   # Walrus add (3)
d1268 1
a1268 1
    <input type="text" name="mymsg" value="" size="40">
@


1.24
log
@2002-08-29  Wakaba <w@@suika.fam.cx>

	* wiki.cgi: Fix cross site problem, syncing with
	WalWiki 2.0.3.wal1 (WikiAntenna is not merged).
@
text
@d86 1
a86 1
my $url_stylesheet = 'wiki-style.css';
d120 1
a120 1
my $interwiki_name = '([^:]+):i:([^:].*)';
d124 2
d166 1
d209 1
d218 14
d498 1
a498 1
  my $cvslog = '$Revision: 1.22 $ $Date: 2002/06/30 07:52:46 $';
d557 1
d571 2
a572 2
        if (/^\*\*\*\*\*(.*)/) {
            push(@@toc, qq(-- <a href="#i$tocnum">@@{[&escape($1)]}</a>\n));
d575 2
a576 2
        } elsif (/^\*\*\*\*(.*)/) {
            push(@@toc, qq(-- <a href="#i$tocnum">@@{[&escape($1)]}</a>\n));
d579 2
a580 2
        } elsif (/^\*\*\*(.*)/) {
            push(@@toc, qq(-- <a href="#i$tocnum">@@{[&escape($1)]}</a>\n));
d583 1
a583 1
        } elsif (/^\*\*(.*)/) {
d586 1
a586 1
            push(@@toc, qq(-- <a href="#i$tocnum">@@{[&escape($1)]}</a>\n));
d589 2
a590 2
        } elsif (/^\*(.*)/) {
            push(@@toc, qq(- <a href="#i$tocnum">@@{[&escape($1)]}</a>\n));
d593 1
a593 3
        #} elsif (/^----/) {
        #    push(@@result, splice(@@saved), '<hr>');
        } elsif (/^(={1,5})(.*)/) {
d596 1
a596 1
        } elsif (/^(-{1,5})(.*)/) {
d648 1
a648 1
            if (/^(-{1,3})(.*)/) {
d682 1
a682 1
        (?:&lt;(?:mailto|http|https|ftp|urn):[\x21-\x7E]*)&gt;
d706 1
a706 1
    if ($use_autoimg and $name =~ /^(http|https|ftp|):.+\.(png|gif|jpe?g)/) {
d711 1
a711 1
    if ($chunk =~ /^(http|https|ftp):/) {
d844 1
d952 1
a952 1
        $mymsg = &escape($mymsg);
d964 1
a964 1
    <textarea cols="$cols" rows="$rows" name="mymsg" wrap="off" tabindex="1">$mymsg</textarea><br>
d1026 3
a1028 3
    if ($name =~ /^$wiki_name$/) {
        return $name;
    } else {
d1030 1
a1030 1
    }
d1203 20
a1222 5
    my $namestr = $form{myname} ? " ''[[$form{myname}]]'' : " : " ";
    if ($content =~ s/(\Q$embed_comment\E)/- $datestr$namestr$form{mymsg}\n$1/) {
        ;
    } else {
        $content =~ s/(\Q$embed_rcomment\E)/$1\n- $datestr$namestr$form{mymsg}/;
d1234 1
d1245 2
a1246 1
    $resource{yourname}
@


1.23
log
@2002-06-18  Wakaba <w@@suika.fam.cx>

	* wiki.cgi: Fix cross site scripting problems.
@
text
@d277 1
a277 1
            print qq(<li><a href="$url_cgi?@@{[&encode($page)]}">$page</a>@@{[&escape(&get_subjectline($page))]}</li>);
d346 1
a346 2
    print get_search_result ($word, -output_not_found => 1);
    print "foo";
d361 1
a361 1
      $r .= qq(<li><a href ="$url_cgi?@@{[&escape(&encode($page))]}">@@{[&escape($page)]}</a>@@{[&escape(&get_subjectline($page))]}</li>);
d412 1
d423 1
a423 1
    <title>@@{[&escape($page.' '.&get_subjectline($page))]}</title>
d425 2
a426 2
    <link rev="made" href="mailto:$modifier_mail">
    <link rel="stylesheet" type="text/css" href="$url_stylesheet">
a551 8
        # Walrus mod (6) start
        #if ($saved[0] eq '</html>') {
        #    if (/<\/html>/i) { splice(@@saved); }
        #    else { push (@@result, &html_to_ignored_html($_)); }
        #} elsif (/^<html>/i and &is_ignore_html($form{mypage})) {
        #    push(@@result, splice(@@saved));
        #    push(@@saved, '</html>');
        #} els
d724 1
a724 1
                return qq(<a href="$remoteurl">$name</a>);  # Walrus add (3)
d727 1
a727 1
                return $name;                               # Walrus add (3)
d732 1
a732 1
            return qq(<a title="$subject" href="$url_cgi?$cookedchunk">$name</a>);   # Walrus add (3)
d735 1
a735 1
            return qq(<a title="$chunk" href="$url_cgi?$cookedchunk" class="wiki">$name</a>);     # Walrus add (3)
d737 1
a737 1
            return qq(<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit;mypage=$cookedchunk" class="wiki">$name<span class="mark">$editchar</span></a>);
a741 33
# Walrus add (6) start
sub is_ignore_html {
    my ($pagename) = @@_;
    foreach (@@ignore_html_page) {
        return 1 if ($pagename eq $_);
    }
    return 0;
}
# Walrus add (6) end

# Walrus add (6) start
sub html_to_ignored_html {
    my $str = shift(@@_);
    my $text_regex        = q{[^<]*};
    my $tag_regex_        = q{[^"'<>]*(?:"[^"]*"[^"'<>]*|'[^']*'[^"'<>]*)*(?:>|(?=<)|$(?!\n))}; #'}}}}
    my $comment_tag_regex = '<!(?:--[^-]*-(?:[^-]+-)*?-(?:[^>-]*(?:-[^>-]+)*?)??)*(?:>|$(?!\n)|--.*$)';
    my $tag_regex         = qq{$comment_tag_regex|<$tag_regex_};
    my $ignored           = join('|', @@ignore_html_tags);
    my $result = '';
    while ($str =~ /($text_regex)($tag_regex)?/gso) {
      last if $1 eq '' and $2 eq '';
      $result .= $1;
      my $tag_tmp = $2;
      $result .= ($tag_tmp =~ /^<\/?($ignored)(?![0-9A-Za-z])/i) ? $tag_tmp : &escape($tag_tmp);
      if ($tag_tmp =~ /^<(XMP|PLAINTEXT|SCRIPT)(?![0-9A-Za-z])/i) {
        $str =~ /(.*?)(?:<\/$1(?![0-9A-Za-z])$tag_regex_|$)/gsi;
        $result .= &escape($1);
      }
    }
    return $result;
}
# Walrus add (6) end

d938 2
d943 1
a943 1
    @@{[ $mode{admin} ? qq($resource{frozenpassword} <input type="password" name="mypassword" value="$form{mypassword}" size="10"><br>) : "" ]}
d945 1
a945 1
    <input type="hidden" name="mypage" value="@@{[&escape($form{mypage})]}">
@


1.22
log
@2002-06-02  wakaba <w@@suika.fam.cx>

	* wiki.cgi: Sync with WalWiki 2.0.beta.1.wal.1.
	* wiki-style.css: New file.
@
text
@d347 1
d362 1
a362 1
      $r .= qq(<li><a href ="$url_cgi?@@{[&encode($page)]}">$page</a>@@{[&escape(&get_subjectline($page))]}</li>);
d423 1
a423 1
    <title>$page @@{[&escape(&get_subjectline($page))]}</title>
d434 1
a434 1
    href="$url_cgi?mycmd=search;mymsg=$cookedpage">$page</a>@@{[&escape(&get_subjectline($page))]}</h1>
d480 1
a480 1
  my $cvslog = '$Revision: 1.21 $ $Date: 2002/06/02 07:15:20 $';
d520 1
a520 1
    $s =~ s|\&|&amp;|g;
d530 4
a533 4
    $s =~ s|\&amp;|\&|g;
    $s =~ s|\&lt;|\<|g;
    $s =~ s|\&gt;|\>|g;
    $s =~ s|\&quot;|\"|g;
d984 1
a984 1
    <input type="hidden" name="mypage" value="$form{mypage}">
@


1.21
log
@2002-06-02  wakaba <w@@suika.fam.cx>

	* wiki.cgi: Sync with WalWiki 2.0.beta.1.wal.1.
	* wiki-style.css: New file.
@
text
@d120 1
a120 1
my $interwiki_name = '([^:]+):([^:].*)';
d125 3
d206 5
d319 1
a319 1
        &print_header($CompletedSuccessfully);
d343 1
a343 1
    my $word = &escape($form{mymsg});
d345 2
a346 17
    &print_searchform($word);
    my $counter = 0;
    foreach my $page (sort keys %database) {
        next if $page =~ /^$RecentChanges$/;
        if ($database{$page} =~ /\Q$form{mymsg}\E/ or $page =~ /\Q$form{mymsg}\E/) {
            if ($counter == 0) {
                print qq|<ul>|;
            }
            print qq(<li><a href ="$url_cgi?@@{[&encode($page)]}">$page</a>@@{[&escape(&get_subjectline($page))]}</li>);
            $counter++;
        }
    }
    if ($counter == 0) {
        &print_message($resource{notfound});
    } else {
        print qq|</ul>|;
    }
d350 21
d403 1
a403 1
    my ($page) = @@_;
a404 2
    my $editable = 0;
    my $admineditable = 0;
a405 2
        $editable = 0;
        $admineditable = 1;
d407 3
a409 5
    } elsif (&is_editable($page) and $form{mycmd} =~ /^(read|write)$/) {
        $admineditable = 1;
        $editable = 1;
    } else {
        $editable = 0;
d428 24
d458 1
a458 1
        ? qq(<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit;mypage=$cookedpage">$resource{editbutton}</a> | )
d472 1
a472 4
<h1 class="header"><a
    title="$resource{searchthispage}"
    href="$url_cgi?mycmd=search;mymsg=$cookedpage">$page</a>@@{[&escape(&get_subjectline($page))]}</h1>
EOD
d479 3
a481 2
my $cvslog = '$Revision: 1.20 $ $Date: 2002/06/02 06:37:36 $';
    print <<"EOD";
d787 5
d984 1
a984 1
    <textarea cols="$cols" rows="$rows" name="mymsg" wrap="off">$mymsg</textarea><br>
d997 1
a997 1
        <input type="submit" name="mypreview_write" value="$resource{savebutton}"><br>
d1255 2
@


1.20
log
@2002-06-02  wakaba <w@@suika.fam.cx>

	* wiki.cgi: Sync with WalWiki 2.0.beta.1.wal.1.
	* wiki-style.css: New file.
@
text
@d450 1
a450 1
my $cvslog = '$Revision: 1.18 $ $Date: 2002/06/02 06:19:43 $';
d659 1
a660 1
    $name =~ s/^&lt;(.*)&gt;$/$1/;
d678 1
a678 1
        return qq(<a href="$chunk">$name</a>);
@


1.19
log
@2002-06-02  wakaba <w@@suika.fam.cx>

	* wiki.cgi: Sync with WalWiki 2.0.beta.1.wal.1.
	* wiki-style.css: New file.
@
text
@d712 1
a712 1
            return qq(<a title="$chunk" href="$url_cgi?$cookedchunk">$name</a>);     # Walrus add (3)
d714 1
a714 2
#           return qq($chunk<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit&amp;mypage=$cookedchunk">$editchar</a>); # Walrus del (3)
            return qq($name<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit&amp;mypage=$cookedchunk">$editchar</a>);  # Walrus add (3)
@


1.18
log
@2002-06-02  wakaba <w@@suika.fam.cx>

	* wiki.cgi: Sync with WalWiki 2.0.beta.1.wal.1.
@
text
@d450 1
d457 1
a457 1
$Revision: 1.15 $ $Date: 2002/04/23 10:14:12 $
d466 1
a466 1
$walrus_log <!-- Walrus add (debug) -->
d522 7
a528 6
        if ($saved[0] eq '</html>') {
            if (/<\/html>/i) { splice(@@saved); }
            else { push (@@result, &html_to_ignored_html($_)); }
        } elsif (/^<html>/i and &is_ignore_html($form{mypage})) {
            push(@@result, splice(@@saved));
            push(@@saved, '</html>');
@


1.17
log
@*** empty log message ***
@
text
@d86 1
a86 1
my $url_stylesheet = './WalWiki/Theme/wiki.css';
d107 1
a107 1
my $FrontPage = 'FrontPage';
d142 1
a142 1
    $FrontPage => 1,
d157 1
a157 1
    $FrontPage => 'FrontPage',
d406 2
a413 2
    <meta http-equiv="Content-Language" content="$lang">
    <meta http-equiv="Content-Type" content="text/html; charset=$charset">
a449 1
    my $mod_info = $modifier_name ? qq(Modified by <a href="$modifier_url">$modifier_name</a>.) : '';
a451 1
<hr />
d455 3
a457 1
$mod_info
d459 5
d527 12
d549 6
a554 3
        } elsif (/^----/) {
            push(@@result, splice(@@saved), '<hr>');
        } elsif (/^(-{1,3})(.*)/) {
d560 1
a560 1
        } elsif (/^(>{1,3})(.*)/) {
d569 2
a570 1
            push(@@result, &escape($1)); # Not &inline, but &escape
d635 2
a636 2
    $line =~ s|'''([^']+?)'''|<i>$1</i>|g;  # Italic
    $line =~ s|''([^']+?)''|<b>$1</b>|g;    # Bold
d639 9
a647 9
                (
                    ((mailto|http|https|ftp):([^\x00-\x20()<>\x7F-\xFF])*)  # Direct http://...
                        |
                    ($bracket_name)             # [[likethis]], [[#comment]], [[Friend:remotelink]]
                        |
                    ($interwiki_definition)     # [[Friend http://somewhere/?q=sjis($1)]]
                        |
                    ($wiki_name)                # LocalLinkLikeThis
                )
d658 1
d678 3
a680 1
    } elsif ($chunk =~ /^(mailto):(.*)/) {
d682 1
a682 1
        return qq(<a href="$chunk">$name</a>);              # Walrus add (3)
@


1.16
log
@2002-03-24  wakaba <w@@suika.fam.cx>

	* wiki.cgi (inline): 
	- Ignore LinkLikeThis style anchor.
	- Allow [[space including anchor]].
	(make_link): Likewise.  Gets rid of angle branckets
	before make anchor.
@
text
@d59 1
d72 1
a72 1
my $modifier_dir_data = '../wiki'; # Your data directory.
@


1.15
log
@2002-03-24  wakaba <w@@suika.fam.cx>

	* wiki.cgi (inline): 
	- Ignore LinkLikeThis style anchor.
	- Allow [[space including anchor]].
	(make_link): Likewise.  Gets rid of angle branckets
	before make anchor.
@
text
@d2 1
a2 4
use lib "../lib";
use CGI::Carp 'fatalsToBrowser';
use Algorithm::Diff qw(traverse_sequences);
# use strict;
d4 1
a4 1
# yukiwiki.cgi - Yet another WikiWikiWeb clone.
d6 1
a6 1
# Copyright (C) 2000,2001 by Hiroshi Yuki.
d10 2
a11 4
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
d13 25
a37 4
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
d39 20
a58 1
# $Id: wiki.cgi,v 1.14 2002/04/02 01:32:31 wakaba Exp $
d60 15
a74 1
my $version = "1.6.6";
d76 12
a87 62
# Ã±ÆÈ¥Æ¥¹¥È¤Î¤È¤­¤Ë¤Ï 1 ¤Ë¤¹¤ë¡£
my $testing = 0;
##############################
# ´Á»ú¥é¥¤¥Ö¥é¥ê
my $jcodelib = 'jcode.pl';
##############################
# ÊÝÂ¸¡¦É½¼¨¤Î´Á»ú¥³¡¼¥É
my $kanjicode = 'euc';     # 'sjis' 'euc'
my $charset = 'euc-jisx0213';  # 'Shift_JIS' 'EUC-JP'
##############################
# dbmopen¤¬»È¤¨¤ë¤Ê¤é1¡¢»È¤¨¤Ê¤¤¤Ê¤é0
my $dbmopen = 0;
##############################
# ¥Ç¡¼¥¿¥Ù¡¼¥¹Ì¾¡Ê.pag, .dir, .db¤Ê¤É¤ÏÉÔÍ×¡Ë
# $dbmopen = 1¤Î¤È¤­¤Ï¥Ç¡¼¥¿¥Ù¡¼¥¹Ì¾¡¢
# $dbmopen = 0¤Î¤È¤­¤Ï¥Ç¥£¥ì¥¯¥È¥êÌ¾¤Ë¤Ê¤ë¡£
my $dbname = './wikidata';
my $diffdbname = './wikidiff';
##############################
# ½¤Àµ¼Ô¤Î»áÌ¾¡Ê¼«Í³¤ËÊÑ¹¹¤·¤Æ¤¯¤À¤µ¤¤¡Ë
my $modifier = 'suika';
##############################
# ½¤Àµ¼Ô¤ÎWeb¥Ú¡¼¥¸¡Ê¼«Í³¤ËÊÑ¹¹¤·¤Æ¤¯¤À¤µ¤¤¡Ë
my $modifierlink = 'http://suika.fam.cx/';
##############################
# ¤³¤Î¥Ú¡¼¥¸¤ÎURL
my $thisurl = 'wiki';
##############################
# ³«»Ï¥Ú¡¼¥¸Ì¾
my $toppage = 'HomePage';
##############################
# ºÇ½ª¹¹¿·¥Ú¡¼¥¸Ì¾
my $whatsnew = 'RecentChanges';
##############################
# ºÇ½ª¹¹¿·¤Ë·ÇºÜ¤¹¤ë¥Ú¡¼¥¸¿ô
my $maxnew = 50;
##############################
# ¥¢¥¤¥³¥ó¥Õ¥¡¥¤¥ëÌ¾¡Ê¥«¥é¡¼ÈÇ¡Ë
my $iconfile = '';
##############################
# ¥¢¥¤¥³¥ó¥Õ¥¡¥¤¥ëÌ¾¡Ê¥â¥Î¥¯¥íÈÇ¡Ë
# my $iconfile = '';
##############################
# ¥Ú¡¼¥¸¤òÊÑ¹¹¤·¤¿¤È¤­¤Ëtouch¤¹¤ë¥Õ¥¡¥¤¥ë¡Ê''¤Ê¤é²¿¤â¤·¤Ê¤¤¡Ë
my $touchfile = 'touch.txt';
##############################
# ¥×¥ì¥Ó¥å¡¼ÍÑ¤ÎÇØ·Ê¿§
my $preview_color = '#FFCCCC';
##############################
# Á´¥Ú¡¼¥¸¤Î¥¹¥¿¥¤¥ë
my $style = <<'EOD';
@@import '/s/simpledoc';
pre, dl, ul, ol, p, blockquote { line-height:120%; 
margin-bottom: 1em}
a.wiki .mark	{vertical-align: sub, color: GrayText}
a { text-decoration: none; }
a:link { color: #0000FF; background-color: #FFFFFF; }
a:visited { color: #9900CC; background-color: #FFFFFF; }
a:hover { text-decoration: underline; }
EOD
##############################
# ¥Æ¥­¥¹¥ÈÆþÎÏÉôÊ¬¤ÎÂç¤­¤µ
d91 89
a179 8
my %form = ();
my %database = ();
my %diffbase = ();
my $diff_text = '';
my @@diff_added = ();
my @@diff_deleted = ();
my $msgrefA;
my $msgrefB;
d181 1
a181 46
# ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸Ì¾°ìÍ÷
my @@uneditable = ( $whatsnew );
##############################
# ¥ê¥ó¥¯ÍÑ¤ÎÀµµ¬É½¸½
# YukiWiki¤Î¥ê¥ó¥¯¤Ï2¼ïÎà¤¢¤ë¡£
# 
# (1) WikiName (RecentChanges¤È¤«FrontPage¤Î¤è¤¦¤Ê¤â¤Î)
# (2) BracketName ([[·ë¾ë¹À]]¤È¤«[[¥È¥é¥Ö¥ë¥·¥å¡¼¥È]]¤Î¤è¤¦¤Ê¤â¤Î)
#
# ¢¨¥·¥Õ¥ÈJIS¤Î2¥Ð¥¤¥ÈÌÜ¤Ë¤Ï ']' ¤¬Íè¤¦¤ë¤Î¤Ç¡¢
# Ê¸»ú']'¤ò1¤ÄÂ¿¤¯¤È¤ë¤è¤¦¤Ë¤·¤Æ¤¤¤ë¡£
#
my $WikiName = '([A-Z][a-z]+([A-Z][a-z]+)+)';
my $BracketName = '\[\[([^>\x09]+?\]?)\]\]';

# ¥¢¥¤¥³¥óÉôÊ¬¤Î¥¿¥°
my $IconTag = ''; #<<"EOD";
#<a href="http://www.hyuki.com/yukiwiki/"><img src="$iconfile"
# border="0" width="80" height="80" alt="[YukiWiki]" /></a>
#EOD

require "$jcodelib";

&init_form($kanjicode);

if ($testing) {
    %form = (
        # 'mycmd' => 'write',
        'mycmd' => 'read',
        #'mycmd' => 'search',
        #'mycmd' => 'edit',
        'mymsg' => <<"EOD",
¤Ï¤¸¤á¤Þ¤·¤Æ¡£
¤³¤ì¤«¤é¤¤¤í¤¤¤í½ñ¤­¹þ¤ß¤Þ¤¹¤Í¡£
LinkPage¤â¸«¤Æ¤¯¤À¤µ¤¤¡£
TestPage¤Ï¤É¤¦¤Ç¤·¤ç¤¦¤«¡£
¤É¤¦¤¾¤è¤í¤·¤¯¡£
http://www.hyuki.com/
[[·ë¾ë¹À]]
EOD
        'mypage' => '<·ë¾ë¹À>',
        'myword' => '·ë',
        # '3C8C8B8FE98D5F3E' => '',
        # 'TestPage' => '',
    );
}
d184 1
a185 1
# ¥á¥¤¥ó
d187 6
a192 41
    &normalize_form;
    if ($dbmopen) {
        if (!dbmopen(%database, $dbname, 0666)) {
            &print_error("(dbmopen) $dbname ¤¬ºî¤ì¤Þ¤»¤ó¡£");
        }
    } else {
        if (!tie(%database, "YukiWikiDB", $dbname)) {
            &print_error("(tie error)");
        }
    }

    # myspecialÂÐ±þ
    foreach (keys %form) {
        if (/^myspecial_(.*)/) {
            $form{mycmd} = $1;
            last;
        }
    }

    if ($form{mycmd} eq 'read') {
        &do_read;
    } elsif ($form{mycmd} eq 'preview') {
        &do_preview;
    } elsif ($form{mycmd} eq 'write') {
        &do_write;
    } elsif ($form{mycmd} eq 'edit') {
        &do_edit;
    } elsif ($form{mycmd} eq 'reedit') {
        &do_reedit;
    } elsif ($form{mycmd} eq 'search') {
        &do_search;
    } elsif ($form{mycmd} eq 'list') {
        &do_list;
    } elsif ($form{mycmd} eq 'diff') {
        &do_diff;
    } else {
        $form{mypage} = $toppage;
        &do_read;
    }
    if ($dbmopen) {
        dbmclose(%database);
d194 1
a194 1
        untie(%database);
d196 1
a198 1
# ¥Ú¡¼¥¸¤ÎÉ½¼¨
d200 3
a202 7
    my $page_name = $form{mypage};
    my $percent_name = &encode_percent($page_name);
    &print_header($page_name);
    print qq|<h1>$IconTag<a href="$thisurl?mycmd=search;myword=$percent_name">$page_name</a></h1>\n|;
    &print_toolbar($page_name);
    print &convert_html(&get_page($page_name));
    &print_footer;
a204 1
# ¥Ú¡¼¥¸¤ÎÊÔ½¸
d206 8
a213 4
    if (not &is_editable($form{mypage})) {
        # ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤ÏÉ½¼¨¤Î¤ß
        &do_read;
        return;
d215 1
a215 1
    &editpage(&get_page($form{mypage}));
d218 5
a222 5
# ¥Ú¡¼¥¸¤ÎºÆÊÔ½¸
sub do_reedit {
    if (not &is_editable($form{mypage})) {
        # ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤ÏÉ½¼¨¤Î¤ß
        &do_read;
d224 2
a225 1
        &editpage($form{mymsg});
d227 1
d230 5
a234 19
sub editpage {
    my $page_msg = shift;
    my $page_name = $form{mypage};
    my $digest = &calc_message_digest($page_msg);
    &print_header($page_name);
    print qq|<h1>$IconTag${page_name}¤ÎÊÔ½¸</h1>\n|;
    &print_toolbar($page_name);
    $page_msg = &escape($page_msg);
    print <<"EOD";
<form action="$thisurl" method="post">
<!--<input type="hidden" name="mycmd" value="preview">-->
<input type="hidden" name="mypage" value="$page_name">
<input type="hidden" name="mydigest" value="$digest">
<textarea cols="$cols" rows="$rows" name="mymsg" wrap="virtual">$page_msg</textarea><br>
<input type="submit" name="myspecial_preview" value="³ÎÇ§">
<input type="submit" name="myspecial_write" value="³ÎÇ§¤»¤ºÊÑ¹¹">
</form>
<hr>
<h3>¥Æ¥­¥¹¥ÈÀ°·Á¤Î¥ë¡¼¥ë</h3>
d236 11
a246 61
<p>ÄÌ¾ï¤ÏÆþÎÏ¤·¤¿Ê¸»ú¤¬¤½¤Î¤Þ¤Þ½ÐÎÏ¤µ¤ì¤Þ¤¹¤¬¡¢
°Ê²¼¤Î¥ë¡¼¥ë¤Ë½¾¤Ã¤Æ¥Æ¥­¥¹¥ÈÀ°·Á¤ò¹Ô¤¦¤³¤È¤¬¤Ç¤­¤Þ¤¹¡£</p>

<ul>
<li>
¶õ¹Ô¤ÏÃÊÍî¤Î¶èÀÚ¤ê¤È¤Ê¤ê¤Þ¤¹¡£

<li>
HTML¤Î¥¿¥°¤Ï½ñ¤±¤Þ¤»¤ó¡£

<li>
''¶¯Ä´''¤Î¤è¤¦¤Ë¥·¥ó¥°¥ë¥¯¥©¡¼¥ÈÆó¤Ä¤Ç¤Ï¤µ¤à¤È¡¢¶¯Ä´¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
'''¹¹¤Ë¶¯Ä´'''¤Î¤è¤¦¤Ë¥·¥ó¥°¥ë¥¯¥©¡¼¥È»°¤Ä¤Ç¤Ï¤µ¤à¤È¡¢¹¹¤Ë¶¯Ä´¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
----¤Î¤è¤¦¤Ë¥Þ¥¤¥Ê¥¹4¤Ä¤¬¤¢¤ë¤È¡¢¿åÊ¿Àþ¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
*¤ò¹ÔÆ¬¤Ë½ñ¤¯¤ÈÂç¸«½Ð¤·¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
**¤ò¹ÔÆ¬¤Ë½ñ¤¯¤È¾®¸«½Ð¤·¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
-¤ò¹ÔÆ¬¤Ë½ñ¤¯¤È²Õ¾ò½ñ¤­¤Ë¤Ê¤ê¤Þ¤¹¡£- -- --- ¤Î3¥ì¥Ù¥ë¤¬¤¢¤ê¤Þ¤¹¡£

<li>
:¤ò¹ÔÆ¬¤Ë½ñ¤¯¤ÈÍÑ¸ì¤È²òÀâÊ¸¤¬ºî¤ì¤Þ¤¹¡£

<pre>
    :ÍÑ¸ì1:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸1
    :ÍÑ¸ì2:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸2
    :ÍÑ¸ì3:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸3
</pre>

<li>
http://www.hyuki.com/ ¤Î¤è¤¦¤ÊURL¤Ï¼«Æ°Åª¤Ë¥ê¥ó¥¯¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
YukiWiki¤Î¤è¤¦¤ËÂçÊ¸»ú¾®Ê¸»ú¤òº®¤¼¤¿±ÑÊ¸»úÎó¤ò½ñ¤¯¤È¡¢
YukiWiki¤Î¥Ú¡¼¥¸Ì¾¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
[[·ë¾ë¹À]]¤Î¤è¤¦¤ËÆó½Å¤ÎÂç¤«¤Ã¤³[[ ]]¤Ç¤¯¤¯¤Ã¤¿Ê¸»úÎó¤ò½ñ¤¯¤È¡¢
YukiWiki¤Î¥Ú¡¼¥¸Ì¾¤Ë¤Ê¤ê¤Þ¤¹¡£
Âç¤«¤Ã¤³¤ÎÃæ¤Ë¤Ï¥¹¥Ú¡¼¥¹¤ò´Þ¤á¤Æ¤Ï¤¤¤±¤Þ¤»¤ó¡£
ÆüËÜ¸ì¤â»È¤¨¤Þ¤¹¡£

<li>
¹ÔÆ¬¤¬¥¹¥Ú¡¼¥¹¤Ç»Ï¤Þ¤Ã¤Æ¤¤¤ë¤È¡¢
¤½¤ÎÃÊÍî¤ÏÀ°·ÁºÑ¤ß°·¤ï¤ì¤Þ¤¹¡£
¥×¥í¥°¥é¥à¤ò½ñ¤­¹þ¤à¤È¤­¤Ë»È¤¦¤ÈÊØÍø¤Ç¤¹¡£

<li>
&gt; ¤ò¹ÔÆ¬¤Ë½ñ¤¯¤È¡¢
°úÍÑÊ¸¤¬½ñ¤±¤Þ¤¹¡£
&gt; ¤Î¿ô¤¬Â¿¤¤¤È¥¤¥ó¥Ç¥ó¥È¤¬¿¼¤¯¤Ê¤ê¤Þ¤¹¡Ê3¥ì¥Ù¥ë¤Þ¤Ç¡Ë¡£

</ul>
d248 1
a248 17
    &print_footer;
}

# ¥Ú¡¼¥¸¤Î¸¡º÷
sub do_search {
    if ($form{myword}) {
        &print_header('¸¡º÷·ë²Ì');
        print qq|<h1>$IconTag$form{myword}¤Î¸¡º÷·ë²Ì</h1>\n|;
        &print_toolbar();
        print qq|<ul>\n|;
        my $count = 0;
        foreach my $page_name (sort keys %database) {    # sort¤¹¤ë¤Î¤ÏÌµËÅ¤«¤Ê
            if ($database{$page_name} =~ /\Q$form{'myword'}\E/) {
                my $encoded = &encode_percent($page_name);
                print qq|<li><a href="$thisurl?mycmd=read;mypage=$encoded">$page_name</a>\n|;
                $count++;
            }
d250 21
a270 5
        print qq|</ul>\n|;
        if ($count > 0) {
            print qq|<p><strong>$form{myword}</strong>¤ò´Þ¤à¥Ú¡¼¥¸¤Ï¡¢¾å¤Ë¼¨¤¹<strong>$count</strong> ¥Ú¡¼¥¸¤Ç¤¹¡£</p>\n|;
        } else {
            print qq|<p><strong>$form{myword}</strong>¤ò´Þ¤à¥Ú¡¼¥¸¤Ï¸«¤Ä¤«¤ê¤Þ¤»¤ó¡£</p>\n|;
a271 4
    } else {
        &print_header('Ã±¸ì¸¡º÷');
        print qq|<h1>$IconTagÃ±¸ì¸¡º÷</h1>\n|;
        &print_toolbar();
d273 2
a274 10
    print <<"EOD";
<p>
<form action="$thisurl" method="post">
<input type="hidden" name="mycmd" value="search">
<input type="text" name="myword" size="20" value="$form{myword}">
<input type="submit" value="Ã±¸ì¸¡º÷">
</form>
</p>
EOD
    &print_footer;
d277 3
a279 30
# ¥Ú¡¼¥¸¤Î°ìÍ÷
sub do_list {
    &print_header('¥Ú¡¼¥¸°ìÍ÷');
    print qq|<h1>$IconTag ¥Ú¡¼¥¸°ìÍ÷</h1>\n|;
    &print_toolbar();
    print qq|<ul>\n|;
    foreach my $page_name (sort keys %database) {    # sort¤¹¤ë¤Î¤ÏÌµËÅ¤«¤Ê
        my $encoded = &encode_percent($page_name);
        print qq|<li><a href="$thisurl?mycmd=read;mypage=$encoded">$page_name</a>\n|
    }
    print qq|</ul>\n|;
    &print_footer;
}

# ¥×¥ì¥Ó¥å¡¼
sub do_preview {
    my $page_name = $form{mypage};
    my $escapedmsg = &escape($form{mymsg});
    &print_header($page_name);
    print qq|<h1>$IconTag${page_name}¤Î¥×¥ì¥Ó¥å¡¼</h1>\n|;
    &print_toolbar($page_name);
    # local $percent_name = &encode_percent($page_name);
    print qq|<p>°Ê²¼¤Î¥×¥ì¥Ó¥å¡¼¤ò³ÎÇ§¤·¤Æ¡¢¤è¤±¤ì¤Ð¥Ú¡¼¥¸²¼Éô¤Î¥Ü¥¿¥ó¤Ç¹¹¿·¤·¤Æ¤¯¤À¤µ¤¤¡£</p>\n|;
    if ($form{mymsg}) {
        print qq|<table width="100%" bgcolor="$preview_color" ><tr><td>\n|;
        # print &convert_html($escapedmsg);
        print &convert_html($form{mymsg});
        print qq|</td></tr></table>\n|;
    } else {
        print qq|<p>¡Ê¥Ú¡¼¥¸¤ÎÆâÍÆ¤Ï¶õ¤Ç¤¹¡£¹¹¿·¤¹¤ë¤È¤³¤Î¥Ú¡¼¥¸¤Ï<strong>ºï½ü</strong>¤µ¤ì¤Þ¤¹¡£¡Ë</p>\n|;
a280 17
    &print_preview_buttons($page_name, $escapedmsg, $form{mydigest});
    &print_footer;
}

sub print_preview_buttons {
    my ($page_name, $escapedmsg, $digest) = @@_;
    print <<"EOD";
    <form action="$thisurl" method="post">
    <textarea cols="$cols" rows="$rows" name="mymsg" wrap="virtual">$escapedmsg</textarea>
    <br />
    <input type="hidden" name="mypage" value="$page_name">
    <input type="hidden" name="mydigest" value="$digest">
    <input type="submit" name="myspecial_preview" value="ºÆÅÙ¥×¥ì¥Ó¥å¡¼">
    <input type="submit" name="myspecial_write" value="¥Ú¡¼¥¸¤Î¹¹¿·">
    </form>
EOD
}
a281 2
# ½ñ¤­¹þ¤à
sub do_write {
d283 3
a285 2
        # ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤ÏÉ½¼¨¤Î¤ß
        &do_read;
d289 1
a289 25
    my $page_name = $form{mypage};

    # digest¤ò»È¤Ã¤Æ¡¢¹¹¿·¤Î¾×ÆÍ¥Á¥§¥Ã¥¯
    my $original_digest = &calc_message_digest(&get_page($page_name));
    if ($form{mydigest} ne $original_digest) {
        &print_header($page_name);
        print qq|<h1>$IconTag${page_name}¤Ç¡Ú¹¹¿·¤Î¾×ÆÍ¡Û¤¬µ¯¤­¤Þ¤·¤¿</h1>\n|;
        print <<"EOD";
<p>¤¢¤Ê¤¿¤¬¤³¤Î¥Ú¡¼¥¸¤òÊÔ½¸¤·¤Æ¤¤¤ë´Ö¤Ë¡¢
Â¾¤Î¿Í¤¬Æ±¤¸¥Ú¡¼¥¸¤ò¹¹¿·¤·¤Æ¤·¤Þ¤Ã¤¿¤è¤¦¤Ç¤¹¡£
</p><p>
°Ê²¼¤Ë¡¢¤¢¤Ê¤¿¤ÎÊÔ½¸¤·¤¿¥Æ¥­¥¹¥È¤¬¤¢¤ê¤Þ¤¹¤Î¤Ç¡¢
¤¢¤Ê¤¿¤ÎÊÔ½¸ÆâÍÆ¤¬¼º¤ï¤ì¤Ê¤¤¤è¤¦¤Ë¡¢
¤¤¤Þ¤¹¤°¡¢¥á¥âÄ¢¤Ê¤É¤Ë¥³¥Ô¡¼¡õ¥Ú¡¼¥¹¥È¤·¤Æ¤¯¤À¤µ¤¤¡£
</p><p>
¥³¥Ô¡¼¡õ¥Ú¡¼¥¹¥È¤¬ºÑ¤ó¤Ç¤«¤é¡¢
ºÇ¿·¤ÎÆâÍÆ¤ò¸«¤ÆºÆÅÙÊÔ½¸¤·Ä¾¤·¤Æ¤¯¤À¤µ¤¤¡£
ºÇ¿·¤ÎÆâÍÆ¤Ï
<a target="_blank" href="$thisurl?mycmd=read;mypage=$form{mypage}">$form{mypage}</a>
¤Ç¸«¤ë¤³¤È¤¬¤Ç¤­¤Þ¤¹¡£
</p>
EOD
        # &print_toolbar($page_name);
        &print_preview_buttons($page_name, &escape($form{mymsg}), $form{mydigest});
        &print_footer;
d293 1
a293 1
    # diffÀ¸À®
d295 2
a296 2
        &opendiff;
        my @@msg1 = split(/\n/, &get_page($page_name));
d298 2
a299 6
        $msgrefA = \@@msg1;
        $msgrefB = \@@msg2;
        &diff_check;
        $diffbase{$form{mypage}} = $diff_text;
        $diff_text = '';
        &closediff;
a301 2
    &print_header($page_name);
    &set_page($page_name, $form{mymsg});
d303 21
a323 14
        print qq|<h1>$IconTag${page_name}¤ò¹¹¿·¤·¤Þ¤·¤¿</h1>\n|;
        &print_toolbar($page_name);
        print &convert_html(&get_page($page_name));
    } else {
        print qq|<h1>$IconTag${page_name}¤òºï½ü¤·¤Þ¤·¤¿</h1>\n|;
        &print_toolbar($page_name);
        print qq|<p>${page_name}¤òºï½ü¤·¤Þ¤·¤¿¡£</p>\n|;
    }
    &print_footer;
    # ¹¹¿·¤µ¤ì¤¿¤Î¤Ç¥¿¥Ã¥Á¤·¤Æ¤ª¤¯¡£
    if ($touchfile) {
        open(FILE, "> $touchfile");
        print FILE "\n";
        close(FILE);
d327 4
a330 35
# ¥Ú¡¼¥¸¤ÎÊÑ¹¹ÅÀ
sub do_diff {
    if (not &is_editable($form{mypage})) {
        # ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤ÏÉ½¼¨¤Î¤ß
        &do_read;
        return;
    }
    &opendiff;
    &print_header($form{mypage} . '¤ÎÊÑ¹¹ÅÀ');
    print qq|<h1>$IconTag <a href="$thisurl?mycmd=read&mypage=$form{mypage}">$form{mypage}</a>¤ÎÊÑ¹¹ÅÀ</h1>\n|;
    &print_toolbar();
    $_ = &escape($diffbase{$form{mypage}});
    print <<"EOD";
<ul>
<li>ÄÉ²Ã¤µ¤ì¤¿¹Ô¤Ï<ins>ÀÄ¿§</ins>¤Ç¤¹¡£
<li>ºï½ü¤µ¤ì¤¿¹Ô¤Ï<del>ÀÖ¿§</del>¤Ç¤¹¡£
<li><a href="$thisurl?mycmd=read;mypage=$form{mypage}">$form{mypage}</a>¤Ø¹Ô¤¯¡£
</ul>
<hr />
EOD
    print qq|<pre>\n|;
    foreach (split(/\n/, $_)) {
        if (/^\+(.*)/) {
            print qq|<ins>$1</ins>\n|;
        } elsif (/^\-(.*)/) {
            print qq|<del>$1</del>\n|;
        } elsif (/^\=(.*)/) {
            print qq|$1\n|;
        } else {
            print qq|??? $_\n|;
        }
    }
    print qq|</pre>\n|;
    &print_footer;
    &closediff;
d333 13
a345 4
sub opendiff {
    if ($dbmopen) {
        if (!dbmopen(%diffbase, $diffdbname, 0666)) {
            &print_error("(dbmopen) $diffdbname ¤¬ºî¤ì¤Þ¤»¤ó¡£");
d347 3
d351 1
a351 3
        if (!tie(%diffbase, "YukiWikiDB", $diffdbname)) {
            &print_error("(tie error)");
        }
d353 1
d356 11
a366 6
sub closediff {
    if ($dbmopen) {
        dbmclose(%diffbase);
    } else {
        untie(%diffbase);
    }
d369 8
a376 18
# ¥Õ¥©¡¼¥à¤«¤é¤Î¾ðÊó¤òÏ¢ÁÛÇÛÎó %form ¤ËÆþ¤ì¤ë
# &init_form('euc');
sub init_form {
    my ($charcode) = @@_;
    my $query;
    if ($ENV{REQUEST_METHOD} =~ /^post$/i) {
        read(STDIN, $query, $ENV{CONTENT_LENGTH});
    } else {
        $query = $ENV{QUERY_STRING};
    }
    my @@assocarray = split(/[&;]/, $query);
    foreach my $assoc (@@assocarray) {
        my ($property, $value) = split(/=/, $assoc);
        $value =~ tr/+/ /;
        $value =~ s/%([A-Fa-f0-9][A-Fa-f0-9])/pack("C", hex($1))/eg;
        &jcode::convert(\$value, $charcode);
        $form{$property} = $value;
    }
a378 1
# ¥¨¥é¡¼¥Ú¡¼¥¸¤ò½ÐÎÏ¤¹¤ë
d381 3
a383 2
    &print_header('Error');
    print "<h1>$IconTag$msg</h1></body></html>";
d387 14
a400 57
sub escape {
    my ($line) = shift;
    $line =~ s|<|&lt;|g;
    $line =~ s|>|&gt;|g;
    $line =~ s|"|&quot;|g;
    # $line =~ s|\&|&amp;|g;
    return $line;
}

sub inline {
    my ($line) = shift;
    $line = &escape($line);
    $line =~ s|'''([^']+?)'''|<strong>$1</strong>|g;
    $line =~ s|''([^']+?)''|<em>$1</em>|g;          
    $line =~ s!
       (
         (?:&lt;(?:mailto|http|https|ftp|urn):[\x21-\x7E]*)&gt;
       #| (?:$WikiName)                         # LocalLinkLikeThis
       | (?:$BracketName)                      # [[ÆüËÜ¸ì¥ê¥ó¥¯]]
       )
            !
                &make_link($1)
            !gex;
    return $line;
}

# ¥Ú¡¼¥¸¤Î¥¿¥¤¥È¥ë¤«¤é¥Ú¡¼¥¸¤ÎÆâÍÆ¤òÆÀ¤ë
sub get_page {
    my $page_name = shift;
    return $database{$page_name} || $database{'[['.$page_name.']]'};
}

# ¥Ú¡¼¥¸¤ÎÆâÍÆ¤òÍ¿¤¨¤ë
# &set_page($title, $txt)
sub set_page {
    # ¥Ú¡¼¥¸¤ò¹¹¿·¤¹¤ë
    my $title = $_[0];
    $database{$title} = $_[1];
    # ¶õ¥Ú¡¼¥¸¤Ê¤éºï½ü¤¹¤ë
    unless ($database{$title}) {
        delete $database{$title};
    }
    # RecentChanges¤ò¹¹¿·¤¹¤ë
    my $delim = ' - ';
    my @@pages = split(/\n/, $database{$whatsnew});
    my $datestr = &get_current_datestr;
    unshift(@@pages, qq|-$datestr$delim$title|);
    # Æ±°ì¥Ú¡¼¥¸¤Î¹¹¿·¤ÏºÇ¿·¤Î¤â¤Î¤Î¤ß¤Ë¤·¡¢
    # Â¸ºß¤·¤Ê¤¤¥Ú¡¼¥¸¤Ï¥¹¥­¥Ã¥×¤¹¤ë¡£
    my %count;
    my @@newpages;
    foreach my $line (@@pages) {
        my ($prefix, $title) = split(/$delim/, $line);
        $count{$title}++;
        if ($count{$title} == 1 and exists($database{$title})) {
            push(@@newpages, qq|$prefix - $title|);
        }
d402 1
a402 7
    # ¤³¤³¤ÇËÜÅö¤Ë¹¹¿·
    $database{$whatsnew} = join("\n", splice(@@newpages, 0, $maxnew));
}

# ¥Ú¡¼¥¸¤Î¥Ø¥Ã¥À¤ò½ÐÎÏ
sub print_header {
    my $title = shift;
d404 1
a404 1
Content-type: text/html; charset=${charset}
d406 11
a416 5
<html><head>
<title>$title</title>
<style type="text/css">
$style
</style>
d418 24
a441 1
<body>
d445 5
a449 11
# ¥Ä¡¼¥ë¥Ð¡¼¤ò½ÐÎÏ
sub print_toolbar {
    my $page_name = shift;
    my $percent_name = &encode_percent($page_name);
    my $editlink = '';
    if ($page_name ne '' and &is_editable($page_name)) {
        $editlink = <<"EOD";
<a href="$thisurl?mycmd=edit;mypage=$percent_name">ÊÔ½¸</a> | 
<a href="$thisurl?mycmd=diff;mypage=$percent_name">º¹Ê¬</a> | 
EOD
    }
d451 2
d454 3
a456 7
 [ 
<a href="$thisurl?mycmd=read;mypage=$toppage">¥È¥Ã¥×</a> | 
<a href="$thisurl?mycmd=list">°ìÍ÷</a> | 
$editlink
<a href="$thisurl?mycmd=search">Ã±¸ì¸¡º÷</a> | 
<a href="$thisurl?mycmd=read;mypage=$whatsnew">ºÇ¶á¤Î¹¹¿·</a>
 ]
a457 10
EOD
}

# ¥Ú¡¼¥¸¤Î¥Õ¥Ã¥¿¤ò½ÐÎÏ
sub print_footer {
    print <<"EOD";
<div class="navigation">
[<a href="/" title="¤³¤Î¥µ¡¼¥Ð¡¼¤Î¼óÊÇ">/</a>
<a href="/map" title="¤³¤Î¥µ¡¼¥Ð¡¼¤Î°ÆÆâ">ÃÏ¿Þ</a>
<a href="/search/" title="¤³¤Î¥µ¡¼¥Ð¡¼¤Î¸¡º÷">¸¡º÷</a>]
d459 3
d463 14
a476 10
  print <<'EOH';
<div class="update">
<a href="http://www.hyuki.com/yukiwiki/">YukiWiki</a> 1.6.6 
Copyright &copy; 2000,2001 by <a href="http://www.hyuki.com/">Hiroshi Yuki.</a>
<a href="/gate/cvs/wakaba/wiki/" title="CVS Repository">
$Revision: 1.14 $ $Date: 2002/04/02 01:32:31 $
</a>
</div>
</body></html>
EOH
d479 23
a501 47
# URL¤ä¥Ú¡¼¥¸¤ÎÌ¾Á°¤«¤é¥ê¥ó¥¯¤òºî¤ë
sub make_link {
    my $name = shift;
    $name =~ s/^&lt;(.*)&gt;$/$1/;
    $name =~ s/^\[\[(.*)\]\]$/$1/;
    if ($name =~ /^(http|https|ftp).*?(\.png|\.jpeg|\.jpg)?$/) {
        if ($2) {
            return qq|<a href="$name"><img border="0" src="$name" /></a>|;
        } else {
            return qq|&lt;<a href="$name">$name</a>&gt;|;
        }
    } elsif ($name =~ /^mailto:(.*)/) {
        my $address = $1;
        return qq|&lt;<a href="$name">$address</a>&gt;|;
    } elsif ($name =~ m#^urn:[0-9A-Za-z_:;/.-]+#) {
        return qq|&lt;<a href="/uri-res/N2L?${name}">$name</a>&gt;|;
    } else {
      my $name2 = $name; $name2 =~ tr/\x20/-/;
      if ($database{$name2}) {
        my $percent_name = &encode_percent($name2);
        return qq|<a href="$thisurl?mycmd=read;mypage=$percent_name" class="wiki">$name</a>|;
      } elsif ($database{'[['.$name2.']]'}) {
        my $percent_name = &encode_percent('[['.$name2.']]');
        return qq|<a href="$thisurl?mycmd=read;mypage=$percent_name" class="wiki">$name</a>|;
      } else {
        my $percent_name = &encode_percent($name2);
        return qq|<a href="$thisurl?mycmd=edit;mypage=$percent_name" class="wiki newpage">$name<span class="mark">?</span></a>|;
      }
    }
}

# %xx ¤Î·Á¼°¤Ë¥¨¥ó¥³¡¼¥É¤¹¤ë
# ¤³¤ì¤Ï¡¢
# http://www.hyuki.com/yukiwiki/yukiwiki.cgi?mycmd=read&mypage=%3C%8C%8B%8F%E9%8D_%3E
# ¤È¤¤¤¦·Á¼°¤Î¤¿¤á¤Ë»È¤ï¤ì¤ë¡£
# '<·ë¾ë¹À>' ¢ª '%3C%8C%8B%8F%E9%8D_%3E'
sub encode_percent {
    my $name = shift;
    my $encoded = '';
    foreach my $ch (split(//, $name)) {
        if ($ch =~ /[A-Za-z0-9_]/) {
            $encoded .= $ch;
        } else {
            $encoded .= '%' . sprintf("%02X", ord($ch));
        }
    }
    return $encoded;
d504 2
a505 3
# ¥Æ¥­¥¹¥ÈËÜÂÎ¤òHTML¤ËÊÑ´¹¤¹¤ë
sub convert_html {
    my ($txt) = shift;
d507 5
a511 1
    push (@@result, '<p>');	## ad hoc...
d514 7
a520 6
        if (/^\*\*\*\*\*(.*)/) {
            push(@@result, splice(@@saved), '<h6>' . &inline($1) . '</h6>');
        } elsif (/^\*\*\*\*(.*)/) {
            push(@@result, splice(@@saved), '<h5>' . &inline($1) . '</h5>');
        } elsif (/^\*\*\*(.*)/) {
            push(@@result, splice(@@saved), '<h4>' . &inline($1) . '</h4>');
d522 5
a526 1
            push(@@result, splice(@@saved), '<h3>' . &inline($1) . '</h3>');
d528 3
a530 1
            push(@@result, splice(@@saved), '<h2>' . &inline($1) . '</h2>');
d534 1
a534 4
            &back_push('ul', length($1));
            push(@@result, '<li>' . &inline($2) . '</li>');
        } elsif (/^(={1,3})(.*)/) {
            &back_push('ol', length($1));
d537 1
a537 1
            &back_push('dl', 1);
d540 1
a540 1
            &back_push('blockquote', length($1));
d547 26
a572 3
            &back_push('pre', 1);
            #push(@@result, &escape($1)); # Not &inline, but &escape
            push(@@result, &inline($1)); # Not &inline, but &escape
d578 16
a593 1
    return join("\n", @@result);
a595 2
# &back_push($tag, $count)
# $tag¤Î¥¿¥°¤ò$level¥ì¥Ù¥ë¤Þ¤ÇµÍ¤á¤ë¡£
d597 10
a606 10
    my ($tag, $level) = @@_;
    while (@@saved > $level) {
        push(@@result, shift(@@saved));
    }
    if ($saved[0] ne "</$tag>") {
        push(@@result, splice(@@saved));
    }
    while (@@saved < $level) {
        unshift(@@saved, "</$tag>");
        push(@@result, "<$tag>");
d610 79
a688 7
# ÊÔ½¸²ÄÇ½¥Ú¡¼¥¸¤«¡©
sub is_editable {return 1;
## TODO: ...
    my ($pagename) = @@_;
    foreach (@@uneditable) {
        if ($pagename eq $_) {
            return 0;
a690 4
    if (&is_valid_name($pagename)) {
        return 1;
    }
    return 0;
d693 2
a694 2
# Valid¤ÊÌ¾Á°¤«?
sub is_valid_name {
d696 2
a697 6
    if ($pagename =~ /^$WikiName$/) {
        return 1;
    } elsif ($pagename =~ /^$BracketName$/) {
        return 1;
    } else {
        return 0;
d699 1
d701 1
d703 18
a720 22
# ¸½ºß»þ¹ï¤ÎÊ¸»úÎó¤òÆÀ¤ë
sub get_current_datestr {
    my (@@wdays) = ( "Æü", "·î", "²Ð", "¿å", "ÌÚ", "¶â", "ÅÚ" );
    my ($sec, $min, $hour, $mday, $mon, $year, $wday) = localtime(time);
    return sprintf("%4d-%02d-%02d (%s) %02d:%02d:%02d",
        $year + 1900, $mon + 1, $mday, $wdays[$wday], $hour, $min, $sec);
}

# URL?SomePage¤ä¡¢
# URL?[[·ë¾ë¹À]]¤Î·Á¼°¤À¤Ã¤¿¾ì¹ç¡¢(not yet)
# ¶¯À©Åª¤Ëmycmd¤òread¤Ë¤·¤Æ$form¤ÎÆâÍÆ¤òÀßÄê¤¹¤ë¡£
sub normalize_form {
    foreach my $key (keys %form) {
        if ($key =~ /^$WikiName$/) {
            $form{mycmd} = 'read';
            $form{mypage} = $1;
            last;
        } elsif ($key =~ /^$BracketName$/) {
            $form{mycmd} = 'read';
            $form{mypage} = $1;
            last;
        }
d722 1
d724 1
d726 3
a728 60
# ÊÑ´¹¥Æ¥¹¥È¤ò¹Ô¤Ê¤¦¤È¤­¤Î¥µ¥ó¥×¥ë
sub print_sample {
    my $txt = &convert_html(<<"EOD");
*Âç¸«½Ð¤·1
**¾®¸«½Ð¤·1-1
-¹àÌÜ1
-¹àÌÜ2
-¹àÌÜ3
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî''¶¯Ä´''1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1

ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
**¾®¸«½Ð¤·1-2
:ÍÑ¸ì1:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸1¤È''¶¯Ä´Ã±¸ì''
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
:ÍÑ¸ì2:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸2
:ÍÑ¸ì3:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸3
----
*Âç¸«½Ð¤·2
**¾®¸«½Ð¤·2-1
&lt;http://suika.fam.cx/&gt;
**¾®¸«½Ð¤·2-2

[[·ë¾ë¹À]]

ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî'''¶¯Ä´'''1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî'''''¶¯¤¤¶¯Ä´'''''1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
>ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
>ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
>ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2

¥ì¥Ù¥ë0¥ì¥Ù¥ë0¥ì¥Ù¥ë0¥ì¥Ù¥ë0¥ì¥Ù¥ë0¥ì¥Ù¥ë0

>¥ì¥Ù¥ë1
>¥ì¥Ù¥ë1
>¥ì¥Ù¥ë1
>>¥ì¥Ù¥ë2
>>¥ì¥Ù¥ë2
>>¥ì¥Ù¥ë2
>>>¥ì¥Ù¥ë3
-¤Ï¤í1
--¤Ï¤í2
¤í¤í¤í¤í2
---¤Ï¤í3
--¤Ï¤í2
---¤Ï¤í3
--¤Ï¤í2
---¤Ï¤í3
>>>¥ì¥Ù¥ë3
>>>¥ì¥Ù¥ë3
>>>¥ì¥Ù¥ë3
EOD
    print $txt;
    exit;
d731 30
a760 11
sub diff_check {
    traverse_sequences(
            $msgrefA, $msgrefB,
            {
                MATCH => \&df_match,
                DISCARD_A => \&df_delete,
                DISCARD_B => \&df_add,
            }
    );
    &diff_flush;
}
d762 29
a790 3
sub diff_flush {
    $diff_text .= join('', map { "-$_\n" } splice(@@diff_deleted));
    $diff_text .= join('', map { "+$_\n" } splice(@@diff_added));
d793 10
a802 5
sub df_match {
    my ($a, $b) = @@_;
    &diff_flush;
    $diff_text .= "=$msgrefA->[$a]\n";
}
d804 5
a808 3
sub df_delete {
    my ($a, $b) = @@_;
    push(@@diff_deleted, $msgrefA->[$a]);
d811 25
a835 3
sub df_add {
    my ($a, $b) = @@_;
    push(@@diff_added, $msgrefB->[$b]);
d838 10
a847 8
sub calc_message_digest {   # You have to use MD5...
    my $text = shift;
    my @@text = split(//, $text);
    my $len = length($text);
    my $checksum = 0;
    foreach (@@text) {
        $checksum += ord($_);
        $checksum = ($checksum * 2) % 65536 + (($checksum & 32768) ? 1 : 0); # 16bit rotate
a848 1
    return "$len:$checksum";
d851 12
a862 2
# Definition of YukiWikiDB
package YukiWikiDB;
d864 9
a872 1
my $debug = 1;
d874 8
a881 3
# Constructor
sub new {
    return shift->TIEHASH(@@_);
d884 9
a892 14
# tying
sub TIEHASH {
    my ($class, $dbname) = @@_;
    my $self = {
        dir => $dbname,
        keys => [],
    };
    if (not -d $self->{dir}) {
        if (!mkdir($self->{dir}, 0777)) {
            print "mkdir(" . $self->{dir} . ") fail\n" if ($debug);
            return undef;
        }
    }
    return bless($self, $class);
d895 17
a911 9
# Store
sub STORE {
    my ($self, $key, $val) = @@_;
    my $file = &make_filename($self, $key);
    if (open(FILE,"> $file")) {
        binmode(FILE);
        print FILE $val;
        close(FILE);
        return $self->{$key} = $val;
d913 1
a913 1
        print "$file create error.";
a914 1
}
d916 30
a945 7
# Fetch
sub FETCH {
    my ($self, $key) = @@_;
    my $file = &make_filename($self, $key);
    if (open(FILE, $file)) {
        local $/;
        $self->{$key} = <FILE>;
d947 1
a948 1
    return $self->{$key};
d951 10
a960 5
# Exists
sub EXISTS {
    my ($self, $key) = @@_;
    my $file = &make_filename($self, $key);
    return -e($file);
d963 15
a977 6
# Delete
sub DELETE {
    my ($self, $key) = @@_;
    my $file = &make_filename($self, $key);
    unlink $file;
    return delete $self->{$key};
d980 9
a988 7
sub FIRSTKEY {
    my ($self) = @@_;
    opendir(DIR, $self->{dir}) or die $self->{dir};
    @@{$self->{keys}} = grep /\.txt$/, readdir(DIR);
    foreach my $name (@@{$self->{keys}}) {
        $name =~ s/\.txt$//;
        $name =~ s/[0-9A-F][0-9A-F]/pack("C", hex($&))/eg;
a989 1
    return shift @@{$self->{keys}};
d992 10
a1001 3
sub NEXTKEY {
    my ($self) = @@_;
    return shift @@{$self->{keys}};
d1004 6
a1009 5
sub make_filename {
    my ($self, $key) = @@_;
    my $enkey = '';
    foreach my $ch (split(//, $key)) {
        $enkey .= sprintf("%02X", ord($ch));
a1010 1
    return $self->{dir} . "/$enkey.txt";
a1011 1
__END__
d1013 6
a1018 1
=head1 NAME
d1020 12
a1031 1
YukiWiki - ¼«Í³¤Ë¥Ú¡¼¥¸¤òÄÉ²Ã¡¦ºï½ü¡¦ÊÔ½¸¤Ç¤­¤ëWeb¥Ú¡¼¥¸¹½ÃÛCGI
d1033 10
a1042 4
    Copyright (C) 2000,2001 by Hiroshi Yuki.
    ·ë¾ë¹À <hyuki@@hyuki.com>
    http://www.hyuki.com/
    http://www.hyuki.com/yukiwiki/
d1044 38
a1081 1
=head1 SYNOPSIS
d1083 24
a1106 1
    http://www.hyuki.com/yukiwiki/yukiwiki.cgi
d1108 5
a1112 1
=head1 DESCRIPTION
d1114 10
a1123 5
YukiWiki¡Ê·ë¾ë¥¦¥£¥­¥£¡Ë¤Ï»²²Ã¼Ô¤¬¼«Í³¤Ë¥Ú¡¼¥¸¤òÄÉ²Ã¡¦ºï½ü¡¦ÊÔ½¸¤Ç¤­¤ë
ÉÔ»×µÄ¤ÊWeb¥Ú¡¼¥¸·²¤òºî¤ëCGI¤Ç¤¹¡£
Web¤ÇÆ°ºî¤¹¤ë·Ç¼¨ÈÄ¤È¤Á¤ç¤Ã¤È»÷¤Æ¤¤¤Þ¤¹¤¬¡¢
Web·Ç¼¨ÈÄ¤¬Ã±¤Ë¥á¥Ã¥»¡¼¥¸¤òÄÉ²Ã¤¹¤ë¤À¤±¤Ê¤Î¤ËÂÐ¤·¤Æ¡¢
YukiWiki¤Ï¡¢Web¥Ú¡¼¥¸Á´ÂÎ¤ò¼«Í³¤ËÊÑ¹¹¤¹¤ë¤³¤È¤¬¤Ç¤­¤Þ¤¹¡£
d1125 14
a1138 2
YukiWiki¤Ï¡¢Cunningham & Cunningham¤ÎWikiWikiWeb¤Î
»ÅÍÍ¤ò»²¹Í¤Ë¤·¤ÆÆÈ¼«¤Ëºî¤é¤ì¤Þ¤·¤¿¡£
d1140 9
a1148 2
YukiWiki¤ÏPerl¤Ç½ñ¤«¤ì¤¿CGI¥¹¥¯¥ê¥×¥È¤È¤·¤Æ¼Â¸½¤µ¤ì¤Æ¤¤¤Þ¤¹¤Î¤Ç¡¢
Perl¤¬Æ°ºî¤¹¤ëWeb¥µ¡¼¥Ð¤Ê¤é¤ÐÈæ³ÓÅªÍÆ°×¤ËÀßÃÖ¤Ç¤­¤Þ¤¹¡£
d1150 8
a1157 1
¤¢¤È¤Ïdbmopen¤¬»È¤¨¤ë´Ä¶­¤Ê¤é¤ÐÀßÃÖ¤Ç¤­¤Þ¤¹(Version 1.5.0°Ê¹ß¤Ê¤édbmopen¤¬»È¤¨¤Ê¤¯¤Æ¤âÀßÃÖ¤Ç¤­¤Þ¤¹)¡£
d1159 18
d1178 25
a1202 2
YukiWiki¤Ï¥Õ¥ê¡¼¥½¥Õ¥È¤Ç¤¹¡£
¤´¼«Í³¤Ë¤ª»È¤¤¤¯¤À¤µ¤¤¡£
d1204 12
a1215 1
=head1 ÀßÃÖÊýË¡
d1217 21
a1237 1
=head2 Æþ¼ê
d1239 33
a1271 3
YukiWiki¤ÎºÇ¿·ÈÇ¤Ï¡¢
http://www.hyuki.com/yukiwiki/
¤«¤éÆþ¼ê¤Ç¤­¤Þ¤¹¡£
d1273 1
a1273 1
=head2 ¥Õ¥¡¥¤¥ë°ìÍ÷
d1275 33
a1307 5
    readme.txt      ¥É¥­¥å¥á¥ó¥È
    yukiwiki.cgi    YukiWikiËÜÂÎ
    yukiwiki.gif    ¥í¥´¡Ê¥«¥é¡¼ÈÇ¡Ë
    yukimono.gif    ¥í¥´¡Ê¥â¥Î¥¯¥íÈÇ¡Ë
    jcode.pl        ´Á»ú¥³¡¼¥É¥é¥¤¥Ö¥é¥ê
d1309 28
a1336 1
=head2 ¥¤¥ó¥¹¥È¡¼¥ë
d1338 29
a1366 1
=over 4
d1368 3
a1370 1
=item 1.
d1372 8
a1379 1
¥¢¡¼¥«¥¤¥Ö¤ò²ò¤¯¡£
d1381 3
a1383 1
=item 2.
d1385 1
a1385 3
yukiwiki.cgi¤Î¤Ï¤¸¤á¤ÎÊý¤Ë¤¢¤ëÀßÄê¤ò³ÎÇ§¤·¤Þ¤¹¡£
ÄÌ¾ï¤Ï²¿¤â¤·¤Ê¤¯¤Æ¤è¤¤¤¬¡¢
¤Ï¤¸¤á¤Ï$touchfile¤ò''¤Ë¤·¤¿Êý¤¬¤è¤¤¤Ç¤·¤ç¤¦¡£
d1387 1
a1387 387
=item 3.

yukiwiki.cgi¤Èjcode.pl¤òÆ±¤¸¤È¤³¤í¤ËÀßÃÖ¤·¤Þ¤¹¡£

=item 4.

¥µ¥¤¥º0¤Îyukiwiki.db¤È¤¤¤¦¥Õ¥¡¥¤¥ë¤òÀßÃÖ¤·¤Þ¤¹¡£
¡ÊPerl¥·¥¹¥Æ¥à¤Ë¤è¤Ã¤Æ¤Ïyukiwiki.pag, yukiwiki.dir¡Ë

=item 5.

yukiwiki.cgi¤Ë¥Ö¥é¥¦¥¶¤«¤é¥¢¥¯¥»¥¹¤·¤Þ¤¹¡£

=back

=head2 ¥Ñ¡¼¥ß¥Ã¥·¥ç¥ó

        ¥Õ¥¡¥¤¥ë        ¥Ñ¡¼¥ß¥Ã¥·¥ç¥ó      Å¾Á÷¥â¡¼¥É
        yukiwiki.cgi    755                 ASCII
        yukiwiki.gif    644                 BINARY
        yukimono.gif    644                 BINARY
        jcode.pl        644                 ASCII

    $dbmopen = 1; ¤Ë¤·¤¿¾ì¹ç:
        yukiwiki.db     666                 BINARY
        (yukiwiki.pag, yukiwiki.dir¤Î¾ì¹ç¤â¤¢¤ê¡Ë

    $dbmopen = 0; ¤Ë¤·¤¿¾ì¹ç: (¥«¥ì¥ó¥È¥Ç¥£¥ì¥¯¥È¥ê¤ò777¤Ë¤·¤Æ¤ª¤¯)
        .               777                 (Å¾Á÷¤·¤Ê¤¤)

=head1 ¥Ç¡¼¥¿¤Î¥Ð¥Ã¥¯¥¢¥Ã¥×ÊýË¡

$dbmopen = 1;¤Î¾ì¹ç¤Ï¡¢
¥Ç¡¼¥¿¤Ï¤¹¤Ù¤Æyukiwiki.db(.dir, .pag)¤ËÆþ¤ë¡£
¤³¤ì¤ò¥Ð¥Ã¥¯¥¢¥Ã¥×¤¹¤ì¤Ð¤è¤¤¡£

$dbmopen = 0;¤Î¾ì¹ç¤Ï¡¢
yukiwiki¤È¤¤¤¦¥Ç¥£¥ì¥¯¥È¥ê¤¬¤Ç¤­¤ë¤Î¤Ç¡¢
¤³¤ì°Ê²¼¤ò¥Ð¥Ã¥¯¥¢¥Ã¥×¤¹¤ì¤Ð¤è¤¤¡£

=head1 ¿·¤·¤¤¥Ú¡¼¥¸¤Îºî¤êÊý 

=over 4

=item 1.

¤Þ¤º¡¢Å¬Åö¤Ê¥Ú¡¼¥¸¡ÊÎã¤¨¤ÐFrontPage¡Ë¤òÁª¤Ó¡¢
¥Ú¡¼¥¸¤Î²¼¤Ë¤¢¤ë¡ÖÊÔ½¸¡×¥ê¥ó¥¯¤ò¤¿¤É¤ê¤Þ¤¹¡£ 

=item 2.

¤¹¤ë¤È¥Æ¥­¥¹¥ÈÆþÎÏ¤¬¤Ç¤­¤ë¾õÂÖ¤Ë¤Ê¤ë¤Î¤Ç¡¢
¤½¤³¤ËNewPage¤Î¤è¤¦¤ÊÃ±¸ì
¡ÊÂçÊ¸»ú¾®Ê¸»úº®ºß¤·¤Æ¤¤¤ë±ÑÊ¸»úÎó¡Ë
¤ò½ñ¤¤¤Æ¡ÖÊÝÂ¸¡×¤·¤Þ¤¹¡£

=item 3.

ÊÝÂ¸¤¹¤ë¤È¡¢FrontPage¤Î¥Ú¡¼¥¸¤¬½ñ¤­´¹¤ï¤ê¡¢
¤¢¤Ê¤¿¤¬½ñ¤¤¤¿NewPage¤È¤¤¤¦Ê¸»úÎó¤Î¸å¤í¤Ë ? ¤È¤¤¤¦¥ê¥ó¥¯¤¬É½¼¨¤µ¤ì¤Þ¤¹¡£ 
¤³¤Î ? ¤Ï¤½¤Î¥Ú¡¼¥¸¤¬¤Þ¤ÀÂ¸ºß¤·¤Ê¤¤¤³¤È¤ò¼¨¤¹°õ¤Ç¤¹¡£ 

=item 4.

¤½¤Î ? ¤ò¥¯¥ê¥Ã¥¯¤¹¤ë¤È¿·¤·¤¤¥Ú¡¼¥¸NewPage¤¬¤Ç¤­¤Þ¤¹¤Î¤Ç¡¢
¤¢¤Ê¤¿¤Î¹¥¤­¤ÊÊ¸¾Ï¤ò¤½¤Î¿·¤·¤¤¥Ú¡¼¥¸¤Ë½ñ¤¤¤ÆÊÝÂ¸¤·¤Þ¤¹¡£

=item 5.

NewPage¥Ú¡¼¥¸¤¬¤Ç¤­¤ë¤ÈFrontPage¤Î ? ¤Ï¾Ã¤¨¤Æ¡¢¥ê¥ó¥¯¤È¤Ê¤ê¤Þ¤¹¡£ 

=back

=head1 ¥Æ¥­¥¹¥ÈÀ°·Á¤Î¥ë¡¼¥ë

=over 4

=item *

Ï¢Â³¤·¤¿Ê£¿ô¹Ô¤Ï¥Õ¥£¥ë¤µ¤ì¤ÆÉ½¼¨¤µ¤ì¤Þ¤¹¡£

=item *

¶õ¹Ô¤ÏÃÊÍîC<< <p> >>¤Î¶èÀÚ¤ê¤È¤Ê¤ê¤Þ¤¹¡£

=item *

HTML¤Î¥¿¥°¤Ï½ñ¤±¤Þ¤»¤ó¡£

=item *

B<''¥Ü¡¼¥ë¥É''>¤Î¤è¤¦¤Ë¥·¥ó¥°¥ë¥¯¥©¡¼¥ÈÆó¤Ä¤Ç¤Ï¤µ¤à¤È¡¢
¥Ü¡¼¥ë¥ÉC<< <b> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

B<'''¥¤¥¿¥ê¥Ã¥¯'''>¤Î¤è¤¦¤Ë¥·¥ó¥°¥ë¥¯¥©¡¼¥È»°¤Ä¤Ç¤Ï¤µ¤à¤È¡¢
¥¤¥¿¥ê¥Ã¥¯C<< <i> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

B<---->¤Î¤è¤¦¤Ë¥Þ¥¤¥Ê¥¹4¤Ä¤¬¤¢¤ë¤È¡¢
¿åÊ¿ÀþC<< <hr> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

¹Ô¤òB<*>¤Ç¤Ï¤¸¤á¤ë¤È¡¢
Âç¸«½Ð¤·C<< <h2> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

¹Ô¤òB<**>¤Ç¤Ï¤¸¤á¤ë¤È¡¢
¾®¸«½Ð¤·C<< <h3> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

¹Ô¤ò¥Þ¥¤¥Ê¥¹-¤Ç¤Ï¤¸¤á¤ë¤È¡¢
²Õ¾ò½ñ¤­C<< <ul> >>¤Ë¤Ê¤ê¤Þ¤¹¡£
¥Þ¥¤¥Ê¥¹¤Î¿ô¤¬Áý¤¨¤ë¤È¥ì¥Ù¥ë¤¬²¼¤¬¤ê¤Þ¤¹¡Ê3¥ì¥Ù¥ë¤Þ¤Ç¡Ë

    -¹àÌÜ1
    --¹àÌÜ1-1
    --¹àÌÜ1-2
    -¹àÌÜ2
    -¹àÌÜ3
    --¹àÌÜ3-1
    ---¹àÌÜ3-1-1
    ---¹àÌÜ3-1-2
    --¹àÌÜ3-2

=item *

¥³¥í¥ó¤ò»È¤¦¤È¡¢
ÍÑ¸ì¤È²òÀâÊ¸¤Î¥ê¥¹¥ÈC<< <dl> >>¤¬½ñ¤±¤Þ¤¹¡£

    :ÍÑ¸ì1:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸1
    :ÍÑ¸ì2:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸2
    :ÍÑ¸ì3:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸3

=item *

¥ê¥ó¥¯

=over 4

=item *

LinkToSomePage¤äFrontPage¤Î¤è¤¦¤Ë¡¢
±ÑÃ±¸ì¤ÎºÇ½é¤Î°ìÊ¸»ú¤òÂçÊ¸»ú¤Ë¤·¤¿¤â¤Î¤¬
Æó¤Ä°Ê¾åÏ¢Â³¤·¤¿¤â¤Î¤ÏYukiWiki¤Î¥Ú¡¼¥¸Ì¾¤È¤Ê¤ê¡¢
¤½¤ì¤¬Ê¸¾ÏÃæ¤Ë´Þ¤Þ¤ì¤ë¤È¥ê¥ó¥¯¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

http://www.hyuki.com/ ¤Î¤è¤¦¤ÊURL¤Ï¼«Æ°Åª¤Ë¥ê¥ó¥¯¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

Æó½Å¤ÎÂç¤«¤Ã¤³[[ ]]¤Ç¤¯¤¯¤Ã¤¿Ê¸»úÎó¤â¡¢
YukiWiki¤Î¥Ú¡¼¥¸Ì¾¤Ë¤Ê¤ê¤Þ¤¹¡£
Âç¤«¤Ã¤³¤ÎÃæ¤Ë¤Ï¥¹¥Ú¡¼¥¹¤ò´Þ¤á¤Æ¤Ï¤¤¤±¤Þ¤»¤ó¡£
ÆüËÜ¸ì¤â»È¤¨¤Þ¤¹¡£

=back

=item *

¹ÔÆ¬¤¬¥¹¥Ú¡¼¥¹¤ä¥¿¥Ö¤Ç»Ï¤Þ¤Ã¤Æ¤¤¤ë¤È¡¢
¤½¤ì¤ÏÀ°·ÁºÑ¤ß¤ÎÃÊÍîC<< <pre> >>¤È¤·¤Æ°·¤ï¤ì¤Þ¤¹¡£
¥×¥í¥°¥é¥à¤ÎÉ½¼¨¤Ê¤É¤Ë»È¤¦¤ÈÊØÍø¤Ç¤¹¡£


=item *

¹Ô¤ò > ¤Ç¤Ï¤¸¤á¤ë¤È¡¢
°úÍÑÊ¸C<< <blockquote> >>¤¬½ñ¤±¤Þ¤¹¡£
>¤Î¿ô¤¬Â¿¤¤¤È¥¤¥ó¥Ç¥ó¥È¤¬¿¼¤¯¤Ê¤ê¤Þ¤¹¡Ê3¥ì¥Ù¥ë¤Þ¤Ç¡Ë¡£

    >Ê¸¾Ï
    >Ê¸¾Ï
    >>¤µ¤é¤Ê¤ë°úÍÑ
    >Ê¸¾Ï

=back

=head1 ¹¹¿·ÍúÎò

=over 4

=item *

2001Ç¯10·î20Æü¡¢Version 1.6.6¡£

¹¹¿·¤Î¾×ÆÍÂÐºö¡£
¸µ¥Ú¡¼¥¸¤Î´ÊÃ±¤Ê¥Á¥§¥Ã¥¯¥µ¥à¤ò¼è¤Ã¤Æ¤ª¤­¡¢
¹¹¿·Á°¤Ë¥Á¥§¥Ã¥¯¥µ¥à¤òÈæ³Ó¤¹¤ë¡£
½¤Àµ¸Ä½ê¤Ïdigest¤È¤¤¤¦Ê¸»úÎó¤ò¸¡º÷¤¹¤ì¤ÐÊ¬¤«¤ë¡£
ËÜÍè¤ÏMD5¤Ê¤É¤Ç¤Á¤ã¤ó¤È¤ä¤Ã¤¿Êý¤¬¤¤¤¤¤Î¤À¤±¤ì¤É¡£

¾×ÆÍ»þ¤ËÉ½¼¨¤µ¤ì¤ë¥á¥Ã¥»¡¼¥¸¤Ê¤É¤Ï¡Ö¶Ë°­¡×¤µ¤ó¤Î¥Ú¡¼¥¸¤ò»²¹Í¤Ë¤·¤¿¡£

=item *

2001Ç¯10·î17Æü¡¢Version 1.6.5¡£

¥×¥ì¥Ó¥å¡¼²èÌÌ¤Ç¡¢¹¹¿·¥Ü¥¿¥ó¤ò²¡¤·¤¿¤È¤­¤ËÁ÷¿®¤µ¤ì¤ë
¥á¥Ã¥»¡¼¥¸¤ÎÆâÍÆ¤òinputÍ×ÁÇ¤Îtype="hidden"¤ò»È¤Ã¤ÆËä¤á¹þ¤à¤Î¤ò¤ä¤á¤ë¡£
Âå¤ï¤ê¤Ë¡¢textareaÍ×ÁÇ¤ò»È¤¦¡£
ºÆ¥×¥ì¥Ó¥å¡¼ÍÑ¤Ëmyspecial_¤òÆ³Æþ¡£¤Ç¤â¤­¤ì¤¤¤ÊÂÐºö¤Ç¤Ï¤Ê¤¤¡£

=item *

2001Ç¯8·î30Æü¡¢Version 1.6.4¡£

URL¤Ç¥À¥¤¥ì¥¯¥È¤Ë¥Ú¡¼¥¸Ì¾¤ò»ØÄê¤·¤Æ¤â¡¢
$WikiName¤È$BracketName°Ê³°¤Î¥Ú¡¼¥¸¤òºî¤ì¤Ê¤¤¤è¤¦¤Ë¤·¤¿¡£
(is_valid_name¤Èis_editable»²¾È)¡£

=item *

2001Ç¯8·î30Æü¡¢Version 1.6.3¡£

RecentChanges¤òÊÔ½¸¡¦ºÆÊÔ½¸ÉÔ²Ä¤È¤·¤¿¡£
ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤Ï@@uneditable¤Ë¥Ú¡¼¥¸Ì¾¤òÆþ¤ì¤ë¡£

=item *

2001Ç¯2·î25Æü¡¢Version 1.6.1, 1.6.2¡£

º¹Ê¬µ¡Ç½¤Î¥Ð¥°½¤Àµ¡£
do_preview¤Ç'>'¤¬°·¤¨¤Ê¤¤¥Ð¥°¤ò½¤Àµ
¡Ê¥æ¡¼¥¶¤«¤é¤Î»ØÅ¦¡Ë¡£

=item *

2001Ç¯2·î22Æü¡¢Version 1.6.0¡£
º¹Ê¬µ¡Ç½¤ò¼ÂÁõ¤·¤¿¡£

=item *

2001Ç¯2·î19Æü¡¢Version 1.5.4¡£
²èÁü¥Õ¥¡¥¤¥ë¤Ø¤Î¥ê¥ó¥¯¤Ï²èÁü¤Ë¤·¤Æ¤ß¤¿¡£

=item *

2001Ç¯2·î19Æü¡¢Version 1.5.3¡£
RecentChanges¤ÎÃæ¤Ëºï½ü¤·¤¿¥Ú¡¼¥¸¤¬¤¢¤ë¤Î¤ò¤ä¤á¤¿¡£
use strict;¤Ç°ú¤Ã¤«¤«¤ëÉôÊ¬¤ò¾¯¤·À°Íý(´°Á´¤Ç¤Ï¤Ê¤¤)¡£

=item *

2001Ç¯2·î16Æü¡¢Version 1.5.2¡£
textarea¤ËÉ½¼¨¤ª¤è¤Ó¥×¥ì¥Ó¥å¡¼¤¹¤ëÁ°¤Ë < ¤ä > ¤ò &lt; ¤ä &gt; ¤ËÊÑ´¹¤·¤¿
(do_preview, editpage, print_preview_buttons)¡£

=item *

2000Ç¯12·î27Æü¡¢Version 1.5.1¡£
¥×¥ì¥Ó¥å¡¼²èÌÌ¤òÀ°Íý¤·¤¿¡£

=item *

2000Ç¯12·î22Æü¡¢Version 1.5.0¡£
Á´ÂÎÅª¤Ë¤º¤¤¤Ö¤ó½ñ¤­Ä¾¤·¤¿¡£
°ìÍ÷¤òÊÌÅÓºîÀ®¤¹¤ë¤è¤¦¤Ë¤·¤¿(do_list)¡£
½ñ¤­¹þ¤àÁ°¤Ë³ÎÇ§²èÌÌ¤ò½Ð¤¹¤è¤¦¤Ë¤·¤¿(do_preview)¡£
¥Æ¥­¥¹¥È¤Î½ñ¤­Êý¤òÊÔ½¸²èÌÌ¤ËÆþ¤ì¤¿(do_edit, do_reedit)¡£
WhatsNew¢ªRecentChanges¡¢TopPage¢ªFrontPage¤ËÊÑ¹¹¤·¤¿¡£

=item *

2000Ç¯12·î20Æü¡¢Version 1.1.0¡£
tie¤òÍøÍÑ¤·¤Æ¡¢dbmopen¤¬»È¤¨¤Ê¤¤¾ì¹ç¤Ç¤âÆ°ºî¤¹¤ë¤è¤¦¤Ë½¤Àµ¡£
ÍøÍÑ¼Ô¤Î1¿Í¤Ç¤¢¤ë¡Ö¶Ë°­¡×¤µ¤ó¤«¤é
Á÷¤Ã¤Æ¤¤¤¿¤À¤¤¤¿¥³¡¼¥É¤ò¸µ¤Ë¤·¤Æ¤¤¤Þ¤¹¡£

=item *

2000Ç¯9·î5Æü¡¢Version 1.0.2¡£
 <body color=...> ¢ª <body bgcolor=...>
ÍøÍÑ¼Ô¤«¤é¤Î»ØÅ¦¤Ë¤è¤ë¡£´¶¼Õ¡£

=item *

2000Ç¯8·î6Æü¡¢Version 1.0.1¤ò¸ø³«¡£
C MAGAZINE¡Ê¥½¥Õ¥È¥Ð¥ó¥¯¥Ñ¥Ö¥ê¥Ã¥·¥ó¥°¡Ë
2000Ç¯10·î¹æÏ¢ºÜµ­»ö¸þ¤±¸ø³«ÈÇ¡£
[[ ]] ¤ÎºÇ¸å¤¬¡ÖË¾¡×¤Î¤è¤¦¤Ë¥·¥Õ¥ÈJIS¤Ç
0x5D¤Ë¤Ê¤ë¾ì¹ç¤Î²óÈò¤ò¹Ô¤Ê¤Ã¤¿¡£

=item *

2000Ç¯8·î5Æü¡¢Version 1.0.0¤ò¸ø³«¡£

=item *

2000Ç¯7·î23Æü¡¢Version 0.82¤ò¸ø³«¡£
ÊÔ½¸»þ¤Î¥ê¥ó¥¯¥ß¥¹¡£
<textarea>¤ÎÂ°À­ÊÑ¹¹¡£

=item *

2000Ç¯7·î22Æü¡¢Version 0.81¤ò¸ø³«¡£
¥í¥´¤òÁÈ¤ß¹þ¤à¡£

=item *

2000Ç¯7·î21Æü¡¢Version 0.80¤ò¸ø³«¡£
POD¤òCGIÃæ¤Ë½ñ¤­¹þ¤à¡£

=item *

2000Ç¯7·î19Æü¡¢Version 0.70¤ò¸ø³«¡£
'''¥¤¥¿¥ê¥Ã¥¯'''¤ä¡¢--¡¢---¡¢>>¡¢>>>¤Ê¤É¤ò¼ÂÁõ¡£

=item *

2000Ç¯7·î18Æü¡¢Version 0.60¤ò¸ø³«¡£
*ÂÀ»ú*¤ò''ÂÀ»ú''¤ËÊÑ¹¹

=item *

2000Ç¯7·î17Æü¡¢Version 0.50¤ò¸ø³«¡£

=item *

2000Ç¯7·î17Æü¡¢¤µ¤é¤Ë¤¤¤í¤¤¤íÄÉ²Ã¤¹¤ë¡£

=item *

2000Ç¯7·î16Æü¡¢¤¤¤í¤¤¤íÄÉ²Ã¡£

=item *

2000Ç¯7·î15Æü¡¢¸ø³«¡£

=back

=head1 TODO

    - ¥Æ¥­¥¹¥ÈÉ½¼¨¥â¡¼¥É
    - Charset¤òÌÀ¼¨¡£
    - textareaÃæ¤ÎÊÄ¤¸¥¿¥°ÂÐ±þ
    - ¥á¥Ë¥å¡¼¤Î±Ñ¸ìÉ½µ­ÉÕµ­
    - ¥×¥ì¥Ó¥å¡¼¤Î¥Ü¥¿¥ó¤Ç¡¢mymsg¤òinput¤Îvalue¤ËÆþ¤ì¤Æ¤¤¤ë¤¬¡¢²þ¹Ô¤ò¤½¤Î¤Þ¤Þvalue¤Ë¤¤¤ì¤Æ¤Ï¤¤¤±¤Ê¤¤¤Î¤Ç¤Ï¤Ê¤¤¤«¡£
    - ¡ÖºÆÊÔ½¸¡×¤Îµ¡Ç½¤Ï¥Ö¥é¥¦¥¶¤Î back ¤Ç½¼Ê¬¤Ç¤Ï¤Ê¤¤¤«¡£¥×¥ì¥Ó¥å¡¼¤Ï¤â¤Ã¤È¥·¥ó¥×¥ë¤Ë¡£
    - ¥Ú¡¼¥¸¥¿¥¤¥È¥ë¡ÊWikiname¡Ë¤¬¸¡º÷¤Ë¤«¤«¤ë¤è¤¦¤Ë¤¹¤ë¡£
    - InterWikiÉ÷¤Îµ¡Ç½¡ÖURL¤ò±£¤·¤Ä¤Ä¡¢¥ê¥ó¥¯¤òÄ¥¤ë¡×

=head1 ºî¼Ô

    Copyright (C) 2000 by Hiroshi Yuki.
    ·ë¾ë¹À <hyuki@@hyuki.com>
    http://www.hyuki.com/
    http://www.hyuki.com/yukiwiki/

¼ÁÌä¡¢°Õ¸«¡¢¥Ð¥°Êó¹ð¤Ï hyuki@@hyuki.com ¤Ë¥á¡¼¥ë¤·¤Æ¤¯¤À¤µ¤¤¡£

=head1 ÇÛÉÛ¾ò·ï

YukiWiki¤Ï¡¢
GNU General Public License¤Ë¤Æ¸ø³«¤·¤Þ¤¹¡£

YukiWiki¤Ï¥Õ¥ê¡¼¥½¥Õ¥È¤Ç¤¹¡£
¤´¼«Í³¤Ë¤ª»È¤¤¤¯¤À¤µ¤¤¡£
¼«Ê¬¹¥¤ß¤ÎYukiWiki¤¬ºî¤ì¤ë¤è¤¦¤Ë¥·¥ó¥×¥ë¤Ë¤·¤Æ¤¢¤ê¤Þ¤¹¡£

=head1 ¼Õ¼­

ËÜ²È¤ÎWikiWiki¤òºî¤Ã¤¿Cunningham & Cunningham, Inc.¤Ë
´¶¼Õ¤·¤Þ¤¹¡£

YukiWiki¤ò³Ú¤·¤ó¤Ç»È¤Ã¤Æ¤¯¤À¤µ¤ë
¥Í¥Ã¥È¾å¤ÎÊý¡¹¤Ë´¶¼Õ¤·¤Þ¤¹¡£

YukiWiki¤Î¥í¥´¤ò¥Ç¥¶¥¤¥ó¤·¤Æ¤¯¤À¤µ¤Ã¤¿¶¶ËÜÎéÆà¤µ¤ó
http://city.hokkai.or.jp/~reina/
¤Ë´¶¼Õ¤·¤Þ¤¹¡£

tie¤ò»È¤Ã¤¿ÈÇ¤Î¸µ¤Ë¤Ê¤ë¥³¡¼¥É¤òÁ÷¤Ã¤Æ¤¯¤À¤µ¤Ã¤¿
¡Ö¶Ë°­¡×¤µ¤ó¤Ë´¶¼Õ¤·¤Þ¤¹¡£

=head1 »²¾È¥ê¥ó¥¯

=over 4

=item *
d1389 1
a1389 2
YukiWiki¥Û¡¼¥à¥Ú¡¼¥¸
http://www.hyuki.com/yukiwiki/
d1391 3
a1393 1
=item *
d1395 1
a1395 2
ËÜ²È¤ÎWikiWiki
http://c2.com/cgi/wiki?WikiWikiWeb
d1397 1
a1397 1
=item *
d1399 1
a1399 2
ËÜ²È¤ÎWikiWiki¤Îºî¼Ô(Cunningham & Cunningham, Inc.)
http://c2.com/
d1401 1
a1401 1
=item *
d1403 1
a1403 2
YukiWiki¤Î¥í¥´¥Ç¥¶¥¤¥ó¤ò¤·¤Æ¤¯¤À¤µ¤Ã¤¿¶¶ËÜÎéÆà¤µ¤ó¤Î¥Ú¡¼¥¸
http://city.hokkai.or.jp/~reina/
d1405 2
a1406 1
=back
@


1.14
log
@2002-03-24  wakaba <w@@suika.fam.cx>

	* wiki.cgi (inline): 
	- Ignore LinkLikeThis style anchor.
	- Allow [[space including anchor]].
	(make_link): Likewise.  Gets rid of angle branckets
	before make anchor.
@
text
@d23 1
a23 1
# $Id: wiki.cgi,v 1.13 2002/04/02 00:28:14 wakaba Exp $
d668 2
a669 2
<a href="http://www.hyuki.com/yukiwiki/">YukiWiki</a> 1.6.6 Copyright (C) 2000,2001 by <a href="http://www.hyuki.com/">Hiroshi Yuki.</a> ${version}
+ <a href="$modifierlink">$modifier</a>.
d671 1
a671 1
$Revision: 1.13 $ $Date: 2002/04/02 00:28:14 $
d731 1
@


1.13
log
@2002-03-24  wakaba <w@@suika.fam.cx>

	* wiki.cgi (inline): 
	- Ignore LinkLikeThis style anchor.
	- Allow [[space including anchor]].
	(make_link): Likewise.  Gets rid of angle branckets
	before make anchor.
@
text
@d23 1
a23 1
# $Id: wiki.cgi,v 1.11 2002/03/24 01:12:13 wakaba Exp $
d79 2
a80 1
pre, dl, ul, ol, p, blockquote { line-height:120%; }
d671 1
a671 1
$Revision: 1.11 $ $Date: 2002/03/24 01:12:13 $
@


1.12
log
@2002-03-24  wakaba <w@@suika.fam.cx>

	* wiki.cgi (inline): 
	- Ignore LinkLikeThis style anchor.
	- Allow [[space including anchor]].
	(make_link): Likewise.  Gets rid of angle branckets
	before make anchor.
@
text
@d78 1
d80 1
a659 2
<a href="http://www.hyuki.com/yukiwiki/">YukiWiki</a> 1.6.6 Copyright (C) 2000,2001 by <a href="http://www.hyuki.com/">Hiroshi Yuki.</a>
+ <a href="$modifierlink">$modifier</a> ${version}.
d667 2
d732 7
a738 1
        if (/^\*\*(.*)/) {
d747 3
d762 2
a763 1
            push(@@result, &escape($1)); # Not &inline, but &escape
@


1.11
log
@2002-03-24  wakaba <w@@suika.fam.cx>

	* wiki.cgi (inline): 
	- Ignore LinkLikeThis style anchor.
	- Allow [[space including anchor]].
	(make_link): Likewise.  Gets rid of angle branckets
	before make anchor.
@
text
@d23 1
a23 1
# $Id: wiki.cgi,v 1.10 2002/03/24 01:09:03 wakaba Exp $
d664 2
d668 1
a668 2
\$Revision: wiki.cgi,v 1.10 2002/03/24 01:09:03 wakaba Exp $
\$Date: $
d672 1
a672 1
EOD
@


1.10
log
@2002-03-24  wakaba <w@@suika.fam.cx>

	* wiki.cgi (inline): 
	- Ignore LinkLikeThis style anchor.
	- Allow [[space including anchor]].
	(make_link): Likewise.  Gets rid of angle branckets
	before make anchor.
@
text
@d23 1
a23 1
# $Id: wiki.cgi,v 1.7 2002/02/04 15:27:22 wakaba Exp $
d664 6
a669 1
<div class="update">\$Id: $ </div>
@


1.9
log
@Change newline from 0x0D0A to 0x0A.
@
text
@d581 1
a581 1
    return $database{$page_name};
d618 1
a618 1
Content-type: text/html
d648 1
a648 1
<a href="$thisurl?mycmd=read;mypage=$whatsnew">ºÇ½ª¹¹¿·</a>
d657 1
a657 1
<address>
d663 2
a664 1
</address>
d683 1
a683 1
    } elsif ($name =~ /^urn:[0-9A-Za-z_:-]+/) {
d695 1
a695 1
        return qq|<a href="$thisurl?mycmd=edit;mypage=$percent_name" class="wiki newpage">$name?</a>|;
d771 2
a772 1
sub is_editable {
d785 1
a785 1
# Valid¤ÊÌ¾Á°¤«¡©
@


1.8
log
@2002-03-24  wakaba <w@@suika.fam.cx>

	* wiki.cgi (inline): 
	- Ignore LinkLikeThis style anchor.
	- Allow [[space including anchor]].
	(make_link): Likewise.  Gets rid of angle branckets
	before make anchor.
@
text
@d1 1491
a1491 1491
#!/usr/bin/perl
use lib "../lib";
use CGI::Carp 'fatalsToBrowser';
use Algorithm::Diff qw(traverse_sequences);
# use strict;
#
# yukiwiki.cgi - Yet another WikiWikiWeb clone.
#
# Copyright (C) 2000,2001 by Hiroshi Yuki.
# <hyuki@@hyuki.com>
# http://www.hyuki.com/yukiwiki/
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# $Id: wiki.cgi,v 1.7 2002/02/04 15:27:22 wakaba Exp $
##############################
my $version = "1.6.6";
##############################
# Ã±ÆÈ¥Æ¥¹¥È¤Î¤È¤­¤Ë¤Ï 1 ¤Ë¤¹¤ë¡£
my $testing = 0;
##############################
# ´Á»ú¥é¥¤¥Ö¥é¥ê
my $jcodelib = 'jcode.pl';
##############################
# ÊÝÂ¸¡¦É½¼¨¤Î´Á»ú¥³¡¼¥É
my $kanjicode = 'euc';     # 'sjis' 'euc'
my $charset = 'euc-jisx0213';  # 'Shift_JIS' 'EUC-JP'
##############################
# dbmopen¤¬»È¤¨¤ë¤Ê¤é1¡¢»È¤¨¤Ê¤¤¤Ê¤é0
my $dbmopen = 0;
##############################
# ¥Ç¡¼¥¿¥Ù¡¼¥¹Ì¾¡Ê.pag, .dir, .db¤Ê¤É¤ÏÉÔÍ×¡Ë
# $dbmopen = 1¤Î¤È¤­¤Ï¥Ç¡¼¥¿¥Ù¡¼¥¹Ì¾¡¢
# $dbmopen = 0¤Î¤È¤­¤Ï¥Ç¥£¥ì¥¯¥È¥êÌ¾¤Ë¤Ê¤ë¡£
my $dbname = './wikidata';
my $diffdbname = './wikidiff';
##############################
# ½¤Àµ¼Ô¤Î»áÌ¾¡Ê¼«Í³¤ËÊÑ¹¹¤·¤Æ¤¯¤À¤µ¤¤¡Ë
my $modifier = 'suika';
##############################
# ½¤Àµ¼Ô¤ÎWeb¥Ú¡¼¥¸¡Ê¼«Í³¤ËÊÑ¹¹¤·¤Æ¤¯¤À¤µ¤¤¡Ë
my $modifierlink = 'http://suika.fam.cx/';
##############################
# ¤³¤Î¥Ú¡¼¥¸¤ÎURL
my $thisurl = 'wiki';
##############################
# ³«»Ï¥Ú¡¼¥¸Ì¾
my $toppage = 'HomePage';
##############################
# ºÇ½ª¹¹¿·¥Ú¡¼¥¸Ì¾
my $whatsnew = 'RecentChanges';
##############################
# ºÇ½ª¹¹¿·¤Ë·ÇºÜ¤¹¤ë¥Ú¡¼¥¸¿ô
my $maxnew = 50;
##############################
# ¥¢¥¤¥³¥ó¥Õ¥¡¥¤¥ëÌ¾¡Ê¥«¥é¡¼ÈÇ¡Ë
my $iconfile = '';
##############################
# ¥¢¥¤¥³¥ó¥Õ¥¡¥¤¥ëÌ¾¡Ê¥â¥Î¥¯¥íÈÇ¡Ë
# my $iconfile = '';
##############################
# ¥Ú¡¼¥¸¤òÊÑ¹¹¤·¤¿¤È¤­¤Ëtouch¤¹¤ë¥Õ¥¡¥¤¥ë¡Ê''¤Ê¤é²¿¤â¤·¤Ê¤¤¡Ë
my $touchfile = 'touch.txt';
##############################
# ¥×¥ì¥Ó¥å¡¼ÍÑ¤ÎÇØ·Ê¿§
my $preview_color = '#FFCCCC';
##############################
# Á´¥Ú¡¼¥¸¤Î¥¹¥¿¥¤¥ë
my $style = <<'EOD';
pre, dl, ul, ol, p, blockquote { line-height:120%; }
a { text-decoration: none; }
a:link { color: #0000FF; background-color: #FFFFFF; }
a:visited { color: #9900CC; background-color: #FFFFFF; }
a:hover { text-decoration: underline; }
EOD
##############################
# ¥Æ¥­¥¹¥ÈÆþÎÏÉôÊ¬¤ÎÂç¤­¤µ
my $cols = 80;
my $rows = 20;
##############################
my %form = ();
my %database = ();
my %diffbase = ();
my $diff_text = '';
my @@diff_added = ();
my @@diff_deleted = ();
my $msgrefA;
my $msgrefB;
##############################
# ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸Ì¾°ìÍ÷
my @@uneditable = ( $whatsnew );
##############################
# ¥ê¥ó¥¯ÍÑ¤ÎÀµµ¬É½¸½
# YukiWiki¤Î¥ê¥ó¥¯¤Ï2¼ïÎà¤¢¤ë¡£
# 
# (1) WikiName (RecentChanges¤È¤«FrontPage¤Î¤è¤¦¤Ê¤â¤Î)
# (2) BracketName ([[·ë¾ë¹À]]¤È¤«[[¥È¥é¥Ö¥ë¥·¥å¡¼¥È]]¤Î¤è¤¦¤Ê¤â¤Î)
#
# ¢¨¥·¥Õ¥ÈJIS¤Î2¥Ð¥¤¥ÈÌÜ¤Ë¤Ï ']' ¤¬Íè¤¦¤ë¤Î¤Ç¡¢
# Ê¸»ú']'¤ò1¤ÄÂ¿¤¯¤È¤ë¤è¤¦¤Ë¤·¤Æ¤¤¤ë¡£
#
my $WikiName = '([A-Z][a-z]+([A-Z][a-z]+)+)';
my $BracketName = '\[\[([^>\x09]+?\]?)\]\]';

# ¥¢¥¤¥³¥óÉôÊ¬¤Î¥¿¥°
my $IconTag = ''; #<<"EOD";
#<a href="http://www.hyuki.com/yukiwiki/"><img src="$iconfile"
# border="0" width="80" height="80" alt="[YukiWiki]" /></a>
#EOD

require "$jcodelib";

&init_form($kanjicode);

if ($testing) {
    %form = (
        # 'mycmd' => 'write',
        'mycmd' => 'read',
        #'mycmd' => 'search',
        #'mycmd' => 'edit',
        'mymsg' => <<"EOD",
¤Ï¤¸¤á¤Þ¤·¤Æ¡£
¤³¤ì¤«¤é¤¤¤í¤¤¤í½ñ¤­¹þ¤ß¤Þ¤¹¤Í¡£
LinkPage¤â¸«¤Æ¤¯¤À¤µ¤¤¡£
TestPage¤Ï¤É¤¦¤Ç¤·¤ç¤¦¤«¡£
¤É¤¦¤¾¤è¤í¤·¤¯¡£
http://www.hyuki.com/
[[·ë¾ë¹À]]
EOD
        'mypage' => '<·ë¾ë¹À>',
        'myword' => '·ë',
        # '3C8C8B8FE98D5F3E' => '',
        # 'TestPage' => '',
    );
}
&main;
exit(0);

# ¥á¥¤¥ó
sub main {
    &normalize_form;
    if ($dbmopen) {
        if (!dbmopen(%database, $dbname, 0666)) {
            &print_error("(dbmopen) $dbname ¤¬ºî¤ì¤Þ¤»¤ó¡£");
        }
    } else {
        if (!tie(%database, "YukiWikiDB", $dbname)) {
            &print_error("(tie error)");
        }
    }

    # myspecialÂÐ±þ
    foreach (keys %form) {
        if (/^myspecial_(.*)/) {
            $form{mycmd} = $1;
            last;
        }
    }

    if ($form{mycmd} eq 'read') {
        &do_read;
    } elsif ($form{mycmd} eq 'preview') {
        &do_preview;
    } elsif ($form{mycmd} eq 'write') {
        &do_write;
    } elsif ($form{mycmd} eq 'edit') {
        &do_edit;
    } elsif ($form{mycmd} eq 'reedit') {
        &do_reedit;
    } elsif ($form{mycmd} eq 'search') {
        &do_search;
    } elsif ($form{mycmd} eq 'list') {
        &do_list;
    } elsif ($form{mycmd} eq 'diff') {
        &do_diff;
    } else {
        $form{mypage} = $toppage;
        &do_read;
    }
    if ($dbmopen) {
        dbmclose(%database);
    } else {
        untie(%database);
    }
}

# ¥Ú¡¼¥¸¤ÎÉ½¼¨
sub do_read {
    my $page_name = $form{mypage};
    my $percent_name = &encode_percent($page_name);
    &print_header($page_name);
    print qq|<h1>$IconTag<a href="$thisurl?mycmd=search;myword=$percent_name">$page_name</a></h1>\n|;
    &print_toolbar($page_name);
    print &convert_html(&get_page($page_name));
    &print_footer;
}

# ¥Ú¡¼¥¸¤ÎÊÔ½¸
sub do_edit {
    if (not &is_editable($form{mypage})) {
        # ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤ÏÉ½¼¨¤Î¤ß
        &do_read;
        return;
    }
    &editpage(&get_page($form{mypage}));
}

# ¥Ú¡¼¥¸¤ÎºÆÊÔ½¸
sub do_reedit {
    if (not &is_editable($form{mypage})) {
        # ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤ÏÉ½¼¨¤Î¤ß
        &do_read;
    } else {
        &editpage($form{mymsg});
    }
}

sub editpage {
    my $page_msg = shift;
    my $page_name = $form{mypage};
    my $digest = &calc_message_digest($page_msg);
    &print_header($page_name);
    print qq|<h1>$IconTag${page_name}¤ÎÊÔ½¸</h1>\n|;
    &print_toolbar($page_name);
    $page_msg = &escape($page_msg);
    print <<"EOD";
<form action="$thisurl" method="post">
<!--<input type="hidden" name="mycmd" value="preview">-->
<input type="hidden" name="mypage" value="$page_name">
<input type="hidden" name="mydigest" value="$digest">
<textarea cols="$cols" rows="$rows" name="mymsg" wrap="virtual">$page_msg</textarea><br>
<input type="submit" name="myspecial_preview" value="³ÎÇ§">
<input type="submit" name="myspecial_write" value="³ÎÇ§¤»¤ºÊÑ¹¹">
</form>
<hr>
<h3>¥Æ¥­¥¹¥ÈÀ°·Á¤Î¥ë¡¼¥ë</h3>

<p>ÄÌ¾ï¤ÏÆþÎÏ¤·¤¿Ê¸»ú¤¬¤½¤Î¤Þ¤Þ½ÐÎÏ¤µ¤ì¤Þ¤¹¤¬¡¢
°Ê²¼¤Î¥ë¡¼¥ë¤Ë½¾¤Ã¤Æ¥Æ¥­¥¹¥ÈÀ°·Á¤ò¹Ô¤¦¤³¤È¤¬¤Ç¤­¤Þ¤¹¡£</p>

<ul>
<li>
¶õ¹Ô¤ÏÃÊÍî¤Î¶èÀÚ¤ê¤È¤Ê¤ê¤Þ¤¹¡£

<li>
HTML¤Î¥¿¥°¤Ï½ñ¤±¤Þ¤»¤ó¡£

<li>
''¶¯Ä´''¤Î¤è¤¦¤Ë¥·¥ó¥°¥ë¥¯¥©¡¼¥ÈÆó¤Ä¤Ç¤Ï¤µ¤à¤È¡¢¶¯Ä´¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
'''¹¹¤Ë¶¯Ä´'''¤Î¤è¤¦¤Ë¥·¥ó¥°¥ë¥¯¥©¡¼¥È»°¤Ä¤Ç¤Ï¤µ¤à¤È¡¢¹¹¤Ë¶¯Ä´¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
----¤Î¤è¤¦¤Ë¥Þ¥¤¥Ê¥¹4¤Ä¤¬¤¢¤ë¤È¡¢¿åÊ¿Àþ¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
*¤ò¹ÔÆ¬¤Ë½ñ¤¯¤ÈÂç¸«½Ð¤·¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
**¤ò¹ÔÆ¬¤Ë½ñ¤¯¤È¾®¸«½Ð¤·¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
-¤ò¹ÔÆ¬¤Ë½ñ¤¯¤È²Õ¾ò½ñ¤­¤Ë¤Ê¤ê¤Þ¤¹¡£- -- --- ¤Î3¥ì¥Ù¥ë¤¬¤¢¤ê¤Þ¤¹¡£

<li>
:¤ò¹ÔÆ¬¤Ë½ñ¤¯¤ÈÍÑ¸ì¤È²òÀâÊ¸¤¬ºî¤ì¤Þ¤¹¡£

<pre>
    :ÍÑ¸ì1:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸1
    :ÍÑ¸ì2:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸2
    :ÍÑ¸ì3:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸3
</pre>

<li>
http://www.hyuki.com/ ¤Î¤è¤¦¤ÊURL¤Ï¼«Æ°Åª¤Ë¥ê¥ó¥¯¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
YukiWiki¤Î¤è¤¦¤ËÂçÊ¸»ú¾®Ê¸»ú¤òº®¤¼¤¿±ÑÊ¸»úÎó¤ò½ñ¤¯¤È¡¢
YukiWiki¤Î¥Ú¡¼¥¸Ì¾¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
[[·ë¾ë¹À]]¤Î¤è¤¦¤ËÆó½Å¤ÎÂç¤«¤Ã¤³[[ ]]¤Ç¤¯¤¯¤Ã¤¿Ê¸»úÎó¤ò½ñ¤¯¤È¡¢
YukiWiki¤Î¥Ú¡¼¥¸Ì¾¤Ë¤Ê¤ê¤Þ¤¹¡£
Âç¤«¤Ã¤³¤ÎÃæ¤Ë¤Ï¥¹¥Ú¡¼¥¹¤ò´Þ¤á¤Æ¤Ï¤¤¤±¤Þ¤»¤ó¡£
ÆüËÜ¸ì¤â»È¤¨¤Þ¤¹¡£

<li>
¹ÔÆ¬¤¬¥¹¥Ú¡¼¥¹¤Ç»Ï¤Þ¤Ã¤Æ¤¤¤ë¤È¡¢
¤½¤ÎÃÊÍî¤ÏÀ°·ÁºÑ¤ß°·¤ï¤ì¤Þ¤¹¡£
¥×¥í¥°¥é¥à¤ò½ñ¤­¹þ¤à¤È¤­¤Ë»È¤¦¤ÈÊØÍø¤Ç¤¹¡£

<li>
&gt; ¤ò¹ÔÆ¬¤Ë½ñ¤¯¤È¡¢
°úÍÑÊ¸¤¬½ñ¤±¤Þ¤¹¡£
&gt; ¤Î¿ô¤¬Â¿¤¤¤È¥¤¥ó¥Ç¥ó¥È¤¬¿¼¤¯¤Ê¤ê¤Þ¤¹¡Ê3¥ì¥Ù¥ë¤Þ¤Ç¡Ë¡£

</ul>
EOD
    &print_footer;
}

# ¥Ú¡¼¥¸¤Î¸¡º÷
sub do_search {
    if ($form{myword}) {
        &print_header('¸¡º÷·ë²Ì');
        print qq|<h1>$IconTag$form{myword}¤Î¸¡º÷·ë²Ì</h1>\n|;
        &print_toolbar();
        print qq|<ul>\n|;
        my $count = 0;
        foreach my $page_name (sort keys %database) {    # sort¤¹¤ë¤Î¤ÏÌµËÅ¤«¤Ê
            if ($database{$page_name} =~ /\Q$form{'myword'}\E/) {
                my $encoded = &encode_percent($page_name);
                print qq|<li><a href="$thisurl?mycmd=read;mypage=$encoded">$page_name</a>\n|;
                $count++;
            }
        }
        print qq|</ul>\n|;
        if ($count > 0) {
            print qq|<p><strong>$form{myword}</strong>¤ò´Þ¤à¥Ú¡¼¥¸¤Ï¡¢¾å¤Ë¼¨¤¹<strong>$count</strong> ¥Ú¡¼¥¸¤Ç¤¹¡£</p>\n|;
        } else {
            print qq|<p><strong>$form{myword}</strong>¤ò´Þ¤à¥Ú¡¼¥¸¤Ï¸«¤Ä¤«¤ê¤Þ¤»¤ó¡£</p>\n|;
        }
    } else {
        &print_header('Ã±¸ì¸¡º÷');
        print qq|<h1>$IconTagÃ±¸ì¸¡º÷</h1>\n|;
        &print_toolbar();
    }
    print <<"EOD";
<p>
<form action="$thisurl" method="post">
<input type="hidden" name="mycmd" value="search">
<input type="text" name="myword" size="20" value="$form{myword}">
<input type="submit" value="Ã±¸ì¸¡º÷">
</form>
</p>
EOD
    &print_footer;
}

# ¥Ú¡¼¥¸¤Î°ìÍ÷
sub do_list {
    &print_header('¥Ú¡¼¥¸°ìÍ÷');
    print qq|<h1>$IconTag ¥Ú¡¼¥¸°ìÍ÷</h1>\n|;
    &print_toolbar();
    print qq|<ul>\n|;
    foreach my $page_name (sort keys %database) {    # sort¤¹¤ë¤Î¤ÏÌµËÅ¤«¤Ê
        my $encoded = &encode_percent($page_name);
        print qq|<li><a href="$thisurl?mycmd=read;mypage=$encoded">$page_name</a>\n|
    }
    print qq|</ul>\n|;
    &print_footer;
}

# ¥×¥ì¥Ó¥å¡¼
sub do_preview {
    my $page_name = $form{mypage};
    my $escapedmsg = &escape($form{mymsg});
    &print_header($page_name);
    print qq|<h1>$IconTag${page_name}¤Î¥×¥ì¥Ó¥å¡¼</h1>\n|;
    &print_toolbar($page_name);
    # local $percent_name = &encode_percent($page_name);
    print qq|<p>°Ê²¼¤Î¥×¥ì¥Ó¥å¡¼¤ò³ÎÇ§¤·¤Æ¡¢¤è¤±¤ì¤Ð¥Ú¡¼¥¸²¼Éô¤Î¥Ü¥¿¥ó¤Ç¹¹¿·¤·¤Æ¤¯¤À¤µ¤¤¡£</p>\n|;
    if ($form{mymsg}) {
        print qq|<table width="100%" bgcolor="$preview_color" ><tr><td>\n|;
        # print &convert_html($escapedmsg);
        print &convert_html($form{mymsg});
        print qq|</td></tr></table>\n|;
    } else {
        print qq|<p>¡Ê¥Ú¡¼¥¸¤ÎÆâÍÆ¤Ï¶õ¤Ç¤¹¡£¹¹¿·¤¹¤ë¤È¤³¤Î¥Ú¡¼¥¸¤Ï<strong>ºï½ü</strong>¤µ¤ì¤Þ¤¹¡£¡Ë</p>\n|;
    }
    &print_preview_buttons($page_name, $escapedmsg, $form{mydigest});
    &print_footer;
}

sub print_preview_buttons {
    my ($page_name, $escapedmsg, $digest) = @@_;
    print <<"EOD";
    <form action="$thisurl" method="post">
    <textarea cols="$cols" rows="$rows" name="mymsg" wrap="virtual">$escapedmsg</textarea>
    <br />
    <input type="hidden" name="mypage" value="$page_name">
    <input type="hidden" name="mydigest" value="$digest">
    <input type="submit" name="myspecial_preview" value="ºÆÅÙ¥×¥ì¥Ó¥å¡¼">
    <input type="submit" name="myspecial_write" value="¥Ú¡¼¥¸¤Î¹¹¿·">
    </form>
EOD
}

# ½ñ¤­¹þ¤à
sub do_write {
    if (not &is_editable($form{mypage})) {
        # ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤ÏÉ½¼¨¤Î¤ß
        &do_read;
        return;
    }

    my $page_name = $form{mypage};

    # digest¤ò»È¤Ã¤Æ¡¢¹¹¿·¤Î¾×ÆÍ¥Á¥§¥Ã¥¯
    my $original_digest = &calc_message_digest(&get_page($page_name));
    if ($form{mydigest} ne $original_digest) {
        &print_header($page_name);
        print qq|<h1>$IconTag${page_name}¤Ç¡Ú¹¹¿·¤Î¾×ÆÍ¡Û¤¬µ¯¤­¤Þ¤·¤¿</h1>\n|;
        print <<"EOD";
<p>¤¢¤Ê¤¿¤¬¤³¤Î¥Ú¡¼¥¸¤òÊÔ½¸¤·¤Æ¤¤¤ë´Ö¤Ë¡¢
Â¾¤Î¿Í¤¬Æ±¤¸¥Ú¡¼¥¸¤ò¹¹¿·¤·¤Æ¤·¤Þ¤Ã¤¿¤è¤¦¤Ç¤¹¡£
</p><p>
°Ê²¼¤Ë¡¢¤¢¤Ê¤¿¤ÎÊÔ½¸¤·¤¿¥Æ¥­¥¹¥È¤¬¤¢¤ê¤Þ¤¹¤Î¤Ç¡¢
¤¢¤Ê¤¿¤ÎÊÔ½¸ÆâÍÆ¤¬¼º¤ï¤ì¤Ê¤¤¤è¤¦¤Ë¡¢
¤¤¤Þ¤¹¤°¡¢¥á¥âÄ¢¤Ê¤É¤Ë¥³¥Ô¡¼¡õ¥Ú¡¼¥¹¥È¤·¤Æ¤¯¤À¤µ¤¤¡£
</p><p>
¥³¥Ô¡¼¡õ¥Ú¡¼¥¹¥È¤¬ºÑ¤ó¤Ç¤«¤é¡¢
ºÇ¿·¤ÎÆâÍÆ¤ò¸«¤ÆºÆÅÙÊÔ½¸¤·Ä¾¤·¤Æ¤¯¤À¤µ¤¤¡£
ºÇ¿·¤ÎÆâÍÆ¤Ï
<a target="_blank" href="$thisurl?mycmd=read;mypage=$form{mypage}">$form{mypage}</a>
¤Ç¸«¤ë¤³¤È¤¬¤Ç¤­¤Þ¤¹¡£
</p>
EOD
        # &print_toolbar($page_name);
        &print_preview_buttons($page_name, &escape($form{mymsg}), $form{mydigest});
        &print_footer;
        return;
    }

    # diffÀ¸À®
    {
        &opendiff;
        my @@msg1 = split(/\n/, &get_page($page_name));
        my @@msg2 = split(/\n/, $form{mymsg});
        $msgrefA = \@@msg1;
        $msgrefB = \@@msg2;
        &diff_check;
        $diffbase{$form{mypage}} = $diff_text;
        $diff_text = '';
        &closediff;
    }

    &print_header($page_name);
    &set_page($page_name, $form{mymsg});
    if ($form{mymsg}) {
        print qq|<h1>$IconTag${page_name}¤ò¹¹¿·¤·¤Þ¤·¤¿</h1>\n|;
        &print_toolbar($page_name);
        print &convert_html(&get_page($page_name));
    } else {
        print qq|<h1>$IconTag${page_name}¤òºï½ü¤·¤Þ¤·¤¿</h1>\n|;
        &print_toolbar($page_name);
        print qq|<p>${page_name}¤òºï½ü¤·¤Þ¤·¤¿¡£</p>\n|;
    }
    &print_footer;
    # ¹¹¿·¤µ¤ì¤¿¤Î¤Ç¥¿¥Ã¥Á¤·¤Æ¤ª¤¯¡£
    if ($touchfile) {
        open(FILE, "> $touchfile");
        print FILE "\n";
        close(FILE);
    }
}

# ¥Ú¡¼¥¸¤ÎÊÑ¹¹ÅÀ
sub do_diff {
    if (not &is_editable($form{mypage})) {
        # ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤ÏÉ½¼¨¤Î¤ß
        &do_read;
        return;
    }
    &opendiff;
    &print_header($form{mypage} . '¤ÎÊÑ¹¹ÅÀ');
    print qq|<h1>$IconTag <a href="$thisurl?mycmd=read&mypage=$form{mypage}">$form{mypage}</a>¤ÎÊÑ¹¹ÅÀ</h1>\n|;
    &print_toolbar();
    $_ = &escape($diffbase{$form{mypage}});
    print <<"EOD";
<ul>
<li>ÄÉ²Ã¤µ¤ì¤¿¹Ô¤Ï<ins>ÀÄ¿§</ins>¤Ç¤¹¡£
<li>ºï½ü¤µ¤ì¤¿¹Ô¤Ï<del>ÀÖ¿§</del>¤Ç¤¹¡£
<li><a href="$thisurl?mycmd=read;mypage=$form{mypage}">$form{mypage}</a>¤Ø¹Ô¤¯¡£
</ul>
<hr />
EOD
    print qq|<pre>\n|;
    foreach (split(/\n/, $_)) {
        if (/^\+(.*)/) {
            print qq|<ins>$1</ins>\n|;
        } elsif (/^\-(.*)/) {
            print qq|<del>$1</del>\n|;
        } elsif (/^\=(.*)/) {
            print qq|$1\n|;
        } else {
            print qq|??? $_\n|;
        }
    }
    print qq|</pre>\n|;
    &print_footer;
    &closediff;
}

sub opendiff {
    if ($dbmopen) {
        if (!dbmopen(%diffbase, $diffdbname, 0666)) {
            &print_error("(dbmopen) $diffdbname ¤¬ºî¤ì¤Þ¤»¤ó¡£");
        }
    } else {
        if (!tie(%diffbase, "YukiWikiDB", $diffdbname)) {
            &print_error("(tie error)");
        }
    }
}

sub closediff {
    if ($dbmopen) {
        dbmclose(%diffbase);
    } else {
        untie(%diffbase);
    }
}

# ¥Õ¥©¡¼¥à¤«¤é¤Î¾ðÊó¤òÏ¢ÁÛÇÛÎó %form ¤ËÆþ¤ì¤ë
# &init_form('euc');
sub init_form {
    my ($charcode) = @@_;
    my $query;
    if ($ENV{REQUEST_METHOD} =~ /^post$/i) {
        read(STDIN, $query, $ENV{CONTENT_LENGTH});
    } else {
        $query = $ENV{QUERY_STRING};
    }
    my @@assocarray = split(/[&;]/, $query);
    foreach my $assoc (@@assocarray) {
        my ($property, $value) = split(/=/, $assoc);
        $value =~ tr/+/ /;
        $value =~ s/%([A-Fa-f0-9][A-Fa-f0-9])/pack("C", hex($1))/eg;
        &jcode::convert(\$value, $charcode);
        $form{$property} = $value;
    }
}

# ¥¨¥é¡¼¥Ú¡¼¥¸¤ò½ÐÎÏ¤¹¤ë
sub print_error {
    my ($msg) = @@_;
    &print_header('Error');
    print "<h1>$IconTag$msg</h1></body></html>";
    exit(0);
}

sub escape {
    my ($line) = shift;
    $line =~ s|<|&lt;|g;
    $line =~ s|>|&gt;|g;
    $line =~ s|"|&quot;|g;
    # $line =~ s|\&|&amp;|g;
    return $line;
}

sub inline {
    my ($line) = shift;
    $line = &escape($line);
    $line =~ s|'''([^']+?)'''|<strong>$1</strong>|g;
    $line =~ s|''([^']+?)''|<em>$1</em>|g;          
    $line =~ s!
       (
         (?:&lt;(?:mailto|http|https|ftp|urn):[\x21-\x7E]*)&gt;
       #| (?:$WikiName)                         # LocalLinkLikeThis
       | (?:$BracketName)                      # [[ÆüËÜ¸ì¥ê¥ó¥¯]]
       )
            !
                &make_link($1)
            !gex;
    return $line;
}

# ¥Ú¡¼¥¸¤Î¥¿¥¤¥È¥ë¤«¤é¥Ú¡¼¥¸¤ÎÆâÍÆ¤òÆÀ¤ë
sub get_page {
    my $page_name = shift;
    return $database{$page_name};
}

# ¥Ú¡¼¥¸¤ÎÆâÍÆ¤òÍ¿¤¨¤ë
# &set_page($title, $txt)
sub set_page {
    # ¥Ú¡¼¥¸¤ò¹¹¿·¤¹¤ë
    my $title = $_[0];
    $database{$title} = $_[1];
    # ¶õ¥Ú¡¼¥¸¤Ê¤éºï½ü¤¹¤ë
    unless ($database{$title}) {
        delete $database{$title};
    }
    # RecentChanges¤ò¹¹¿·¤¹¤ë
    my $delim = ' - ';
    my @@pages = split(/\n/, $database{$whatsnew});
    my $datestr = &get_current_datestr;
    unshift(@@pages, qq|-$datestr$delim$title|);
    # Æ±°ì¥Ú¡¼¥¸¤Î¹¹¿·¤ÏºÇ¿·¤Î¤â¤Î¤Î¤ß¤Ë¤·¡¢
    # Â¸ºß¤·¤Ê¤¤¥Ú¡¼¥¸¤Ï¥¹¥­¥Ã¥×¤¹¤ë¡£
    my %count;
    my @@newpages;
    foreach my $line (@@pages) {
        my ($prefix, $title) = split(/$delim/, $line);
        $count{$title}++;
        if ($count{$title} == 1 and exists($database{$title})) {
            push(@@newpages, qq|$prefix - $title|);
        }
    }
    # ¤³¤³¤ÇËÜÅö¤Ë¹¹¿·
    $database{$whatsnew} = join("\n", splice(@@newpages, 0, $maxnew));
}

# ¥Ú¡¼¥¸¤Î¥Ø¥Ã¥À¤ò½ÐÎÏ
sub print_header {
    my $title = shift;
    print <<"EOD";
Content-type: text/html

<html><head>
<title>$title</title>
<style type="text/css">
$style
</style>
</head>
<body>
EOD
}

# ¥Ä¡¼¥ë¥Ð¡¼¤ò½ÐÎÏ
sub print_toolbar {
    my $page_name = shift;
    my $percent_name = &encode_percent($page_name);
    my $editlink = '';
    if ($page_name ne '' and &is_editable($page_name)) {
        $editlink = <<"EOD";
<a href="$thisurl?mycmd=edit;mypage=$percent_name">ÊÔ½¸</a> | 
<a href="$thisurl?mycmd=diff;mypage=$percent_name">º¹Ê¬</a> | 
EOD
    }
    print <<"EOD";
<p>
 [ 
<a href="$thisurl?mycmd=read;mypage=$toppage">¥È¥Ã¥×</a> | 
<a href="$thisurl?mycmd=list">°ìÍ÷</a> | 
$editlink
<a href="$thisurl?mycmd=search">Ã±¸ì¸¡º÷</a> | 
<a href="$thisurl?mycmd=read;mypage=$whatsnew">ºÇ½ª¹¹¿·</a>
 ]
</p>
EOD
}

# ¥Ú¡¼¥¸¤Î¥Õ¥Ã¥¿¤ò½ÐÎÏ
sub print_footer {
    print <<"EOD";
<address>
<a href="http://www.hyuki.com/yukiwiki/">YukiWiki</a> 1.6.6 Copyright (C) 2000,2001 by <a href="http://www.hyuki.com/">Hiroshi Yuki.</a>
+ <a href="$modifierlink">$modifier</a> ${version}.
[<a href="/" title="¤³¤Î¥µ¡¼¥Ð¡¼¤Î¼óÊÇ">/</a>
<a href="/map" title="¤³¤Î¥µ¡¼¥Ð¡¼¤Î°ÆÆâ">ÃÏ¿Þ</a>
<a href="/search/" title="¤³¤Î¥µ¡¼¥Ð¡¼¤Î¸¡º÷">¸¡º÷</a>]
</address>
</body></html>
EOD
}

# URL¤ä¥Ú¡¼¥¸¤ÎÌ¾Á°¤«¤é¥ê¥ó¥¯¤òºî¤ë
sub make_link {
    my $name = shift;
    $name =~ s/^&lt;(.*)&gt;$/$1/;
    $name =~ s/^\[\[(.*)\]\]$/$1/;
    if ($name =~ /^(http|https|ftp).*?(\.png|\.jpeg|\.jpg)?$/) {
        if ($2) {
            return qq|<a href="$name"><img border="0" src="$name" /></a>|;
        } else {
            return qq|&lt;<a href="$name">$name</a>&gt;|;
        }
    } elsif ($name =~ /^mailto:(.*)/) {
        my $address = $1;
        return qq|&lt;<a href="$name">$address</a>&gt;|;
    } elsif ($name =~ /^urn:[0-9A-Za-z_:-]+/) {
        return qq|&lt;<a href="/uri-res/N2L?${name}">$name</a>&gt;|;
    } else {
      my $name2 = $name; $name2 =~ tr/\x20/-/;
      if ($database{$name2}) {
        my $percent_name = &encode_percent($name2);
        return qq|<a href="$thisurl?mycmd=read;mypage=$percent_name" class="wiki">$name</a>|;
      } elsif ($database{'[['.$name2.']]'}) {
        my $percent_name = &encode_percent('[['.$name2.']]');
        return qq|<a href="$thisurl?mycmd=read;mypage=$percent_name" class="wiki">$name</a>|;
      } else {
        my $percent_name = &encode_percent($name2);
        return qq|<a href="$thisurl?mycmd=edit;mypage=$percent_name" class="wiki newpage">$name?</a>|;
      }
    }
}

# %xx ¤Î·Á¼°¤Ë¥¨¥ó¥³¡¼¥É¤¹¤ë
# ¤³¤ì¤Ï¡¢
# http://www.hyuki.com/yukiwiki/yukiwiki.cgi?mycmd=read&mypage=%3C%8C%8B%8F%E9%8D_%3E
# ¤È¤¤¤¦·Á¼°¤Î¤¿¤á¤Ë»È¤ï¤ì¤ë¡£
# '<·ë¾ë¹À>' ¢ª '%3C%8C%8B%8F%E9%8D_%3E'
sub encode_percent {
    my $name = shift;
    my $encoded = '';
    foreach my $ch (split(//, $name)) {
        if ($ch =~ /[A-Za-z0-9_]/) {
            $encoded .= $ch;
        } else {
            $encoded .= '%' . sprintf("%02X", ord($ch));
        }
    }
    return $encoded;
}

# ¥Æ¥­¥¹¥ÈËÜÂÎ¤òHTML¤ËÊÑ´¹¤¹¤ë
sub convert_html {
    my ($txt) = shift;
    my (@@txt) = split(/\n/, $txt);
    foreach (@@txt) {
        chomp;
        if (/^\*\*(.*)/) {
            push(@@result, splice(@@saved), '<h3>' . &inline($1) . '</h3>');
        } elsif (/^\*(.*)/) {
            push(@@result, splice(@@saved), '<h2>' . &inline($1) . '</h2>');
        } elsif (/^----/) {
            push(@@result, splice(@@saved), '<hr>');
        } elsif (/^(-{1,3})(.*)/) {
            &back_push('ul', length($1));
            push(@@result, '<li>' . &inline($2) . '</li>');
        } elsif (/^:([^:]+):(.*)/) {
            &back_push('dl', 1);
            push(@@result, '<dt>' . &inline($1) . '</dt>', '<dd>' . &inline($2) . '</dd>');
        } elsif (/^(>{1,3})(.*)/) {
            &back_push('blockquote', length($1));
            push(@@result, &inline($2));
        } elsif (/^\s*$/) {
            push(@@result, splice(@@saved));
            unshift(@@saved, "</p>");
            push(@@result, "<p>");
        } elsif (/^(\s+.*)$/) {
            &back_push('pre', 1);
            push(@@result, &escape($1)); # Not &inline, but &escape
        } else {
            push(@@result, &inline($_));
        }
    }
    push(@@result, splice(@@saved));
    return join("\n", @@result);
}

# &back_push($tag, $count)
# $tag¤Î¥¿¥°¤ò$level¥ì¥Ù¥ë¤Þ¤ÇµÍ¤á¤ë¡£
sub back_push {
    my ($tag, $level) = @@_;
    while (@@saved > $level) {
        push(@@result, shift(@@saved));
    }
    if ($saved[0] ne "</$tag>") {
        push(@@result, splice(@@saved));
    }
    while (@@saved < $level) {
        unshift(@@saved, "</$tag>");
        push(@@result, "<$tag>");
    }
}

# ÊÔ½¸²ÄÇ½¥Ú¡¼¥¸¤«¡©
sub is_editable {
    my ($pagename) = @@_;
    foreach (@@uneditable) {
        if ($pagename eq $_) {
            return 0;
        }
    }
    if (&is_valid_name($pagename)) {
        return 1;
    }
    return 0;
}

# Valid¤ÊÌ¾Á°¤«¡©
sub is_valid_name {
    my ($pagename) = @@_;
    if ($pagename =~ /^$WikiName$/) {
        return 1;
    } elsif ($pagename =~ /^$BracketName$/) {
        return 1;
    } else {
        return 0;
    }
}

# ¸½ºß»þ¹ï¤ÎÊ¸»úÎó¤òÆÀ¤ë
sub get_current_datestr {
    my (@@wdays) = ( "Æü", "·î", "²Ð", "¿å", "ÌÚ", "¶â", "ÅÚ" );
    my ($sec, $min, $hour, $mday, $mon, $year, $wday) = localtime(time);
    return sprintf("%4d-%02d-%02d (%s) %02d:%02d:%02d",
        $year + 1900, $mon + 1, $mday, $wdays[$wday], $hour, $min, $sec);
}

# URL?SomePage¤ä¡¢
# URL?[[·ë¾ë¹À]]¤Î·Á¼°¤À¤Ã¤¿¾ì¹ç¡¢(not yet)
# ¶¯À©Åª¤Ëmycmd¤òread¤Ë¤·¤Æ$form¤ÎÆâÍÆ¤òÀßÄê¤¹¤ë¡£
sub normalize_form {
    foreach my $key (keys %form) {
        if ($key =~ /^$WikiName$/) {
            $form{mycmd} = 'read';
            $form{mypage} = $1;
            last;
        } elsif ($key =~ /^$BracketName$/) {
            $form{mycmd} = 'read';
            $form{mypage} = $1;
            last;
        }
    }
}

# ÊÑ´¹¥Æ¥¹¥È¤ò¹Ô¤Ê¤¦¤È¤­¤Î¥µ¥ó¥×¥ë
sub print_sample {
    my $txt = &convert_html(<<"EOD");
*Âç¸«½Ð¤·1
**¾®¸«½Ð¤·1-1
-¹àÌÜ1
-¹àÌÜ2
-¹àÌÜ3
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî''¶¯Ä´''1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1

ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
**¾®¸«½Ð¤·1-2
:ÍÑ¸ì1:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸1¤È''¶¯Ä´Ã±¸ì''
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
:ÍÑ¸ì2:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸2
:ÍÑ¸ì3:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸3
----
*Âç¸«½Ð¤·2
**¾®¸«½Ð¤·2-1
&lt;http://suika.fam.cx/&gt;
**¾®¸«½Ð¤·2-2

[[·ë¾ë¹À]]

ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî'''¶¯Ä´'''1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî'''''¶¯¤¤¶¯Ä´'''''1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
>ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
>ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
>ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2

¥ì¥Ù¥ë0¥ì¥Ù¥ë0¥ì¥Ù¥ë0¥ì¥Ù¥ë0¥ì¥Ù¥ë0¥ì¥Ù¥ë0

>¥ì¥Ù¥ë1
>¥ì¥Ù¥ë1
>¥ì¥Ù¥ë1
>>¥ì¥Ù¥ë2
>>¥ì¥Ù¥ë2
>>¥ì¥Ù¥ë2
>>>¥ì¥Ù¥ë3
-¤Ï¤í1
--¤Ï¤í2
¤í¤í¤í¤í2
---¤Ï¤í3
--¤Ï¤í2
---¤Ï¤í3
--¤Ï¤í2
---¤Ï¤í3
>>>¥ì¥Ù¥ë3
>>>¥ì¥Ù¥ë3
>>>¥ì¥Ù¥ë3
EOD
    print $txt;
    exit;
}

sub diff_check {
    traverse_sequences(
            $msgrefA, $msgrefB,
            {
                MATCH => \&df_match,
                DISCARD_A => \&df_delete,
                DISCARD_B => \&df_add,
            }
    );
    &diff_flush;
}

sub diff_flush {
    $diff_text .= join('', map { "-$_\n" } splice(@@diff_deleted));
    $diff_text .= join('', map { "+$_\n" } splice(@@diff_added));
}

sub df_match {
    my ($a, $b) = @@_;
    &diff_flush;
    $diff_text .= "=$msgrefA->[$a]\n";
}

sub df_delete {
    my ($a, $b) = @@_;
    push(@@diff_deleted, $msgrefA->[$a]);
}

sub df_add {
    my ($a, $b) = @@_;
    push(@@diff_added, $msgrefB->[$b]);
}

sub calc_message_digest {   # You have to use MD5...
    my $text = shift;
    my @@text = split(//, $text);
    my $len = length($text);
    my $checksum = 0;
    foreach (@@text) {
        $checksum += ord($_);
        $checksum = ($checksum * 2) % 65536 + (($checksum & 32768) ? 1 : 0); # 16bit rotate
    }
    return "$len:$checksum";
}

# Definition of YukiWikiDB
package YukiWikiDB;

my $debug = 1;

# Constructor
sub new {
    return shift->TIEHASH(@@_);
}

# tying
sub TIEHASH {
    my ($class, $dbname) = @@_;
    my $self = {
        dir => $dbname,
        keys => [],
    };
    if (not -d $self->{dir}) {
        if (!mkdir($self->{dir}, 0777)) {
            print "mkdir(" . $self->{dir} . ") fail\n" if ($debug);
            return undef;
        }
    }
    return bless($self, $class);
}

# Store
sub STORE {
    my ($self, $key, $val) = @@_;
    my $file = &make_filename($self, $key);
    if (open(FILE,"> $file")) {
        binmode(FILE);
        print FILE $val;
        close(FILE);
        return $self->{$key} = $val;
    } else {
        print "$file create error.";
    }
}

# Fetch
sub FETCH {
    my ($self, $key) = @@_;
    my $file = &make_filename($self, $key);
    if (open(FILE, $file)) {
        local $/;
        $self->{$key} = <FILE>;
        close(FILE);
    }
    return $self->{$key};
}

# Exists
sub EXISTS {
    my ($self, $key) = @@_;
    my $file = &make_filename($self, $key);
    return -e($file);
}

# Delete
sub DELETE {
    my ($self, $key) = @@_;
    my $file = &make_filename($self, $key);
    unlink $file;
    return delete $self->{$key};
}

sub FIRSTKEY {
    my ($self) = @@_;
    opendir(DIR, $self->{dir}) or die $self->{dir};
    @@{$self->{keys}} = grep /\.txt$/, readdir(DIR);
    foreach my $name (@@{$self->{keys}}) {
        $name =~ s/\.txt$//;
        $name =~ s/[0-9A-F][0-9A-F]/pack("C", hex($&))/eg;
    }
    return shift @@{$self->{keys}};
}

sub NEXTKEY {
    my ($self) = @@_;
    return shift @@{$self->{keys}};
}

sub make_filename {
    my ($self, $key) = @@_;
    my $enkey = '';
    foreach my $ch (split(//, $key)) {
        $enkey .= sprintf("%02X", ord($ch));
    }
    return $self->{dir} . "/$enkey.txt";
}
__END__

=head1 NAME

YukiWiki - ¼«Í³¤Ë¥Ú¡¼¥¸¤òÄÉ²Ã¡¦ºï½ü¡¦ÊÔ½¸¤Ç¤­¤ëWeb¥Ú¡¼¥¸¹½ÃÛCGI

    Copyright (C) 2000,2001 by Hiroshi Yuki.
    ·ë¾ë¹À <hyuki@@hyuki.com>
    http://www.hyuki.com/
    http://www.hyuki.com/yukiwiki/

=head1 SYNOPSIS

    http://www.hyuki.com/yukiwiki/yukiwiki.cgi

=head1 DESCRIPTION

YukiWiki¡Ê·ë¾ë¥¦¥£¥­¥£¡Ë¤Ï»²²Ã¼Ô¤¬¼«Í³¤Ë¥Ú¡¼¥¸¤òÄÉ²Ã¡¦ºï½ü¡¦ÊÔ½¸¤Ç¤­¤ë
ÉÔ»×µÄ¤ÊWeb¥Ú¡¼¥¸·²¤òºî¤ëCGI¤Ç¤¹¡£
Web¤ÇÆ°ºî¤¹¤ë·Ç¼¨ÈÄ¤È¤Á¤ç¤Ã¤È»÷¤Æ¤¤¤Þ¤¹¤¬¡¢
Web·Ç¼¨ÈÄ¤¬Ã±¤Ë¥á¥Ã¥»¡¼¥¸¤òÄÉ²Ã¤¹¤ë¤À¤±¤Ê¤Î¤ËÂÐ¤·¤Æ¡¢
YukiWiki¤Ï¡¢Web¥Ú¡¼¥¸Á´ÂÎ¤ò¼«Í³¤ËÊÑ¹¹¤¹¤ë¤³¤È¤¬¤Ç¤­¤Þ¤¹¡£

YukiWiki¤Ï¡¢Cunningham & Cunningham¤ÎWikiWikiWeb¤Î
»ÅÍÍ¤ò»²¹Í¤Ë¤·¤ÆÆÈ¼«¤Ëºî¤é¤ì¤Þ¤·¤¿¡£

YukiWiki¤ÏPerl¤Ç½ñ¤«¤ì¤¿CGI¥¹¥¯¥ê¥×¥È¤È¤·¤Æ¼Â¸½¤µ¤ì¤Æ¤¤¤Þ¤¹¤Î¤Ç¡¢
Perl¤¬Æ°ºî¤¹¤ëWeb¥µ¡¼¥Ð¤Ê¤é¤ÐÈæ³ÓÅªÍÆ°×¤ËÀßÃÖ¤Ç¤­¤Þ¤¹¡£

¤¢¤È¤Ïdbmopen¤¬»È¤¨¤ë´Ä¶­¤Ê¤é¤ÐÀßÃÖ¤Ç¤­¤Þ¤¹(Version 1.5.0°Ê¹ß¤Ê¤édbmopen¤¬»È¤¨¤Ê¤¯¤Æ¤âÀßÃÖ¤Ç¤­¤Þ¤¹)¡£


YukiWiki¤Ï¥Õ¥ê¡¼¥½¥Õ¥È¤Ç¤¹¡£
¤´¼«Í³¤Ë¤ª»È¤¤¤¯¤À¤µ¤¤¡£

=head1 ÀßÃÖÊýË¡

=head2 Æþ¼ê

YukiWiki¤ÎºÇ¿·ÈÇ¤Ï¡¢
http://www.hyuki.com/yukiwiki/
¤«¤éÆþ¼ê¤Ç¤­¤Þ¤¹¡£

=head2 ¥Õ¥¡¥¤¥ë°ìÍ÷

    readme.txt      ¥É¥­¥å¥á¥ó¥È
    yukiwiki.cgi    YukiWikiËÜÂÎ
    yukiwiki.gif    ¥í¥´¡Ê¥«¥é¡¼ÈÇ¡Ë
    yukimono.gif    ¥í¥´¡Ê¥â¥Î¥¯¥íÈÇ¡Ë
    jcode.pl        ´Á»ú¥³¡¼¥É¥é¥¤¥Ö¥é¥ê

=head2 ¥¤¥ó¥¹¥È¡¼¥ë

=over 4

=item 1.

¥¢¡¼¥«¥¤¥Ö¤ò²ò¤¯¡£

=item 2.

yukiwiki.cgi¤Î¤Ï¤¸¤á¤ÎÊý¤Ë¤¢¤ëÀßÄê¤ò³ÎÇ§¤·¤Þ¤¹¡£
ÄÌ¾ï¤Ï²¿¤â¤·¤Ê¤¯¤Æ¤è¤¤¤¬¡¢
¤Ï¤¸¤á¤Ï$touchfile¤ò''¤Ë¤·¤¿Êý¤¬¤è¤¤¤Ç¤·¤ç¤¦¡£

=item 3.

yukiwiki.cgi¤Èjcode.pl¤òÆ±¤¸¤È¤³¤í¤ËÀßÃÖ¤·¤Þ¤¹¡£

=item 4.

¥µ¥¤¥º0¤Îyukiwiki.db¤È¤¤¤¦¥Õ¥¡¥¤¥ë¤òÀßÃÖ¤·¤Þ¤¹¡£
¡ÊPerl¥·¥¹¥Æ¥à¤Ë¤è¤Ã¤Æ¤Ïyukiwiki.pag, yukiwiki.dir¡Ë

=item 5.

yukiwiki.cgi¤Ë¥Ö¥é¥¦¥¶¤«¤é¥¢¥¯¥»¥¹¤·¤Þ¤¹¡£

=back

=head2 ¥Ñ¡¼¥ß¥Ã¥·¥ç¥ó

        ¥Õ¥¡¥¤¥ë        ¥Ñ¡¼¥ß¥Ã¥·¥ç¥ó      Å¾Á÷¥â¡¼¥É
        yukiwiki.cgi    755                 ASCII
        yukiwiki.gif    644                 BINARY
        yukimono.gif    644                 BINARY
        jcode.pl        644                 ASCII

    $dbmopen = 1; ¤Ë¤·¤¿¾ì¹ç:
        yukiwiki.db     666                 BINARY
        (yukiwiki.pag, yukiwiki.dir¤Î¾ì¹ç¤â¤¢¤ê¡Ë

    $dbmopen = 0; ¤Ë¤·¤¿¾ì¹ç: (¥«¥ì¥ó¥È¥Ç¥£¥ì¥¯¥È¥ê¤ò777¤Ë¤·¤Æ¤ª¤¯)
        .               777                 (Å¾Á÷¤·¤Ê¤¤)

=head1 ¥Ç¡¼¥¿¤Î¥Ð¥Ã¥¯¥¢¥Ã¥×ÊýË¡

$dbmopen = 1;¤Î¾ì¹ç¤Ï¡¢
¥Ç¡¼¥¿¤Ï¤¹¤Ù¤Æyukiwiki.db(.dir, .pag)¤ËÆþ¤ë¡£
¤³¤ì¤ò¥Ð¥Ã¥¯¥¢¥Ã¥×¤¹¤ì¤Ð¤è¤¤¡£

$dbmopen = 0;¤Î¾ì¹ç¤Ï¡¢
yukiwiki¤È¤¤¤¦¥Ç¥£¥ì¥¯¥È¥ê¤¬¤Ç¤­¤ë¤Î¤Ç¡¢
¤³¤ì°Ê²¼¤ò¥Ð¥Ã¥¯¥¢¥Ã¥×¤¹¤ì¤Ð¤è¤¤¡£

=head1 ¿·¤·¤¤¥Ú¡¼¥¸¤Îºî¤êÊý 

=over 4

=item 1.

¤Þ¤º¡¢Å¬Åö¤Ê¥Ú¡¼¥¸¡ÊÎã¤¨¤ÐFrontPage¡Ë¤òÁª¤Ó¡¢
¥Ú¡¼¥¸¤Î²¼¤Ë¤¢¤ë¡ÖÊÔ½¸¡×¥ê¥ó¥¯¤ò¤¿¤É¤ê¤Þ¤¹¡£ 

=item 2.

¤¹¤ë¤È¥Æ¥­¥¹¥ÈÆþÎÏ¤¬¤Ç¤­¤ë¾õÂÖ¤Ë¤Ê¤ë¤Î¤Ç¡¢
¤½¤³¤ËNewPage¤Î¤è¤¦¤ÊÃ±¸ì
¡ÊÂçÊ¸»ú¾®Ê¸»úº®ºß¤·¤Æ¤¤¤ë±ÑÊ¸»úÎó¡Ë
¤ò½ñ¤¤¤Æ¡ÖÊÝÂ¸¡×¤·¤Þ¤¹¡£

=item 3.

ÊÝÂ¸¤¹¤ë¤È¡¢FrontPage¤Î¥Ú¡¼¥¸¤¬½ñ¤­´¹¤ï¤ê¡¢
¤¢¤Ê¤¿¤¬½ñ¤¤¤¿NewPage¤È¤¤¤¦Ê¸»úÎó¤Î¸å¤í¤Ë ? ¤È¤¤¤¦¥ê¥ó¥¯¤¬É½¼¨¤µ¤ì¤Þ¤¹¡£ 
¤³¤Î ? ¤Ï¤½¤Î¥Ú¡¼¥¸¤¬¤Þ¤ÀÂ¸ºß¤·¤Ê¤¤¤³¤È¤ò¼¨¤¹°õ¤Ç¤¹¡£ 

=item 4.

¤½¤Î ? ¤ò¥¯¥ê¥Ã¥¯¤¹¤ë¤È¿·¤·¤¤¥Ú¡¼¥¸NewPage¤¬¤Ç¤­¤Þ¤¹¤Î¤Ç¡¢
¤¢¤Ê¤¿¤Î¹¥¤­¤ÊÊ¸¾Ï¤ò¤½¤Î¿·¤·¤¤¥Ú¡¼¥¸¤Ë½ñ¤¤¤ÆÊÝÂ¸¤·¤Þ¤¹¡£

=item 5.

NewPage¥Ú¡¼¥¸¤¬¤Ç¤­¤ë¤ÈFrontPage¤Î ? ¤Ï¾Ã¤¨¤Æ¡¢¥ê¥ó¥¯¤È¤Ê¤ê¤Þ¤¹¡£ 

=back

=head1 ¥Æ¥­¥¹¥ÈÀ°·Á¤Î¥ë¡¼¥ë

=over 4

=item *

Ï¢Â³¤·¤¿Ê£¿ô¹Ô¤Ï¥Õ¥£¥ë¤µ¤ì¤ÆÉ½¼¨¤µ¤ì¤Þ¤¹¡£

=item *

¶õ¹Ô¤ÏÃÊÍîC<< <p> >>¤Î¶èÀÚ¤ê¤È¤Ê¤ê¤Þ¤¹¡£

=item *

HTML¤Î¥¿¥°¤Ï½ñ¤±¤Þ¤»¤ó¡£

=item *

B<''¥Ü¡¼¥ë¥É''>¤Î¤è¤¦¤Ë¥·¥ó¥°¥ë¥¯¥©¡¼¥ÈÆó¤Ä¤Ç¤Ï¤µ¤à¤È¡¢
¥Ü¡¼¥ë¥ÉC<< <b> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

B<'''¥¤¥¿¥ê¥Ã¥¯'''>¤Î¤è¤¦¤Ë¥·¥ó¥°¥ë¥¯¥©¡¼¥È»°¤Ä¤Ç¤Ï¤µ¤à¤È¡¢
¥¤¥¿¥ê¥Ã¥¯C<< <i> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

B<---->¤Î¤è¤¦¤Ë¥Þ¥¤¥Ê¥¹4¤Ä¤¬¤¢¤ë¤È¡¢
¿åÊ¿ÀþC<< <hr> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

¹Ô¤òB<*>¤Ç¤Ï¤¸¤á¤ë¤È¡¢
Âç¸«½Ð¤·C<< <h2> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

¹Ô¤òB<**>¤Ç¤Ï¤¸¤á¤ë¤È¡¢
¾®¸«½Ð¤·C<< <h3> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

¹Ô¤ò¥Þ¥¤¥Ê¥¹-¤Ç¤Ï¤¸¤á¤ë¤È¡¢
²Õ¾ò½ñ¤­C<< <ul> >>¤Ë¤Ê¤ê¤Þ¤¹¡£
¥Þ¥¤¥Ê¥¹¤Î¿ô¤¬Áý¤¨¤ë¤È¥ì¥Ù¥ë¤¬²¼¤¬¤ê¤Þ¤¹¡Ê3¥ì¥Ù¥ë¤Þ¤Ç¡Ë

    -¹àÌÜ1
    --¹àÌÜ1-1
    --¹àÌÜ1-2
    -¹àÌÜ2
    -¹àÌÜ3
    --¹àÌÜ3-1
    ---¹àÌÜ3-1-1
    ---¹àÌÜ3-1-2
    --¹àÌÜ3-2

=item *

¥³¥í¥ó¤ò»È¤¦¤È¡¢
ÍÑ¸ì¤È²òÀâÊ¸¤Î¥ê¥¹¥ÈC<< <dl> >>¤¬½ñ¤±¤Þ¤¹¡£

    :ÍÑ¸ì1:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸1
    :ÍÑ¸ì2:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸2
    :ÍÑ¸ì3:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸3

=item *

¥ê¥ó¥¯

=over 4

=item *

LinkToSomePage¤äFrontPage¤Î¤è¤¦¤Ë¡¢
±ÑÃ±¸ì¤ÎºÇ½é¤Î°ìÊ¸»ú¤òÂçÊ¸»ú¤Ë¤·¤¿¤â¤Î¤¬
Æó¤Ä°Ê¾åÏ¢Â³¤·¤¿¤â¤Î¤ÏYukiWiki¤Î¥Ú¡¼¥¸Ì¾¤È¤Ê¤ê¡¢
¤½¤ì¤¬Ê¸¾ÏÃæ¤Ë´Þ¤Þ¤ì¤ë¤È¥ê¥ó¥¯¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

http://www.hyuki.com/ ¤Î¤è¤¦¤ÊURL¤Ï¼«Æ°Åª¤Ë¥ê¥ó¥¯¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

Æó½Å¤ÎÂç¤«¤Ã¤³[[ ]]¤Ç¤¯¤¯¤Ã¤¿Ê¸»úÎó¤â¡¢
YukiWiki¤Î¥Ú¡¼¥¸Ì¾¤Ë¤Ê¤ê¤Þ¤¹¡£
Âç¤«¤Ã¤³¤ÎÃæ¤Ë¤Ï¥¹¥Ú¡¼¥¹¤ò´Þ¤á¤Æ¤Ï¤¤¤±¤Þ¤»¤ó¡£
ÆüËÜ¸ì¤â»È¤¨¤Þ¤¹¡£

=back

=item *

¹ÔÆ¬¤¬¥¹¥Ú¡¼¥¹¤ä¥¿¥Ö¤Ç»Ï¤Þ¤Ã¤Æ¤¤¤ë¤È¡¢
¤½¤ì¤ÏÀ°·ÁºÑ¤ß¤ÎÃÊÍîC<< <pre> >>¤È¤·¤Æ°·¤ï¤ì¤Þ¤¹¡£
¥×¥í¥°¥é¥à¤ÎÉ½¼¨¤Ê¤É¤Ë»È¤¦¤ÈÊØÍø¤Ç¤¹¡£


=item *

¹Ô¤ò > ¤Ç¤Ï¤¸¤á¤ë¤È¡¢
°úÍÑÊ¸C<< <blockquote> >>¤¬½ñ¤±¤Þ¤¹¡£
>¤Î¿ô¤¬Â¿¤¤¤È¥¤¥ó¥Ç¥ó¥È¤¬¿¼¤¯¤Ê¤ê¤Þ¤¹¡Ê3¥ì¥Ù¥ë¤Þ¤Ç¡Ë¡£

    >Ê¸¾Ï
    >Ê¸¾Ï
    >>¤µ¤é¤Ê¤ë°úÍÑ
    >Ê¸¾Ï

=back

=head1 ¹¹¿·ÍúÎò

=over 4

=item *

2001Ç¯10·î20Æü¡¢Version 1.6.6¡£

¹¹¿·¤Î¾×ÆÍÂÐºö¡£
¸µ¥Ú¡¼¥¸¤Î´ÊÃ±¤Ê¥Á¥§¥Ã¥¯¥µ¥à¤ò¼è¤Ã¤Æ¤ª¤­¡¢
¹¹¿·Á°¤Ë¥Á¥§¥Ã¥¯¥µ¥à¤òÈæ³Ó¤¹¤ë¡£
½¤Àµ¸Ä½ê¤Ïdigest¤È¤¤¤¦Ê¸»úÎó¤ò¸¡º÷¤¹¤ì¤ÐÊ¬¤«¤ë¡£
ËÜÍè¤ÏMD5¤Ê¤É¤Ç¤Á¤ã¤ó¤È¤ä¤Ã¤¿Êý¤¬¤¤¤¤¤Î¤À¤±¤ì¤É¡£

¾×ÆÍ»þ¤ËÉ½¼¨¤µ¤ì¤ë¥á¥Ã¥»¡¼¥¸¤Ê¤É¤Ï¡Ö¶Ë°­¡×¤µ¤ó¤Î¥Ú¡¼¥¸¤ò»²¹Í¤Ë¤·¤¿¡£

=item *

2001Ç¯10·î17Æü¡¢Version 1.6.5¡£

¥×¥ì¥Ó¥å¡¼²èÌÌ¤Ç¡¢¹¹¿·¥Ü¥¿¥ó¤ò²¡¤·¤¿¤È¤­¤ËÁ÷¿®¤µ¤ì¤ë
¥á¥Ã¥»¡¼¥¸¤ÎÆâÍÆ¤òinputÍ×ÁÇ¤Îtype="hidden"¤ò»È¤Ã¤ÆËä¤á¹þ¤à¤Î¤ò¤ä¤á¤ë¡£
Âå¤ï¤ê¤Ë¡¢textareaÍ×ÁÇ¤ò»È¤¦¡£
ºÆ¥×¥ì¥Ó¥å¡¼ÍÑ¤Ëmyspecial_¤òÆ³Æþ¡£¤Ç¤â¤­¤ì¤¤¤ÊÂÐºö¤Ç¤Ï¤Ê¤¤¡£

=item *

2001Ç¯8·î30Æü¡¢Version 1.6.4¡£

URL¤Ç¥À¥¤¥ì¥¯¥È¤Ë¥Ú¡¼¥¸Ì¾¤ò»ØÄê¤·¤Æ¤â¡¢
$WikiName¤È$BracketName°Ê³°¤Î¥Ú¡¼¥¸¤òºî¤ì¤Ê¤¤¤è¤¦¤Ë¤·¤¿¡£
(is_valid_name¤Èis_editable»²¾È)¡£

=item *

2001Ç¯8·î30Æü¡¢Version 1.6.3¡£

RecentChanges¤òÊÔ½¸¡¦ºÆÊÔ½¸ÉÔ²Ä¤È¤·¤¿¡£
ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤Ï@@uneditable¤Ë¥Ú¡¼¥¸Ì¾¤òÆþ¤ì¤ë¡£

=item *

2001Ç¯2·î25Æü¡¢Version 1.6.1, 1.6.2¡£

º¹Ê¬µ¡Ç½¤Î¥Ð¥°½¤Àµ¡£
do_preview¤Ç'>'¤¬°·¤¨¤Ê¤¤¥Ð¥°¤ò½¤Àµ
¡Ê¥æ¡¼¥¶¤«¤é¤Î»ØÅ¦¡Ë¡£

=item *

2001Ç¯2·î22Æü¡¢Version 1.6.0¡£
º¹Ê¬µ¡Ç½¤ò¼ÂÁõ¤·¤¿¡£

=item *

2001Ç¯2·î19Æü¡¢Version 1.5.4¡£
²èÁü¥Õ¥¡¥¤¥ë¤Ø¤Î¥ê¥ó¥¯¤Ï²èÁü¤Ë¤·¤Æ¤ß¤¿¡£

=item *

2001Ç¯2·î19Æü¡¢Version 1.5.3¡£
RecentChanges¤ÎÃæ¤Ëºï½ü¤·¤¿¥Ú¡¼¥¸¤¬¤¢¤ë¤Î¤ò¤ä¤á¤¿¡£
use strict;¤Ç°ú¤Ã¤«¤«¤ëÉôÊ¬¤ò¾¯¤·À°Íý(´°Á´¤Ç¤Ï¤Ê¤¤)¡£

=item *

2001Ç¯2·î16Æü¡¢Version 1.5.2¡£
textarea¤ËÉ½¼¨¤ª¤è¤Ó¥×¥ì¥Ó¥å¡¼¤¹¤ëÁ°¤Ë < ¤ä > ¤ò &lt; ¤ä &gt; ¤ËÊÑ´¹¤·¤¿
(do_preview, editpage, print_preview_buttons)¡£

=item *

2000Ç¯12·î27Æü¡¢Version 1.5.1¡£
¥×¥ì¥Ó¥å¡¼²èÌÌ¤òÀ°Íý¤·¤¿¡£

=item *

2000Ç¯12·î22Æü¡¢Version 1.5.0¡£
Á´ÂÎÅª¤Ë¤º¤¤¤Ö¤ó½ñ¤­Ä¾¤·¤¿¡£
°ìÍ÷¤òÊÌÅÓºîÀ®¤¹¤ë¤è¤¦¤Ë¤·¤¿(do_list)¡£
½ñ¤­¹þ¤àÁ°¤Ë³ÎÇ§²èÌÌ¤ò½Ð¤¹¤è¤¦¤Ë¤·¤¿(do_preview)¡£
¥Æ¥­¥¹¥È¤Î½ñ¤­Êý¤òÊÔ½¸²èÌÌ¤ËÆþ¤ì¤¿(do_edit, do_reedit)¡£
WhatsNew¢ªRecentChanges¡¢TopPage¢ªFrontPage¤ËÊÑ¹¹¤·¤¿¡£

=item *

2000Ç¯12·î20Æü¡¢Version 1.1.0¡£
tie¤òÍøÍÑ¤·¤Æ¡¢dbmopen¤¬»È¤¨¤Ê¤¤¾ì¹ç¤Ç¤âÆ°ºî¤¹¤ë¤è¤¦¤Ë½¤Àµ¡£
ÍøÍÑ¼Ô¤Î1¿Í¤Ç¤¢¤ë¡Ö¶Ë°­¡×¤µ¤ó¤«¤é
Á÷¤Ã¤Æ¤¤¤¿¤À¤¤¤¿¥³¡¼¥É¤ò¸µ¤Ë¤·¤Æ¤¤¤Þ¤¹¡£

=item *

2000Ç¯9·î5Æü¡¢Version 1.0.2¡£
 <body color=...> ¢ª <body bgcolor=...>
ÍøÍÑ¼Ô¤«¤é¤Î»ØÅ¦¤Ë¤è¤ë¡£´¶¼Õ¡£

=item *

2000Ç¯8·î6Æü¡¢Version 1.0.1¤ò¸ø³«¡£
C MAGAZINE¡Ê¥½¥Õ¥È¥Ð¥ó¥¯¥Ñ¥Ö¥ê¥Ã¥·¥ó¥°¡Ë
2000Ç¯10·î¹æÏ¢ºÜµ­»ö¸þ¤±¸ø³«ÈÇ¡£
[[ ]] ¤ÎºÇ¸å¤¬¡ÖË¾¡×¤Î¤è¤¦¤Ë¥·¥Õ¥ÈJIS¤Ç
0x5D¤Ë¤Ê¤ë¾ì¹ç¤Î²óÈò¤ò¹Ô¤Ê¤Ã¤¿¡£

=item *

2000Ç¯8·î5Æü¡¢Version 1.0.0¤ò¸ø³«¡£

=item *

2000Ç¯7·î23Æü¡¢Version 0.82¤ò¸ø³«¡£
ÊÔ½¸»þ¤Î¥ê¥ó¥¯¥ß¥¹¡£
<textarea>¤ÎÂ°À­ÊÑ¹¹¡£

=item *

2000Ç¯7·î22Æü¡¢Version 0.81¤ò¸ø³«¡£
¥í¥´¤òÁÈ¤ß¹þ¤à¡£

=item *

2000Ç¯7·î21Æü¡¢Version 0.80¤ò¸ø³«¡£
POD¤òCGIÃæ¤Ë½ñ¤­¹þ¤à¡£

=item *

2000Ç¯7·î19Æü¡¢Version 0.70¤ò¸ø³«¡£
'''¥¤¥¿¥ê¥Ã¥¯'''¤ä¡¢--¡¢---¡¢>>¡¢>>>¤Ê¤É¤ò¼ÂÁõ¡£

=item *

2000Ç¯7·î18Æü¡¢Version 0.60¤ò¸ø³«¡£
*ÂÀ»ú*¤ò''ÂÀ»ú''¤ËÊÑ¹¹

=item *

2000Ç¯7·î17Æü¡¢Version 0.50¤ò¸ø³«¡£

=item *

2000Ç¯7·î17Æü¡¢¤µ¤é¤Ë¤¤¤í¤¤¤íÄÉ²Ã¤¹¤ë¡£

=item *

2000Ç¯7·î16Æü¡¢¤¤¤í¤¤¤íÄÉ²Ã¡£

=item *

2000Ç¯7·î15Æü¡¢¸ø³«¡£

=back

=head1 TODO

    - ¥Æ¥­¥¹¥ÈÉ½¼¨¥â¡¼¥É
    - Charset¤òÌÀ¼¨¡£
    - textareaÃæ¤ÎÊÄ¤¸¥¿¥°ÂÐ±þ
    - ¥á¥Ë¥å¡¼¤Î±Ñ¸ìÉ½µ­ÉÕµ­
    - ¥×¥ì¥Ó¥å¡¼¤Î¥Ü¥¿¥ó¤Ç¡¢mymsg¤òinput¤Îvalue¤ËÆþ¤ì¤Æ¤¤¤ë¤¬¡¢²þ¹Ô¤ò¤½¤Î¤Þ¤Þvalue¤Ë¤¤¤ì¤Æ¤Ï¤¤¤±¤Ê¤¤¤Î¤Ç¤Ï¤Ê¤¤¤«¡£
    - ¡ÖºÆÊÔ½¸¡×¤Îµ¡Ç½¤Ï¥Ö¥é¥¦¥¶¤Î back ¤Ç½¼Ê¬¤Ç¤Ï¤Ê¤¤¤«¡£¥×¥ì¥Ó¥å¡¼¤Ï¤â¤Ã¤È¥·¥ó¥×¥ë¤Ë¡£
    - ¥Ú¡¼¥¸¥¿¥¤¥È¥ë¡ÊWikiname¡Ë¤¬¸¡º÷¤Ë¤«¤«¤ë¤è¤¦¤Ë¤¹¤ë¡£
    - InterWikiÉ÷¤Îµ¡Ç½¡ÖURL¤ò±£¤·¤Ä¤Ä¡¢¥ê¥ó¥¯¤òÄ¥¤ë¡×

=head1 ºî¼Ô

    Copyright (C) 2000 by Hiroshi Yuki.
    ·ë¾ë¹À <hyuki@@hyuki.com>
    http://www.hyuki.com/
    http://www.hyuki.com/yukiwiki/

¼ÁÌä¡¢°Õ¸«¡¢¥Ð¥°Êó¹ð¤Ï hyuki@@hyuki.com ¤Ë¥á¡¼¥ë¤·¤Æ¤¯¤À¤µ¤¤¡£

=head1 ÇÛÉÛ¾ò·ï

YukiWiki¤Ï¡¢
GNU General Public License¤Ë¤Æ¸ø³«¤·¤Þ¤¹¡£

YukiWiki¤Ï¥Õ¥ê¡¼¥½¥Õ¥È¤Ç¤¹¡£
¤´¼«Í³¤Ë¤ª»È¤¤¤¯¤À¤µ¤¤¡£
¼«Ê¬¹¥¤ß¤ÎYukiWiki¤¬ºî¤ì¤ë¤è¤¦¤Ë¥·¥ó¥×¥ë¤Ë¤·¤Æ¤¢¤ê¤Þ¤¹¡£

=head1 ¼Õ¼­

ËÜ²È¤ÎWikiWiki¤òºî¤Ã¤¿Cunningham & Cunningham, Inc.¤Ë
´¶¼Õ¤·¤Þ¤¹¡£

YukiWiki¤ò³Ú¤·¤ó¤Ç»È¤Ã¤Æ¤¯¤À¤µ¤ë
¥Í¥Ã¥È¾å¤ÎÊý¡¹¤Ë´¶¼Õ¤·¤Þ¤¹¡£

YukiWiki¤Î¥í¥´¤ò¥Ç¥¶¥¤¥ó¤·¤Æ¤¯¤À¤µ¤Ã¤¿¶¶ËÜÎéÆà¤µ¤ó
http://city.hokkai.or.jp/~reina/
¤Ë´¶¼Õ¤·¤Þ¤¹¡£

tie¤ò»È¤Ã¤¿ÈÇ¤Î¸µ¤Ë¤Ê¤ë¥³¡¼¥É¤òÁ÷¤Ã¤Æ¤¯¤À¤µ¤Ã¤¿
¡Ö¶Ë°­¡×¤µ¤ó¤Ë´¶¼Õ¤·¤Þ¤¹¡£

=head1 »²¾È¥ê¥ó¥¯

=over 4

=item *

YukiWiki¥Û¡¼¥à¥Ú¡¼¥¸
http://www.hyuki.com/yukiwiki/

=item *

ËÜ²È¤ÎWikiWiki
http://c2.com/cgi/wiki?WikiWikiWeb

=item *

ËÜ²È¤ÎWikiWiki¤Îºî¼Ô(Cunningham & Cunningham, Inc.)
http://c2.com/

=item *

YukiWiki¤Î¥í¥´¥Ç¥¶¥¤¥ó¤ò¤·¤Æ¤¯¤À¤µ¤Ã¤¿¶¶ËÜÎéÆà¤µ¤ó¤Î¥Ú¡¼¥¸
http://city.hokkai.or.jp/~reina/

=back

=cut
@


1.7
log
@*** empty log message ***
@
text
@d1 1491
a1491 1484
#!/usr/bin/perl
use lib "../lib";
use CGI::Carp 'fatalsToBrowser';
use Algorithm::Diff qw(traverse_sequences);
# use strict;
#
# yukiwiki.cgi - Yet another WikiWikiWeb clone.
#
# Copyright (C) 2000,2001 by Hiroshi Yuki.
# <hyuki@@hyuki.com>
# http://www.hyuki.com/yukiwiki/
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# $Id: wiki.cgi,v 1.3 2002/02/04 14:36:18 wakaba Exp $
##############################
my $version = "1.6.6";
##############################
# Ã±ÆÈ¥Æ¥¹¥È¤Î¤È¤­¤Ë¤Ï 1 ¤Ë¤¹¤ë¡£
my $testing = 0;
##############################
# ´Á»ú¥é¥¤¥Ö¥é¥ê
my $jcodelib = 'jcode.pl';
##############################
# ÊÝÂ¸¡¦É½¼¨¤Î´Á»ú¥³¡¼¥É
my $kanjicode = 'euc';     # 'sjis' 'euc'
my $charset = 'euc-jisx0213';  # 'Shift_JIS' 'EUC-JP'
##############################
# dbmopen¤¬»È¤¨¤ë¤Ê¤é1¡¢»È¤¨¤Ê¤¤¤Ê¤é0
my $dbmopen = 0;
##############################
# ¥Ç¡¼¥¿¥Ù¡¼¥¹Ì¾¡Ê.pag, .dir, .db¤Ê¤É¤ÏÉÔÍ×¡Ë
# $dbmopen = 1¤Î¤È¤­¤Ï¥Ç¡¼¥¿¥Ù¡¼¥¹Ì¾¡¢
# $dbmopen = 0¤Î¤È¤­¤Ï¥Ç¥£¥ì¥¯¥È¥êÌ¾¤Ë¤Ê¤ë¡£
my $dbname = './wikidata';
my $diffdbname = './wikidiff';
##############################
# ½¤Àµ¼Ô¤Î»áÌ¾¡Ê¼«Í³¤ËÊÑ¹¹¤·¤Æ¤¯¤À¤µ¤¤¡Ë
my $modifier = 'suika';
##############################
# ½¤Àµ¼Ô¤ÎWeb¥Ú¡¼¥¸¡Ê¼«Í³¤ËÊÑ¹¹¤·¤Æ¤¯¤À¤µ¤¤¡Ë
my $modifierlink = 'http://suika.fam.cx/';
##############################
# ¤³¤Î¥Ú¡¼¥¸¤ÎURL
my $thisurl = 'wiki';
##############################
# ³«»Ï¥Ú¡¼¥¸Ì¾
my $toppage = 'HomePage';
##############################
# ºÇ½ª¹¹¿·¥Ú¡¼¥¸Ì¾
my $whatsnew = 'RecentChanges';
##############################
# ºÇ½ª¹¹¿·¤Ë·ÇºÜ¤¹¤ë¥Ú¡¼¥¸¿ô
my $maxnew = 50;
##############################
# ¥¢¥¤¥³¥ó¥Õ¥¡¥¤¥ëÌ¾¡Ê¥«¥é¡¼ÈÇ¡Ë
my $iconfile = '';
##############################
# ¥¢¥¤¥³¥ó¥Õ¥¡¥¤¥ëÌ¾¡Ê¥â¥Î¥¯¥íÈÇ¡Ë
# my $iconfile = '';
##############################
# ¥Ú¡¼¥¸¤òÊÑ¹¹¤·¤¿¤È¤­¤Ëtouch¤¹¤ë¥Õ¥¡¥¤¥ë¡Ê''¤Ê¤é²¿¤â¤·¤Ê¤¤¡Ë
my $touchfile = 'touch.txt';
##############################
# ¥×¥ì¥Ó¥å¡¼ÍÑ¤ÎÇØ·Ê¿§
my $preview_color = '#FFCCCC';
##############################
# Á´¥Ú¡¼¥¸¤Î¥¹¥¿¥¤¥ë
my $style = <<'EOD';
pre, dl, ul, ol, p, blockquote { line-height:120%; }
a { text-decoration: none; }
a:link { color: #0000FF; background-color: #FFFFFF; }
a:visited { color: #9900CC; background-color: #FFFFFF; }
a:hover { text-decoration: underline; }
EOD
##############################
# ¥Æ¥­¥¹¥ÈÆþÎÏÉôÊ¬¤ÎÂç¤­¤µ
my $cols = 80;
my $rows = 20;
##############################
my %form = ();
my %database = ();
my %diffbase = ();
my $diff_text = '';
my @@diff_added = ();
my @@diff_deleted = ();
my $msgrefA;
my $msgrefB;
##############################
# ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸Ì¾°ìÍ÷
my @@uneditable = ( $whatsnew );
##############################
# ¥ê¥ó¥¯ÍÑ¤ÎÀµµ¬É½¸½
# YukiWiki¤Î¥ê¥ó¥¯¤Ï2¼ïÎà¤¢¤ë¡£
# 
# (1) WikiName (RecentChanges¤È¤«FrontPage¤Î¤è¤¦¤Ê¤â¤Î)
# (2) BracketName ([[·ë¾ë¹À]]¤È¤«[[¥È¥é¥Ö¥ë¥·¥å¡¼¥È]]¤Î¤è¤¦¤Ê¤â¤Î)
#
# ¢¨¥·¥Õ¥ÈJIS¤Î2¥Ð¥¤¥ÈÌÜ¤Ë¤Ï ']' ¤¬Íè¤¦¤ë¤Î¤Ç¡¢
# Ê¸»ú']'¤ò1¤ÄÂ¿¤¯¤È¤ë¤è¤¦¤Ë¤·¤Æ¤¤¤ë¡£
#
my $WikiName = '([A-Z][a-z]+([A-Z][a-z]+)+)';
my $BracketName = '\[\[([^>\s]+?\]?)\]\]';

# ¥¢¥¤¥³¥óÉôÊ¬¤Î¥¿¥°
my $IconTag = ''; #<<"EOD";
#<a href="http://www.hyuki.com/yukiwiki/"><img src="$iconfile"
# border="0" width="80" height="80" alt="[YukiWiki]" /></a>
#EOD

require "$jcodelib";

&init_form($kanjicode);

if ($testing) {
    %form = (
        # 'mycmd' => 'write',
        'mycmd' => 'read',
        #'mycmd' => 'search',
        #'mycmd' => 'edit',
        'mymsg' => <<"EOD",
¤Ï¤¸¤á¤Þ¤·¤Æ¡£
¤³¤ì¤«¤é¤¤¤í¤¤¤í½ñ¤­¹þ¤ß¤Þ¤¹¤Í¡£
LinkPage¤â¸«¤Æ¤¯¤À¤µ¤¤¡£
TestPage¤Ï¤É¤¦¤Ç¤·¤ç¤¦¤«¡£
¤É¤¦¤¾¤è¤í¤·¤¯¡£
http://www.hyuki.com/
[[·ë¾ë¹À]]
EOD
        'mypage' => '<·ë¾ë¹À>',
        'myword' => '·ë',
        # '3C8C8B8FE98D5F3E' => '',
        # 'TestPage' => '',
    );
}
&main;
exit(0);

# ¥á¥¤¥ó
sub main {
    &normalize_form;
    if ($dbmopen) {
        if (!dbmopen(%database, $dbname, 0666)) {
            &print_error("(dbmopen) $dbname ¤¬ºî¤ì¤Þ¤»¤ó¡£");
        }
    } else {
        if (!tie(%database, "YukiWikiDB", $dbname)) {
            &print_error("(tie error)");
        }
    }

    # myspecialÂÐ±þ
    foreach (keys %form) {
        if (/^myspecial_(.*)/) {
            $form{mycmd} = $1;
            last;
        }
    }

    if ($form{mycmd} eq 'read') {
        &do_read;
    } elsif ($form{mycmd} eq 'preview') {
        &do_preview;
    } elsif ($form{mycmd} eq 'write') {
        &do_write;
    } elsif ($form{mycmd} eq 'edit') {
        &do_edit;
    } elsif ($form{mycmd} eq 'reedit') {
        &do_reedit;
    } elsif ($form{mycmd} eq 'search') {
        &do_search;
    } elsif ($form{mycmd} eq 'list') {
        &do_list;
    } elsif ($form{mycmd} eq 'diff') {
        &do_diff;
    } else {
        $form{mypage} = $toppage;
        &do_read;
    }
    if ($dbmopen) {
        dbmclose(%database);
    } else {
        untie(%database);
    }
}

# ¥Ú¡¼¥¸¤ÎÉ½¼¨
sub do_read {
    my $page_name = $form{mypage};
    my $percent_name = &encode_percent($page_name);
    &print_header($page_name);
    print qq|<h1>$IconTag<a href="$thisurl?mycmd=search;myword=$percent_name">$page_name</a></h1>\n|;
    &print_toolbar($page_name);
    print &convert_html(&get_page($page_name));
    &print_footer;
}

# ¥Ú¡¼¥¸¤ÎÊÔ½¸
sub do_edit {
    if (not &is_editable($form{mypage})) {
        # ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤ÏÉ½¼¨¤Î¤ß
        &do_read;
        return;
    }
    &editpage(&get_page($form{mypage}));
}

# ¥Ú¡¼¥¸¤ÎºÆÊÔ½¸
sub do_reedit {
    if (not &is_editable($form{mypage})) {
        # ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤ÏÉ½¼¨¤Î¤ß
        &do_read;
    } else {
        &editpage($form{mymsg});
    }
}

sub editpage {
    my $page_msg = shift;
    my $page_name = $form{mypage};
    my $digest = &calc_message_digest($page_msg);
    &print_header($page_name);
    print qq|<h1>$IconTag${page_name}¤ÎÊÔ½¸</h1>\n|;
    &print_toolbar($page_name);
    $page_msg = &escape($page_msg);
    print <<"EOD";
<form action="$thisurl" method="post">
<!--<input type="hidden" name="mycmd" value="preview">-->
<input type="hidden" name="mypage" value="$page_name">
<input type="hidden" name="mydigest" value="$digest">
<textarea cols="$cols" rows="$rows" name="mymsg" wrap="virtual">$page_msg</textarea><br>
<input type="submit" name="myspecial_preview" value="³ÎÇ§">
<input type="submit" name="myspecial_write" value="³ÎÇ§¤»¤ºÊÑ¹¹">
</form>
<hr>
<h3>¥Æ¥­¥¹¥ÈÀ°·Á¤Î¥ë¡¼¥ë</h3>

<p>ÄÌ¾ï¤ÏÆþÎÏ¤·¤¿Ê¸»ú¤¬¤½¤Î¤Þ¤Þ½ÐÎÏ¤µ¤ì¤Þ¤¹¤¬¡¢
°Ê²¼¤Î¥ë¡¼¥ë¤Ë½¾¤Ã¤Æ¥Æ¥­¥¹¥ÈÀ°·Á¤ò¹Ô¤¦¤³¤È¤¬¤Ç¤­¤Þ¤¹¡£</p>

<ul>
<li>
¶õ¹Ô¤ÏÃÊÍî¤Î¶èÀÚ¤ê¤È¤Ê¤ê¤Þ¤¹¡£

<li>
HTML¤Î¥¿¥°¤Ï½ñ¤±¤Þ¤»¤ó¡£

<li>
''¶¯Ä´''¤Î¤è¤¦¤Ë¥·¥ó¥°¥ë¥¯¥©¡¼¥ÈÆó¤Ä¤Ç¤Ï¤µ¤à¤È¡¢¶¯Ä´¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
'''¹¹¤Ë¶¯Ä´'''¤Î¤è¤¦¤Ë¥·¥ó¥°¥ë¥¯¥©¡¼¥È»°¤Ä¤Ç¤Ï¤µ¤à¤È¡¢¹¹¤Ë¶¯Ä´¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
----¤Î¤è¤¦¤Ë¥Þ¥¤¥Ê¥¹4¤Ä¤¬¤¢¤ë¤È¡¢¿åÊ¿Àþ¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
*¤ò¹ÔÆ¬¤Ë½ñ¤¯¤ÈÂç¸«½Ð¤·¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
**¤ò¹ÔÆ¬¤Ë½ñ¤¯¤È¾®¸«½Ð¤·¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
-¤ò¹ÔÆ¬¤Ë½ñ¤¯¤È²Õ¾ò½ñ¤­¤Ë¤Ê¤ê¤Þ¤¹¡£- -- --- ¤Î3¥ì¥Ù¥ë¤¬¤¢¤ê¤Þ¤¹¡£

<li>
:¤ò¹ÔÆ¬¤Ë½ñ¤¯¤ÈÍÑ¸ì¤È²òÀâÊ¸¤¬ºî¤ì¤Þ¤¹¡£

<pre>
    :ÍÑ¸ì1:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸1
    :ÍÑ¸ì2:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸2
    :ÍÑ¸ì3:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸3
</pre>

<li>
http://www.hyuki.com/ ¤Î¤è¤¦¤ÊURL¤Ï¼«Æ°Åª¤Ë¥ê¥ó¥¯¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
YukiWiki¤Î¤è¤¦¤ËÂçÊ¸»ú¾®Ê¸»ú¤òº®¤¼¤¿±ÑÊ¸»úÎó¤ò½ñ¤¯¤È¡¢
YukiWiki¤Î¥Ú¡¼¥¸Ì¾¤Ë¤Ê¤ê¤Þ¤¹¡£

<li>
[[·ë¾ë¹À]]¤Î¤è¤¦¤ËÆó½Å¤ÎÂç¤«¤Ã¤³[[ ]]¤Ç¤¯¤¯¤Ã¤¿Ê¸»úÎó¤ò½ñ¤¯¤È¡¢
YukiWiki¤Î¥Ú¡¼¥¸Ì¾¤Ë¤Ê¤ê¤Þ¤¹¡£
Âç¤«¤Ã¤³¤ÎÃæ¤Ë¤Ï¥¹¥Ú¡¼¥¹¤ò´Þ¤á¤Æ¤Ï¤¤¤±¤Þ¤»¤ó¡£
ÆüËÜ¸ì¤â»È¤¨¤Þ¤¹¡£

<li>
¹ÔÆ¬¤¬¥¹¥Ú¡¼¥¹¤Ç»Ï¤Þ¤Ã¤Æ¤¤¤ë¤È¡¢
¤½¤ÎÃÊÍî¤ÏÀ°·ÁºÑ¤ß°·¤ï¤ì¤Þ¤¹¡£
¥×¥í¥°¥é¥à¤ò½ñ¤­¹þ¤à¤È¤­¤Ë»È¤¦¤ÈÊØÍø¤Ç¤¹¡£

<li>
&gt; ¤ò¹ÔÆ¬¤Ë½ñ¤¯¤È¡¢
°úÍÑÊ¸¤¬½ñ¤±¤Þ¤¹¡£
&gt; ¤Î¿ô¤¬Â¿¤¤¤È¥¤¥ó¥Ç¥ó¥È¤¬¿¼¤¯¤Ê¤ê¤Þ¤¹¡Ê3¥ì¥Ù¥ë¤Þ¤Ç¡Ë¡£

</ul>
EOD
    &print_footer;
}

# ¥Ú¡¼¥¸¤Î¸¡º÷
sub do_search {
    if ($form{myword}) {
        &print_header('¸¡º÷·ë²Ì');
        print qq|<h1>$IconTag$form{myword}¤Î¸¡º÷·ë²Ì</h1>\n|;
        &print_toolbar();
        print qq|<ul>\n|;
        my $count = 0;
        foreach my $page_name (sort keys %database) {    # sort¤¹¤ë¤Î¤ÏÌµËÅ¤«¤Ê
            if ($database{$page_name} =~ /\Q$form{'myword'}\E/) {
                my $encoded = &encode_percent($page_name);
                print qq|<li><a href="$thisurl?mycmd=read;mypage=$encoded">$page_name</a>\n|;
                $count++;
            }
        }
        print qq|</ul>\n|;
        if ($count > 0) {
            print qq|<p><strong>$form{myword}</strong>¤ò´Þ¤à¥Ú¡¼¥¸¤Ï¡¢¾å¤Ë¼¨¤¹<strong>$count</strong> ¥Ú¡¼¥¸¤Ç¤¹¡£</p>\n|;
        } else {
            print qq|<p><strong>$form{myword}</strong>¤ò´Þ¤à¥Ú¡¼¥¸¤Ï¸«¤Ä¤«¤ê¤Þ¤»¤ó¡£</p>\n|;
        }
    } else {
        &print_header('Ã±¸ì¸¡º÷');
        print qq|<h1>$IconTagÃ±¸ì¸¡º÷</h1>\n|;
        &print_toolbar();
    }
    print <<"EOD";
<p>
<form action="$thisurl" method="post">
<input type="hidden" name="mycmd" value="search">
<input type="text" name="myword" size="20" value="$form{myword}">
<input type="submit" value="Ã±¸ì¸¡º÷">
</form>
</p>
EOD
    &print_footer;
}

# ¥Ú¡¼¥¸¤Î°ìÍ÷
sub do_list {
    &print_header('¥Ú¡¼¥¸°ìÍ÷');
    print qq|<h1>$IconTag ¥Ú¡¼¥¸°ìÍ÷</h1>\n|;
    &print_toolbar();
    print qq|<ul>\n|;
    foreach my $page_name (sort keys %database) {    # sort¤¹¤ë¤Î¤ÏÌµËÅ¤«¤Ê
        my $encoded = &encode_percent($page_name);
        print qq|<li><a href="$thisurl?mycmd=read;mypage=$encoded">$page_name</a>\n|
    }
    print qq|</ul>\n|;
    &print_footer;
}

# ¥×¥ì¥Ó¥å¡¼
sub do_preview {
    my $page_name = $form{mypage};
    my $escapedmsg = &escape($form{mymsg});
    &print_header($page_name);
    print qq|<h1>$IconTag${page_name}¤Î¥×¥ì¥Ó¥å¡¼</h1>\n|;
    &print_toolbar($page_name);
    # local $percent_name = &encode_percent($page_name);
    print qq|<p>°Ê²¼¤Î¥×¥ì¥Ó¥å¡¼¤ò³ÎÇ§¤·¤Æ¡¢¤è¤±¤ì¤Ð¥Ú¡¼¥¸²¼Éô¤Î¥Ü¥¿¥ó¤Ç¹¹¿·¤·¤Æ¤¯¤À¤µ¤¤¡£</p>\n|;
    if ($form{mymsg}) {
        print qq|<table width="100%" bgcolor="$preview_color" ><tr><td>\n|;
        # print &convert_html($escapedmsg);
        print &convert_html($form{mymsg});
        print qq|</td></tr></table>\n|;
    } else {
        print qq|<p>¡Ê¥Ú¡¼¥¸¤ÎÆâÍÆ¤Ï¶õ¤Ç¤¹¡£¹¹¿·¤¹¤ë¤È¤³¤Î¥Ú¡¼¥¸¤Ï<strong>ºï½ü</strong>¤µ¤ì¤Þ¤¹¡£¡Ë</p>\n|;
    }
    &print_preview_buttons($page_name, $escapedmsg, $form{mydigest});
    &print_footer;
}

sub print_preview_buttons {
    my ($page_name, $escapedmsg, $digest) = @@_;
    print <<"EOD";
    <form action="$thisurl" method="post">
    <textarea cols="$cols" rows="$rows" name="mymsg" wrap="virtual">$escapedmsg</textarea>
    <br />
    <input type="hidden" name="mypage" value="$page_name">
    <input type="hidden" name="mydigest" value="$digest">
    <input type="submit" name="myspecial_preview" value="ºÆÅÙ¥×¥ì¥Ó¥å¡¼">
    <input type="submit" name="myspecial_write" value="¥Ú¡¼¥¸¤Î¹¹¿·">
    </form>
EOD
}

# ½ñ¤­¹þ¤à
sub do_write {
    if (not &is_editable($form{mypage})) {
        # ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤ÏÉ½¼¨¤Î¤ß
        &do_read;
        return;
    }

    my $page_name = $form{mypage};

    # digest¤ò»È¤Ã¤Æ¡¢¹¹¿·¤Î¾×ÆÍ¥Á¥§¥Ã¥¯
    my $original_digest = &calc_message_digest(&get_page($page_name));
    if ($form{mydigest} ne $original_digest) {
        &print_header($page_name);
        print qq|<h1>$IconTag${page_name}¤Ç¡Ú¹¹¿·¤Î¾×ÆÍ¡Û¤¬µ¯¤­¤Þ¤·¤¿</h1>\n|;
        print <<"EOD";
<p>¤¢¤Ê¤¿¤¬¤³¤Î¥Ú¡¼¥¸¤òÊÔ½¸¤·¤Æ¤¤¤ë´Ö¤Ë¡¢
Â¾¤Î¿Í¤¬Æ±¤¸¥Ú¡¼¥¸¤ò¹¹¿·¤·¤Æ¤·¤Þ¤Ã¤¿¤è¤¦¤Ç¤¹¡£
</p><p>
°Ê²¼¤Ë¡¢¤¢¤Ê¤¿¤ÎÊÔ½¸¤·¤¿¥Æ¥­¥¹¥È¤¬¤¢¤ê¤Þ¤¹¤Î¤Ç¡¢
¤¢¤Ê¤¿¤ÎÊÔ½¸ÆâÍÆ¤¬¼º¤ï¤ì¤Ê¤¤¤è¤¦¤Ë¡¢
¤¤¤Þ¤¹¤°¡¢¥á¥âÄ¢¤Ê¤É¤Ë¥³¥Ô¡¼¡õ¥Ú¡¼¥¹¥È¤·¤Æ¤¯¤À¤µ¤¤¡£
</p><p>
¥³¥Ô¡¼¡õ¥Ú¡¼¥¹¥È¤¬ºÑ¤ó¤Ç¤«¤é¡¢
ºÇ¿·¤ÎÆâÍÆ¤ò¸«¤ÆºÆÅÙÊÔ½¸¤·Ä¾¤·¤Æ¤¯¤À¤µ¤¤¡£
ºÇ¿·¤ÎÆâÍÆ¤Ï
<a target="_blank" href="$thisurl?mycmd=read;mypage=$form{mypage}">$form{mypage}</a>
¤Ç¸«¤ë¤³¤È¤¬¤Ç¤­¤Þ¤¹¡£
</p>
EOD
        # &print_toolbar($page_name);
        &print_preview_buttons($page_name, &escape($form{mymsg}), $form{mydigest});
        &print_footer;
        return;
    }

    # diffÀ¸À®
    {
        &opendiff;
        my @@msg1 = split(/\n/, &get_page($page_name));
        my @@msg2 = split(/\n/, $form{mymsg});
        $msgrefA = \@@msg1;
        $msgrefB = \@@msg2;
        &diff_check;
        $diffbase{$form{mypage}} = $diff_text;
        $diff_text = '';
        &closediff;
    }

    &print_header($page_name);
    &set_page($page_name, $form{mymsg});
    if ($form{mymsg}) {
        print qq|<h1>$IconTag${page_name}¤ò¹¹¿·¤·¤Þ¤·¤¿</h1>\n|;
        &print_toolbar($page_name);
        print &convert_html(&get_page($page_name));
    } else {
        print qq|<h1>$IconTag${page_name}¤òºï½ü¤·¤Þ¤·¤¿</h1>\n|;
        &print_toolbar($page_name);
        print qq|<p>${page_name}¤òºï½ü¤·¤Þ¤·¤¿¡£</p>\n|;
    }
    &print_footer;
    # ¹¹¿·¤µ¤ì¤¿¤Î¤Ç¥¿¥Ã¥Á¤·¤Æ¤ª¤¯¡£
    if ($touchfile) {
        open(FILE, "> $touchfile");
        print FILE "\n";
        close(FILE);
    }
}

# ¥Ú¡¼¥¸¤ÎÊÑ¹¹ÅÀ
sub do_diff {
    if (not &is_editable($form{mypage})) {
        # ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤ÏÉ½¼¨¤Î¤ß
        &do_read;
        return;
    }
    &opendiff;
    &print_header($form{mypage} . '¤ÎÊÑ¹¹ÅÀ');
    print qq|<h1>$IconTag <a href="$thisurl?mycmd=read&mypage=$form{mypage}">$form{mypage}</a>¤ÎÊÑ¹¹ÅÀ</h1>\n|;
    &print_toolbar();
    $_ = &escape($diffbase{$form{mypage}});
    print <<"EOD";
<ul>
<li>ÄÉ²Ã¤µ¤ì¤¿¹Ô¤Ï<ins>ÀÄ¿§</ins>¤Ç¤¹¡£
<li>ºï½ü¤µ¤ì¤¿¹Ô¤Ï<del>ÀÖ¿§</del>¤Ç¤¹¡£
<li><a href="$thisurl?mycmd=read;mypage=$form{mypage}">$form{mypage}</a>¤Ø¹Ô¤¯¡£
</ul>
<hr />
EOD
    print qq|<pre>\n|;
    foreach (split(/\n/, $_)) {
        if (/^\+(.*)/) {
            print qq|<ins>$1</ins>\n|;
        } elsif (/^\-(.*)/) {
            print qq|<del>$1</del>\n|;
        } elsif (/^\=(.*)/) {
            print qq|$1\n|;
        } else {
            print qq|??? $_\n|;
        }
    }
    print qq|</pre>\n|;
    &print_footer;
    &closediff;
}

sub opendiff {
    if ($dbmopen) {
        if (!dbmopen(%diffbase, $diffdbname, 0666)) {
            &print_error("(dbmopen) $diffdbname ¤¬ºî¤ì¤Þ¤»¤ó¡£");
        }
    } else {
        if (!tie(%diffbase, "YukiWikiDB", $diffdbname)) {
            &print_error("(tie error)");
        }
    }
}

sub closediff {
    if ($dbmopen) {
        dbmclose(%diffbase);
    } else {
        untie(%diffbase);
    }
}

# ¥Õ¥©¡¼¥à¤«¤é¤Î¾ðÊó¤òÏ¢ÁÛÇÛÎó %form ¤ËÆþ¤ì¤ë
# &init_form('euc');
sub init_form {
    my ($charcode) = @@_;
    my $query;
    if ($ENV{REQUEST_METHOD} =~ /^post$/i) {
        read(STDIN, $query, $ENV{CONTENT_LENGTH});
    } else {
        $query = $ENV{QUERY_STRING};
    }
    my @@assocarray = split(/[&;]/, $query);
    foreach my $assoc (@@assocarray) {
        my ($property, $value) = split(/=/, $assoc);
        $value =~ tr/+/ /;
        $value =~ s/%([A-Fa-f0-9][A-Fa-f0-9])/pack("C", hex($1))/eg;
        &jcode::convert(\$value, $charcode);
        $form{$property} = $value;
    }
}

# ¥¨¥é¡¼¥Ú¡¼¥¸¤ò½ÐÎÏ¤¹¤ë
sub print_error {
    my ($msg) = @@_;
    &print_header('Error');
    print "<h1>$IconTag$msg</h1></body></html>";
    exit(0);
}

sub escape {
    my ($line) = shift;
    $line =~ s|<|&lt;|g;
    $line =~ s|>|&gt;|g;
    $line =~ s|"|&quot;|g;
    # $line =~ s|\&|&amp;|g;
    return $line;
}

sub inline {
    my ($line) = shift;
    $line = &escape($line);
    $line =~ s|'''([^']+?)'''|<strong>$1</strong>|g;
    $line =~ s|''([^']+?)''|<em>$1</em>|g;          
    $line =~ s!
       (
         (?:&lt;(?:mailto|http|https|ftp|urn):[\x21-\x7E]*)&gt;
       | (?:$WikiName)                         # LocalLinkLikeThis
       | (?:$BracketName)                      # [[ÆüËÜ¸ì¥ê¥ó¥¯]]
       )
            !
                &make_link($1)
            !gex;
    return $line;
}

# ¥Ú¡¼¥¸¤Î¥¿¥¤¥È¥ë¤«¤é¥Ú¡¼¥¸¤ÎÆâÍÆ¤òÆÀ¤ë
sub get_page {
    my $page_name = shift;
    return $database{$page_name};
}

# ¥Ú¡¼¥¸¤ÎÆâÍÆ¤òÍ¿¤¨¤ë
# &set_page($title, $txt)
sub set_page {
    # ¥Ú¡¼¥¸¤ò¹¹¿·¤¹¤ë
    my $title = $_[0];
    $database{$title} = $_[1];
    # ¶õ¥Ú¡¼¥¸¤Ê¤éºï½ü¤¹¤ë
    unless ($database{$title}) {
        delete $database{$title};
    }
    # RecentChanges¤ò¹¹¿·¤¹¤ë
    my $delim = ' - ';
    my @@pages = split(/\n/, $database{$whatsnew});
    my $datestr = &get_current_datestr;
    unshift(@@pages, qq|-$datestr$delim$title|);
    # Æ±°ì¥Ú¡¼¥¸¤Î¹¹¿·¤ÏºÇ¿·¤Î¤â¤Î¤Î¤ß¤Ë¤·¡¢
    # Â¸ºß¤·¤Ê¤¤¥Ú¡¼¥¸¤Ï¥¹¥­¥Ã¥×¤¹¤ë¡£
    my %count;
    my @@newpages;
    foreach my $line (@@pages) {
        my ($prefix, $title) = split(/$delim/, $line);
        $count{$title}++;
        if ($count{$title} == 1 and exists($database{$title})) {
            push(@@newpages, qq|$prefix - $title|);
        }
    }
    # ¤³¤³¤ÇËÜÅö¤Ë¹¹¿·
    $database{$whatsnew} = join("\n", splice(@@newpages, 0, $maxnew));
}

# ¥Ú¡¼¥¸¤Î¥Ø¥Ã¥À¤ò½ÐÎÏ
sub print_header {
    my $title = shift;
    print <<"EOD";
Content-type: text/html

<html><head>
<title>$title</title>
<style type="text/css">
$style
</style>
</head>
<body>
EOD
}

# ¥Ä¡¼¥ë¥Ð¡¼¤ò½ÐÎÏ
sub print_toolbar {
    my $page_name = shift;
    my $percent_name = &encode_percent($page_name);
    my $editlink = '';
    if ($page_name ne '' and &is_editable($page_name)) {
        $editlink = <<"EOD";
<a href="$thisurl?mycmd=edit;mypage=$percent_name">ÊÔ½¸</a> | 
<a href="$thisurl?mycmd=diff;mypage=$percent_name">º¹Ê¬</a> | 
EOD
    }
    print <<"EOD";
<p>
 [ 
<a href="$thisurl?mycmd=read;mypage=$toppage">¥È¥Ã¥×</a> | 
<a href="$thisurl?mycmd=list">°ìÍ÷</a> | 
$editlink
<a href="$thisurl?mycmd=search">Ã±¸ì¸¡º÷</a> | 
<a href="$thisurl?mycmd=read;mypage=$whatsnew">ºÇ½ª¹¹¿·</a>
 ]
</p>
EOD
}

# ¥Ú¡¼¥¸¤Î¥Õ¥Ã¥¿¤ò½ÐÎÏ
sub print_footer {
    print <<"EOD";
<address>
<a href="http://www.hyuki.com/yukiwiki/">YukiWiki</a> 1.6.6 Copyright (C) 2000,2001 by <a href="http://www.hyuki.com/">Hiroshi Yuki.</a>
+ <a href="$modifierlink">$modifier</a> ${version}.
[<a href="/" title="¤³¤Î¥µ¡¼¥Ð¡¼¤Î¼óÊÇ">/</a>
<a href="/map" title="¤³¤Î¥µ¡¼¥Ð¡¼¤Î°ÆÆâ">ÃÏ¿Þ</a>
<a href="/search/" title="¤³¤Î¥µ¡¼¥Ð¡¼¤Î¸¡º÷">¸¡º÷</a>]
</address>
</body></html>
EOD
}

# URL¤ä¥Ú¡¼¥¸¤ÎÌ¾Á°¤«¤é¥ê¥ó¥¯¤òºî¤ë
sub make_link {
    my $name = shift;
    $name =~ s/^&lt;(.*)&gt;$/$1/;
    if ($name =~ /^(http|https|ftp).*?(\.png|\.jpeg|\.jpg)?$/) {
        if ($2) {
            return qq|<a href="$name"><img border="0" src="$name" /></a>|;
        } else {
            return qq|&lt;<a href="$name">$name</a>&gt;|;
        }
    } elsif ($name =~ /^mailto:(.*)/) {
        my $address = $1;
        return qq|&lt;<a href="$name">$address</a>&gt;|;
    } elsif ($name =~ /^urn:[0-9A-Za-z_:-]+/) {
        return qq|&lt;<a href="/uri-res/N2L?${name}">$name</a>&gt;|;
    } elsif ($database{$name}) {
        my $percent_name = &encode_percent($name);
        return qq|<a href="$thisurl?mycmd=read;mypage=$percent_name">$name</a>|;
    } else {
        my $percent_name = &encode_percent($name);
        return qq|$name<a href="$thisurl?mycmd=edit;mypage=$percent_name">?</a>|;
    }
}

# %xx ¤Î·Á¼°¤Ë¥¨¥ó¥³¡¼¥É¤¹¤ë
# ¤³¤ì¤Ï¡¢
# http://www.hyuki.com/yukiwiki/yukiwiki.cgi?mycmd=read&mypage=%3C%8C%8B%8F%E9%8D_%3E
# ¤È¤¤¤¦·Á¼°¤Î¤¿¤á¤Ë»È¤ï¤ì¤ë¡£
# '<·ë¾ë¹À>' ¢ª '%3C%8C%8B%8F%E9%8D_%3E'
sub encode_percent {
    my $name = shift;
    my $encoded = '';
    foreach my $ch (split(//, $name)) {
        if ($ch =~ /[A-Za-z0-9_]/) {
            $encoded .= $ch;
        } else {
            $encoded .= '%' . sprintf("%02X", ord($ch));
        }
    }
    return $encoded;
}

# ¥Æ¥­¥¹¥ÈËÜÂÎ¤òHTML¤ËÊÑ´¹¤¹¤ë
sub convert_html {
    my ($txt) = shift;
    my (@@txt) = split(/\n/, $txt);
    foreach (@@txt) {
        chomp;
        if (/^\*\*(.*)/) {
            push(@@result, splice(@@saved), '<h3>' . &inline($1) . '</h3>');
        } elsif (/^\*(.*)/) {
            push(@@result, splice(@@saved), '<h2>' . &inline($1) . '</h2>');
        } elsif (/^----/) {
            push(@@result, splice(@@saved), '<hr>');
        } elsif (/^(-{1,3})(.*)/) {
            &back_push('ul', length($1));
            push(@@result, '<li>' . &inline($2) . '</li>');
        } elsif (/^:([^:]+):(.*)/) {
            &back_push('dl', 1);
            push(@@result, '<dt>' . &inline($1) . '</dt>', '<dd>' . &inline($2) . '</dd>');
        } elsif (/^(>{1,3})(.*)/) {
            &back_push('blockquote', length($1));
            push(@@result, &inline($2));
        } elsif (/^\s*$/) {
            push(@@result, splice(@@saved));
            unshift(@@saved, "</p>");
            push(@@result, "<p>");
        } elsif (/^(\s+.*)$/) {
            &back_push('pre', 1);
            push(@@result, &escape($1)); # Not &inline, but &escape
        } else {
            push(@@result, &inline($_));
        }
    }
    push(@@result, splice(@@saved));
    return join("\n", @@result);
}

# &back_push($tag, $count)
# $tag¤Î¥¿¥°¤ò$level¥ì¥Ù¥ë¤Þ¤ÇµÍ¤á¤ë¡£
sub back_push {
    my ($tag, $level) = @@_;
    while (@@saved > $level) {
        push(@@result, shift(@@saved));
    }
    if ($saved[0] ne "</$tag>") {
        push(@@result, splice(@@saved));
    }
    while (@@saved < $level) {
        unshift(@@saved, "</$tag>");
        push(@@result, "<$tag>");
    }
}

# ÊÔ½¸²ÄÇ½¥Ú¡¼¥¸¤«¡©
sub is_editable {
    my ($pagename) = @@_;
    foreach (@@uneditable) {
        if ($pagename eq $_) {
            return 0;
        }
    }
    if (&is_valid_name($pagename)) {
        return 1;
    }
    return 0;
}

# Valid¤ÊÌ¾Á°¤«¡©
sub is_valid_name {
    my ($pagename) = @@_;
    if ($pagename =~ /^$WikiName$/) {
        return 1;
    } elsif ($pagename =~ /^$BracketName$/) {
        return 1;
    } else {
        return 0;
    }
}

# ¸½ºß»þ¹ï¤ÎÊ¸»úÎó¤òÆÀ¤ë
sub get_current_datestr {
    my (@@wdays) = ( "Æü", "·î", "²Ð", "¿å", "ÌÚ", "¶â", "ÅÚ" );
    my ($sec, $min, $hour, $mday, $mon, $year, $wday) = localtime(time);
    return sprintf("%4d-%02d-%02d (%s) %02d:%02d:%02d",
        $year + 1900, $mon + 1, $mday, $wdays[$wday], $hour, $min, $sec);
}

# URL?SomePage¤ä¡¢
# URL?[[·ë¾ë¹À]]¤Î·Á¼°¤À¤Ã¤¿¾ì¹ç¡¢(not yet)
# ¶¯À©Åª¤Ëmycmd¤òread¤Ë¤·¤Æ$form¤ÎÆâÍÆ¤òÀßÄê¤¹¤ë¡£
sub normalize_form {
    foreach my $key (keys %form) {
        if ($key =~ /^$WikiName$/) {
            $form{mycmd} = 'read';
            $form{mypage} = $1;
            last;
        } elsif ($key =~ /^$BracketName$/) {
            $form{mycmd} = 'read';
            $form{mypage} = $1;
            last;
        }
    }
}

# ÊÑ´¹¥Æ¥¹¥È¤ò¹Ô¤Ê¤¦¤È¤­¤Î¥µ¥ó¥×¥ë
sub print_sample {
    my $txt = &convert_html(<<"EOD");
*Âç¸«½Ð¤·1
**¾®¸«½Ð¤·1-1
-¹àÌÜ1
-¹àÌÜ2
-¹àÌÜ3
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî''¶¯Ä´''1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1

ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
**¾®¸«½Ð¤·1-2
:ÍÑ¸ì1:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸1¤È''¶¯Ä´Ã±¸ì''
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
:ÍÑ¸ì2:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸2
:ÍÑ¸ì3:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸3
----
*Âç¸«½Ð¤·2
**¾®¸«½Ð¤·2-1
&lt;http://suika.fam.cx/&gt;
**¾®¸«½Ð¤·2-2

[[·ë¾ë¹À]]

ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî'''¶¯Ä´'''1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî'''''¶¯¤¤¶¯Ä´'''''1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1ÃÊÍî1
>ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
>ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2
>ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2ÃÊÍî2

¥ì¥Ù¥ë0¥ì¥Ù¥ë0¥ì¥Ù¥ë0¥ì¥Ù¥ë0¥ì¥Ù¥ë0¥ì¥Ù¥ë0

>¥ì¥Ù¥ë1
>¥ì¥Ù¥ë1
>¥ì¥Ù¥ë1
>>¥ì¥Ù¥ë2
>>¥ì¥Ù¥ë2
>>¥ì¥Ù¥ë2
>>>¥ì¥Ù¥ë3
-¤Ï¤í1
--¤Ï¤í2
¤í¤í¤í¤í2
---¤Ï¤í3
--¤Ï¤í2
---¤Ï¤í3
--¤Ï¤í2
---¤Ï¤í3
>>>¥ì¥Ù¥ë3
>>>¥ì¥Ù¥ë3
>>>¥ì¥Ù¥ë3
EOD
    print $txt;
    exit;
}

sub diff_check {
    traverse_sequences(
            $msgrefA, $msgrefB,
            {
                MATCH => \&df_match,
                DISCARD_A => \&df_delete,
                DISCARD_B => \&df_add,
            }
    );
    &diff_flush;
}

sub diff_flush {
    $diff_text .= join('', map { "-$_\n" } splice(@@diff_deleted));
    $diff_text .= join('', map { "+$_\n" } splice(@@diff_added));
}

sub df_match {
    my ($a, $b) = @@_;
    &diff_flush;
    $diff_text .= "=$msgrefA->[$a]\n";
}

sub df_delete {
    my ($a, $b) = @@_;
    push(@@diff_deleted, $msgrefA->[$a]);
}

sub df_add {
    my ($a, $b) = @@_;
    push(@@diff_added, $msgrefB->[$b]);
}

sub calc_message_digest {   # You have to use MD5...
    my $text = shift;
    my @@text = split(//, $text);
    my $len = length($text);
    my $checksum = 0;
    foreach (@@text) {
        $checksum += ord($_);
        $checksum = ($checksum * 2) % 65536 + (($checksum & 32768) ? 1 : 0); # 16bit rotate
    }
    return "$len:$checksum";
}

# Definition of YukiWikiDB
package YukiWikiDB;

my $debug = 1;

# Constructor
sub new {
    return shift->TIEHASH(@@_);
}

# tying
sub TIEHASH {
    my ($class, $dbname) = @@_;
    my $self = {
        dir => $dbname,
        keys => [],
    };
    if (not -d $self->{dir}) {
        if (!mkdir($self->{dir}, 0777)) {
            print "mkdir(" . $self->{dir} . ") fail\n" if ($debug);
            return undef;
        }
    }
    return bless($self, $class);
}

# Store
sub STORE {
    my ($self, $key, $val) = @@_;
    my $file = &make_filename($self, $key);
    if (open(FILE,"> $file")) {
        binmode(FILE);
        print FILE $val;
        close(FILE);
        return $self->{$key} = $val;
    } else {
        print "$file create error.";
    }
}

# Fetch
sub FETCH {
    my ($self, $key) = @@_;
    my $file = &make_filename($self, $key);
    if (open(FILE, $file)) {
        local $/;
        $self->{$key} = <FILE>;
        close(FILE);
    }
    return $self->{$key};
}

# Exists
sub EXISTS {
    my ($self, $key) = @@_;
    my $file = &make_filename($self, $key);
    return -e($file);
}

# Delete
sub DELETE {
    my ($self, $key) = @@_;
    my $file = &make_filename($self, $key);
    unlink $file;
    return delete $self->{$key};
}

sub FIRSTKEY {
    my ($self) = @@_;
    opendir(DIR, $self->{dir}) or die $self->{dir};
    @@{$self->{keys}} = grep /\.txt$/, readdir(DIR);
    foreach my $name (@@{$self->{keys}}) {
        $name =~ s/\.txt$//;
        $name =~ s/[0-9A-F][0-9A-F]/pack("C", hex($&))/eg;
    }
    return shift @@{$self->{keys}};
}

sub NEXTKEY {
    my ($self) = @@_;
    return shift @@{$self->{keys}};
}

sub make_filename {
    my ($self, $key) = @@_;
    my $enkey = '';
    foreach my $ch (split(//, $key)) {
        $enkey .= sprintf("%02X", ord($ch));
    }
    return $self->{dir} . "/$enkey.txt";
}
__END__

=head1 NAME

YukiWiki - ¼«Í³¤Ë¥Ú¡¼¥¸¤òÄÉ²Ã¡¦ºï½ü¡¦ÊÔ½¸¤Ç¤­¤ëWeb¥Ú¡¼¥¸¹½ÃÛCGI

    Copyright (C) 2000,2001 by Hiroshi Yuki.
    ·ë¾ë¹À <hyuki@@hyuki.com>
    http://www.hyuki.com/
    http://www.hyuki.com/yukiwiki/

=head1 SYNOPSIS

    http://www.hyuki.com/yukiwiki/yukiwiki.cgi

=head1 DESCRIPTION

YukiWiki¡Ê·ë¾ë¥¦¥£¥­¥£¡Ë¤Ï»²²Ã¼Ô¤¬¼«Í³¤Ë¥Ú¡¼¥¸¤òÄÉ²Ã¡¦ºï½ü¡¦ÊÔ½¸¤Ç¤­¤ë
ÉÔ»×µÄ¤ÊWeb¥Ú¡¼¥¸·²¤òºî¤ëCGI¤Ç¤¹¡£
Web¤ÇÆ°ºî¤¹¤ë·Ç¼¨ÈÄ¤È¤Á¤ç¤Ã¤È»÷¤Æ¤¤¤Þ¤¹¤¬¡¢
Web·Ç¼¨ÈÄ¤¬Ã±¤Ë¥á¥Ã¥»¡¼¥¸¤òÄÉ²Ã¤¹¤ë¤À¤±¤Ê¤Î¤ËÂÐ¤·¤Æ¡¢
YukiWiki¤Ï¡¢Web¥Ú¡¼¥¸Á´ÂÎ¤ò¼«Í³¤ËÊÑ¹¹¤¹¤ë¤³¤È¤¬¤Ç¤­¤Þ¤¹¡£

YukiWiki¤Ï¡¢Cunningham & Cunningham¤ÎWikiWikiWeb¤Î
»ÅÍÍ¤ò»²¹Í¤Ë¤·¤ÆÆÈ¼«¤Ëºî¤é¤ì¤Þ¤·¤¿¡£

YukiWiki¤ÏPerl¤Ç½ñ¤«¤ì¤¿CGI¥¹¥¯¥ê¥×¥È¤È¤·¤Æ¼Â¸½¤µ¤ì¤Æ¤¤¤Þ¤¹¤Î¤Ç¡¢
Perl¤¬Æ°ºî¤¹¤ëWeb¥µ¡¼¥Ð¤Ê¤é¤ÐÈæ³ÓÅªÍÆ°×¤ËÀßÃÖ¤Ç¤­¤Þ¤¹¡£

¤¢¤È¤Ïdbmopen¤¬»È¤¨¤ë´Ä¶­¤Ê¤é¤ÐÀßÃÖ¤Ç¤­¤Þ¤¹(Version 1.5.0°Ê¹ß¤Ê¤édbmopen¤¬»È¤¨¤Ê¤¯¤Æ¤âÀßÃÖ¤Ç¤­¤Þ¤¹)¡£


YukiWiki¤Ï¥Õ¥ê¡¼¥½¥Õ¥È¤Ç¤¹¡£
¤´¼«Í³¤Ë¤ª»È¤¤¤¯¤À¤µ¤¤¡£

=head1 ÀßÃÖÊýË¡

=head2 Æþ¼ê

YukiWiki¤ÎºÇ¿·ÈÇ¤Ï¡¢
http://www.hyuki.com/yukiwiki/
¤«¤éÆþ¼ê¤Ç¤­¤Þ¤¹¡£

=head2 ¥Õ¥¡¥¤¥ë°ìÍ÷

    readme.txt      ¥É¥­¥å¥á¥ó¥È
    yukiwiki.cgi    YukiWikiËÜÂÎ
    yukiwiki.gif    ¥í¥´¡Ê¥«¥é¡¼ÈÇ¡Ë
    yukimono.gif    ¥í¥´¡Ê¥â¥Î¥¯¥íÈÇ¡Ë
    jcode.pl        ´Á»ú¥³¡¼¥É¥é¥¤¥Ö¥é¥ê

=head2 ¥¤¥ó¥¹¥È¡¼¥ë

=over 4

=item 1.

¥¢¡¼¥«¥¤¥Ö¤ò²ò¤¯¡£

=item 2.

yukiwiki.cgi¤Î¤Ï¤¸¤á¤ÎÊý¤Ë¤¢¤ëÀßÄê¤ò³ÎÇ§¤·¤Þ¤¹¡£
ÄÌ¾ï¤Ï²¿¤â¤·¤Ê¤¯¤Æ¤è¤¤¤¬¡¢
¤Ï¤¸¤á¤Ï$touchfile¤ò''¤Ë¤·¤¿Êý¤¬¤è¤¤¤Ç¤·¤ç¤¦¡£

=item 3.

yukiwiki.cgi¤Èjcode.pl¤òÆ±¤¸¤È¤³¤í¤ËÀßÃÖ¤·¤Þ¤¹¡£

=item 4.

¥µ¥¤¥º0¤Îyukiwiki.db¤È¤¤¤¦¥Õ¥¡¥¤¥ë¤òÀßÃÖ¤·¤Þ¤¹¡£
¡ÊPerl¥·¥¹¥Æ¥à¤Ë¤è¤Ã¤Æ¤Ïyukiwiki.pag, yukiwiki.dir¡Ë

=item 5.

yukiwiki.cgi¤Ë¥Ö¥é¥¦¥¶¤«¤é¥¢¥¯¥»¥¹¤·¤Þ¤¹¡£

=back

=head2 ¥Ñ¡¼¥ß¥Ã¥·¥ç¥ó

        ¥Õ¥¡¥¤¥ë        ¥Ñ¡¼¥ß¥Ã¥·¥ç¥ó      Å¾Á÷¥â¡¼¥É
        yukiwiki.cgi    755                 ASCII
        yukiwiki.gif    644                 BINARY
        yukimono.gif    644                 BINARY
        jcode.pl        644                 ASCII

    $dbmopen = 1; ¤Ë¤·¤¿¾ì¹ç:
        yukiwiki.db     666                 BINARY
        (yukiwiki.pag, yukiwiki.dir¤Î¾ì¹ç¤â¤¢¤ê¡Ë

    $dbmopen = 0; ¤Ë¤·¤¿¾ì¹ç: (¥«¥ì¥ó¥È¥Ç¥£¥ì¥¯¥È¥ê¤ò777¤Ë¤·¤Æ¤ª¤¯)
        .               777                 (Å¾Á÷¤·¤Ê¤¤)

=head1 ¥Ç¡¼¥¿¤Î¥Ð¥Ã¥¯¥¢¥Ã¥×ÊýË¡

$dbmopen = 1;¤Î¾ì¹ç¤Ï¡¢
¥Ç¡¼¥¿¤Ï¤¹¤Ù¤Æyukiwiki.db(.dir, .pag)¤ËÆþ¤ë¡£
¤³¤ì¤ò¥Ð¥Ã¥¯¥¢¥Ã¥×¤¹¤ì¤Ð¤è¤¤¡£

$dbmopen = 0;¤Î¾ì¹ç¤Ï¡¢
yukiwiki¤È¤¤¤¦¥Ç¥£¥ì¥¯¥È¥ê¤¬¤Ç¤­¤ë¤Î¤Ç¡¢
¤³¤ì°Ê²¼¤ò¥Ð¥Ã¥¯¥¢¥Ã¥×¤¹¤ì¤Ð¤è¤¤¡£

=head1 ¿·¤·¤¤¥Ú¡¼¥¸¤Îºî¤êÊý 

=over 4

=item 1.

¤Þ¤º¡¢Å¬Åö¤Ê¥Ú¡¼¥¸¡ÊÎã¤¨¤ÐFrontPage¡Ë¤òÁª¤Ó¡¢
¥Ú¡¼¥¸¤Î²¼¤Ë¤¢¤ë¡ÖÊÔ½¸¡×¥ê¥ó¥¯¤ò¤¿¤É¤ê¤Þ¤¹¡£ 

=item 2.

¤¹¤ë¤È¥Æ¥­¥¹¥ÈÆþÎÏ¤¬¤Ç¤­¤ë¾õÂÖ¤Ë¤Ê¤ë¤Î¤Ç¡¢
¤½¤³¤ËNewPage¤Î¤è¤¦¤ÊÃ±¸ì
¡ÊÂçÊ¸»ú¾®Ê¸»úº®ºß¤·¤Æ¤¤¤ë±ÑÊ¸»úÎó¡Ë
¤ò½ñ¤¤¤Æ¡ÖÊÝÂ¸¡×¤·¤Þ¤¹¡£

=item 3.

ÊÝÂ¸¤¹¤ë¤È¡¢FrontPage¤Î¥Ú¡¼¥¸¤¬½ñ¤­´¹¤ï¤ê¡¢
¤¢¤Ê¤¿¤¬½ñ¤¤¤¿NewPage¤È¤¤¤¦Ê¸»úÎó¤Î¸å¤í¤Ë ? ¤È¤¤¤¦¥ê¥ó¥¯¤¬É½¼¨¤µ¤ì¤Þ¤¹¡£ 
¤³¤Î ? ¤Ï¤½¤Î¥Ú¡¼¥¸¤¬¤Þ¤ÀÂ¸ºß¤·¤Ê¤¤¤³¤È¤ò¼¨¤¹°õ¤Ç¤¹¡£ 

=item 4.

¤½¤Î ? ¤ò¥¯¥ê¥Ã¥¯¤¹¤ë¤È¿·¤·¤¤¥Ú¡¼¥¸NewPage¤¬¤Ç¤­¤Þ¤¹¤Î¤Ç¡¢
¤¢¤Ê¤¿¤Î¹¥¤­¤ÊÊ¸¾Ï¤ò¤½¤Î¿·¤·¤¤¥Ú¡¼¥¸¤Ë½ñ¤¤¤ÆÊÝÂ¸¤·¤Þ¤¹¡£

=item 5.

NewPage¥Ú¡¼¥¸¤¬¤Ç¤­¤ë¤ÈFrontPage¤Î ? ¤Ï¾Ã¤¨¤Æ¡¢¥ê¥ó¥¯¤È¤Ê¤ê¤Þ¤¹¡£ 

=back

=head1 ¥Æ¥­¥¹¥ÈÀ°·Á¤Î¥ë¡¼¥ë

=over 4

=item *

Ï¢Â³¤·¤¿Ê£¿ô¹Ô¤Ï¥Õ¥£¥ë¤µ¤ì¤ÆÉ½¼¨¤µ¤ì¤Þ¤¹¡£

=item *

¶õ¹Ô¤ÏÃÊÍîC<< <p> >>¤Î¶èÀÚ¤ê¤È¤Ê¤ê¤Þ¤¹¡£

=item *

HTML¤Î¥¿¥°¤Ï½ñ¤±¤Þ¤»¤ó¡£

=item *

B<''¥Ü¡¼¥ë¥É''>¤Î¤è¤¦¤Ë¥·¥ó¥°¥ë¥¯¥©¡¼¥ÈÆó¤Ä¤Ç¤Ï¤µ¤à¤È¡¢
¥Ü¡¼¥ë¥ÉC<< <b> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

B<'''¥¤¥¿¥ê¥Ã¥¯'''>¤Î¤è¤¦¤Ë¥·¥ó¥°¥ë¥¯¥©¡¼¥È»°¤Ä¤Ç¤Ï¤µ¤à¤È¡¢
¥¤¥¿¥ê¥Ã¥¯C<< <i> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

B<---->¤Î¤è¤¦¤Ë¥Þ¥¤¥Ê¥¹4¤Ä¤¬¤¢¤ë¤È¡¢
¿åÊ¿ÀþC<< <hr> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

¹Ô¤òB<*>¤Ç¤Ï¤¸¤á¤ë¤È¡¢
Âç¸«½Ð¤·C<< <h2> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

¹Ô¤òB<**>¤Ç¤Ï¤¸¤á¤ë¤È¡¢
¾®¸«½Ð¤·C<< <h3> >>¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

¹Ô¤ò¥Þ¥¤¥Ê¥¹-¤Ç¤Ï¤¸¤á¤ë¤È¡¢
²Õ¾ò½ñ¤­C<< <ul> >>¤Ë¤Ê¤ê¤Þ¤¹¡£
¥Þ¥¤¥Ê¥¹¤Î¿ô¤¬Áý¤¨¤ë¤È¥ì¥Ù¥ë¤¬²¼¤¬¤ê¤Þ¤¹¡Ê3¥ì¥Ù¥ë¤Þ¤Ç¡Ë

    -¹àÌÜ1
    --¹àÌÜ1-1
    --¹àÌÜ1-2
    -¹àÌÜ2
    -¹àÌÜ3
    --¹àÌÜ3-1
    ---¹àÌÜ3-1-1
    ---¹àÌÜ3-1-2
    --¹àÌÜ3-2

=item *

¥³¥í¥ó¤ò»È¤¦¤È¡¢
ÍÑ¸ì¤È²òÀâÊ¸¤Î¥ê¥¹¥ÈC<< <dl> >>¤¬½ñ¤±¤Þ¤¹¡£

    :ÍÑ¸ì1:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸1
    :ÍÑ¸ì2:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸2
    :ÍÑ¸ì3:¤¤¤í¤¤¤í½ñ¤¤¤¿²òÀâÊ¸3

=item *

¥ê¥ó¥¯

=over 4

=item *

LinkToSomePage¤äFrontPage¤Î¤è¤¦¤Ë¡¢
±ÑÃ±¸ì¤ÎºÇ½é¤Î°ìÊ¸»ú¤òÂçÊ¸»ú¤Ë¤·¤¿¤â¤Î¤¬
Æó¤Ä°Ê¾åÏ¢Â³¤·¤¿¤â¤Î¤ÏYukiWiki¤Î¥Ú¡¼¥¸Ì¾¤È¤Ê¤ê¡¢
¤½¤ì¤¬Ê¸¾ÏÃæ¤Ë´Þ¤Þ¤ì¤ë¤È¥ê¥ó¥¯¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

http://www.hyuki.com/ ¤Î¤è¤¦¤ÊURL¤Ï¼«Æ°Åª¤Ë¥ê¥ó¥¯¤Ë¤Ê¤ê¤Þ¤¹¡£

=item *

Æó½Å¤ÎÂç¤«¤Ã¤³[[ ]]¤Ç¤¯¤¯¤Ã¤¿Ê¸»úÎó¤â¡¢
YukiWiki¤Î¥Ú¡¼¥¸Ì¾¤Ë¤Ê¤ê¤Þ¤¹¡£
Âç¤«¤Ã¤³¤ÎÃæ¤Ë¤Ï¥¹¥Ú¡¼¥¹¤ò´Þ¤á¤Æ¤Ï¤¤¤±¤Þ¤»¤ó¡£
ÆüËÜ¸ì¤â»È¤¨¤Þ¤¹¡£

=back

=item *

¹ÔÆ¬¤¬¥¹¥Ú¡¼¥¹¤ä¥¿¥Ö¤Ç»Ï¤Þ¤Ã¤Æ¤¤¤ë¤È¡¢
¤½¤ì¤ÏÀ°·ÁºÑ¤ß¤ÎÃÊÍîC<< <pre> >>¤È¤·¤Æ°·¤ï¤ì¤Þ¤¹¡£
¥×¥í¥°¥é¥à¤ÎÉ½¼¨¤Ê¤É¤Ë»È¤¦¤ÈÊØÍø¤Ç¤¹¡£


=item *

¹Ô¤ò > ¤Ç¤Ï¤¸¤á¤ë¤È¡¢
°úÍÑÊ¸C<< <blockquote> >>¤¬½ñ¤±¤Þ¤¹¡£
>¤Î¿ô¤¬Â¿¤¤¤È¥¤¥ó¥Ç¥ó¥È¤¬¿¼¤¯¤Ê¤ê¤Þ¤¹¡Ê3¥ì¥Ù¥ë¤Þ¤Ç¡Ë¡£

    >Ê¸¾Ï
    >Ê¸¾Ï
    >>¤µ¤é¤Ê¤ë°úÍÑ
    >Ê¸¾Ï

=back

=head1 ¹¹¿·ÍúÎò

=over 4

=item *

2001Ç¯10·î20Æü¡¢Version 1.6.6¡£

¹¹¿·¤Î¾×ÆÍÂÐºö¡£
¸µ¥Ú¡¼¥¸¤Î´ÊÃ±¤Ê¥Á¥§¥Ã¥¯¥µ¥à¤ò¼è¤Ã¤Æ¤ª¤­¡¢
¹¹¿·Á°¤Ë¥Á¥§¥Ã¥¯¥µ¥à¤òÈæ³Ó¤¹¤ë¡£
½¤Àµ¸Ä½ê¤Ïdigest¤È¤¤¤¦Ê¸»úÎó¤ò¸¡º÷¤¹¤ì¤ÐÊ¬¤«¤ë¡£
ËÜÍè¤ÏMD5¤Ê¤É¤Ç¤Á¤ã¤ó¤È¤ä¤Ã¤¿Êý¤¬¤¤¤¤¤Î¤À¤±¤ì¤É¡£

¾×ÆÍ»þ¤ËÉ½¼¨¤µ¤ì¤ë¥á¥Ã¥»¡¼¥¸¤Ê¤É¤Ï¡Ö¶Ë°­¡×¤µ¤ó¤Î¥Ú¡¼¥¸¤ò»²¹Í¤Ë¤·¤¿¡£

=item *

2001Ç¯10·î17Æü¡¢Version 1.6.5¡£

¥×¥ì¥Ó¥å¡¼²èÌÌ¤Ç¡¢¹¹¿·¥Ü¥¿¥ó¤ò²¡¤·¤¿¤È¤­¤ËÁ÷¿®¤µ¤ì¤ë
¥á¥Ã¥»¡¼¥¸¤ÎÆâÍÆ¤òinputÍ×ÁÇ¤Îtype="hidden"¤ò»È¤Ã¤ÆËä¤á¹þ¤à¤Î¤ò¤ä¤á¤ë¡£
Âå¤ï¤ê¤Ë¡¢textareaÍ×ÁÇ¤ò»È¤¦¡£
ºÆ¥×¥ì¥Ó¥å¡¼ÍÑ¤Ëmyspecial_¤òÆ³Æþ¡£¤Ç¤â¤­¤ì¤¤¤ÊÂÐºö¤Ç¤Ï¤Ê¤¤¡£

=item *

2001Ç¯8·î30Æü¡¢Version 1.6.4¡£

URL¤Ç¥À¥¤¥ì¥¯¥È¤Ë¥Ú¡¼¥¸Ì¾¤ò»ØÄê¤·¤Æ¤â¡¢
$WikiName¤È$BracketName°Ê³°¤Î¥Ú¡¼¥¸¤òºî¤ì¤Ê¤¤¤è¤¦¤Ë¤·¤¿¡£
(is_valid_name¤Èis_editable»²¾È)¡£

=item *

2001Ç¯8·î30Æü¡¢Version 1.6.3¡£

RecentChanges¤òÊÔ½¸¡¦ºÆÊÔ½¸ÉÔ²Ä¤È¤·¤¿¡£
ÊÔ½¸ÉÔ²Ä¥Ú¡¼¥¸¤Ï@@uneditable¤Ë¥Ú¡¼¥¸Ì¾¤òÆþ¤ì¤ë¡£

=item *

2001Ç¯2·î25Æü¡¢Version 1.6.1, 1.6.2¡£

º¹Ê¬µ¡Ç½¤Î¥Ð¥°½¤Àµ¡£
do_preview¤Ç'>'¤¬°·¤¨¤Ê¤¤¥Ð¥°¤ò½¤Àµ
¡Ê¥æ¡¼¥¶¤«¤é¤Î»ØÅ¦¡Ë¡£

=item *

2001Ç¯2·î22Æü¡¢Version 1.6.0¡£
º¹Ê¬µ¡Ç½¤ò¼ÂÁõ¤·¤¿¡£

=item *

2001Ç¯2·î19Æü¡¢Version 1.5.4¡£
²èÁü¥Õ¥¡¥¤¥ë¤Ø¤Î¥ê¥ó¥¯¤Ï²èÁü¤Ë¤·¤Æ¤ß¤¿¡£

=item *

2001Ç¯2·î19Æü¡¢Version 1.5.3¡£
RecentChanges¤ÎÃæ¤Ëºï½ü¤·¤¿¥Ú¡¼¥¸¤¬¤¢¤ë¤Î¤ò¤ä¤á¤¿¡£
use strict;¤Ç°ú¤Ã¤«¤«¤ëÉôÊ¬¤ò¾¯¤·À°Íý(´°Á´¤Ç¤Ï¤Ê¤¤)¡£

=item *

2001Ç¯2·î16Æü¡¢Version 1.5.2¡£
textarea¤ËÉ½¼¨¤ª¤è¤Ó¥×¥ì¥Ó¥å¡¼¤¹¤ëÁ°¤Ë < ¤ä > ¤ò &lt; ¤ä &gt; ¤ËÊÑ´¹¤·¤¿
(do_preview, editpage, print_preview_buttons)¡£

=item *

2000Ç¯12·î27Æü¡¢Version 1.5.1¡£
¥×¥ì¥Ó¥å¡¼²èÌÌ¤òÀ°Íý¤·¤¿¡£

=item *

2000Ç¯12·î22Æü¡¢Version 1.5.0¡£
Á´ÂÎÅª¤Ë¤º¤¤¤Ö¤ó½ñ¤­Ä¾¤·¤¿¡£
°ìÍ÷¤òÊÌÅÓºîÀ®¤¹¤ë¤è¤¦¤Ë¤·¤¿(do_list)¡£
½ñ¤­¹þ¤àÁ°¤Ë³ÎÇ§²èÌÌ¤ò½Ð¤¹¤è¤¦¤Ë¤·¤¿(do_preview)¡£
¥Æ¥­¥¹¥È¤Î½ñ¤­Êý¤òÊÔ½¸²èÌÌ¤ËÆþ¤ì¤¿(do_edit, do_reedit)¡£
WhatsNew¢ªRecentChanges¡¢TopPage¢ªFrontPage¤ËÊÑ¹¹¤·¤¿¡£

=item *

2000Ç¯12·î20Æü¡¢Version 1.1.0¡£
tie¤òÍøÍÑ¤·¤Æ¡¢dbmopen¤¬»È¤¨¤Ê¤¤¾ì¹ç¤Ç¤âÆ°ºî¤¹¤ë¤è¤¦¤Ë½¤Àµ¡£
ÍøÍÑ¼Ô¤Î1¿Í¤Ç¤¢¤ë¡Ö¶Ë°­¡×¤µ¤ó¤«¤é
Á÷¤Ã¤Æ¤¤¤¿¤À¤¤¤¿¥³¡¼¥É¤ò¸µ¤Ë¤·¤Æ¤¤¤Þ¤¹¡£

=item *

2000Ç¯9·î5Æü¡¢Version 1.0.2¡£
 <body color=...> ¢ª <body bgcolor=...>
ÍøÍÑ¼Ô¤«¤é¤Î»ØÅ¦¤Ë¤è¤ë¡£´¶¼Õ¡£

=item *

2000Ç¯8·î6Æü¡¢Version 1.0.1¤ò¸ø³«¡£
C MAGAZINE¡Ê¥½¥Õ¥È¥Ð¥ó¥¯¥Ñ¥Ö¥ê¥Ã¥·¥ó¥°¡Ë
2000Ç¯10·î¹æÏ¢ºÜµ­»ö¸þ¤±¸ø³«ÈÇ¡£
[[ ]] ¤ÎºÇ¸å¤¬¡ÖË¾¡×¤Î¤è¤¦¤Ë¥·¥Õ¥ÈJIS¤Ç
0x5D¤Ë¤Ê¤ë¾ì¹ç¤Î²óÈò¤ò¹Ô¤Ê¤Ã¤¿¡£

=item *

2000Ç¯8·î5Æü¡¢Version 1.0.0¤ò¸ø³«¡£

=item *

2000Ç¯7·î23Æü¡¢Version 0.82¤ò¸ø³«¡£
ÊÔ½¸»þ¤Î¥ê¥ó¥¯¥ß¥¹¡£
<textarea>¤ÎÂ°À­ÊÑ¹¹¡£

=item *

2000Ç¯7·î22Æü¡¢Version 0.81¤ò¸ø³«¡£
¥í¥´¤òÁÈ¤ß¹þ¤à¡£

=item *

2000Ç¯7·î21Æü¡¢Version 0.80¤ò¸ø³«¡£
POD¤òCGIÃæ¤Ë½ñ¤­¹þ¤à¡£

=item *

2000Ç¯7·î19Æü¡¢Version 0.70¤ò¸ø³«¡£
'''¥¤¥¿¥ê¥Ã¥¯'''¤ä¡¢--¡¢---¡¢>>¡¢>>>¤Ê¤É¤ò¼ÂÁõ¡£

=item *

2000Ç¯7·î18Æü¡¢Version 0.60¤ò¸ø³«¡£
*ÂÀ»ú*¤ò''ÂÀ»ú''¤ËÊÑ¹¹

=item *

2000Ç¯7·î17Æü¡¢Version 0.50¤ò¸ø³«¡£

=item *

2000Ç¯7·î17Æü¡¢¤µ¤é¤Ë¤¤¤í¤¤¤íÄÉ²Ã¤¹¤ë¡£

=item *

2000Ç¯7·î16Æü¡¢¤¤¤í¤¤¤íÄÉ²Ã¡£

=item *

2000Ç¯7·î15Æü¡¢¸ø³«¡£

=back

=head1 TODO

    - ¥Æ¥­¥¹¥ÈÉ½¼¨¥â¡¼¥É
    - Charset¤òÌÀ¼¨¡£
    - textareaÃæ¤ÎÊÄ¤¸¥¿¥°ÂÐ±þ
    - ¥á¥Ë¥å¡¼¤Î±Ñ¸ìÉ½µ­ÉÕµ­
    - ¥×¥ì¥Ó¥å¡¼¤Î¥Ü¥¿¥ó¤Ç¡¢mymsg¤òinput¤Îvalue¤ËÆþ¤ì¤Æ¤¤¤ë¤¬¡¢²þ¹Ô¤ò¤½¤Î¤Þ¤Þvalue¤Ë¤¤¤ì¤Æ¤Ï¤¤¤±¤Ê¤¤¤Î¤Ç¤Ï¤Ê¤¤¤«¡£
    - ¡ÖºÆÊÔ½¸¡×¤Îµ¡Ç½¤Ï¥Ö¥é¥¦¥¶¤Î back ¤Ç½¼Ê¬¤Ç¤Ï¤Ê¤¤¤«¡£¥×¥ì¥Ó¥å¡¼¤Ï¤â¤Ã¤È¥·¥ó¥×¥ë¤Ë¡£
    - ¥Ú¡¼¥¸¥¿¥¤¥È¥ë¡ÊWikiname¡Ë¤¬¸¡º÷¤Ë¤«¤«¤ë¤è¤¦¤Ë¤¹¤ë¡£
    - InterWikiÉ÷¤Îµ¡Ç½¡ÖURL¤ò±£¤·¤Ä¤Ä¡¢¥ê¥ó¥¯¤òÄ¥¤ë¡×

=head1 ºî¼Ô

    Copyright (C) 2000 by Hiroshi Yuki.
    ·ë¾ë¹À <hyuki@@hyuki.com>
    http://www.hyuki.com/
    http://www.hyuki.com/yukiwiki/

¼ÁÌä¡¢°Õ¸«¡¢¥Ð¥°Êó¹ð¤Ï hyuki@@hyuki.com ¤Ë¥á¡¼¥ë¤·¤Æ¤¯¤À¤µ¤¤¡£

=head1 ÇÛÉÛ¾ò·ï

YukiWiki¤Ï¡¢
GNU General Public License¤Ë¤Æ¸ø³«¤·¤Þ¤¹¡£

YukiWiki¤Ï¥Õ¥ê¡¼¥½¥Õ¥È¤Ç¤¹¡£
¤´¼«Í³¤Ë¤ª»È¤¤¤¯¤À¤µ¤¤¡£
¼«Ê¬¹¥¤ß¤ÎYukiWiki¤¬ºî¤ì¤ë¤è¤¦¤Ë¥·¥ó¥×¥ë¤Ë¤·¤Æ¤¢¤ê¤Þ¤¹¡£

=head1 ¼Õ¼­

ËÜ²È¤ÎWikiWiki¤òºî¤Ã¤¿Cunningham & Cunningham, Inc.¤Ë
´¶¼Õ¤·¤Þ¤¹¡£

YukiWiki¤ò³Ú¤·¤ó¤Ç»È¤Ã¤Æ¤¯¤À¤µ¤ë
¥Í¥Ã¥È¾å¤ÎÊý¡¹¤Ë´¶¼Õ¤·¤Þ¤¹¡£

YukiWiki¤Î¥í¥´¤ò¥Ç¥¶¥¤¥ó¤·¤Æ¤¯¤À¤µ¤Ã¤¿¶¶ËÜÎéÆà¤µ¤ó
http://city.hokkai.or.jp/~reina/
¤Ë´¶¼Õ¤·¤Þ¤¹¡£

tie¤ò»È¤Ã¤¿ÈÇ¤Î¸µ¤Ë¤Ê¤ë¥³¡¼¥É¤òÁ÷¤Ã¤Æ¤¯¤À¤µ¤Ã¤¿
¡Ö¶Ë°­¡×¤µ¤ó¤Ë´¶¼Õ¤·¤Þ¤¹¡£

=head1 »²¾È¥ê¥ó¥¯

=over 4

=item *

YukiWiki¥Û¡¼¥à¥Ú¡¼¥¸
http://www.hyuki.com/yukiwiki/

=item *

ËÜ²È¤ÎWikiWiki
http://c2.com/cgi/wiki?WikiWikiWeb

=item *

ËÜ²È¤ÎWikiWiki¤Îºî¼Ô(Cunningham & Cunningham, Inc.)
http://c2.com/

=item *

YukiWiki¤Î¥í¥´¥Ç¥¶¥¤¥ó¤ò¤·¤Æ¤¯¤À¤µ¤Ã¤¿¶¶ËÜÎéÆà¤µ¤ó¤Î¥Ú¡¼¥¸
http://city.hokkai.or.jp/~reina/

=back

=cut
@


1.6
log
@bug fix of <urn> format.
@
text
@d567 5
a571 7
                (
                    (&lt;(mailto|http|https|ftp|urn):[\x21-\x7E]*)&gt; # Direct http://...
                        |
                    ($WikiName)                         # LocalLinkLikeThis
                        |
                    ($BracketName)                      # [[ÆüËÜ¸ì¥ê¥ó¥¯]]
                )
d671 1
@


1.5
log
@implement <uri:foo:bar> format.
@
text
@d568 1
a568 1
                    (<(mailto|http|https|ftp|urn):[\x21-\x7E]*)> # Direct http://...
@


1.4
log
@don't use preview
@
text
@d568 1
a568 1
                    ((mailto|http|https|ftp):[\x21-\x7E]*) # Direct http://...
d673 1
a673 1
    if ($name =~ /^(http|https|ftp).*?(\.gif|\.png|\.jpeg|\.jpg)?$/) {
d677 1
a677 1
            return qq|<a href="$name">$name</a>|;
d681 3
a683 1
        return qq|<a href="$name">$address</a>|;
d839 1
a839 1
http://www.hyuki.com/
@


1.3
log
@2002-02-02  wakaba <wakaba@@suika.fam.cx>

	* wiki.cgi: New file.
	* ChangeLog: Likewise.
@
text
@d23 1
a23 1
# $Id: wiki.cgi,v 1.1 2002/02/04 13:19:08 wakaba Exp $
d236 1
a236 1
<input type="hidden" name="mycmd" value="preview">
d240 2
a241 1
<input type="submit" value="¥×¥ì¥Ó¥å¡¼">
@


1.2
log
@2002-02-02  wakaba <wakaba@@suika.fam.cx>

	* wiki.cgi: New file.
	* ChangeLog: Likewise.
@
text
@d43 1
a43 1
my $dbname = './wiki';
@


1.1
log
@2002-02-02  wakaba <wakaba@@suika.fam.cx>

	* wiki.cgi: New file.
	* ChangeLog: Likewise.
@
text
@d1 1482
a1482 1482
#!/usr/local/bin/perl
use lib "../lib";
use CGI::Carp 'fatalsToBrowser';
use Algorithm::Diff qw(traverse_sequences);
# use strict;
#
# yukiwiki.cgi - Yet another WikiWikiWeb clone.
#
# Copyright (C) 2000,2001 by Hiroshi Yuki.
# <hyuki@@hyuki.com>
# http://www.hyuki.com/yukiwiki/
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# $Id: yukiwiki.cgi,v 1.1.1.1 2002/02/04 13:13:24 wakaba Exp $
##############################
my $version = "1.6.6";
##############################
# PÆeXgÌÆ«ÉÍ 1 É·éB
my $testing = 0;
##############################
# ¿Cu
my $jcodelib = 'jcode.pl';
##############################
# Û¶E\¦Ì¿R[h
my $kanjicode = 'sjis';     # 'sjis' 'euc'
my $charset = 'Shift_JIS';  # 'Shift_JIS' 'EUC-JP'
##############################
# dbmopenªg¦éÈç1Ag¦È¢Èç0
my $dbmopen = 0;
##############################
# f[^x[X¼i.pag, .dir, .dbÈÇÍsvj
# $dbmopen = 1ÌÆ«Íf[^x[X¼A
# $dbmopen = 0ÌÆ«ÍfBNg¼ÉÈéB
my $dbname = './yukiwiki';
my $diffdbname = './yukidiff';
##############################
# C³ÒÌ¼i©RÉÏXµÄ­¾³¢j
my $modifier = 'Hiroshi Yuki';
##############################
# C³ÒÌWeby[Wi©RÉÏXµÄ­¾³¢j
my $modifierlink = 'http://www.hyuki.com/';
##############################
# ±Ìy[WÌURL
my $thisurl = 'yukiwiki.cgi';
##############################
# Jny[W¼
my $toppage = 'FrontPage';
##############################
# ÅIXVy[W¼
my $whatsnew = 'RecentChanges';
##############################
# ÅIXVÉfÚ·éy[W
my $maxnew = 50;
##############################
# ACRt@@C¼iJ[Åj
my $iconfile = 'yukiwiki.gif';
##############################
# ACRt@@C¼imNÅj
# my $iconfile = 'yukimono.gif';
##############################
# y[WðÏXµ½Æ«Étouch·ét@@Ci''Èç½àµÈ¢j
my $touchfile = 'touch.txt';
##############################
# vr[pÌwiF
my $preview_color = '#FFCCCC';
##############################
# Sy[WÌX^C
my $style = <<'EOD';
pre, dl, ul, ol, p, blockquote { line-height:120%; }
a { text-decoration: none; }
a:link { color: #0000FF; background-color: #FFFFFF; }
a:visited { color: #9900CC; background-color: #FFFFFF; }
a:hover { text-decoration: underline; }
EOD
##############################
# eLXgüÍªÌå«³
my $cols = 80;
my $rows = 20;
##############################
my %form = ();
my %database = ();
my %diffbase = ();
my $diff_text = '';
my @@diff_added = ();
my @@diff_deleted = ();
my $msgrefA;
my $msgrefB;
##############################
# ÒWsÂy[W¼ê
my @@uneditable = ( $whatsnew );
##############################
# NpÌ³K\»
# YukiWikiÌNÍ2íÞ éB
# 
# (1) WikiName (RecentChangesÆ©FrontPageÌæ¤ÈàÌ)
# (2) BracketName ([[é_]]Æ©[[guV[g]]Ìæ¤ÈàÌ)
#
# ¦VtgJISÌ2oCgÚÉÍ ']' ª¤éÌÅA
# ¶']'ð1Â½­Æéæ¤ÉµÄ¢éB
#
my $WikiName = '([A-Z][a-z]+([A-Z][a-z]+)+)';
my $BracketName = '\[\[([^>\s]+?\]?)\]\]';

# ACRªÌ^O
my $IconTag = <<"EOD";
<a href="http://www.hyuki.com/yukiwiki/"><img src="$iconfile"
 border="0" width="80" height="80" alt="[YukiWiki]" /></a>
EOD

require "$jcodelib";

&init_form($kanjicode);

if ($testing) {
    %form = (
        # 'mycmd' => 'write',
        'mycmd' => 'read',
        #'mycmd' => 'search',
        #'mycmd' => 'edit',
        'mymsg' => <<"EOD",
Í¶ßÜµÄB
±ê©ç¢ë¢ë«ÝÜ·ËB
LinkPageà©Ä­¾³¢B
TestPageÍÇ¤Åµå¤©B
Ç¤¼æëµ­B
http://www.hyuki.com/
[[é_]]
EOD
        'mypage' => '<é_>',
        'myword' => '',
        # '3C8C8B8FE98D5F3E' => '',
        # 'TestPage' => '',
    );
}
&main;
exit(0);

# C
sub main {
    &normalize_form;
    if ($dbmopen) {
        if (!dbmopen(%database, $dbname, 0666)) {
            &print_error("(dbmopen) $dbname ªìêÜ¹ñB");
        }
    } else {
        if (!tie(%database, "YukiWikiDB", $dbname)) {
            &print_error("(tie error)");
        }
    }

    # myspecialÎ
    foreach (keys %form) {
        if (/^myspecial_(.*)/) {
            $form{mycmd} = $1;
            last;
        }
    }

    if ($form{mycmd} eq 'read') {
        &do_read;
    } elsif ($form{mycmd} eq 'preview') {
        &do_preview;
    } elsif ($form{mycmd} eq 'write') {
        &do_write;
    } elsif ($form{mycmd} eq 'edit') {
        &do_edit;
    } elsif ($form{mycmd} eq 'reedit') {
        &do_reedit;
    } elsif ($form{mycmd} eq 'search') {
        &do_search;
    } elsif ($form{mycmd} eq 'list') {
        &do_list;
    } elsif ($form{mycmd} eq 'diff') {
        &do_diff;
    } else {
        $form{mypage} = $toppage;
        &do_read;
    }
    if ($dbmopen) {
        dbmclose(%database);
    } else {
        untie(%database);
    }
}

# y[WÌ\¦
sub do_read {
    my $page_name = $form{mypage};
    my $percent_name = &encode_percent($page_name);
    &print_header($page_name);
    print qq|<h1>$IconTag<a href="$thisurl?mycmd=search&myword=$percent_name">$page_name</a></h1>\n|;
    &print_toolbar($page_name);
    print &convert_html(&get_page($page_name));
    &print_footer;
}

# y[WÌÒW
sub do_edit {
    if (not &is_editable($form{mypage})) {
        # ÒWsÂy[WÍ\¦ÌÝ
        &do_read;
        return;
    }
    &editpage(&get_page($form{mypage}));
}

# y[WÌÄÒW
sub do_reedit {
    if (not &is_editable($form{mypage})) {
        # ÒWsÂy[WÍ\¦ÌÝ
        &do_read;
    } else {
        &editpage($form{mymsg});
    }
}

sub editpage {
    my $page_msg = shift;
    my $page_name = $form{mypage};
    my $digest = &calc_message_digest($page_msg);
    &print_header($page_name);
    print qq|<h1>$IconTag${page_name}ÌÒW</h1>\n|;
    &print_toolbar($page_name);
    $page_msg = &escape($page_msg);
    print <<"EOD";
<form action="$thisurl" method="post">
<input type="hidden" name="mycmd" value="preview">
<input type="hidden" name="mypage" value="$page_name">
<input type="hidden" name="mydigest" value="$digest">
<textarea cols="$cols" rows="$rows" name="mymsg" wrap="virtual">$page_msg</textarea><br>
<input type="submit" value="vr[">
</form>
<hr>
<h3>eLXg®`Ì[</h3>

<p>ÊíÍüÍµ½¶ª»ÌÜÜoÍ³êÜ·ªA
ÈºÌ[É]ÁÄeLXg®`ðs¤±ÆªÅ«Ü·B</p>

<ul>
<li>
ósÍiÌæØèÆÈèÜ·B

<li>
HTMLÌ^OÍ¯Ü¹ñB

<li>
''{[h''Ìæ¤ÉVONH[gñÂÅÍ³ÞÆA{[hÉÈèÜ·B

<li>
'''C^bN'''Ìæ¤ÉVONH[gOÂÅÍ³ÞÆAC^bNÉÈèÜ·B

<li>
----Ìæ¤É}CiX4Âª éÆA½üÉÈèÜ·B

<li>
*ðsªÉ­Æå©oµÉÈèÜ·B

<li>
**ðsªÉ­Æ¬©oµÉÈèÜ·B

<li>
-ðsªÉ­ÆÓð«ÉÈèÜ·B- -- --- Ì3xª èÜ·B

<li>
:ðsªÉ­ÆpêÆðà¶ªìêÜ·B

<pre>
    :pê1:¢ë¢ë¢½ðà¶1
    :pê2:¢ë¢ë¢½ðà¶2
    :pê3:¢ë¢ë¢½ðà¶3
</pre>

<li>
http://www.hyuki.com/ Ìæ¤ÈURLÍ©®IÉNÉÈèÜ·B

<li>
YukiWikiÌæ¤Éå¶¬¶ð¬º½p¶ñð­ÆA
YukiWikiÌy[W¼ÉÈèÜ·B

<li>
[[é_]]Ìæ¤ÉñdÌå©Á±[[ ]]Å­­Á½¶ñð­ÆA
YukiWikiÌy[W¼ÉÈèÜ·B
å©Á±ÌÉÍXy[XðÜßÄÍ¢¯Ü¹ñB
ú{êàg¦Ü·B

<li>
sªªXy[XÅnÜÁÄ¢éÆA
»ÌiÍ®`ÏÝµíêÜ·B
vOð«ÞÆ«Ég¤ÆÖÅ·B

<li>
> ðsªÉ­ÆA
øp¶ª¯Ü·B
>Ìª½¢ÆCfgª[­ÈèÜ·i3xÜÅjB

</ul>
EOD
    &print_footer;
}

# y[WÌõ
sub do_search {
    if ($form{myword}) {
        &print_header('õÊ');
        print qq|<h1>$IconTag$form{myword}ÌõÊ</h1>\n|;
        &print_toolbar();
        print qq|<ul>\n|;
        my $count = 0;
        foreach my $page_name (sort keys %database) {    # sort·éÌÍ³d©È
            if ($database{$page_name} =~ /\Q$form{'myword'}\E/) {
                my $encoded = &encode_percent($page_name);
                print qq|<li><a href="$thisurl?mycmd=read&mypage=$encoded">$page_name</a>\n|;
                $count++;
            }
        }
        print qq|</ul>\n|;
        if ($count > 0) {
            print qq|<p><b>$form{myword}</b>ðÜÞy[WÍAãÉ¦·<b>$count</b>y[WÅ·B</p>\n|;
        } else {
            print qq|<p><b>$form{myword}</b>ðÜÞy[WÍ©Â©èÜ¹ñB</p>\n|;
        }
    } else {
        &print_header('Pêõ');
        print qq|<h1>$IconTagPêõ</h1>\n|;
        &print_toolbar();
    }
    print <<"EOD";
<p>
<form action="$thisurl" method="post">
<input type="hidden" name="mycmd" value="search">
<input type="text" name="myword" size="20" value="$form{myword}">
<input type="submit" value="Pêõ">
</form>
</p>
EOD
    &print_footer;
}

# y[WÌê
sub do_list {
    &print_header('y[Wê');
    print qq|<h1>$IconTag y[Wê</h1>\n|;
    &print_toolbar();
    print qq|<ul>\n|;
    foreach my $page_name (sort keys %database) {    # sort·éÌÍ³d©È
        my $encoded = &encode_percent($page_name);
        print qq|<li><a href="$thisurl?mycmd=read&mypage=$encoded">$page_name</a>\n|
    }
    print qq|</ul>\n|;
    &print_footer;
}

# vr[
sub do_preview {
    my $page_name = $form{mypage};
    my $escapedmsg = &escape($form{mymsg});
    &print_header($page_name);
    print qq|<h1>$IconTag${page_name}Ìvr[</h1>\n|;
    &print_toolbar($page_name);
    # local $percent_name = &encode_percent($page_name);
    print qq|<p>ÈºÌvr[ðmFµÄAæ¯êÎy[WºÌ{^ÅXVµÄ­¾³¢B</p>\n|;
    if ($form{mymsg}) {
        print qq|<table width="100%" bgcolor="$preview_color" ><tr><td>\n|;
        # print &convert_html($escapedmsg);
        print &convert_html($form{mymsg});
        print qq|</td></tr></table>\n|;
    } else {
        print qq|<p>iy[WÌàeÍóÅ·BXV·éÆ±Ìy[WÍ<b>í</b>³êÜ·Bj</p>\n|;
    }
    &print_preview_buttons($page_name, $escapedmsg, $form{mydigest});
    &print_footer;
}

sub print_preview_buttons {
    my ($page_name, $escapedmsg, $digest) = @@_;
    print <<"EOD";
    <form action="$thisurl" method="post">
    <textarea cols="$cols" rows="$rows" name="mymsg" wrap="virtual">$escapedmsg</textarea>
    <br />
    <input type="hidden" name="mypage" value="$page_name">
    <input type="hidden" name="mydigest" value="$digest">
    <input type="submit" name="myspecial_preview" value="Äxvr[">
    <input type="submit" name="myspecial_write" value="y[WÌXV">
    </form>
EOD
}

# «Þ
sub do_write {
    if (not &is_editable($form{mypage})) {
        # ÒWsÂy[WÍ\¦ÌÝ
        &do_read;
        return;
    }

    my $page_name = $form{mypage};

    # digestðgÁÄAXVÌÕË`FbN
    my $original_digest = &calc_message_digest(&get_page($page_name));
    if ($form{mydigest} ne $original_digest) {
        &print_header($page_name);
        print qq|<h1>$IconTag${page_name}ÅyXVÌÕËzªN«Üµ½</h1>\n|;
        print <<"EOD";
<p> È½ª±Ìy[WðÒWµÄ¢éÔÉA
¼Ìlª¯¶y[WðXVµÄµÜÁ½æ¤Å·B
</p><p>
ÈºÉA È½ÌÒWµ½eLXgª èÜ·ÌÅA
 È½ÌÒWàeª¸íêÈ¢æ¤ÉA
¢Ü·®A ÈÇÉRs[y[XgµÄ­¾³¢B
</p><p>
Rs[y[XgªÏñÅ©çA
ÅVÌàeð©ÄÄxÒWµ¼µÄ­¾³¢B
ÅVÌàeÍ
<a target="_blank" href="$thisurl?mycmd=read&mypage=$form{mypage}">$form{mypage}</a>
Å©é±ÆªÅ«Ü·B
</p>
EOD
        # &print_toolbar($page_name);
        &print_preview_buttons($page_name, &escape($form{mymsg}), $form{mydigest});
        &print_footer;
        return;
    }

    # diff¶¬
    {
        &opendiff;
        my @@msg1 = split(/\n/, &get_page($page_name));
        my @@msg2 = split(/\n/, $form{mymsg});
        $msgrefA = \@@msg1;
        $msgrefB = \@@msg2;
        &diff_check;
        $diffbase{$form{mypage}} = $diff_text;
        $diff_text = '';
        &closediff;
    }

    &print_header($page_name);
    &set_page($page_name, $form{mymsg});
    if ($form{mymsg}) {
        print qq|<h1>$IconTag${page_name}ðXVµÜµ½</h1>\n|;
        &print_toolbar($page_name);
        print &convert_html(&get_page($page_name));
    } else {
        print qq|<h1>$IconTag${page_name}ðíµÜµ½</h1>\n|;
        &print_toolbar($page_name);
        print qq|<p>${page_name}ðíµÜµ½B</p>\n|;
    }
    &print_footer;
    # XV³ê½ÌÅ^b`µÄ¨­B
    if ($touchfile) {
        open(FILE, "> $touchfile");
        print FILE "\n";
        close(FILE);
    }
}

# y[WÌÏX_
sub do_diff {
    if (not &is_editable($form{mypage})) {
        # ÒWsÂy[WÍ\¦ÌÝ
        &do_read;
        return;
    }
    &opendiff;
    &print_header($form{mypage} . 'ÌÏX_');
    print qq|<h1>$IconTag <a href="$thisurl?mycmd=read&mypage=$form{mypage}">$form{mypage}</a>ÌÏX_</h1>\n|;
    &print_toolbar();
    $_ = &escape($diffbase{$form{mypage}});
    print <<"EOD";
<ul>
<li>ÇÁ³ê½sÍ<font color="blue">ÂF</font>Å·B
<li>í³ê½sÍ<font color="red">ÔF</font>Å·B
<li><a href="$thisurl?mycmd=read&mypage=$form{mypage}">$form{mypage}</a>Ös­B
</ul>
<hr />
EOD
    print qq|<pre>\n|;
    foreach (split(/\n/, $_)) {
        if (/^\+(.*)/) {
            print qq|<font color="blue">$1</font>\n|;
        } elsif (/^\-(.*)/) {
            print qq|<font color="red">$1</font>\n|;
        } elsif (/^\=(.*)/) {
            print qq|$1\n|;
        } else {
            print qq|??? $_\n|;
        }
    }
    print qq|</pre>\n|;
    &print_footer;
    &closediff;
}

sub opendiff {
    if ($dbmopen) {
        if (!dbmopen(%diffbase, $diffdbname, 0666)) {
            &print_error("(dbmopen) $diffdbname ªìêÜ¹ñB");
        }
    } else {
        if (!tie(%diffbase, "YukiWikiDB", $diffdbname)) {
            &print_error("(tie error)");
        }
    }
}

sub closediff {
    if ($dbmopen) {
        dbmclose(%diffbase);
    } else {
        untie(%diffbase);
    }
}

# tH[©çÌîñðAzzñ %form Éüêé
# &init_form('euc');
sub init_form {
    my ($charcode) = @@_;
    my $query;
    if ($ENV{REQUEST_METHOD} =~ /^post$/i) {
        read(STDIN, $query, $ENV{CONTENT_LENGTH});
    } else {
        $query = $ENV{QUERY_STRING};
    }
    my @@assocarray = split(/&/, $query);
    foreach my $assoc (@@assocarray) {
        my ($property, $value) = split(/=/, $assoc);
        $value =~ tr/+/ /;
        $value =~ s/%([A-Fa-f0-9][A-Fa-f0-9])/pack("C", hex($1))/eg;
        &jcode::convert(\$value, $charcode);
        $form{$property} = $value;
    }
}

# G[y[WðoÍ·é
sub print_error {
    my ($msg) = @@_;
    &print_header('Error');
    print "<h1>$IconTag$msg</h1></body></html>";
    exit(0);
}

sub escape {
    my ($line) = shift;
    $line =~ s|<|&lt;|g;
    $line =~ s|>|&gt;|g;
    $line =~ s|"|&quot;|g;
    # $line =~ s|\&|&amp;|g;
    return $line;
}

sub inline {
    my ($line) = shift;
    $line = &escape($line);
    $line =~ s|'''([^']+?)'''|<i>$1</i>|g;              # Italic
    $line =~ s|''([^']+?)''|<b>$1</b>|g;                # Bold
    $line =~ s!
                (
                    ((mailto|http|https|ftp):[\x21-\x7E]*) # Direct http://...
                        |
                    ($WikiName)                         # LocalLinkLikeThis
                        |
                    ($BracketName)                      # [[ú{êN]]
                )
            !
                &make_link($1)
            !gex;
    return $line;
}

# y[WÌ^Cg©çy[WÌàeð¾é
sub get_page {
    my $page_name = shift;
    return $database{$page_name};
}

# y[WÌàeð^¦é
# &set_page($title, $txt)
sub set_page {
    # y[WðXV·é
    my $title = $_[0];
    $database{$title} = $_[1];
    # óy[WÈçí·é
    unless ($database{$title}) {
        delete $database{$title};
    }
    # RecentChangesðXV·é
    my $delim = ' - ';
    my @@pages = split(/\n/, $database{$whatsnew});
    my $datestr = &get_current_datestr;
    unshift(@@pages, qq|-$datestr$delim$title|);
    # ¯êy[WÌXVÍÅVÌàÌÌÝÉµA
    # ¶ÝµÈ¢y[WÍXLbv·éB
    my %count;
    my @@newpages;
    foreach my $line (@@pages) {
        my ($prefix, $title) = split(/$delim/, $line);
        $count{$title}++;
        if ($count{$title} == 1 and exists($database{$title})) {
            push(@@newpages, qq|$prefix - $title|);
        }
    }
    # ±±Å{ÉXV
    $database{$whatsnew} = join("\n", splice(@@newpages, 0, $maxnew));
}

# y[WÌwb_ðoÍ
sub print_header {
    my $title = shift;
    print <<"EOD";
Content-type: text/html

<html><head>
<title>$title</title>
<style type="text/css">
<!--
$style
-->
</style>
</head>
<body bgcolor="white">
EOD
}

# c[o[ðoÍ
sub print_toolbar {
    my $page_name = shift;
    my $percent_name = &encode_percent($page_name);
    my $editlink = '';
    if ($page_name ne '' and &is_editable($page_name)) {
        $editlink = <<"EOD";
<a href="$thisurl?mycmd=edit&mypage=$percent_name">ÒW</a> | 
<a href="$thisurl?mycmd=diff&mypage=$percent_name">·ª</a> | 
EOD
    }
    print <<"EOD";
<p>
 [ 
<a href="$thisurl?mycmd=read&mypage=$toppage">gbv</a> | 
<a href="$thisurl?mycmd=list">ê</a> | 
$editlink
<a href="$thisurl?mycmd=search">Pêõ</a> | 
<a href="$thisurl?mycmd=read&mypage=$whatsnew">ÅIXV</a>
 ]
</p>
EOD
}

# y[WÌtb^ðoÍ
sub print_footer {
    print <<"EOD";
<hr>
<p>
<a href="http://www.hyuki.com/yukiwiki/">YukiWiki</a> $version Copyright (C) 2000,2001 by <a href="http://www.hyuki.com/">Hiroshi Yuki.</a><br />
Modified by <a href="$modifierlink">$modifier</a>.<br/>
</p>
</body></html>
EOD
}

# URLây[WÌ¼O©çNðìé
sub make_link {
    my $name = shift;
    if ($name =~ /^(http|https|ftp).*?(\.gif|\.png|\.jpeg|\.jpg)?$/) {
        if ($2) {
            return qq|<a href="$name"><img border="0" src="$name" /></a>|;
        } else {
            return qq|<a href="$name">$name</a>|;
        }
    } elsif ($name =~ /^mailto:(.*)/) {
        my $address = $1;
        return qq|<a href="$name">$address</a>|;
    } elsif ($database{$name}) {
        my $percent_name = &encode_percent($name);
        return qq|<a href="$thisurl?mycmd=read&mypage=$percent_name">$name</a>|;
    } else {
        my $percent_name = &encode_percent($name);
        return qq|$name<a href="$thisurl?mycmd=edit&mypage=$percent_name">?</a>|;
    }
}

# %xx Ì`®ÉGR[h·é
# ±êÍA
# http://www.hyuki.com/yukiwiki/yukiwiki.cgi?mycmd=read&mypage=%3C%8C%8B%8F%E9%8D_%3E
# Æ¢¤`®Ì½ßÉgíêéB
# '<é_>' ¨ '%3C%8C%8B%8F%E9%8D_%3E'
sub encode_percent {
    my $name = shift;
    my $encoded = '';
    foreach my $ch (split(//, $name)) {
        if ($ch =~ /[A-Za-z0-9_]/) {
            $encoded .= $ch;
        } else {
            $encoded .= '%' . sprintf("%02X", ord($ch));
        }
    }
    return $encoded;
}

# eLXg{ÌðHTMLÉÏ··é
sub convert_html {
    my ($txt) = shift;
    my (@@txt) = split(/\n/, $txt);
    foreach (@@txt) {
        chomp;
        if (/^\*\*(.*)/) {
            push(@@result, splice(@@saved), '<h3>' . &inline($1) . '</h3>');
        } elsif (/^\*(.*)/) {
            push(@@result, splice(@@saved), '<h2>' . &inline($1) . '</h2>');
        } elsif (/^----/) {
            push(@@result, splice(@@saved), '<hr>');
        } elsif (/^(-{1,3})(.*)/) {
            &back_push('ul', length($1));
            push(@@result, '<li>' . &inline($2) . '</li>');
        } elsif (/^:([^:]+):(.*)/) {
            &back_push('dl', 1);
            push(@@result, '<dt>' . &inline($1) . '</dt>', '<dd>' . &inline($2) . '</dd>');
        } elsif (/^(>{1,3})(.*)/) {
            &back_push('blockquote', length($1));
            push(@@result, &inline($2));
        } elsif (/^\s*$/) {
            push(@@result, splice(@@saved));
            unshift(@@saved, "</p>");
            push(@@result, "<p>");
        } elsif (/^(\s+.*)$/) {
            &back_push('pre', 1);
            push(@@result, &escape($1)); # Not &inline, but &escape
        } else {
            push(@@result, &inline($_));
        }
    }
    push(@@result, splice(@@saved));
    return join("\n", @@result);
}

# &back_push($tag, $count)
# $tagÌ^Oð$levelxÜÅlßéB
sub back_push {
    my ($tag, $level) = @@_;
    while (@@saved > $level) {
        push(@@result, shift(@@saved));
    }
    if ($saved[0] ne "</$tag>") {
        push(@@result, splice(@@saved));
    }
    while (@@saved < $level) {
        unshift(@@saved, "</$tag>");
        push(@@result, "<$tag>");
    }
}

# ÒWÂ\y[W©H
sub is_editable {
    my ($pagename) = @@_;
    foreach (@@uneditable) {
        if ($pagename eq $_) {
            return 0;
        }
    }
    if (&is_valid_name($pagename)) {
        return 1;
    }
    return 0;
}

# ValidÈ¼O©H
sub is_valid_name {
    my ($pagename) = @@_;
    if ($pagename =~ /^$WikiName$/) {
        return 1;
    } elsif ($pagename =~ /^$BracketName$/) {
        return 1;
    } else {
        return 0;
    }
}

# »ÝÌ¶ñð¾é
sub get_current_datestr {
    my (@@wdays) = ( "ú", "", "Î", "", "Ø", "à", "y" );
    my ($sec, $min, $hour, $mday, $mon, $year, $wday) = localtime(time);
    return sprintf("%4d-%02d-%02d (%s) %02d:%02d:%02d",
        $year + 1900, $mon + 1, $mday, $wdays[$wday], $hour, $min, $sec);
}

# URL?SomePageâA
# URL?[[é_]]Ì`®¾Á½êA(not yet)
# ­§IÉmycmdðreadÉµÄ$formÌàeðÝè·éB
sub normalize_form {
    foreach my $key (keys %form) {
        if ($key =~ /^$WikiName$/) {
            $form{mycmd} = 'read';
            $form{mypage} = $1;
            last;
        } elsif ($key =~ /^$BracketName$/) {
            $form{mycmd} = 'read';
            $form{mypage} = $1;
            last;
        }
    }
}

# Ï·eXgðsÈ¤Æ«ÌTv
sub print_sample {
    my $txt = &convert_html(<<"EOD");
*å©oµ1
**¬©oµ1-1
-Ú1
-Ú2
-Ú3
i1i1i1i1i1i1i1i1i1i1i1i1
i1i1i1i1i1i''­²''1i1i1i1i1i1
i1i1i1i1i1i1i1i1i1i1i1i1

i2i2i2i2i2i2i2i2i2i2i2i2
i2i2i2i2i2i2i2i2i2i2i2i2
i2i2i2i2i2i2i2i2i2i2i2i2
**¬©oµ1-2
:pê1:¢ë¢ë¢½ðà¶1Æ''­²Pê''
i1i1i1i1i1i1i1i1i1i1i1i1
i1i1i1i1i1i1i1i1i1i1i1i1
i1i1i1i1i1i1i1i1i1i1i1i1
:pê2:¢ë¢ë¢½ðà¶2
:pê3:¢ë¢ë¢½ðà¶3
----
*å©oµ2
**¬©oµ2-1
http://www.hyuki.com/
**¬©oµ2-2

[[é_]]

i1i1i1i1i1i1i1i1i1i1i1i1
i1i1i1i'''C^bN'''1i1i1i1i1i1i1i1
i1i1i1i'''''C^{[h'''''1i1i1i1i1i1i1i1i1
>i2i2i2i2i2i2i2i2i2i2i2i2
>i2i2i2i2i2i2i2i2i2i2i2i2
>i2i2i2i2i2i2i2i2i2i2i2i2

x0x0x0x0x0x0

>x1
>x1
>x1
>>x2
>>x2
>>x2
>>>x3
-Íë1
--Íë2
ëëëë2
---Íë3
--Íë2
---Íë3
--Íë2
---Íë3
>>>x3
>>>x3
>>>x3
EOD
    print $txt;
    exit;
}

sub diff_check {
    traverse_sequences(
            $msgrefA, $msgrefB,
            {
                MATCH => \&df_match,
                DISCARD_A => \&df_delete,
                DISCARD_B => \&df_add,
            }
    );
    &diff_flush;
}

sub diff_flush {
    $diff_text .= join('', map { "-$_\n" } splice(@@diff_deleted));
    $diff_text .= join('', map { "+$_\n" } splice(@@diff_added));
}

sub df_match {
    my ($a, $b) = @@_;
    &diff_flush;
    $diff_text .= "=$msgrefA->[$a]\n";
}

sub df_delete {
    my ($a, $b) = @@_;
    push(@@diff_deleted, $msgrefA->[$a]);
}

sub df_add {
    my ($a, $b) = @@_;
    push(@@diff_added, $msgrefB->[$b]);
}

sub calc_message_digest {   # You have to use MD5...
    my $text = shift;
    my @@text = split(//, $text);
    my $len = length($text);
    my $checksum = 0;
    foreach (@@text) {
        $checksum += ord($_);
        $checksum = ($checksum * 2) % 65536 + (($checksum & 32768) ? 1 : 0); # 16bit rotate
    }
    return "$len:$checksum";
}

# Definition of YukiWikiDB
package YukiWikiDB;

my $debug = 1;

# Constructor
sub new {
    return shift->TIEHASH(@@_);
}

# tying
sub TIEHASH {
    my ($class, $dbname) = @@_;
    my $self = {
        dir => $dbname,
        keys => [],
    };
    if (not -d $self->{dir}) {
        if (!mkdir($self->{dir}, 0777)) {
            print "mkdir(" . $self->{dir} . ") fail\n" if ($debug);
            return undef;
        }
    }
    return bless($self, $class);
}

# Store
sub STORE {
    my ($self, $key, $val) = @@_;
    my $file = &make_filename($self, $key);
    if (open(FILE,"> $file")) {
        binmode(FILE);
        print FILE $val;
        close(FILE);
        return $self->{$key} = $val;
    } else {
        print "$file create error.";
    }
}

# Fetch
sub FETCH {
    my ($self, $key) = @@_;
    my $file = &make_filename($self, $key);
    if (open(FILE, $file)) {
        local $/;
        $self->{$key} = <FILE>;
        close(FILE);
    }
    return $self->{$key};
}

# Exists
sub EXISTS {
    my ($self, $key) = @@_;
    my $file = &make_filename($self, $key);
    return -e($file);
}

# Delete
sub DELETE {
    my ($self, $key) = @@_;
    my $file = &make_filename($self, $key);
    unlink $file;
    return delete $self->{$key};
}

sub FIRSTKEY {
    my ($self) = @@_;
    opendir(DIR, $self->{dir}) or die $self->{dir};
    @@{$self->{keys}} = grep /\.txt$/, readdir(DIR);
    foreach my $name (@@{$self->{keys}}) {
        $name =~ s/\.txt$//;
        $name =~ s/[0-9A-F][0-9A-F]/pack("C", hex($&))/eg;
    }
    return shift @@{$self->{keys}};
}

sub NEXTKEY {
    my ($self) = @@_;
    return shift @@{$self->{keys}};
}

sub make_filename {
    my ($self, $key) = @@_;
    my $enkey = '';
    foreach my $ch (split(//, $key)) {
        $enkey .= sprintf("%02X", ord($ch));
    }
    return $self->{dir} . "/$enkey.txt";
}
__END__

=head1 NAME

YukiWiki - ©RÉy[WðÇÁEíEÒWÅ«éWeby[W\zCGI

    Copyright (C) 2000,2001 by Hiroshi Yuki.
    é_ <hyuki@@hyuki.com>
    http://www.hyuki.com/
    http://www.hyuki.com/yukiwiki/

=head1 SYNOPSIS

    http://www.hyuki.com/yukiwiki/yukiwiki.cgi

=head1 DESCRIPTION

YukiWikiiéEBLBjÍQÁÒª©RÉy[WðÇÁEíEÒWÅ«é
svcÈWeby[WQðìéCGIÅ·B
WebÅ®ì·éf¦ÂÆ¿åÁÆÄ¢Ü·ªA
Webf¦ÂªPÉbZ[WðÇÁ·é¾¯ÈÌÉÎµÄA
YukiWikiÍAWeby[WSÌð©RÉÏX·é±ÆªÅ«Ü·B

YukiWikiÍACunningham & CunninghamÌWikiWikiWebÌ
dlðQlÉµÄÆ©ÉìçêÜµ½B

YukiWikiÍPerlÅ©ê½CGIXNvgÆµÄÀ»³êÄ¢Ü·ÌÅA
Perlª®ì·éWebT[oÈçÎärIeÕÉÝuÅ«Ü·B

 ÆÍdbmopenªg¦éÂ«ÈçÎÝuÅ«Ü·(Version 1.5.0È~Èçdbmopenªg¦È­ÄàÝuÅ«Ü·)B


YukiWikiÍt[\tgÅ·B
²©RÉ¨g¢­¾³¢B

=head1 Ýuû@@

=head2 üè

YukiWikiÌÅVÅÍA
http://www.hyuki.com/yukiwiki/
©çüèÅ«Ü·B

=head2 t@@Cê

    readme.txt      hLg
    yukiwiki.cgi    YukiWiki{Ì
    yukiwiki.gif    SiJ[Åj
    yukimono.gif    SimNÅj
    jcode.pl        ¿R[hCu

=head2 CXg[

=over 4

=item 1.

A[JCuðð­B

=item 2.

yukiwiki.cgiÌÍ¶ßÌûÉ éÝèðmFµÜ·B
ÊíÍ½àµÈ­Äæ¢ªA
Í¶ßÍ$touchfileð''Éµ½ûªæ¢Åµå¤B

=item 3.

yukiwiki.cgiÆjcode.plð¯¶Æ±ëÉÝuµÜ·B

=item 4.

TCY0Ìyukiwiki.dbÆ¢¤t@@CðÝuµÜ·B
iPerlVXeÉæÁÄÍyukiwiki.pag, yukiwiki.dirj

=item 5.

yukiwiki.cgiÉuEU©çANZXµÜ·B

=back

=head2 p[~bV

        t@@C        p[~bV      ][h
        yukiwiki.cgi    755                 ASCII
        yukiwiki.gif    644                 BINARY
        yukimono.gif    644                 BINARY
        jcode.pl        644                 ASCII

    $dbmopen = 1; Éµ½ê:
        yukiwiki.db     666                 BINARY
        (yukiwiki.pag, yukiwiki.dirÌêà èj

    $dbmopen = 0; Éµ½ê: (JgfBNgð777ÉµÄ¨­)
        .               777                 (]µÈ¢)

=head1 f[^ÌobNAbvû@@

$dbmopen = 1;ÌêÍA
f[^Í·×Äyukiwiki.db(.dir, .pag)ÉüéB
±êðobNAbv·êÎæ¢B

$dbmopen = 0;ÌêÍA
yukiwikiÆ¢¤fBNgªÅ«éÌÅA
±êÈºðobNAbv·êÎæ¢B

=head1 Vµ¢y[WÌìèû 

=over 4

=item 1.

Ü¸AKÈy[Wiá¦ÎFrontPagejðIÑA
y[WÌºÉ éuÒWvNð½ÇèÜ·B 

=item 2.

·éÆeLXgüÍªÅ«éóÔÉÈéÌÅA
»±ÉNewPageÌæ¤ÈPê
iå¶¬¶¬ÝµÄ¢ép¶ñj
ð¢ÄuÛ¶vµÜ·B

=item 3.

Û¶·éÆAFrontPageÌy[Wª«·íèA
 È½ª¢½NewPageÆ¢¤¶ñÌãëÉ ? Æ¢¤Nª\¦³êÜ·B 
±Ì ? Í»Ìy[WªÜ¾¶ÝµÈ¢±Æð¦·óÅ·B 

=item 4.

»Ì ? ðNbN·éÆVµ¢y[WNewPageªÅ«Ü·ÌÅA
 È½ÌD«È¶Íð»ÌVµ¢y[WÉ¢ÄÛ¶µÜ·B

=item 5.

NewPagey[WªÅ«éÆFrontPageÌ ? ÍÁ¦ÄANÆÈèÜ·B 

=back

=head1 eLXg®`Ì[

=over 4

=item *

A±µ½¡sÍtB³êÄ\¦³êÜ·B

=item *

ósÍiC<< <p> >>ÌæØèÆÈèÜ·B

=item *

HTMLÌ^OÍ¯Ü¹ñB

=item *

B<''{[h''>Ìæ¤ÉVONH[gñÂÅÍ³ÞÆA
{[hC<< <b> >>ÉÈèÜ·B

=item *

B<'''C^bN'''>Ìæ¤ÉVONH[gOÂÅÍ³ÞÆA
C^bNC<< <i> >>ÉÈèÜ·B

=item *

B<---->Ìæ¤É}CiX4Âª éÆA
½üC<< <hr> >>ÉÈèÜ·B

=item *

sðB<*>ÅÍ¶ßéÆA
å©oµC<< <h2> >>ÉÈèÜ·B

=item *

sðB<**>ÅÍ¶ßéÆA
¬©oµC<< <h3> >>ÉÈèÜ·B

=item *

sð}CiX-ÅÍ¶ßéÆA
Óð«C<< <ul> >>ÉÈèÜ·B
}CiXÌª¦éÆxªºªèÜ·i3xÜÅj

    -Ú1
    --Ú1-1
    --Ú1-2
    -Ú2
    -Ú3
    --Ú3-1
    ---Ú3-1-1
    ---Ú3-1-2
    --Ú3-2

=item *

Rðg¤ÆA
pêÆðà¶ÌXgC<< <dl> >>ª¯Ü·B

    :pê1:¢ë¢ë¢½ðà¶1
    :pê2:¢ë¢ë¢½ðà¶2
    :pê3:¢ë¢ë¢½ðà¶3

=item *

N

=over 4

=item *

LinkToSomePageâFrontPageÌæ¤ÉA
pPêÌÅÌê¶ðå¶Éµ½àÌª
ñÂÈãA±µ½àÌÍYukiWikiÌy[W¼ÆÈèA
»êª¶ÍÉÜÜêéÆNÉÈèÜ·B

=item *

http://www.hyuki.com/ Ìæ¤ÈURLÍ©®IÉNÉÈèÜ·B

=item *

ñdÌå©Á±[[ ]]Å­­Á½¶ñàA
YukiWikiÌy[W¼ÉÈèÜ·B
å©Á±ÌÉÍXy[XðÜßÄÍ¢¯Ü¹ñB
ú{êàg¦Ü·B

=back

=item *

sªªXy[Xâ^uÅnÜÁÄ¢éÆA
»êÍ®`ÏÝÌiC<< <pre> >>ÆµÄµíêÜ·B
vOÌ\¦ÈÇÉg¤ÆÖÅ·B


=item *

sð > ÅÍ¶ßéÆA
øp¶C<< <blockquote> >>ª¯Ü·B
>Ìª½¢ÆCfgª[­ÈèÜ·i3xÜÅjB

    >¶Í
    >¶Í
    >>³çÈéøp
    >¶Í

=back

=head1 XVð

=over 4

=item *

2001N1020úAVersion 1.6.6B

XVÌÕËÎôB
³y[WÌÈPÈ`FbNTðæÁÄ¨«A
XVOÉ`FbNTðär·éB
C³ÂÍdigestÆ¢¤¶ñðõ·êÎª©éB
{ÍMD5ÈÇÅ¿áñÆâÁ½ûª¢¢Ì¾¯êÇB

ÕËÉ\¦³êébZ[WÈÇÍuÉ«v³ñÌy[WðQlÉµ½B

=item *

2001N1017úAVersion 1.6.5B

vr[æÊÅAXV{^ðµ½Æ«ÉM³êé
bZ[WÌàeðinputvfÌtype="hidden"ðgÁÄßÞÌðâßéB
ãíèÉAtextareavfðg¤B
Ävr[pÉmyspecial_ð±üBÅà«ê¢ÈÎôÅÍÈ¢B

=item *

2001N830úAVersion 1.6.4B

URLÅ_CNgÉy[W¼ðwèµÄàA
$WikiNameÆ$BracketNameÈOÌy[WðìêÈ¢æ¤Éµ½B
(is_valid_nameÆis_editableQÆ)B

=item *

2001N830úAVersion 1.6.3B

RecentChangesðÒWEÄÒWsÂÆµ½B
ÒWsÂy[WÍ@@uneditableÉy[W¼ðüêéB

=item *

2001N225úAVersion 1.6.1, 1.6.2B

·ª@@\ÌoOC³B
do_previewÅ'>'ªµ¦È¢oOðC³
i[U©çÌwEjB

=item *

2001N222úAVersion 1.6.0B
·ª@@\ðÀµ½B

=item *

2001N219úAVersion 1.5.4B
æt@@CÖÌNÍæÉµÄÝ½B

=item *

2001N219úAVersion 1.5.3B
RecentChangesÌÉíµ½y[Wª éÌðâß½B
use strict;ÅøÁ©©éªð­µ®(®SÅÍÈ¢)B

=item *

2001N216úAVersion 1.5.2B
textareaÉ\¦¨æÑvr[·éOÉ < â > ð &lt; â &gt; ÉÏ·µ½
(do_preview, editpage, print_preview_buttons)B

=item *

2000N1227úAVersion 1.5.1B
vr[æÊð®µ½B

=item *

2000N1222úAVersion 1.5.0B
SÌIÉ¸¢Ôñ«¼µ½B
êðÊrì¬·éæ¤Éµ½(do_list)B
«ÞOÉmFæÊðo·æ¤Éµ½(do_preview)B
eLXgÌ«ûðÒWæÊÉüê½(do_edit, do_reedit)B
WhatsNew¨RecentChangesATopPage¨FrontPageÉÏXµ½B

=item *

2000N1220úAVersion 1.1.0B
tieðpµÄAdbmopenªg¦È¢êÅà®ì·éæ¤ÉC³B
pÒÌ1lÅ éuÉ«v³ñ©ç
ÁÄ¢½¾¢½R[hð³ÉµÄ¢Ü·B

=item *

2000N95úAVersion 1.0.2B
 <body color=...> ¨ <body bgcolor=...>
pÒ©çÌwEÉæéB´ÓB

=item *

2000N86úAVersion 1.0.1ðöJB
C MAGAZINEi\tgoNpubVOj
2000N10AÚLü¯öJÅB
[[ ]] ÌÅãªu]vÌæ¤ÉVtgJISÅ
0x5DÉÈéêÌñððsÈÁ½B

=item *

2000N85úAVersion 1.0.0ðöJB

=item *

2000N723úAVersion 0.82ðöJB
ÒWÌN~XB
<textarea>Ì®«ÏXB

=item *

2000N722úAVersion 0.81ðöJB
SðgÝÞB

=item *

2000N721úAVersion 0.80ðöJB
PODðCGIÉ«ÞB

=item *

2000N719úAVersion 0.70ðöJB
'''C^bN'''âA--A---A>>A>>>ÈÇðÀB

=item *

2000N718úAVersion 0.60ðöJB
*¾*ð''¾''ÉÏX

=item *

2000N717úAVersion 0.50ðöJB

=item *

2000N717úA³çÉ¢ë¢ëÇÁ·éB

=item *

2000N716úA¢ë¢ëÇÁB

=item *

2000N715úAöJB

=back

=head1 TODO

    - eLXg\¦[h
    - Charsetð¾¦B
    - textareaÌÂ¶^OÎ
    - j[Ìpê\LtL
    - vr[Ì{^ÅAmymsgðinputÌvalueÉüêÄ¢éªAüsð»ÌÜÜvalueÉ¢êÄÍ¢¯È¢ÌÅÍÈ¢©B
    - uÄÒWvÌ@@\ÍuEUÌ back Å[ªÅÍÈ¢©Bvr[ÍàÁÆVvÉB
    - y[W^CgiWikinamejªõÉ©©éæ¤É·éB
    - InterWikiÌ@@\uURLðBµÂÂANð£év

=head1 ìÒ

    Copyright (C) 2000 by Hiroshi Yuki.
    é_ <hyuki@@hyuki.com>
    http://www.hyuki.com/
    http://www.hyuki.com/yukiwiki/

¿âAÓ©AoOñÍ hyuki@@hyuki.com É[µÄ­¾³¢B

=head1 zzð

YukiWikiÍA
GNU General Public LicenseÉÄöJµÜ·B

YukiWikiÍt[\tgÅ·B
²©RÉ¨g¢­¾³¢B
©ªDÝÌYukiWikiªìêéæ¤ÉVvÉµÄ èÜ·B

=head1 Ó«

{ÆÌWikiWikiðìÁ½Cunningham & Cunningham, Inc.É
´ÓµÜ·B

YukiWikiðyµñÅgÁÄ­¾³é
lbgãÌûXÉ´ÓµÜ·B

YukiWikiÌSðfUCµÄ­¾³Á½´{çÞ³ñ
http://city.hokkai.or.jp/~reina/
É´ÓµÜ·B

tieðgÁ½ÅÌ³ÉÈéR[hðÁÄ­¾³Á½
uÉ«v³ñÉ´ÓµÜ·B

=head1 QÆN

=over 4

=item *

YukiWikiz[y[W
http://www.hyuki.com/yukiwiki/

=item *

{ÆÌWikiWiki
http://c2.com/cgi/wiki?WikiWikiWeb

=item *

{ÆÌWikiWikiÌìÒ(Cunningham & Cunningham, Inc.)
http://c2.com/

=item *

YukiWikiÌSfUCðµÄ­¾³Á½´{çÞ³ñÌy[W
http://city.hokkai.or.jp/~reina/

=back

=cut
@


1.1.1.1
log
@*** empty log message ***
@
text
@d2 4
a5 1
#!perl
d7 1
a7 1
# wiki.cgi - This is YukiWiki, yet another Wiki clone.
d9 1
a9 1
# Copyright (C) 2000-2002 by Hiroshi Yuki.
d13 4
a16 2
# This program is free software; you can redistribute it and/or
# modify it under the same terms as Perl itself.
d18 54
d73 2
a74 45
#
# walwiki.cgi based on yukiwiki.cgi - Yet another WikiWikiWeb clone.
#
# WalWikiÌ»o[WÍAYukiWiki 2.0.beta1ðx[XÉµÄ¢Ü·B
# 
# * XVàe
# 
# 2.0.beta1.wal.1 on 2002/05/19,22:32:19
# (1) FooterÌÏX
# (2) WikiNameÌg£ : PerlCEàïÜAPPMInstallÍÜÜÈ¢
# (3) Ê¼Ni[Ê¼ URL]jÉÎB
# (4) ISBNðA}].jpÌAsociatevONÉÏ·B
# (5) [[#box:InterWikiName]]ÅInterWikiÈeLXg{bNX¶¬
# (6) HTML[hÎB
#
# 2.0.alpha0.wal.3ÅÜÅÌC³ÌàAÈºÉÏXª èÜ·B
# EÈºÍYukiWiki2ÉÀ³ê½½ßAÆ©R[hÍÈ­ÈèÜµ½B
#   - CCÌæÏ·
#   - YukiWikiDBÎ
#   - e[u
#   - DBÖAW[useÌeval»
#   - BracketNameÉæéL[©çuPbgðr
# EISBNÔÖÌÎÍWalWiki2.0æèAInterWikiÖÌAdd-OnÉÈèÜµ½B
#   [[ISBN http://www.amazon.co.jp/exec/obidos/ASIN/isbn($1)/walrdigi-22]]Ìæ¤Éo^B
#
#=======================================

# Walrus add (debug) start
my $walrus_log;
my $walrus_debugging = 0;
# Walrus add (debug) end

# Libraries.
use strict;
use lib qw(./WalWiki/lib);
use CGI qw(:standard);
use CGI::Carp qw(fatalsToBrowser);
use Yuki::RSS;
use Yuki::DiffText qw(difftext);
use Yuki::YukiWikiDB;
use AnyDBM_File;
require 'jcode.pl';
# use Jcode;
use Fcntl;
my $version = '2.0.beta1.2002-05-29';
d76 8
a83 15
#
# You MUST modify following '$modifier_...' variables.
#
my $modifier_mail = ''; # Your mail address, like 'walrus@@digit.que.ne.jp'.
my $modifier_url  = ''; # Your web page, like 'http://digit.que.ne.jp/work/'.
my $modifier_name = ''; # Your name, like 'Makio Tsukamoto'.
# my $modifier_dbtype = 'AnyDBM_File';  # Fast, not available on some server, page size limited.
# my $modifier_dbtype = 'dbmopen';      # Fast, not available on some server, page size limited.
my $modifier_dbtype = 'YukiWikiDB';     # Slow, available on all environment.
# my $modifier_sendmail = '/usr/sbin/sendmail -t -n'; # Your sendmail.
my $modifier_sendmail = ''; # If you don't need mail notification.
my $modifier_dir_data = './WalWiki'; # Your data directory.
my $modifier_rss_title = "WalWiki $walversion";
my $modifier_rss_link = 'http://yourhost/wiki.cgi'; # Blank is not allowed.
my $modifier_rss_description = 'This is WalWiki, yet another Wiki clone based on YukiWiki';
d85 1
a85 12
#
# You MAY modify following variables.
#
my $file_touch = "$modifier_dir_data/touched.txt";
my $file_resource = "$modifier_dir_data/resource.txt";
my $file_FrontPage = "$modifier_dir_data/frontpage.txt";
my $file_conflict = "$modifier_dir_data/conflict.txt";
my $file_format = "$modifier_dir_data/format.txt";
my $url_cgi = 'wiki.cgi';
my $url_stylesheet = './WalWiki/Theme/wiki.css';
my $icontag = '<img src="./WalWiki/Theme/icon.gif" alt="*" width="40" height="40" />';
my $maxrecent = 50;
d89 20
d110 34
a143 90
# You MAY, but do NOT NEED modify following variables.
# 
my $dataname = "$modifier_dir_data/wiki";
my $infoname = "$modifier_dir_data/info";
my $diffname = "$modifier_dir_data/diff";
my $editchar = '?';
my $subject_delimiter = ' - ';
my $use_autoimg = 1; # automatically convert image URL into <img> tag.
my $use_exists = 0; # If you can use 'exists' method for your DB.
##############################
my $InterWikiName = 'InterWikiName';
my $RecentChanges = 'RecentChanges';
my $AdminChangePassword = 'AdminChangePassword';
my $CompletedSuccessfully = 'CompletedSuccessfully';
my $FrontPage = 'FrontPage';
my $IndexPage = 'IndexPage';
my $SearchPage = 'SearchPage';
my $CreatePage = 'CreatePage';
my $ErrorPage = 'ErrorPage';
my $RssPage = 'RssPage';
my $AdminSpecialPage = 'Admin Special Page'; # must include spaces.
##############################
# my $wiki_name = '\b([A-Z][a-z]+([A-Z][a-z]+)+)\b';        # Walrus del (2)
my $wiki_name   = '\b([A-Z][a-z]+([A-Z][a-z]*)+)\b';        # Walrus add (2)
my $bracket_name = '\[\[(\S+?)\]\]';
my $embedded_name = '\[\[(#\S+?)\]\]';
my $interwiki_definition = '\[\[(\S+?)\ (\S+?)\]\]';
my $interwiki_name = '([^:]+):([^:].*)';
##############################
my $embed_comment = '[[#comment]]';
my $embed_rcomment = '[[#rcomment]]';
my $embed_interwiki = '^\[\[#(box|text|password):(\S+)\]\]$';    # Walrus add (5)
##############################
my $info_LastModified = 'LastModified';
my $info_IsFrozen = 'IsFrozen';
my $info_AdminPassword = 'AdminPassword';
##############################
my $kanjicode = 'euc';
my $charset = 'EUC-JP';
my $lang = 'ja';
my %fixedpage = (
    $IndexPage => 1,
    $CreatePage => 1,
    $ErrorPage => 1,
    $RssPage => 1,
    $RecentChanges => 1,
    $SearchPage => 1,
    $AdminChangePassword => 1,
    $CompletedSuccessfully => 1,
    $FrontPage => 1,
);
my %form;
my %database;
my %infobase;
my %diffbase;
my %resource;
my %interwiki;
##############################
my %page_command = (
    $IndexPage => 'index',
    $SearchPage => 'searchform',
    $CreatePage => 'create',
    $RssPage => 'rss',
    $AdminChangePassword => 'adminchangepasswordform',
    $FrontPage => 'FrontPage',
);
my %command_do = (
    read => \&do_read,
    edit => \&do_edit,
    adminedit => \&do_adminedit,
    adminchangepasswordform => \&do_adminchangepasswordform,
    adminchangepassword => \&do_adminchangepassword,
    write => \&do_write,
    index => \&do_index,
    searchform => \&do_searchform,
    search => \&do_search,
    create => \&do_create,
    createresult => \&do_createresult,
    FrontPage => \&do_FrontPage,
    comment => \&do_comment,
    rss => \&do_rss,
    diff => \&do_diff,
    interwikibox => \&do_interwiki_box, # Walrus add (5)
);
##############################
my @@ignore_html_page = ('FrontPage');        # Walrus add (6)
my @@ignore_html_tags = ('a', 'br', 'img');   # Walrus add (6)
my $walversion = '2.0.beta1.wal.1';          # Walrus add (1)
##############################
# &test_convert;
a145 1
##############################
d147 1
d149 35
a183 6
    &init_resource;
    &open_db;
    &init_form;
    &init_InterWikiName;
    if ($command_do{$form{mycmd}}) {
        &{$command_do{$form{mycmd}}};
d185 7
a191 1
        &do_FrontPage;
a192 1
    &close_db;
d195 1
d197 7
a203 3
    &print_header($form{mypage});
    &print_content($database{$form{mypage}});
    &print_footer($form{mypage});
d206 1
d208 4
a211 8
    my ($page) = &unarmor_name(&armor_name($form{mypage}));
    &print_header($page);
    if (not &is_editable($page)) {
        &print_message($resource{cantchange});
    } elsif (&is_frozen($page)) {
        &print_message($resource{cantchange});
    } else {
        &print_editform($database{$page}, &get_info($page, $info_LastModified), admin=>0);
d213 1
a213 1
    &print_footer($page);
d216 5
a220 5
sub do_adminedit {
    my ($page) = &unarmor_name(&armor_name($form{mypage}));
    &print_header($page);
    if (not &is_editable($page)) {
        &print_message($resource{cantchange});
d222 1
a222 2
        &print_message($resource{passwordneeded});
        &print_editform($database{$page}, &get_info($page, $info_LastModified), admin=>1);
a223 1
    &print_footer($page);
d226 82
a307 4
sub do_adminchangepasswordform {
    &print_header($AdminChangePassword);
    &print_passwordform;
    &print_footer($AdminChangePassword);
d310 14
a323 13
sub do_adminchangepassword {
    if ($form{mynewpassword} ne $form{mynewpassword2}) {
        &print_error($resource{passwordmismatcherror});
    }
    my ($validpassword_crypt) = &get_info($AdminSpecialPage, $info_AdminPassword);
    if ($validpassword_crypt) {
        if (not &valid_password($form{myoldpassword})) {
            &send_mail_to_admin(<<"EOD", "AdminChangePassword");
myoldpassword=$form{myoldpassword}
mynewpassword=$form{mynewpassword}
mynewpassword2=$form{mynewpassword2}
EOD
            &print_error($resource{passworderror});
d325 5
a329 21
    }
    my ($sec, $min, $hour, $day, $mon, $year, $weekday) = localtime(time);
    my (@@token) = ('0'..'9', 'A'..'Z', 'a'..'z');
    my $salt1 = $token[(time | $$) % scalar(@@token)];
    my $salt2 = $token[($sec + $min*60 + $hour*60*60) % scalar(@@token)];
    my $crypted = crypt($form{mynewpassword}, "$salt1$salt2");
    &set_info($AdminSpecialPage, $info_AdminPassword, $crypted);

    &print_header($CompletedSuccessfully);
    &print_message($resource{passwordchanged});
    &print_footer($CompletedSuccessfully);
}

sub do_index {
    &print_header($IndexPage);
    print qq(<ul>);
    foreach my $page (sort keys %database) {
        if (&is_editable($page)) {
            print qq(<li><a href="$url_cgi?@@{[&encode($page)]}">$page</a>@@{[&escape(&get_subjectline($page))]}</li>);
            # print qq(<li>@@{[&get_info($page, $info_IsFrozen)]}</li>);
            # print qq(<li>@@{[0 + &is_frozen($page)]}</li>);
d331 4
d336 10
a345 2
    print qq(</ul>);
    &print_footer($IndexPage);
d348 30
a377 3
sub do_write {
    if (&frozen_reject()) {
        return;
d379 3
d383 16
d400 2
a401 3
        &print_header($form{mypage});
        &print_message($resource{cantchange});
        &print_footer($form{mypage});
d405 25
a429 1
    if (&conflict($form{mypage}, $form{mymsg})) {
d433 1
a433 1
    # Making diff
d435 2
a436 2
        &open_diff;
        my @@msg1 = split(/\n/, $database{$form{mypage}});
d438 6
a443 2
        $diffbase{$form{mypage}} = &difftext(\@@msg1, \@@msg2);
        &close_diff;
d446 2
d449 14
a462 21
        $database{$form{mypage}} = $form{mymsg};
        &send_mail_to_admin($form{mypage}, "Modify");
        if ($form{mytouch}) {
            &set_info($form{mypage}, $info_LastModified, '' . localtime);
            &update_recent_changes;
        }
        &set_info($form{mypage}, $info_IsFrozen, 0 + $form{myfrozen});
        &print_header($CompletedSuccessfully);
        &print_message($resource{saved});
        &print_content("$resource{continuereading} @@{[&armor_name($form{mypage})]}");
        &print_footer($CompletedSuccessfully);
    } else {
        &send_mail_to_admin($form{mypage}, "Delete");
        delete $database{$form{mypage}};
        delete $infobase{$form{mypage}};
        if ($form{mytouch}) {
            &update_recent_changes;
        }
        &print_header($form{mypage});
        &print_message($resource{deleted});
        &print_footer($form{mypage});
d466 35
a500 4
sub do_searchform {
    &print_header($SearchPage);
    &print_searchform("");
    &print_footer($SearchPage);
d503 4
a506 13
sub do_search {
    my $word = &escape($form{mymsg});
    &print_header($SearchPage);
    &print_searchform($word);
    my $counter = 0;
    foreach my $page (sort keys %database) {
        next if $page =~ /^$RecentChanges$/;
        if ($database{$page} =~ /\Q$form{mymsg}\E/ or $page =~ /\Q$form{mymsg}\E/) {
            if ($counter == 0) {
                print qq|<ul>|;
            }
            print qq(<li><a href ="$url_cgi?@@{[&encode($page)]}">$page</a>@@{[&escape(&get_subjectline($page))]}</li>);
            $counter++;
a507 3
    }
    if ($counter == 0) {
        &print_message($resource{notfound});
d509 3
a511 1
        print qq|</ul>|;
a512 1
    &print_footer($SearchPage);
d515 6
a520 11
sub do_create {
    &print_header($CreatePage);
    print <<"EOD";
<form action="$url_cgi" method="post">
    <input type="hidden" name="mycmd" value="edit">
    <strong>$resource{newpagename}</strong><br>
    <input type="text" name="mypage" value="" size="20">
    <input type="submit" value="$resource{createbutton}"><br>
</form>
EOD
    &print_footer($CreatePage);
d523 18
a540 8
sub do_FrontPage {
    open(FILE, $file_FrontPage) or &print_error("($file_FrontPage)");
    my $content = join('', <FILE>);
    &code_convert(\$content, $kanjicode);
    close(FILE);
    &print_header($FrontPage);
    &print_content($content);
    &print_footer($FrontPage);
d543 1
d546 2
a547 3
    &print_header($ErrorPage);
    print qq(<p><strong class="error">$msg</strong></p>);
    &print_footer($ErrorPage);
d551 65
d617 1
a617 15
    my ($page) = @@_;
    my $bodyclass = "normal";
    my $editable = 0;
    my $admineditable = 0;
    if (&is_frozen($page) and $form{mycmd} =~ /^(read|write)$/) {
        $editable = 0;
        $admineditable = 1;
        $bodyclass = "frozen";
    } elsif (&is_editable($page) and $form{mycmd} =~ /^(read|write)$/) {
        $admineditable = 1;
        $editable = 1;
    } else {
        $editable = 0;
    }
    my $cookedpage = &encode($page);
d619 1
a619 1
Content-type: text/html; charset=$charset
d621 7
a627 11
<!DOCTYPE html
    PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
    "http://www.w3.org/TR/html4/loose.dtd">
<html lang="$lang">
<head>
    <meta http-equiv="Content-Language" content="$lang">
    <meta http-equiv="Content-Type" content="text/html; charset=$charset">
    <title>$page @@{[&escape(&get_subjectline($page))]}</title>
    <link rel="index" href="$url_cgi?$IndexPage">
    <link rev="made" href="mailto:$modifier_mail">
    <link rel="stylesheet" type="text/css" href="$url_stylesheet">
d629 25
a653 24
<body class="$bodyclass">
<div class="tools">
    @@{[ $admineditable
        ? qq(<a title="$resource{admineditthispage}" href="$url_cgi?mycmd=adminedit&amp;mypage=$cookedpage">$resource{admineditbutton}</a> | )
        : qq()
    ]}
    @@{[ $editable
        ? qq(<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit&amp;mypage=$cookedpage">$resource{editbutton}</a> | )
        : qq()
    ]}
    @@{[ $admineditable
        ? qq(<a href="$url_cgi?mycmd=diff&amp;mypage=$cookedpage">$resource{diffbutton}</a> | )
        : qq()
    ]}
    <a href="$url_cgi?$CreatePage">$resource{createbutton}</a> | 
    <a href="$url_cgi?$IndexPage">$resource{indexbutton}</a> | 
    <a href="$url_cgi?$RssPage">$resource{rssbutton}</a> | 
    <a href="$url_cgi?$FrontPage">$FrontPage</a> | 
    <a href="$url_cgi?$SearchPage">$resource{searchbutton}</a> | 
    <a href="$url_cgi?$RecentChanges">$resource{recentchangesbutton}</a>
</div>
<h1 class="header"><a
    title="$resource{searchthispage}"
    href="$url_cgi?mycmd=search&amp;mymsg=$cookedpage">$page</a>@@{[&escape(&get_subjectline($page))]}</h1>
d657 1
a658 4
    my ($page) = @@_;
    $walrus_log = ($walrus_debugging) ? &text_to_html("----\n$walrus_log") : '';    # Walrus add (debug)
    # Walrus mod (1) start
    my $mod_info = $modifier_name ? qq(Modified by <a href="$modifier_url">$modifier_name</a>.) : '';
d660 1
a660 2
<div class="footer">
<hr />
d662 2
a663 5
<a href="http://digit.que.ne.jp/work/">WalWiki</a> $walversion &copy; 2000-2002 by <a href="http://digit.que.ne.jp/">Makio Tsukamoto</a>.<br />
based on <a href="http://www.hyuki.com/yukiwiki/">YukiWiki</a> $version &copy; 2000-2002 by <a href="http://www.hyuki.com/">Hiroshi Yuki</a>.<br />
$mod_info
</p><p>
<a href="http://digit.que.ne.jp/work/">$icontag</a>
d665 1
a665 4
</div>
$walrus_log <!-- Walrus add (debug) -->
</body>
</html>
a666 14
#       print <<"EOD";
#   <hr>
#   <address class="footer">
#       <a href="http://www.hyuki.com/yukiwiki/">YukiWiki</a> $version
#       &copy; 2000-2002 by <a href="http://www.hyuki.com/">Hiroshi Yuki</a>.<br />
#       Modified by <a href="$modifier_url">$modifier_name</a>.
#   </address>
#   <p class="footer">
#       <a href="http://www.hyuki.com/yukiwiki/">$icontag</a>
#   </p>
#   </body>
#   </html>
#   EOD
    # Walrus mod (1) end
d669 37
a705 23
sub escape {
    my $s = shift;
    $s =~ s|\r\n|\n|g;
    $s =~ s|\&|&amp;|g;
    $s =~ s|<|&lt;|g;
    $s =~ s|>|&gt;|g;
    $s =~ s|"|&quot;|g;
    return $s;
}

sub unescape {
    my $s = shift;
    # $s =~ s|\n|\r\n|g;
    $s =~ s|\&amp;|\&|g;
    $s =~ s|\&lt;|\<|g;
    $s =~ s|\&gt;|\>|g;
    $s =~ s|\&quot;|\"|g;
    return $s;
}

sub print_content {
    my ($rawcontent) = @@_;
    print &text_to_html($rawcontent, toc=>1);
d708 3
a710 2
sub text_to_html {
    my ($txt, %option) = @@_;
a711 5
    my (@@toc);
    my $tocnum = 0;
    my (@@saved, @@result);
    unshift(@@saved, "</p>");
    push(@@result, "<p>");
d714 2
a715 13
        # Walrus mod (6) start
        if ($saved[0] eq '</html>') {
            if (/<\/html>/i) { splice(@@saved); }
            else { push (@@result, &html_to_ignored_html($_)); }
        } elsif (/^<html>/i and &is_ignore_html($form{mypage})) {
            push(@@result, splice(@@saved));
            push(@@saved, '</html>');
        } elsif (/^\*\*(.*)/) {
        # if (/^\*\*(.*)/) {
        # Walrus mod (6) end
            push(@@toc, qq(-- <a href="#i$tocnum">@@{[&escape($1)]}</a>\n));
            push(@@result, splice(@@saved), qq(<h3><a name="i$tocnum"> </a>) . &inline($1) . '</h3>');
            $tocnum++;
d717 1
a717 3
            push(@@toc, qq(- <a href="#i$tocnum">@@{[&escape($1)]}</a>\n));
            push(@@result, splice(@@saved), qq(<h2><a name="i$tocnum"> </a>) . &inline($1) . '</h2>');
            $tocnum++;
d721 1
a721 1
            &back_push('ul', length($1), \@@saved, \@@result);
d724 1
a724 1
            &back_push('dl', 1, \@@saved, \@@result);
d727 1
a727 1
            &back_push('blockquote', length($1), \@@saved, \@@result);
d734 1
a734 1
            &back_push('pre', 1, \@@saved, \@@result);
a735 24
#       } elsif (/^\,(.*)$/) {             # Walrus del (BF)
        } elsif (/^\,(.*?)[\x0D\x0A]*$/) { # Walrus add (BF)
            &back_push('table', 1, \@@saved, \@@result, ' border="1"');
            #######
            # This part is taken from Mr. Ohzaki's Perl Memo and Makio Tsukamoto's WalWiki.
            # XXXXX
            my $tmp = "$1,";
            my @@value = map {/^"(.*)"$/ ? scalar($_ = $1, s/""/"/g, $_) : $_} ($tmp =~ /("[^"]*(?:""[^"]*)*"|[^,]*),/g);
            my @@align = map {(s/^\s+//) ? ((s/\s+$//) ? ' align="center"' : ' align="right"') : ''} @@value;
            my @@colspan = map {($_ eq '==') ? 0 : 1} @@value;
            for (my $i = 0; $i < @@value; $i++) {
                if ($colspan[$i]) {
                    while ($i + $colspan[$i] < @@value and $value[$i + $colspan[$i]] eq '==') {
                        $colspan[$i]++;
                    }
                    $colspan[$i] = ($colspan[$i] > 1) ? sprintf(' colspan="%d"', $colspan[$i]) : '';
                    $value[$i] = sprintf('<td%s%s>%s</td>', $align[$i], $colspan[$i], &inline($value[$i]));
                } else {
                    $value[$i] = '';
                }
            }
            push(@@result, join('', '<tr>', @@value, '</tr>'));
            # XXXXX
            #######
d741 18
d760 6
a765 9
    if ($option{toc}) {
        # Convert @@toc (table of contents) to HTML.
        # This part is taken from Makio Tsukamoto's WalWiki.
        my (@@tocsaved, @@tocresult);
        foreach (@@toc) {
            if (/^(-{1,3})(.*)/) {
                &back_push('ul', length($1), \@@tocsaved, \@@tocresult);
                push(@@tocresult, '<li>' . $2 . '</li>');
            }
d767 14
a780 2
        push(@@tocresult, splice(@@tocsaved));
        return join("\n", @@tocresult, @@result);
d782 1
a782 1
        return join("\n", @@result);
d786 22
a807 11
sub back_push {
    my ($tag, $level, $savedref, $resultref, $attr) = @@_;
    while (@@$savedref > $level) {
        push(@@$resultref, shift(@@$savedref));
    }
    if ($savedref->[0] ne "</$tag>") {
        push(@@$resultref, splice(@@$savedref));
    }
    while (@@$savedref < $level) {
        unshift(@@$savedref, "</$tag>");
        push(@@$resultref, "<$tag$attr>");
d811 60
a870 20
sub inline {
    my ($line) = @@_;
    $line = &escape($line);
    $line =~ s|'''([^']+?)'''|<i>$1</i>|g;  # Italic
    $line =~ s|''([^']+?)''|<b>$1</b>|g;    # Bold
    $line =~ s|(\d\d\d\d-\d\d-\d\d \(\w\w\w\) \d\d:\d\d:\d\d)|<span class="date">$1</span>|g;   # Date
    $line =~ s!
                (
                    ((mailto|http|https|ftp):([^\x00-\x20()<>\x7F-\xFF])*)  # Direct http://...
                        |
                    ($bracket_name)             # [[likethis]], [[#comment]], [[Friend:remotelink]]
                        |
                    ($interwiki_definition)     # [[Friend http://somewhere/?q=sjis($1)]]
                        |
                    ($wiki_name)                # LocalLinkLikeThis
                )
            !
                &make_link($1)
            !gex;
    return $line;
d873 7
a879 46
sub make_link {
    my $chunk = shift;
    # Walrus add (3) start
    my $name  = $chunk;
    if ($chunk =~ /^\[\[([^ ]+?) ([^ ]+?)\]\]$/ and $form{mypage} ne $InterWikiName) {
        ($name, $chunk) = ($1, $2);
    } elsif ($chunk =~ /^mailto:(.*)$/) {
        $name = $1;
    }
    if ($use_autoimg and $name =~ /^(http|https|ftp|):.+\.(png|gif|jpe?g)/) {
        $name = qq(<img src="$name">) ;
    }
    $name = &unarmor_name($name);
    # Walrus add (3) end
    if ($chunk =~ /^(http|https|ftp):/) {
        # Walrus mod (3) start
#       if ($use_autoimg and $chunk =~ /\.(gif|png|jpeg|jpg)$/) {
#           return qq(<a href="$chunk"><img src="$chunk"></a>);
#       } else {
#           return qq(<a href="$chunk">$chunk</a>);
#       }
        return qq(<a href="$chunk">$name</a>);
        # Walrus mod (3) end
    } elsif ($chunk =~ /^(mailto):(.*)/) {
#       return qq(<a href="$chunk">$2</a>);                 # Walrus del (3)
        return qq(<a href="$chunk">$name</a>);              # Walrus add (3)
    } elsif ($chunk =~ /^$interwiki_definition$/) {
#       return qq(<span class="InterWiki">$chunk</span>);   # Walrus del (3)
        return qq(<span class="InterWiki">$name</span>);    # Walrus add (3)
    } elsif ($chunk =~ /^$embedded_name$/) {
        return &embedded_to_html($chunk);
    } else {
        $chunk = &unarmor_name($chunk);
        $chunk = &unescape($chunk); # To treat '&' or '>' or '<' correctly.
        my $cookedchunk = &encode($chunk);
        if ($chunk =~ /^$interwiki_name$/) {
            my ($intername, $localname) = ($1, $2);
            my $remoteurl = $interwiki{$intername};
            if ($remoteurl) {
#               $remoteurl =~ s/\b(euc|sjis|ykwk|asis)\(\$1\)/&interwiki_convert($1, $localname)/e;      # Walrus del (4)
                $remoteurl =~ s/\b(euc|sjis|ykwk|asis|isbn)\(\$1\)/&interwiki_convert($1, $localname)/e; # Walrus add (4)
#               return qq(<a href="$remoteurl">$chunk</a>); # Walrus del (3)
                return qq(<a href="$remoteurl">$name</a>);  # Walrus add (3)
            } else {
#               return $chunk;                              # Walrus del (3)
                return $name;                               # Walrus add (3)
d881 7
a887 12
        } elsif ($database{$chunk}) {
            my $subject = &escape(&get_subjectline($chunk, delimiter => ''));
#           return qq(<a title="$subject" href="$url_cgi?$cookedchunk">$chunk</a>);  # Walrus del (3)
            return qq(<a title="$subject" href="$url_cgi?$cookedchunk">$name</a>);   # Walrus add (3)
        } elsif ($page_command{$chunk}) {
#           return qq(<a title="$chunk" href="$url_cgi?$cookedchunk">$chunk</a>);    # Walrus del (3)
            return qq(<a title="$chunk" href="$url_cgi?$cookedchunk">$name</a>);     # Walrus add (3)
        } else {
#           return qq($chunk<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit&amp;mypage=$cookedchunk">$editchar</a>); # Walrus del (3)
            return qq($name<a title="$resource{editthispage}" href="$url_cgi?mycmd=edit&amp;mypage=$cookedchunk">$editchar</a>);  # Walrus add (3)
        }
    }
d890 4
a893 7
# Walrus add (6) start
sub is_ignore_html {
    my ($pagename) = @@_;
    foreach (@@ignore_html_page) {
        return 1 if ($pagename eq $_);
    }
    return 0;
a894 1
# Walrus add (6) end
d896 3
a898 20
# Walrus add (6) start
sub html_to_ignored_html {
    my $str = shift(@@_);
    my $text_regex        = q{[^<]*};
    my $tag_regex_        = q{[^"'<>]*(?:"[^"]*"[^"'<>]*|'[^']*'[^"'<>]*)*(?:>|(?=<)|$(?!\n))}; #'}}}}
    my $comment_tag_regex = '<!(?:--[^-]*-(?:[^-]+-)*?-(?:[^>-]*(?:-[^>-]+)*?)??)*(?:>|$(?!\n)|--.*$)';
    my $tag_regex         = qq{$comment_tag_regex|<$tag_regex_};
    my $ignored           = join('|', @@ignore_html_tags);
    my $result = '';
    while ($str =~ /($text_regex)($tag_regex)?/gso) {
      last if $1 eq '' and $2 eq '';
      $result .= $1;
      my $tag_tmp = $2;
      $result .= ($tag_tmp =~ /^<\/?($ignored)(?![0-9A-Za-z])/i) ? $tag_tmp : &escape($tag_tmp);
      if ($tag_tmp =~ /^<(XMP|PLAINTEXT|SCRIPT)(?![0-9A-Za-z])/i) {
        $str =~ /(.*?)(?:<\/$1(?![0-9A-Za-z])$tag_regex_|$)/gsi;
        $result .= &escape($1);
      }
    }
    return $result;
a899 1
# Walrus add (6) end
d901 3
a903 3
sub print_message {
    my ($msg) = @@_;
    print qq(<p><strong>$msg</strong></p>);
d906 8
a913 7
sub init_form {
    if (param()) {
        foreach my $var (param()) {
            $form{$var} = param($var);
        }
    } else {
        $ENV{QUERY_STRING} = $FrontPage;
d915 5
d921 18
a938 19
    my $query = &decode($ENV{QUERY_STRING});
    if ($page_command{$query}) {
        $form{mycmd} = $page_command{$query};
        $form{mypage} = $query;
    } elsif ($query =~ /^($wiki_name)$/) {
        $form{mycmd} = 'read';
        $form{mypage} = $1;
    } elsif ($database{$query}) {
        $form{mycmd} = 'read';
        $form{mypage} = $query;
    }

    # mypreview_edit        -> do_edit, with preview.
    # mypreview_adminedit   -> do_adminedit, with preview.
    # mypreview_write       -> do_write, without preview.
    foreach (keys %form) {
        if (/^mypreview_(.*)$/) {
            $form{mycmd} = $1;
            $form{mypreview} = 1;
d941 2
d944 7
a950 27
    #
    # $form{mycmd} is frozen here.
    #

    $form{mymsg} = &code_convert(\$form{mymsg}, $kanjicode);
    $form{myname} = &code_convert(\$form{myname}, $kanjicode);
}

sub update_recent_changes {
    my $update = "- @@{[&get_now]} @@{[&armor_name($form{mypage})]} @@{[&get_subjectline($form{mypage})]}";
    my @@oldupdates = split(/\r?\n/, $database{$RecentChanges});
    my @@updates;
    foreach (@@oldupdates) {
        /^\- \d\d\d\d\-\d\d\-\d\d \(...\) \d\d:\d\d:\d\d (\S+)/;    # date format.
        my $name = &unarmor_name($1);
        if (&is_exist_page($name) and ($name ne $form{mypage})) {
            push(@@updates, $_);
        }
    }
    if (&is_exist_page($form{mypage})) {
        unshift(@@updates, $update);
    }
    splice(@@updates, $maxrecent + 1);
    $database{$RecentChanges} = join("\n", @@updates);
    if ($file_touch) {
        open(FILE, "> $file_touch");
        print FILE localtime() . "\n";
d952 3
d958 8
a965 15
sub get_subjectline {
    my ($page, %option) = @@_;
    if (not &is_editable($page)) {
        return "";
    } else {
        # Delimiter check.
        my $delim = $subject_delimiter;
        if (defined($option{delimiter})) {
            $delim = $option{delimiter};
        }

        # Get the subject of the page.
        my $subject = $database{$page};
        $subject =~ s/\r?\n.*//s;
        return "$delim$subject";
d967 1
d970 5
a974 25
sub send_mail_to_admin {
    my ($page, $mode) = @@_;
    return unless $modifier_sendmail;
    my $message = <<"EOD";
To: $modifier_mail
From: $modifier_mail
Subject: [Wiki]
MIME-Version: 1.0
Content-Type: text/plain; charset=ISO-2022-JP
Content-Transfer-Encoding: 7bit

--------
MODE = $mode
REMOTE_ADDR = $ENV{REMOTE_ADDR}
REMOTE_HOST = $ENV{REMOTE_HOST}
--------
$page
--------
$database{$page}
--------
EOD
    &code_convert(\$message, 'jis');
    open(MAIL, "| $modifier_sendmail");
    print MAIL $message;
    close(MAIL);
d977 6
a982 11
sub open_db {
    if ($modifier_dbtype eq 'dbmopen') {
        dbmopen(%database, $dataname, 0666) or &print_error("(dbmopen) $dataname");
        dbmopen(%infobase, $infoname, 0666) or &print_error("(dbmopen) $infoname");
    } elsif ($modifier_dbtype eq 'AnyDBM_File') {
        tie(%database, "AnyDBM_File", $dataname, O_RDWR|O_CREAT, 0666) or &print_error("(tie AnyDBM_File) $dataname");
        tie(%infobase, "AnyDBM_File", $infoname, O_RDWR|O_CREAT, 0666) or &print_error("(tie AnyDBM_File) $infoname");
    } else {
        tie(%database, "Yuki::YukiWikiDB", $dataname) or &print_error("(tie Yuki::YukiWikiDB) $dataname");
        tie(%infobase, "Yuki::YukiWikiDB", $infoname) or &print_error("(tie Yuki::YukiWikiDB) $infoname");
    }
d985 7
a991 10
sub close_db {
    if ($modifier_dbtype eq 'dbmopen') {
        dbmclose(%database);
        dbmclose(%infobase);
    } elsif ($modifier_dbtype eq 'AnyDBM_File') {
        untie(%database);
        untie(%infobase);
    } else {
        untie(%database);
        untie(%infobase);
d993 1
d996 3
a998 8
sub open_diff {
    if ($modifier_dbtype eq 'dbmopen') {
        dbmopen(%diffbase, $diffname, 0666) or &print_error("(dbmopen) $diffname");
    } elsif ($modifier_dbtype eq 'AnyDBM_File') {
        tie(%diffbase, "AnyDBM_File", $diffname, O_RDWR|O_CREAT, 0666) or &print_error("(tie AnyDBM_File) $diffname");
    } else {
        tie(%diffbase, "Yuki::YukiWikiDB", $diffname) or &print_error("(tie Yuki::YukiWikiDB) $diffname");
    }
d1001 5
a1005 7
sub close_diff {
    if ($modifier_dbtype eq 'dbmopen') {
        dbmclose(%diffbase);
    } elsif ($modifier_dbtype eq 'AnyDBM_File') {
        untie(%diffbase);
    } else {
        untie(%diffbase);
d1007 1
d1009 313
d1323 52
a1374 10
sub print_searchform {
    my ($word) = @@_;
    print <<"EOD";
<form action="$url_cgi" method="get">
    <input type="hidden" name="mycmd" value="search">
    <input type="text" name="mymsg" value="$word" size="20">
    <input type="submit" value="$resource{searchbutton}">
</form>
EOD
}
d1376 2
a1377 20
sub print_editform {
    my ($mymsg, $lastmodified, %mode) = @@_;
    my $frozen = &is_frozen($form{mypage});

    if ($form{mypreview}) {
        if ($form{mymsg}) {
            unless ($mode{conflict}) {
                print qq(<h3>$resource{previewtitle}</h3>\n);
                print qq($resource{previewnotice}\n);
                print qq(<div class="preview">\n);
                &print_content($form{mymsg});
                print qq(</div>\n);
            }
        } else {
            print qq($resource{previewempty});
        }
        $mymsg = &escape($form{mymsg});
    } else {
        $mymsg = &escape($mymsg);
    }
d1379 1
a1379 1
    my $edit = $mode{admin} ? 'adminedit' : 'edit';
d1381 2
a1382 32
    print <<"EOD";
<form action="$url_cgi" method="post">
    @@{[ $mode{admin} ? qq($resource{frozenpassword} <input type="password" name="mypassword" value="$form{mypassword}" size="10"><br>) : "" ]}
    <input type="hidden" name="myLastModified" value="$lastmodified">
    <input type="hidden" name="mypage" value="$form{mypage}">
    <textarea cols="$cols" rows="$rows" name="mymsg" wrap="off">$mymsg</textarea><br>
@@{[
    $mode{admin} ?
    qq(
    <input type="radio" name="myfrozen" value="1" @@{[$frozen ? qq(checked="checked") : ""]}>$resource{frozenbutton}
    <input type="radio" name="myfrozen" value="0" @@{[$frozen ? "" : qq(checked="checked")]}>$resource{notfrozenbutton}<br>)
    : ""
]}
@@{[
    $mode{conflict} ? "" :
    qq(
        <input type="checkbox" name="mytouch" value="on" checked="checked">$resource{touch}<br>
        <input type="submit" name="mypreview_$edit" value="$resource{previewbutton}">
        <input type="submit" name="mypreview_write" value="$resource{savebutton}"><br>
    )
]}
</form>
EOD
    unless ($mode{conflict}) {
        # Show the format rule.
        open(FILE, $file_format) or &print_error("($file_format)");
        my $content = join('', <FILE>);
        &code_convert(\$content, $kanjicode);
        close(FILE);
        print &text_to_html($content, toc=>0);
    }
}
d1384 1
a1384 11
sub print_passwordform {
        print <<"EOD";
<form action="$url_cgi" method="post">
    <input type="hidden" name="mycmd" value="adminchangepassword">
    $resource{oldpassword} <input type="password" name="myoldpassword" size="10"><br>
    $resource{newpassword} <input type="password" name="mynewpassword" size="10"><br>
    $resource{newpassword2} <input type="password" name="mynewpassword2" size="10"><br>
    <input type="submit" value="$resource{changepasswordbutton}"><br>
</form>
EOD
}
d1386 2
a1387 16
sub is_editable {
    my ($page) = @@_;
    if (&is_bracket_name($page)) {
        return 0;
    } elsif ($fixedpage{$page}) {
        return 0;
    } elsif ($page =~ /\s/) {
        return 0;
    } elsif ($page =~ /^\#/) {
        return 0;
    } elsif ($page =~ /^$interwiki_name$/) {
        return 0;
    } else {
        return 1;
    }
}
d1389 1
a1389 11
# armor_name:
#   WikiName -> WikiName
#   not_wiki_name -> [[not_wiki_name]]
sub armor_name {
    my ($name) = @@_;
    if ($name =~ /^$wiki_name$/) {
        return $name;
    } else {
        return "[[$name]]";
    }
}
d1391 2
a1392 11
# unarmor_name:
#   [[bracket_name]] -> bracket_name
#   WikiName -> WikiName
sub unarmor_name {
    my ($name) = @@_;
    if ($name =~ /^$bracket_name$/) {
        return $1;
    } else {
        return $name;
    }
}
d1394 1
a1394 8
sub is_bracket_name {
    my ($name) = @@_;
    if ($name =~ /^$bracket_name$/) {
        return 1;
    } else {
        return 0;
    }
}
d1396 1
a1396 6
sub decode {
    my ($s) = @@_;
    $s =~ tr/+/ /;
    $s =~ s/%([A-Fa-f0-9][A-Fa-f0-9])/pack("C", hex($1))/eg;
    return $s;
}
d1398 1
a1398 12
sub encode {
    my ($s) = @@_;
    my $encoded = '';
    foreach my $ch (split(//, $s)) {
        if ($ch =~ /[A-Za-z0-9_]/) {
            $encoded .= $ch;
        } else {
            $encoded .= '%' . sprintf("%02X", ord($ch));
        }
    }
    return $encoded;
}
d1400 1
a1400 10
sub init_resource {
    open(FILE, $file_resource) or &print_error("(resource)");
    while (<FILE>) {
        chomp;
        next if /^#/;
        my ($key, $value) = split(/=/, $_, 2);
        $resource{$key} = &code_convert(\$value, $kanjicode);
    }
    close(FILE);
}
d1402 1
a1402 38
sub conflict {
    my ($page, $rawmsg) = @@_;
    if ($form{myLastModified} eq &get_info($page, $info_LastModified)) {
        return 0;
    }
    open(FILE, $file_conflict) or &print_error("(conflict)");
    my $content = join('', <FILE>);
    &code_convert(\$content, $kanjicode);
    close(FILE);
    &print_header($page);
    &print_content($content);
    &print_editform($rawmsg, $form{myLastModified}, frozen=>0, conflict=>1);
    &print_footer($page);
    return 1;
}

sub get_now {
    my (@@week) = qw(Sun Mon Tue Wed Thu Fri Sat);
    my ($sec, $min, $hour, $day, $mon, $year, $weekday) = localtime(time);
    $year += 1900;
    $mon++;
    $mon = "0$mon" if $mon < 10;
    $day = "0$day" if $day < 10;
    $hour = "0$hour" if $hour < 10;
    $min = "0$min" if $min < 10;
    $sec = "0$sec" if $sec < 10;
    $weekday = $week[$weekday];
    return "$year-$mon-$day ($weekday) $hour:$min:$sec";
}

# [[YukiWiki http://www.hyuki.com/yukiwiki/wiki.cgi?euc($1)]]
sub init_InterWikiName {
    my $content = $database{$InterWikiName};
    while ($content =~ /\[\[(\S+) +(\S+)\]\]/g) {
        my ($name, $url) = ($1, $2);
        $interwiki{$name} = $url;
    }
}
d1404 1
a1404 24
sub interwiki_convert {
    my ($type, $localname) = @@_;
    if ($type eq 'sjis' or $type eq 'euc') {
        &code_convert(\$localname, $type);
        return &encode($localname);
    } elsif ($type eq 'ykwk') {
        # for YukiWiki1
        if ($localname =~ /^$wiki_name$/) {
            return $localname;
        } else {
            &code_convert(\$localname, 'sjis');
            return &encode("[[" . $localname . "]]");
        }
    } elsif ($type eq 'asis') {
        return $localname;
    # Walrus add (4) start
    } elsif ($type eq 'isbn') {
        $localname = join('', ($localname =~ /[0-9x]/g)) if ($localname =~ /^(\d-?){9}[\dx]$/);
        return $localname;
    # Walrus add (4) end
    } else {
        return $localname;
    }
}
d1406 1
a1406 5
sub get_info {
    my ($page, $key) = @@_;
    my %info = map { split(/=/, $_, 2) } split(/\n/, $infobase{$page});
    return $info{$key};
}
d1408 1
a1408 10
sub set_info {
    my ($page, $key, $value) = @@_;
    my %info = map { split(/=/, $_, 2) } split(/\n/, $infobase{$page});
    $info{$key} = $value;
    my $s = '';
    for (keys %info) {
        $s .= "$_=$info{$_}\n";
    }
    $infobase{$page} = $s;
}
d1410 1
a1410 14
sub frozen_reject {
    my ($isfrozen) = &get_info($form{mypage}, $info_IsFrozen);
    my ($willbefrozen) = $form{myfrozen};
    if (not $isfrozen and not $willbefrozen) {
        # You need no check.
        return 0;
    } elsif (valid_password($form{mypassword})) {
        # You are admin.
        return 0;
    } else {
        &print_error($resource{passworderror});
        return 1;
    }
}
d1412 1
a1412 9
sub valid_password {
    my ($givenpassword) = @@_;
    my ($validpassword_crypt) = &get_info($AdminSpecialPage, $info_AdminPassword);
    if (crypt($givenpassword, $validpassword_crypt) eq $validpassword_crypt) {
        return 1;
    } else {
        return 0;
    }
}
d1414 8
a1421 8
sub is_frozen {
    my ($page) = @@_;
    if (&get_info($page, $info_IsFrozen)) {
        return 1;
    } else {
        return 0;
    }
}
d1423 1
a1423 18
sub do_comment {
    my ($content) = $database{$form{mypage}};
    my $datestr = &get_now;
    my $namestr = $form{myname} ? " ''[[$form{myname}]]'' : " : " ";
    if ($content =~ s/(\Q$embed_comment\E)/- $datestr$namestr$form{mymsg}\n$1/) {
        ;
    } else {
        $content =~ s/(\Q$embed_rcomment\E)/$1\n- $datestr$namestr$form{mymsg}/;
    }
    if ($form{mymsg}) {
        $form{mymsg} = $content;
        $form{mytouch} = 'on';
        &do_write;
    } else {
        $form{mycmd} = 'read';
        &do_read;
    }
}
d1425 4
a1428 25
sub embedded_to_html {
    my ($embedded) = @@_;
    if ($embedded eq $embed_comment or $embedded eq $embed_rcomment) {
        my $lastmodified = &get_info($form{mypage}, $info_LastModified);
        return <<"EOD";
<form action="$url_cgi" method="post">
    <input type="hidden" name="mycmd" value="comment">
    <input type="hidden" name="mypage" value="$form{mypage}">
    <input type="hidden" name="myLastModified" value="$lastmodified">
    <input type="hidden" name="mytouch" value="on">
    $resource{yourname}
    <input type="text" name="myname" value="" size="10">
    <input type="text" name="mymsg" value="" size="40">
    <input type="submit" value="$resource{commentbutton}">
</form>
EOD
    # Walrus add (5) start
    } elsif ($embedded =~ /$embed_interwiki/ and my $remoteurl = $interwiki{$2}) {
        $_ = &make_interwiki_box($1, $2);
        return ($_) ? $_ : $embedded;
    # Walrus add (5) end
    } else {
        return $embedded;
    }
}
d1430 1
a1430 12
# Walrus add (5) start
sub do_interwiki_box {
    my $remoteurl = $interwiki{$form{'myintername'}};
    if ($remoteurl) {
        $remoteurl =~ s/\b(euc|sjis|ykwk|asis|isbn)\(\$1\)/&interwiki_convert($1, $form{'mylocalname'})/e;
        print "Location: $remoteurl\n\n";
        exit(1);
    } else {
        &do_read;
    }
}
# Walrus add (5) end
d1432 1
a1432 21
# Walrus add (5) start
sub make_interwiki_box {
    my ($localname, $intername) = @@_;
    my %ignoretype = (
        'box'      => 'text',
        'text'     => 'text',
        'pass'     => 'password',
        'password' => 'password'
    );
    my $converted = ($ignoretype{$localname}) ? <<EOD : undef;
<form action="$url_cgi" method="post">
    <input type="hidden" name="mycmd" value="interwikibox">
    <input type="hidden" name="mypage" value="$form{mypage}">
    <input type="hidden" name="myintername" value="$intername">
    $intername:
    <input type="$ignoretype{$localname}" name="mylocalname" value="" size="10">
    <input type="submit" value="Submit">
</form>
EOD
}
# Walrus add (5) end
d1434 2
a1435 33
sub code_convert {
    my ($contentref, $kanjicode) = @@_;
#   &Jcode::convert($contentref, $kanjicode);       # for Jcode.pm
    &jcode::convert($contentref, $kanjicode);       # for jcode.pl
    return $$contentref;
}

sub test_convert {
    my $txt = &text_to_html(<<"EOD", toc=>1);
*HEADER1
**HEADER1-1
-ITEM1
-ITEM2
-ITEM3
PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
PAR1PAR1PAR1PAR1PAR1PAR1''BOLD''PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1

PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2
PAR2PAR2PAR2PAR2PAR2PAR2'''ITALIC'''PAR2PAR2PAR2PAR2PAR2PAR2PAR2
PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2
**HEADER1-2
:TERM1:DESCRIPTION1 AND ''BOLD''
PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
PAR1PAR1PAR1PAR1PAR1PAR1''BOLD''PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
:TERM2:DESCRIPTION2
:TERM3:DESCRIPTION3
----
*HEADER2
**HEADER2-1
http://www.hyuki.com/
**HEADER2-2
d1437 3
a1439 1
[[YukiWiki2]]
d1441 1
a1441 33
PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
PAR1PAR1PAR1PAR1PAR1PAR1'''''BOLD ITALIC'''''PAR1PAR1PAR1PAR1PAR1
PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1PAR1
>PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2
>PAR2PAR2PAR2PAR2PAR2PAR2'''ITALIC'''PAR2PAR2PAR2PAR2PAR2PAR2PAR2
>PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2PAR2

LEVEL0LEVEL0LEVEL0LEVEL0LEVEL0LEVEL0LEVEL0

>LEVEL1
>LEVEL1
>LEVEL1
>>LEVEL2
>>LEVEL2
>>LEVEL2
>>>LEVEL3
-HELLO-1
--HELLO-2
(HELLO-2, HELLO-2, HELLO-2)
---HELLO-3
(HELLO-3, HELLO-3, HELLO-3)
--HELLO-2
---HELLO-3
--HELLO-2
---HELLO-3
>>>LEVEL3
>>>LEVEL3
>>>LEVEL3
>>>LEVEL3
EOD
    print $txt;
    exit;
}
d1443 2
a1444 28
sub do_diff {
    if (not &is_editable($form{mypage})) {
        &do_read;
        return;
    }
    &open_diff;
    my $title = $form{mypage};
    &print_header($title);
    $_ = &escape($diffbase{$form{mypage}});
    &close_diff;
    print qq(<h3>$resource{difftitle}</h3>);
    print qq($resource{diffnotice});
    print qq(<pre class="diff">);
    foreach (split(/\n/, $_)) {
        if (/^\+(.*)/) {
            print qq(<b class="added">$1</b>\n);
        } elsif (/^\-(.*)/) {
            print qq(<s class="deleted">$1</s>\n);
        } elsif (/^\=(.*)/) {
            print qq(<span class="same">$1</span>\n);
        } else {
            print qq|??? $_\n|;
        }
    }
    print qq(</pre>);
    print qq(<hr>);
    &print_footer($title);
}
d1446 2
a1447 29
sub do_rss {
    my $rss = new Yuki::RSS(
        version => '1.0',
        encoding => $charset,
    );
    $rss->channel(
        title => $modifier_rss_title,
        link  => $modifier_rss_link,
        description => $modifier_rss_description,
    );
    my $recentchanges = $database{$RecentChanges};
    my $count = 0;
    foreach (split(/\n/, $recentchanges)) {
        last if ($count >= 15);
        /^\- \d\d\d\d\-\d\d\-\d\d \(...\) \d\d:\d\d:\d\d (\S+)/;    # date format.
        my $title = &unarmor_name($1);
        my $escaped_title = &escape($title);
        my $link = $modifier_rss_link . '?' . &encode($title);
        my $description = $escaped_title . &escape(&get_subjectline($title));
        $rss->add_item(
            title => $escaped_title,
            link  => $link,
            description => $description,
        );
        $count++;
    }
    # print RSS information (as XML).
    print <<"EOD"
Content-type: text/xml
d1449 3
a1451 3
@@{[$rss->as_string]}
EOD
}
d1453 2
a1454 8
sub is_exist_page {
    my ($name) = @@_;
    if ($use_exists) {
        return exists($database{$name});
    } else {
        return $database{$name};
    }
}
d1456 1
a1456 3
1;
__END__
=head1 NAME
d1458 1
a1458 1
wiki.cgi - This is YukiWiki, yet another Wiki clone.
d1460 1
a1460 1
=head1 DESCRIPTION
d1462 2
a1463 1
YukiWiki is yet another Wiki clone.
d1465 1
a1465 3
YukiWiki can treat Japanese WikiNames (enclosed with [[ and ]]).
YukiWiki provides 'InterWiki' feature, RDF Site Summary (RSS),
and some embedded commands (such as [[#comment]] to add comments).
d1467 2
a1468 1
Read F<readme_en.txt> (English) or F<readme_ja.txt> (Japanese) in more detail.
d1470 1
a1470 1
=head1 AUTHOR
d1472 2
a1473 1
Hiroshi Yuki <hyuki@@hyuki.com> http://www.hyuki.com/yukiwiki/
d1475 1
a1475 1
=head1 LICENSE
d1477 2
a1478 1
Copyright (C) 2000-2002 by Hiroshi Yuki.
d1480 1
a1480 2
This program is free software; you can redistribute it and/or
modify it under the same terms as Perl itself.
@


